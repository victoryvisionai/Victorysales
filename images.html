async function loadCollectionsForDropdown() {
    try {
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collections/list", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(prepareRequestBody())
      });
      
      const data = await response.json();
      
      if (data && data.collections) {
        const select = document.getElementById('collectionSelect');
        select.innerHTML = '<option value="">Select a collection</option>';
        
        data.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Error loading collections:", error);
    }
  }
  
  async function loadCollectionImages() {
    const collectionId = document.getElementById('collectionSelect').value;
    const container = document.getElementById('modalImagesContainer');
    container.innerHTML = '<div class="loader" style="display: block;"></div>';
    
    if (!collectionId) {
      container.innerHTML = '<p>Please select a collection</p>';
      return;
    }
    
    try {
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collections/images", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(prepareRequestBody({ collection_id: collectionId }))
      });
      
      const data = await response.json();
      container.innerHTML = '';
      
      if (data && data.images && data.images.length > 0) {
        data.images.forEach(image => {
          const imageDiv = document.createElement('div');
          imageDiv.className = 'collection-item';
          
          const img = document.createElement('img');
          img.src = image.url;
          img.alt = 'Collection image';
          img.addEventListener('click', () => {
            selectReferenceImage(image.url, image.prompt || '');
          });
          
          imageDiv.appendChild(img);
          
          const prompt = document.createElement('p');
          prompt.textContent = image.prompt || 'No prompt available';
          imageDiv.appendChild(prompt);
          
          container.appendChild(imageDiv);
        });
      } else {
        container.innerHTML = '<p>No images found in this collection</p>';
      }
    } catch (error) {
      console.error("Error loading collection images:", error);
      container.innerHTML = '<p>Error loading images</p>';
    }
  }
  
  function selectReferenceImage(imageUrl, prompt) {
    // Set the reference image
    selectedReferenceImage = {
      url: imageUrl,
      prompt: prompt
    };
    
    // Update UI
    const preview = document.getElementById('referenceImagePreview');
    preview.src = imageUrl;
    document.getElementById('selectedReferenceImage').style.display = 'block';
    
    // Set prompt if available
    if (prompt && document.getElementById('imagePrompt').value === '') {
      document.getElementById('imagePrompt').value = prompt;
    }
    
    // Hide modal
    hideCollectionsModal();
  }
  
  function removeReferenceImage() {
    selectedReferenceImage = null;
    document.getElementById('selectedReferenceImage').style.display = 'none';
  }
  
  async function loadCollections() {
    const container = document.getElementById('collectionsListContainer');
    document.getElementById('collectionsLoader').style.display = 'block';
    container.innerHTML = '';
    
    try {
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collections/list", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(prepareRequestBody())
      });
      
      const data = await response.json();
      
      if (data && data.collections) {
        collections = data.collections;
        
        if (collections.length === 0) {
          container.innerHTML = '<p>No collections found. Create your first collection above.</p>';
        } else {
          collections.forEach(collection => {
            const collectionDiv = document.createElement('div');
            collectionDiv.className = 'card';
            collectionDiv.style.cursor = 'pointer';
            
            const collectionHeader = document.createElement('div');
            collectionHeader.style.display = 'flex';
            collectionHeader.style.justifyContent = 'space-between';
            collectionHeader.style.alignItems = 'center';
            
            const name = document.createElement('h3');
            name.textContent = collection.name;
            collectionHeader.appendChild(name);
            
            const count = document.createElement('span');
            count.textContent = `${collection.image_count || 0} images`;
            count.style.color = '#666';
            collectionHeader.appendChild(count);
            
            collectionDiv.appendChild(collectionHeader);
            
            // Preview images
            const previewContainer = document.createElement('div');
            previewContainer.className = 'collections-gallery';
            previewContainer.style.justifyContent = 'flex-start';
            
            if (collection.preview_images && collection.preview_images.length > 0) {
              collection.preview_images.forEach(image => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'collection-item';
                imgDiv.style.margin = '5px';
                
                const img = document.createElement('img');
                img.src = image;
                img.alt = 'Preview';
                img.style.width = '100px';
                img.style.height = '100px';
                
                imgDiv.appendChild(img);
                previewContainer.appendChild(imgDiv);
              });
            } else {
              previewContainer.innerHTML = '<p>No images in this collection</p>';
            }
            
            collectionDiv.appendChild(previewContainer);
            
            // View full collection button
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View Collection';
            viewBtn.style.marginTop = '10px';
            viewBtn.addEventListener('click', () => {
              showCollectionDetailModal(collection.id, collection.name);
            });
            
            collectionDiv.appendChild(viewBtn);
            container.appendChild(collectionDiv);
          });
        }
      } else {
        container.innerHTML = '<p>No collections found</p>';
      }
    } catch (error) {
      console.error("Error loading collections:", error);
      container.innerHTML = '<p>Error loading collections</p>';
    } finally {
      document.getElementById('collectionsLoader').style.display = 'none';
    }
  }
  
  async function loadCollectionDetail(collectionId) {
    const container = document.getElementById('collectionDetailContainer');
    container.innerHTML = '<div class="loader" style="display: block;"></div>';
    
    try {
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collections/images", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(prepareRequestBody({ collection_id: collectionId }))
      });
      
      const data = await response.json();
      container.innerHTML = '';
      
      if (data && data.images && data.images.length > 0) {
        data.images.forEach(image => {
          const imageDiv = document.createElement('div');
          imageDiv.className = 'collection-item';
          imageDiv.style.width = '200px';
          
          const img = document.createElement('img');
          img.src = image.url;
          img.alt = 'Collection image';
          img.style.width = '200px';
          img.style.height = '200px';
          
          const prompt = document.createElement('p');
          prompt.textContent = image.prompt || 'No prompt available';
          
          const useBtn = document.createElement('button');
          useBtn.textContent = 'Use as Reference';
          useBtn.style.fontSize = '12px';
          useBtn.style.padding = '5px 10px';
          useBtn.style.marginTop = '5px';
          useBtn.addEventListener('click', () => {
            selectReferenceImage(image.url, image.prompt || '');
            hideCollectionDetailModal();
          });
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.style.fontSize = '12px';
          removeBtn.style.padding = '5px 10px';
          removeBtn.style.marginTop = '5px';
          removeBtn.style.backgroundColor = '#d9534f';
          removeBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to remove this image from the collection?')) {
              await removeImageFromCollection(collectionId, image.id);
              loadCollectionDetail(collectionId);
            }
          });
          
          imageDiv.appendChild(img);
          imageDiv.appendChild(prompt);
          imageDiv.appendChild(useBtn);
          imageDiv.appendChild(removeBtn);
          
          container.appendChild(imageDiv);
        });
      } else {
        container.innerHTML = '<p>No images found in this collection</p>';
      }
    } catch (error) {
      console.error("Error loading collection detail:", error);
      container.innerHTML = '<p>Error loading collection images</p>';
    }
  }
  
  async function createNewCollection() {
    const name = document.getElementById('newCollectionName').value.trim();
    
    if (!name) {
      alert('Please enter a collection name');
      return;
    }
    
    try {
      console.log("Attempting to create collection: " + name);
      
      const requestBody = prepareRequestBody({ name: name });
      console.log("Request data:", JSON.stringify(requestBody));
      
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collection-create", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(requestBody)
      });
      
      console.log("Response status:", response.status);
      
      // Handle non-OK responses
      if (!response.ok) {
        console.error("Error response:", response.status, response.statusText);
        const errorText = await response.text();
        console.error("Error details:", errorText);
        throw new Error(`Server returned ${response.status}: ${errorText || response.statusText}`);
      }
      
      const data = await response.json();
      console.log("Response data:", data);
      
      if (data.success) {
        alert('Collection created successfully!');
        document.getElementById('newCollectionName').value = '';
        loadCollections();
      } else {
        alert(data.message || 'Failed to create collection');
      }
    } catch (error) {
      console.error("Error creating collection:", error);
      alert('Error creating collection: ' + error.message);
    }
  }
  
  async function removeImageFromCollection(collectionId, imageId) {
    try {
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collections/remove-image", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(prepareRequestBody({
          collection_id: collectionId,
          image_id: imageId
        }))
      });
      
      const data = await response.json();
      
      if (data.success) {
        return true;
      } else {
        alert(data.message || 'Failed to remove image');
        return false;
      }
    } catch (error) {
      console.error("Error removing image:", error);
      alert('Error removing image from collection');
      return false;
    }
  }
  
  async function generateImage() {
    const prompt = document.getElementById('imagePrompt').value;
    const fileInput = document.getElementById('imageUpload');
    const resultsDiv = document.getElementById("imageResults");
    resultsDiv.innerHTML = '';
    showLoader();
  
    try {
      // Prepare request data
      const requestData = prepareRequestBody({ prompt: prompt });
  
      // Handle uploaded file if present
      if (fileInput && fileInput.files[0]) {
        requestData.image = await readFileAsBase64(fileInput.files[0]);
      }
      // Handle reference image if selected
      else if (selectedReferenceImage) {
        requestData.reference_image_url = selectedReferenceImage.url;
      }
  
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/8c4b0570-4136-4202-afc7-3ba7988d9b19", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(requestData)
      });
  
      const contentType = response.headers.get("Content-Type");
      let data;
  
      if (contentType && contentType.startsWith("image/")) {
        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);
        currentImageUrl = objectUrl;
        data = { images: [objectUrl] };
      } else {
        data = await response.json();
        currentImageUrl = data?.images?.[0]?.image || data?.images?.[0];
      }
  
      displayResults(data, prompt);
      updateStatus('Images generated successfully!');
    } catch (error) {
      console.error(error);
      updateStatus("Error: " + error.message);
    } finally {
      hideLoader();
    }
  }
  
  async function loadCollectionDropdown() {
    const dropdowns = document.querySelectorAll('.collection-dropdown');
    
    try {
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collections/list", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(prepareRequestBody())
      });
      
      const data = await response.json();
      
      if (data && data.collections) {
        dropdowns.forEach(dropdown => {
          dropdown.innerHTML = '';
          
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Select Collection';
          dropdown.appendChild(defaultOption);
          
          data.collections.forEach(collection => {
            const option = document.createElement('option');
            option.value = collection.id;
            option.textContent = collection.name;
            dropdown.appendChild(option);
          });
        });
      }
    } catch (error) {
      console.error("Error loading collections for dropdown:", error);
    }
  }
  
  function displayResults(data, prompt) {
    const gallery = document.getElementById("imageResults");
    gallery.innerHTML = '';
  
    if (data.images && data.images.length > 0) {
      data.images.forEach((item, index) => {
        const container = document.createElement("div");
        container.style.margin = "20px";
        container.style.textAlign = "center";
  
        const img = document.createElement("img");
        if (typeof item === "string") {
          img.src = item;
        } else {
          img.src = item.image || "";
        }
        img.classList.add("animated-glow", "gallery-img");
  
        const controlRow = document.createElement("div");
        controlRow.className = "control-row";
  
        // Create collection dropdown and add button
        loadCollectionDropdown().then(() => {
          // Collection dropdown
          const collectionSelect = document.createElement('select');
          collectionSelect.className = 'collection-dropdown';
          collectionSelect.style.padding = '6px';
          collectionSelect.style.marginRight = '10px';
          collectionSelect.style.borderRadius = '4px';
          collectionSelect.style.border = '1px solid #ccc';
          
          // Add default option
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Select Collection';
          collectionSelect.appendChild(defaultOption);
          
          // Get collections for dropdown
          collections.forEach(collection => {
            const option = document.createElement('option');
            option.value = collection.id;
            option.textContent = collection.name;
            collectionSelect.appendChild(option);
          });
          
          controlRow.appendChild(collectionSelect);
          
          // Add to collection button
          const addBtn = document.createElement("button");
          addBtn.innerText = "ðŸ“ Add to Collection";
          addBtn.onclick = () => {
            const selectedCollection = collectionSelect.value;
            if (selectedCollection) {
              addToCollection(selectedCollection, img.src, prompt);
            } else {
              alert("Please select a collection");
            }
          };
          
          controlRow.appendChild(addBtn);
        });
  
        // Download button
        const dlBtn = document.createElement("button");
        dlBtn.innerText = "ðŸ“¥ Download";
        dlBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = img.src;
          a.download = "ai-image.jpg";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
        controlRow.appendChild(dlBtn);
  
        container.appendChild(img);
        container.appendChild(controlRow);
        gallery.appendChild(container);
      });
    } else {
      gallery.innerHTML = '<p>No images were generated. Try a different prompt.</p>';
    }
  }
  
  async function addToCollection(collectionId, imageUrl, prompt) {
    if (!collectionId || !imageUrl) {
      alert("Collection and image are required.");
      return;
    }
  
    try {
      const response = await fetch("https://victoryvision.app.n8n.cloud/webhook/collections/add-image", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(prepareRequestBody({
          collection_id: collectionId,
          image_url: imageUrl,
          prompt: prompt || ""
        }))
      });
  
      const data = await response.json();
  
      if (data.success) {
        alert("Image added to collection successfully!");
      } else {
        alert(data.message || "Failed to add image to collection.");
      }
    } catch (err) {
      console.error(err);
      alert("Error saving image to collection.");
    }
  }
