<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Generate and refine AI-created images for advertising."/>
    <meta name="author" content="Victory Vision"/>
    <title>Victory Vision AI - Smart Image Generator</title>
    <style>
        /* Add basic styling to ensure functionality is visible */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .navbar {
            background-color: #0A3161;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar nav ul li {
            margin: 0 10px;
        }
        .navbar nav ul li a {
            color: white;
            text-decoration: none;
        }
        .content {
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        #imagePrompt {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #0A3161;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .animated-glow {
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .animated-glow:hover {
            box-shadow: 0 0 15px rgba(10, 49, 97, 0.5);
        }
        #status-message {
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0A3161;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: none;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        footer {
            background: #0A3161;
            color: #fff;
            text-align: center;
            padding: 15px;
            margin-top: 20px;
        }
        footer a {
            color: #fff;
            margin-right: 15px;
            text-decoration: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
<header class="navbar">
    <div class="logo">
        <img src="logo.jpg" alt="Victory Vision Logo" 
             onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
    </div>
    <nav>
        <ul>
            <li><a href="ai-opt">ü§ñ</a></li>
            <li><a href="dashboard">KPI's</a></li> 
            <li><a href="images">Images</a></li>
            <li><a href="videos">Videos</a></li>
            <li><a href="pages">Pages</a></li>
            <li><a href="ads">Ads</a></li>
            <li><a href="leads">Leads</a></li>
            <li><a href="social">Social</a></li>
            <li><a href="messages">Messages</a></li>
            <li><a href="settings">‚öôÔ∏è</a></li>
        </ul>
    </nav>
</header>

<div class="content">
    <div class="card">
        <h2>Create or Refine Ad Image</h2>
        <textarea id="imagePrompt" placeholder="Enter your prompt..."></textarea>
        <input type="file" id="imageUpload" accept="image/*">
        <button id="generateBtn">Generate / Analyze</button>
        <div id="loader" class="loader"></div>
        <div id="status-message"></div>
        <div id="suggested-tags"></div>
        <div id="refinement-desc" style="margin-top:10px;color:#777;"></div>
    </div>

    <div class="card">
        <h3>Image Results</h3>
        <div id="imageResults" class="image-gallery"></div>
    </div>
</div>

<footer>
    <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
    <nav>
        <a href="privacy.html">Privacy Policy</a>
        <a href="terms.html">Terms of Service</a>
    </nav>
</footer>

<script>
    // Debug mode - log all events
    const DEBUG = true;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Add click event listener to the button
        const generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
            generateBtn.addEventListener('click', generateImage);
            if (DEBUG) console.log('Generate button listener added');
        } else {
            console.error('Generate button not found!');
        }
    });
    
    // Show the loading indicator
    function showLoader() {
        const loader = document.getElementById('loader');
        if (loader) {
            loader.style.display = 'block';
            updateStatus('Processing your request...');
        }
    }
    
    // Hide the loading indicator
    function hideLoader() {
        const loader = document.getElementById('loader');
        if (loader) {
            loader.style.display = 'none';
        }
    }
    
    // Update status message
    function updateStatus(message) {
        const statusDiv = document.getElementById('status-message');
        if (statusDiv) {
            statusDiv.textContent = message;
        }
    }
    
    // Helper function for typewriter effect
    function typeWriterEffect(element, text, speed) {
        let i = 0;
        element.innerHTML = '';
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, speed);
            }
        }
        type();
    }
    
    // Helper function to animate tags
    function animateTags() {
        const tags = document.querySelectorAll('#suggested-tags button');
        tags.forEach((tag, index) => {
            setTimeout(() => {
                tag.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    tag.style.transform = 'scale(1)';
                }, 200);
            }, index * 100);
        });
    }
    
    // Main function to generate image
    async function generateImage() {
        if (DEBUG) console.log('generateImage function called');
        
        const prompt = document.getElementById('imagePrompt').value;
        const fileInput = document.getElementById('imageUpload');
        const tagsDiv = document.getElementById("suggested-tags");
        const descDiv = document.getElementById("refinement-desc");
        const resultsDiv = document.getElementById("imageResults");
        
        if (!prompt && (!fileInput || !fileInput.files[0])) {
            updateStatus('Please enter a prompt or upload an image');
            return;
        }
        
        // Clear previous results
        if (tagsDiv) tagsDiv.innerHTML = '';
        if (descDiv) descDiv.innerHTML = '';
        if (resultsDiv) resultsDiv.innerHTML = '';
        
        showLoader();
        updateStatus('Sending request to server...');
        
        try {
            // Check if we have a file
            let imageBase64 = null;
            if (fileInput && fileInput.files[0]) {
                imageBase64 = await readFileAsBase64(fileInput.files[0]);
                if (DEBUG) console.log('Image loaded as base64');
            }
            
            // Now send the request
            await sendRequest(prompt, imageBase64);
            
        } catch (error) {
            console.error('Error in generateImage:', error);
            updateStatus('Error: ' + error.message);
            hideLoader();
        }
    }
    
    // Helper function to read file as base64
    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    // Send request to n8n webhook
    async function sendRequest(prompt, image) {
        if (DEBUG) console.log('Sending request with prompt:', prompt);
        
        try {
            // Use the correct webhook URL
            const webhookUrl = 'https://victoryvision.app.n8n.cloud/webhook/8c4b0570-4136-4202-afc7-3ba7988d9b19';
            
            updateStatus('Connecting to webhook...');
            
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    prompt: prompt,
                    customer_id: "client-xyz",
                    image: image
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            updateStatus('Processing response...');
            const data = await response.json();
            
            // Process the response
            displayResults(data);
            hideLoader();
            updateStatus('Images generated successfully!');
            
        } catch (error) {
            console.error('Error in sendRequest:', error);
            hideLoader();
            updateStatus('Error: ' + error.message);
        }
    }
    
    // Display results in the UI
    function displayResults(data) {
        const gallery = document.getElementById("imageResults");
        gallery.innerHTML = '';
        
        if (data.images && data.images.length > 0) {
            data.images.forEach((url, index) => {
                if (!url) return; // Skip empty URLs
                
                const container = document.createElement("div");
                container.style.margin = "10px";
                
                const img = document.createElement("img");
                img.src = url;
                img.style.width = "200px";
                img.classList.add("animated-glow");
                img.onerror = function() {
                    this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="200" height="200" fill="#f0f0f0"/><text x="40" y="100" font-family="Arial" font-size="12" fill="#999">Image failed to load</text></svg>';
                };
                
                const input = document.createElement("input");
                input.placeholder = "Enter collection name";
                input.style.marginTop = "5px";
                input.id = "collection_" + index;
                
                const saveBtn = document.createElement("button");
                saveBtn.innerText = "üíæ Save";
                saveBtn.onclick = () => saveToCollection(url, input.value);
                
                const dlBtn = document.createElement("button");
                dlBtn.innerText = "üì• Download";
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "ai-image.jpg";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
                
                container.appendChild(img);
                container.appendChild(document.createElement("br"));
                container.appendChild(input);
                container.appendChild(saveBtn);
                container.appendChild(dlBtn);
                gallery.appendChild(container);
            });
        } else {
            gallery.innerHTML = '<p>No images were generated. Try a different prompt.</p>';
        }
        
        // Handle suggestions
        if (data.suggestions) {
            const tagsDiv = document.getElementById("suggested-tags");
            tagsDiv.innerHTML = '<strong>Enhance with:</strong><br>';
            
            if (Array.isArray(data.suggestions)) {
                data.suggestions.forEach(tag => {
                    const btn = document.createElement("button");
                    btn.innerText = tag;
                    btn.onclick = () => {
                        document.getElementById('imagePrompt').value += ' ' + tag;
                    };
                    btn.style.margin = '4px';
                    tagsDiv.appendChild(btn);
                });
                animateTags();
            } else {
                // Handle string of suggestions
                const tags = data.suggestions.split(',').map(t => t.trim());
                tags.forEach(tag => {
                    if (!tag) return;
                    const btn = document.createElement("button");
                    btn.innerText = tag;
                    btn.onclick = () => {
                        document.getElementById('imagePrompt').value += ' ' + tag;
                    };
                    btn.style.margin = '4px';
                    tagsDiv.appendChild(btn);
                });
                animateTags();
            }
        }
        
        // Handle description
        if (data.description) {
            const descEl = document.getElementById("refinement-desc");
            typeWriterEffect(descEl, "AI Analysis: " + data.description, 20);
        }
    }
    
    // Save to collection function
    async function saveToCollection(imageUrl, collectionName) {
        if (!collectionName) {
            alert("Please enter a collection name.");
            return;
        }
        
        try {
            const saveResponse = await fetch("https://victoryvision.app.n8n.cloud/webhook/save-to-collection", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    image_url: imageUrl,
                    collection_name: collectionName,
                    customer_id: "client-xyz"
                })
            });
            
            if (!saveResponse.ok) {
                throw new Error(`HTTP error! status: ${saveResponse.status}`);
            }
            
            alert("Saved to collection: " + collectionName);
        } catch (error) {
            console.error('Error saving to collection:', error);
            alert("Error saving to collection: " + error.message);
        }
    }
</script>
</body>
</html>
