<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Manage your email communications and drafts."/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Messages</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .navbar nav ul li {
      margin: 0 10px;
    }
    .navbar nav ul li a {
      color: white;
      text-decoration: none;
    }
    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      position: relative;
      border: none;
      transition: all 0.3s ease;
    }
    .subscription-medallion.bronze {
      background: linear-gradient(45deg, #CD7F32, #A0522D);
    }
    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }
    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }
    .subscription-medallion:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .subscription-medallion .plan-name {
      font-weight: bold;
    }
    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }
    .content {
      padding: 20px 4px;
      max-width: 1800px;
      margin: 0 auto;
    }
    .page-header {
      margin-bottom: 30px;
    }
    .page-title {
      font-size: 2.5rem;
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      font-size: 1.1rem;
      color: #666;
    }
    .messages-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      height: calc(100vh - 200px);
      min-height: 600px;
    }
    .email-list-panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .email-reading-panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    .panel-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 0;
    }
    .filter-section {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      align-items: end;
    }
    .form-group {
      margin: 0;
    }
    .form-group label {
      display: block;
      margin-bottom: 3px;
      font-weight: 500;
      color: #333;
      font-size: 12px;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      box-sizing: border-box;
    }
    .form-group button {
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #0A3161;
      color: white;
      font-weight: 500;
      transition: all 0.2s;
    }
    .form-group button:hover {
      background: #083050;
      transform: translateY(-1px);
    }
    .form-group button.secondary {
      background: #6c757d;
    }
    .form-group button.secondary:hover {
      background: #5a6268;
    }
    .form-group button.success {
      background: #28a745;
    }
    .form-group button.success:hover {
      background: #218838;
    }
    .email-list {
      flex: 1;
      overflow-y: auto;
      border-bottom: 1px solid #dee2e6;
    }
    .email-thread {
      border-bottom: 1px solid #f1f3f4;
    }
    .email-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      border-left: 4px solid transparent;
    }
    .email-item:hover {
      background-color: #f8f9fa;
      transform: translateX(2px);
    }
    .email-item.selected {
      background-color: #e3f2fd;
      border-left: 4px solid #0A3161;
      box-shadow: inset 0 0 0 1px #0A3161;
    }
    .email-item.unread {
      background-color: #fff8e1;
      font-weight: 600;
    }
    .email-item.draft {
      background-color: #f3e5f5;
      border-left: 4px solid #bb133e;
    }
    .email-item.sent {
      background-color: #e8f5e8;
    }
    .email-item.inbound {
      background-color: #f0f8ff;
    }
    .email-item.replied {
      background-color: #f0f8f0;
    }
    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .email-from {
      font-weight: 600;
      color: #0A3161;
      font-size: 14px;
    }
    .email-date {
      font-size: 11px;
      color: #666;
    }
    .email-subject {
      font-size: 13px;
      color: #333;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .email-preview {
      font-size: 12px;
      color: #666;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .email-badges {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }
    .badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 500;
    }
    .badge.draft {
      background: #bb133e;
      color: white;
    }
    .badge.sent {
      background: #28a745;
      color: white;
    }
    .badge.inbound {
      background: #17a2b8;
      color: white;
    }
    .badge.replied {
      background: #6f42c1;
      color: white;
    }
    .badge.opened {
      background: #ffc107;
      color: #333;
    }
    .thread-indicator {
      font-size: 10px;
      color: #666;
      margin-left: 10px;
    }
    .compose-section {
      padding: 15px 20px;
      border-top: 1px solid #dee2e6;
      background: #f8f9fa;
    }
    .reading-pane {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .reading-pane.empty {
      display: flex;
      justify-content: center;
      align-items: center;
      color: #666;
      font-size: 1.1rem;
    }
    .empty-message {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 1;
    }
    .reading-pane:not(.empty) .empty-message {
      display: none;
    }
    
    .email-view {
      display: none;
    }
    .email-view.active {
      display: block;
    }
    .email-view-header {
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .email-view-subject {
      font-size: 1.4rem;
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 15px;
    }
    .email-view-meta {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 15px;
      font-size: 13px;
    }
    .meta-label {
      font-weight: 600;
      color: #666;
    }
    .meta-value {
      color: #333;
    }
    .email-view-body {
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
      margin-bottom: 20px;
      min-height: 200px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .attachments-section {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .attachment-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: white;
      border-radius: 4px;
      margin: 5px 0;
      border: 1px solid #e9ecef;
    }
    .attachment-icon {
      font-size: 20px;
    }
    .attachment-info {
      flex: 1;
    }
    .attachment-name {
      font-weight: 500;
      color: #0A3161;
    }
    .attachment-size {
      font-size: 11px;
      color: #666;
    }
    .download-btn {
      padding: 6px 12px;
      background: #0A3161;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .download-btn:hover {
      background: #083050;
    }
    .email-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #dee2e6;
      flex-wrap: wrap;
    }
    .email-actions button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #0A3161;
      color: white;
    }
    .btn-primary:hover {
      background: #083050;
      transform: translateY(-1px);
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    .compose-form {
      display: none;
      padding: 20px;
      overflow-y: auto;
      max-height: 100%;
    }
    .compose-form.active {
      display: block;
    }
    .compose-form .form-group {
      margin-bottom: 15px;
    }
    .compose-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    .compose-form input,
    .compose-form select,
    .compose-form textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .compose-form textarea {
      min-height: 200px;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding-top: 15px;
      border-top: 1px solid #dee2e6;
    }
    .cc-bcc-toggle {
      font-size: 13px;
      color: #0A3161;
      cursor: pointer;
      text-decoration: underline;
      display: inline-block;
      padding: 5px 0;
    }
    .cc-bcc-toggle:hover {
      color: #083050;
      font-weight: 500;
    }
    .cc-bcc-fields {
      display: none;
    }
    .cc-bcc-fields.active {
      display: block;
    }
    .ai-assist-section {
      background: #f0f8ff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid #b3d9ff;
    }
    .ai-assist-section label {
      font-size: 13px;
      margin-right: 10px;
    }
    .ai-assist-section select {
      width: auto;
      padding: 6px 10px;
      font-size: 13px;
    }
    .ai-assist-section button {
      padding: 6px 12px;
      font-size: 13px;
      margin-left: 10px;
    }
    .status-message {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 15px 20px;
      background: #28a745;
      color: white;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      z-index: 1000;
      max-width: 400px;
    }
    .status-message.error {
      background: #dc3545;
    }
    .status-message.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 3% auto;
      padding: 0;
      border-radius: 8px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      border-radius: 8px 8px 0 0;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
    }
    .modal-search {
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
    }
    .modal-search input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .close {
      color: white;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
      transition: all 0.2s;
    }
    .close:hover {
      color: #f0f0f0;
      transform: scale(1.1);
    }
    .field-group {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e9ecef;
    }
    .field-group:last-child {
      border-bottom: none;
    }
    .field-label {
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      font-size: 12px;
      text-transform: uppercase;
    }
    .field-value {
      color: #333;
      font-size: 14px;
      line-height: 1.6;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 1.1rem;
    }
    .file-selector-modal .file-item {
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin: 5px 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-selector-modal .file-item:hover {
      background: #f8f9fa;
      border-color: #0A3161;
    }
    .file-selector-modal .file-item.selected {
      background: #e3f2fd;
      border-color: #0A3161;
    }
    .attachment-display {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .attachment-tag {
      background: #e9ecef;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .attachment-tag button {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      margin: 0;
    }
    .signature-preview {
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-top: 5px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .vv-chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 999;
    }
    .vv-chat-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.3s;
      position: relative;
    }
    .vv-chat-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
    .vv-chat-toggle.active {
      background: linear-gradient(135deg, #bb133e, #8b0f2e);
    }
    .vv-notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .vv-chat-container {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 550px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 998;
      overflow: hidden;
    }
    .vv-chat-container.open {
      display: flex;
    }
    .vv-chat-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .vv-chat-title {
      font-weight: bold;
      font-size: 16px;
    }
    .vv-chat-minimize {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .vv-chat-minimize:hover {
      background: rgba(255,255,255,0.1);
    }
    .vv-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
    }
    .vv-chat-message {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      max-width: 80%;
      line-height: 1.4;
      font-size: 14px;
    }
    .vv-chat-message.user {
      background: #0A3161;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 2px;
    }
    .vv-chat-message.bot {
      background: white;
      color: #333;
      border-bottom-left-radius: 2px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .vv-chat-typing {
      display: none;
      padding: 10px 14px;
      background: white;
      border-radius: 8px;
      max-width: 80px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .vv-chat-typing.show {
      display: block;
    }
    .vv-chat-typing span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }
    .vv-chat-typing span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .vv-chat-typing span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    .vv-chat-input-area {
      padding: 15px;
      background: white;
      border-top: 1px solid #dee2e6;
      display: flex;
      gap: 10px;
    }
    .vv-chat-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      font-family: Arial, sans-serif;
    }
    .vv-chat-send {
      background: #0A3161;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    .vv-chat-send:hover:not(:disabled) {
      background: #083050;
    }
    .vv-chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .vv-chat-error {
      display: none;
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 15px;
      font-size: 13px;
      border: 1px solid #f5c6cb;
    }
    .vv-quick-replies {
      padding: 10px 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background: white;
      border-top: 1px solid #dee2e6;
    }
    .vv-quick-reply {
      background: #e9ecef;
      border: 1px solid #dee2e6;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .vv-quick-reply:hover {
      background: #0A3161;
      color: white;
      border-color: #0A3161;
    }
    .introjs-button {
      background: #0A3161 !important;
      border-color: #0A3161 !important;
      text-shadow: none !important;
    }
    .introjs-button:hover {
      background: #083050 !important;
      border-color: #083050 !important;
    }
    .introjs-skipbutton {
      color: #666 !important;
    }
    .introjs-skipbutton:hover {
      color: #333 !important;
    }
    .introjs-disabled {
      background: #6c757d !important;
      border-color: #6c757d !important;
    }
    .introjs-progressbar {
      background-color: #0A3161 !important;
    }
    
    @media (max-width: 1024px) {
      .messages-layout {
        grid-template-columns: 1fr;
        height: auto;
      }
      .email-reading-panel {
        min-height: 400px;
      }
    }
    
    @media (max-width: 768px) {
      .content {
        padding: 10px 5px;
      }
      .page-title {
        font-size: 2rem;
      }
      .filter-section {
        grid-template-columns: 1fr;
      }
      .email-actions {
        flex-wrap: wrap;
      }
      .compose-form .form-actions {
        flex-direction: column;
      }
      .vv-chat-container {
        width: 320px;
        height: 450px;
        bottom: 70px;
        right: -10px;
      }
      .vv-chat-widget {
        bottom: 15px;
        right: 15px;
      }
    }
    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #28a745;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
     <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>
      <li><a href="contacts">Contacts</a></li>
      <li><a href="ads">Ads</a></li>
      <li><a href="messages">Messages</a></li>
      <li><a href="meetings">Meetings</a></li>
      <li><a href="ai">Analytics</a></li>
      <li><a href="settings">Settings</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <button onclick="startTour()" style="background: #28a745; padding: 6px 12px; font-size: 11px; margin-left: 10px;" id="tourButton">
      üìñ Take Tour
    </button>
    <div id="subscriptionMedallion" class="subscription-medallion bronze">
      <span class="plan-name">Bronze</span>
    </div>
  </div>
</header>

<div class="content">
  <header class="page-header">
    <h1 class="page-title">Messages</h1>
    <p class="page-subtitle">Manage your email communications and AI-powered outreach</p>
  </header>

  <div class="messages-layout">
    <!-- Email List Panel -->
    <div class="email-list-panel" data-intro="Your email inbox and drafts are displayed here. Filter, search, and organize your communications." data-step="1">
      <div class="panel-header">
        <h2 class="panel-title">üì¨ Inbox & Drafts</h2>
        <button onclick="showComposeForm()" class="btn-primary" style="padding: 10px 16px;">‚úâÔ∏è Compose</button>
      </div>
      
      <div class="filter-section" data-intro="Filter emails by type, status, or search for specific messages." data-step="2">
        <div class="form-group">
          <label for="emailSearch">Search</label>
          <input type="text" id="emailSearch" placeholder="Search emails..." oninput="applyFilters()">
        </div>
        <div class="form-group">
          <label for="emailType">Type</label>
          <select id="emailType" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="inbound">Inbound</option>
            <option value="sent">Sent</option>
            <option value="draft">Drafts</option>
          </select>
        </div>
        <div class="form-group">
          <label for="emailStatus">Status</label>
          <select id="emailStatus" onchange="applyFilters()">
            <option value="">All Status</option>
            <option value="unread">Unread</option>
            <option value="opened">Opened</option>
            <option value="replied">Replied</option>
          </select>
        </div>
        <div class="form-group">
          <button onclick="clearFilters()" class="secondary">Clear Filters</button>
        </div>
        <div class="form-group">
          <button onclick="refreshEmails()" class="success">üîÑ Refresh</button>
        </div>
      </div>
      
      <div class="email-list" id="emailList" data-intro="Click on any email to view its full content. Different colors indicate email status." data-step="3">
        <div class="loading">üìß Loading your emails...</div>
      </div>
      
      <div class="compose-section">
     <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-weight: 600; color: #0A3161;">ü§ñ AI Auto-Reply</span>
            <span style="font-size: 12px; color: #666;">Automatically respond to incoming emails</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoReplyToggle" onchange="toggleAutoReply(this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- Email Reading/Composing Panel -->
    <div class="email-reading-panel" data-intro="Read email content here or compose new messages. Use AI assistance to improve your emails." data-step="4">
      <div class="panel-header">
        <h2 class="panel-title" id="readingPaneTitle">üìñ Reading Pane</h2>
        <div id="readingPaneActions" style="display: none;">
          <button onclick="replyToEmail()" class="btn-primary" style="padding: 10px 16px;">‚Ü©Ô∏è Reply</button>
          <button onclick="replyAllToEmail()" class="btn-primary" style="padding: 10px 16px;">‚Ü©Ô∏è Reply All</button>
          <button onclick="forwardEmail()" class="btn-secondary" style="padding: 10px 16px;">‚û°Ô∏è Forward</button>
        </div>
      </div>
      
      <div class="reading-pane empty" id="readingPane">
        <div class="empty-message">
          <h3>üìß Select an email to read</h3>
          <p>Choose an email from the list to view its content here</p>
        </div>
        
        <!-- Email View Template -->
        <div class="email-view" id="emailViewTemplate">
          <div class="email-view-header">
            <div class="email-view-subject" id="viewSubject"></div>
            <div class="email-view-meta">
              <span class="meta-label">From:</span>
              <span class="meta-value" id="viewFrom"></span>
              <span class="meta-label">To:</span>
              <span class="meta-value" id="viewTo"></span>
              <span class="meta-label">CC:</span>
              <span class="meta-value" id="viewCC">-</span>
              <span class="meta-label">BCC:</span>
              <span class="meta-value" id="viewBCC">-</span>
              <span class="meta-label">Date:</span>
              <span class="meta-value" id="viewDate"></span>
              <span class="meta-label">Status:</span>
              <span class="meta-value" id="viewStatus"></span>
            </div>
          </div>
          
          <div id="viewAttachments" class="attachments-section" style="display: none;">
            <h4>üìé Attachments</h4>
            <div id="attachmentsList"></div>
          </div>
          
          <div class="email-view-body" id="viewBody"></div>
          
          <div class="email-actions">
            <button onclick="replyToEmail()" class="btn-primary">‚Ü©Ô∏è Reply</button>
            <button onclick="replyAllToEmail()" class="btn-primary">‚Ü©Ô∏è Reply All</button>
            <button onclick="forwardEmail()" class="btn-secondary">‚û°Ô∏è Forward</button>
            <button onclick="markAsRead()" class="btn-secondary">‚úì Mark Read</button>
            <button onclick="deleteEmail()" class="btn-danger">üóëÔ∏è Delete</button>
            <button onclick="openEmailModal()" class="btn-secondary">üìã Details</button>
          </div>
        </div>
      </div>
        <div class="email-view-header">
          <div class="email-view-subject" id="viewSubject"></div>
          <div class="email-view-meta">
            <span class="meta-label">From:</span>
            <span class="meta-value" id="viewFrom"></span>
            <span class="meta-label">To:</span>
            <span class="meta-value" id="viewTo"></span>
            <span class="meta-label">CC:</span>
            <span class="meta-value" id="viewCC">-</span>
            <span class="meta-label">BCC:</span>
            <span class="meta-value" id="viewBCC">-</span>
            <span class="meta-label">Date:</span>
            <span class="meta-value" id="viewDate"></span>
            <span class="meta-label">Status:</span>
            <span class="meta-value" id="viewStatus"></span>
          </div>
        </div>
        
        <div id="viewAttachments" class="attachments-section" style="display: none;">
          <h4>üìé Attachments</h4>
          <div id="attachmentsList"></div>
        </div>
        
        <div class="email-view-body" id="viewBody"></div>
        
        <div class="email-actions">
          <button onclick="replyToEmail()" class="btn-primary">‚Ü©Ô∏è Reply</button>
          <button onclick="replyAllToEmail()" class="btn-primary">‚Ü©Ô∏è Reply All</button>
          <button onclick="forwardEmail()" class="btn-secondary">‚û°Ô∏è Forward</button>
          <button onclick="markAsRead()" class="btn-secondary">‚úì Mark Read</button>
          <button onclick="deleteEmail()" class="btn-danger">üóëÔ∏è Delete</button>
          <button onclick="openEmailModal()" class="btn-secondary">üìã Details</button>
        </div>
      
      <!-- Compose Form -->
      <div class="compose-form" id="composeForm" data-intro="Compose new emails with AI assistance. Choose from different AI tones and styles to match your communication goals." data-step="5">
        <form id="emailComposeForm" onsubmit="sendEmail(event)">
          <div class="ai-assist-section">
            <label for="aiTone">AI Assistance:</label>
            <select id="aiTone">
              <option value="">No AI</option>
              <option value="professional">Professional</option>
              <option value="friendly">Friendly</option>
              <option value="persuasive">Persuasive</option>
              <option value="casual">Casual</option>
            </select>
            <button type="button" onclick="aiAssist('generate')" class="btn-secondary">ü§ñ Generate</button>
          </div>
          
          <div class="form-group">
            <label for="composeFrom">From</label>
            <input type="email" id="composeFrom" required readonly>
          </div>
          
          <div class="form-group">
            <label for="composeTo">To</label>
            <input type="email" id="composeTo" required placeholder="recipient@example.com" list="contactsList">
            <datalist id="contactsList"></datalist>
          </div>
          
          <div style="margin-top: -10px; margin-bottom: 15px;">
            <span class="cc-bcc-toggle" onclick="toggleCCBCC()">+ Cc/Bcc</span>
          </div>
          
          <div class="cc-bcc-fields" id="ccBccFields">
            <div class="form-group">
              <label for="composeCC">CC</label>
              <input type="email" id="composeCC" placeholder="cc@example.com">
            </div>
            <div class="form-group">
              <label for="composeBCC">BCC</label>
              <input type="email" id="composeBCC" placeholder="bcc@example.com">
            </div>
          </div>
          
          <div class="form-group">
            <label for="composeSubject">Subject</label>
            <input type="text" id="composeSubject" required placeholder="Email subject">
          </div>
          
          <div class="form-group">
            <label for="composeBody">Message</label>
            <textarea id="composeBody" required placeholder="Type your message here..."></textarea>
          </div>
          
          <div class="form-group">
            <label>Attachments</label>
            <button type="button" onclick="showFileSelector()" class="btn-secondary">üìé Attach Files</button>
            <button type="button" onclick="handleFileUpload()" class="btn-secondary">üì§ Upload New</button>
            <div class="attachment-display" id="attachmentDisplay"></div>
          </div>
          
          <div class="form-group">
            <label>Email Signature</label>
            <div class="signature-preview" id="signaturePreview">No signature set</div>
            <button type="button" onclick="editSignature()" class="btn-secondary" style="margin-top: 10px;">‚úèÔ∏è Edit Signature</button>
          </div>
          
          <div class="form-actions">
            <button type="button" onclick="saveDraft()" class="btn-secondary">üíæ Save Draft</button>
            <button type="button" onclick="scheduleEmail()" class="btn-secondary">‚è∞ Schedule</button>
            <button type="submit" class="btn-success">üì§ Send Email</button>
            <button type="button" onclick="cancelCompose()" class="btn-secondary">‚ùå Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Status Messages -->
  <div id="statusMessage" class="status-message"></div>
</div>

<!-- Email Details Modal -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Email Details</h2>
      <span class="close" onclick="closeEmailModal()">&times;</span>
    </div>
    <div class="modal-search">
      <input type="text" id="modalSearch" placeholder="Search in details..." oninput="filterModalContent()">
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Email details will be loaded here -->
    </div>
  </div>
</div>

<!-- Signature Edit Modal -->
<div id="signatureModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Email Signature</h2>
      <span class="close" onclick="closeSignatureModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="signatureText">Signature Text</label>
        <textarea id="signatureText" rows="6" placeholder="Best regards,&#10;Your Name&#10;Victory Vision&#10;email@victoryvision.com"></textarea>
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button onclick="closeSignatureModal()" class="btn-secondary">Cancel</button>
        <button onclick="saveSignature()" class="btn-primary" style="margin-left: 10px;">üíæ Save Signature</button>
      </div>
    </div>
  </div>
</div>

<!-- File Selector Modal -->
<div id="fileSelectorModal" class="modal file-selector-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Select Files to Attach</h2>
      <span class="close" onclick="closeFileSelector()">&times;</span>
    </div>
    <div class="modal-search">
      <input type="text" id="fileSearch" placeholder="Search files..." oninput="filterFileList()">
    </div>
    <div class="modal-body" id="fileListBody">
      <div class="loading">Loading your media files...</div>
    </div>
    <div style="padding: 20px; border-top: 1px solid #dee2e6; text-align: right;">
      <button onclick="closeFileSelector()" class="btn-secondary">Cancel</button>
      <button onclick="attachSelectedFiles()" class="btn-primary" style="margin-left: 10px;">Attach Selected</button>
    </div>
  </div>
</div>

<!-- Victory Vision Chat Widget -->
<div class="vv-chat-widget">
  <button class="vv-chat-toggle" id="vvChatToggle">
    <span id="vvToggleIcon">üí¨</span>
    <span class="vv-notification-badge" id="vvNotificationBadge">1</span>
  </button>
</div>

<div class="vv-chat-container" id="vvChatContainer">
  <div class="vv-chat-header">
    <div class="vv-chat-title">Victory Vision AI</div>
    <button class="vv-chat-minimize" id="vvChatMinimize">‚úï</button>
  </div>
  <div class="vv-chat-messages" id="vvChatMessages">
    <div class="vv-chat-message bot">
      üëã Hi! I'm Victory Vision AI. How can I help you with your email marketing today?
    </div>
  </div>
  <div class="vv-chat-typing" id="vvChatTyping">
    <span></span><span></span><span></span>
  </div>
  <div class="vv-chat-error" id="vvChatError"></div>
  <div class="vv-quick-replies">
    <button class="vv-quick-reply" onclick="VVChat.sendQuickMessage('Help me write an email')">‚úçÔ∏è Write email</button>
    <button class="vv-quick-reply" onclick="VVChat.sendQuickMessage('Generate campaign ideas')">üí° Campaign ideas</button>
    <button class="vv-quick-reply" onclick="VVChat.sendQuickMessage('Best practices')">üìö Best practices</button>
  </div>
  <div class="vv-chat-input-area">
    <textarea class="vv-chat-input" id="vvChatInput" placeholder="Ask me anything..." rows="1"></textarea>
    <button class="vv-chat-send" id="vvChatSend" disabled>Send</button>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const ENDPOINTS = {
  sendEmail: 'https://victoryvision.app.n8n.cloud/webhook/emails/send',
  saveDraft: 'https://victoryvision.app.n8n.cloud/webhook/emails/draft',
  loadEmails: 'https://victoryvision.app.n8n.cloud/webhook/emails/get',
  aiAssist: 'https://victoryvision.app.n8n.cloud/webhook/emails/ai-assist',
  generateCampaign: 'https://victoryvision.app.n8n.cloud/webhook/emails/generate-campaign',
  scheduleEmail: 'https://victoryvision.app.n8n.cloud/webhook/emails/schedule',
  deleteEmail: 'https://victoryvision.app.n8n.cloud/webhook/emails/delete',
  markRead: 'https://victoryvision.app.n8n.cloud/webhook/emails/mark-read',
  chatMessage: 'https://victoryvision.app.n8n.cloud/webhook/chat/message',
  loadContacts: 'https://victoryvision.app.n8n.cloud/webhook/contacts/get',
  loadMedia: 'https://victoryvision.app.n8n.cloud/webhook/media/get'
};

let authToken = null;
let CUSTOMER_ID = null;
let allEmails = [];
let filteredEmails = [];
let currentEmail = null;
let currentMode = 'compose';
let selectedFiles = [];
let attachedFiles = [];
let mediaFiles = [];
let contacts = [];
let preloadedContact = null;
let userSignature = '';
let currentDraftId = null;

async function checkAuthentication() {
  try {
    console.log('Checking authentication...');
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    if (error) {
      console.error('Supabase session error:', error);
      return false;
    }
    
    if (session && session.user) {
      // Validate session data
      if (!session.user.email) {
        console.error('No email in session');
        return false;
      }
      
      authToken = session.access_token;
      CUSTOMER_ID = session.user.email;
      console.log('Authenticated as:', CUSTOMER_ID);
      console.log('Session expires at:', new Date(session.expires_at * 1000));
      return true;
    }
    
    console.log('No active session found');
    return false;
  } catch (error) {
    console.error('Auth check error:', error);
    return false;
  }
}

function redirectToLogin() {
  console.error('REDIRECT TO LOGIN TRIGGERED');
  console.error('Stack trace:', new Error().stack);
  console.error('Current URL:', window.location.href);
  console.error('Auth Token:', authToken ? 'EXISTS' : 'NULL');
  console.error('Customer ID:', CUSTOMER_ID);
  
  // Clear all session data
  localStorage.removeItem('vv_session');
  sessionStorage.clear();
  
  // Redirect to login
  window.location.href = 'https://www.victoryvision.app';
}

function showStatus(message, isError = false) {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.textContent = message;
  statusDiv.className = 'status-message show' + (isError ? ' error' : '');
  setTimeout(() => {
    statusDiv.classList.remove('show');
  }, 3000);
}

async function loadUserData() {
  const userEmailSpan = document.getElementById('userEmail');
  if (userEmailSpan && CUSTOMER_ID) {
    userEmailSpan.textContent = CUSTOMER_ID;
  }
  
  // Load user signature from localStorage
  const savedSignature = localStorage.getItem(`signature_${CUSTOMER_ID}`);
  if (savedSignature) {
    userSignature = savedSignature;
    updateSignaturePreview();
  }
} 
      // Load auto-reply from localStorage
  const savedAutoReply = localStorage.getItem(`aireply_${CUSTOMER_ID}`);
  if (savedAutoReply) {
    window.userAutoReply = savedAutoReply === 'true';
    const autoReplyToggle = document.getElementById('autoReplyToggle');
    if (autoReplyToggle) {
      autoReplyToggle.checked = window.userAutoReply;
    }
  }

function updateSubscriptionMedallion(plan) {
  const medallion = document.getElementById('subscriptionMedallion');
  const planName = medallion.querySelector('.plan-name');
  
  if (!medallion || !planName) return;
  
  // Remove all plan classes
  medallion.classList.remove('bronze', 'silver', 'gold');
  
  // Add the correct class and update text
  const planLower = (plan || 'bronze').toLowerCase();
  medallion.classList.add(planLower);
  planName.textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
}
async function loadContacts() {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    const response = await fetch(ENDPOINTS.loadContacts, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ customer_id: CUSTOMER_ID }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      
      // Handle both array response and object with contacts property
      if (Array.isArray(data)) {
        contacts = data;
      } else if (data.contacts && Array.isArray(data.contacts)) {
        contacts = data.contacts;
      } else {
        contacts = [];
      }
      
      // Populate autocomplete datalist
      const datalist = document.getElementById('contactsList');
      if (datalist && contacts.length > 0) {
        datalist.innerHTML = contacts.map(contact => {
          const email = contact.email || '';
          const name = contact.name || contact.first_name || '';
          const company = contact.company || '';
          const display = name ? `${name} <${email}>` : email;
          return `<option value="${email}">${display}${company ? ' - ' + company : ''}</option>`;
        }).join('');
      }
      
      console.log('Loaded contacts:', contacts.length);
    } else {
      contacts = [];
    }
  } catch (error) {
    // Completely silent
    contacts = [];
    const datalist = document.getElementById('contactsList');
    if (datalist) {
      datalist.innerHTML = '';
    }
  }
}

async function loadMediaFiles() {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    const response = await fetch(ENDPOINTS.loadMedia, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ customer_id: CUSTOMER_ID }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      
      // Handle both array response and object with media property
      if (Array.isArray(data)) {
        mediaFiles = data;
      } else if (data.media && Array.isArray(data.media)) {
        mediaFiles = data.media;
      } else {
        mediaFiles = [];
      }
      
      console.log('Loaded media files:', mediaFiles.length);
    } else {
      mediaFiles = [];
    }
  } catch (error) {
    // Completely silent
    mediaFiles = [];
  }
}

async function loadEmails() {
  // Silently try to load emails - if endpoint doesn't exist, just show empty inbox
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
    
    const response = await fetch(ENDPOINTS.loadEmails, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ customer_id: CUSTOMER_ID }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const data = await response.json();
      
      // Handle both array response and object with emails property
      let emailsArray = [];
      if (Array.isArray(data)) {
        // Direct array response from n8n
        emailsArray = data;
      } else if (data.emails && Array.isArray(data.emails)) {
        // Object with emails property
        emailsArray = data.emails;
      }
      
      allEmails = emailsArray.filter(email => {
        // FILTER OUT WARM-UP EMAILS
        const subject = (email.subject || '').toLowerCase();
        const tags = (email.tags || []).map(t => t.toLowerCase());
        
        // Remove emails with warm-up indicators
        if (subject.includes('warm-up') || 
            subject.includes('warmup') || 
            tags.includes('warm-up') || 
            tags.includes('warmup') ||
            tags.includes('test')) {
          return false;
        }
        
        return true;
      });
      
      console.log('Loaded emails:', allEmails.length);
      applyFilters();
    } else {
      allEmails = [];
      applyFilters();
    }
  } catch (error) {
    // Completely silent - don't even log
    allEmails = [];
    applyFilters();
  }
}

function applyFilters() {
  const searchTerm = document.getElementById('emailSearch').value.toLowerCase();
  const typeFilter = document.getElementById('emailType').value;
  const statusFilter = document.getElementById('emailStatus').value;
  
  filteredEmails = allEmails.filter(email => {
    const matchesSearch = !searchTerm || 
      (email.subject && email.subject.toLowerCase().includes(searchTerm)) ||
      (email.from && email.from.toLowerCase().includes(searchTerm)) ||
      (email.to && email.to.toLowerCase().includes(searchTerm)) ||
      (email.body && email.body.toLowerCase().includes(searchTerm));
    
    const matchesType = !typeFilter ||
      (typeFilter === 'inbound' && email.inbound) ||
      (typeFilter === 'sent' && !email.inbound && !email.draft) ||
      (typeFilter === 'draft' && email.draft);
    
    const matchesStatus = !statusFilter ||
      (statusFilter === 'unread' && !email.opened) ||
      (statusFilter === 'opened' && email.opened) ||
      (statusFilter === 'replied' && email.replied);
    
    return matchesSearch && matchesType && matchesStatus;
  });
  
  renderEmailList();
}

function clearFilters() {
  document.getElementById('emailSearch').value = '';
  document.getElementById('emailType').value = '';
  document.getElementById('emailStatus').value = '';
  applyFilters();
}

function renderEmailList() {
  const emailList = document.getElementById('emailList');
  
  if (filteredEmails.length === 0) {
    if (allEmails.length === 0) {
      emailList.innerHTML = '<div class="loading">üì≠ No emails yet. Click Compose to start!</div>';
    } else {
      emailList.innerHTML = '<div class="loading">üîç No emails match your filters</div>';
    }
    return;
  }
  
  const sortedEmails = [...filteredEmails].sort((a, b) => {
    return new Date(b.created_at || b.sent_at) - new Date(a.created_at || a.sent_at);
  });
  
  // Group emails by thread
  const threadGroups = new Map();
  sortedEmails.forEach(email => {
    const cleanSubject = (email.subject || '').replace(/^(re:|fwd?:)\s*/i, '').trim().toLowerCase();
    if (!threadGroups.has(cleanSubject)) {
      threadGroups.set(cleanSubject, []);
    }
    threadGroups.get(cleanSubject).push(email);
  });
  
  let html = '';
  
  threadGroups.forEach((emails, subject) => {
    html += '<div class="email-thread">';
    
    emails.forEach((email, index) => {
      const classes = ['email-item'];
      if (currentEmail && currentEmail.id === email.id) classes.push('selected');
      if (!email.opened && email.inbound) classes.push('unread');
      if (email.draft) classes.push('draft');
      else if (email.inbound) classes.push('inbound');
      else if (email.replied) classes.push('replied');
      else classes.push('sent');
      
      const badges = [];
      if (email.draft) badges.push('<span class="badge draft">Draft</span>');
      if (email.inbound && !email.draft) badges.push('<span class="badge inbound">Received</span>');
      if (!email.inbound && !email.draft) badges.push('<span class="badge sent">Sent</span>');
      if (email.replied) badges.push('<span class="badge replied">Replied</span>');
      if (email.opened) badges.push('<span class="badge opened">Opened</span>');
      
      const threadIndicator = emails.length > 1 ? `<span class="thread-indicator">(${index + 1}/${emails.length})</span>` : '';
      
      html += `
        <div class="${classes.join(' ')}" onclick="selectEmail('${email.id}')">
          <div class="email-header">
            <div class="email-from">${getEmailDisplayName(email)}${threadIndicator}</div>
            <div class="email-date">${formatDate(email.created_at || email.sent_at)}</div>
          </div>
          <div class="email-subject">${email.subject || '(No subject)'}</div>
          <div class="email-preview">${getEmailPreview(email)}</div>
          <div class="email-badges">${badges.join('')}</div>
        </div>
      `;
    });
    
    html += '</div>';
  });
  
  emailList.innerHTML = html;
}

function getEmailDisplayName(email) {
  if (email.inbound) {
    return email.from || 'Unknown Sender';
  } else if (email.draft) {
    return `Draft to: ${email.to || 'Unknown'}`;
  } else {
    return email.to || 'Unknown Recipient';
  }
}

function formatDate(dateStr) {
  if (!dateStr) return 'Unknown';
  
  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = Math.abs(now - date);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  
  return date.toLocaleDateString();
}

function getEmailPreview(email) {
  const body = email.body || '';
  return body.length > 150 ? body.substring(0, 150) + '...' : body;
}

function selectEmail(emailId) {
  currentEmail = allEmails.find(e => e.id === emailId);
  if (!currentEmail) return;
  
  const readingPane = document.getElementById('readingPane');
  const emailView = document.getElementById('emailViewTemplate');
  const composeForm = document.getElementById('composeForm');
  const readingPaneActions = document.getElementById('readingPaneActions');
  
  // Show reading pane
  composeForm.classList.remove('active');
  readingPane.classList.remove('empty');
  emailView.classList.add('active');
  if (readingPaneActions) readingPaneActions.style.display = 'flex';
  
  // Populate email view
  document.getElementById('viewSubject').textContent = currentEmail.subject || '(No subject)';
  document.getElementById('viewFrom').textContent = currentEmail.from || '-';
  document.getElementById('viewTo').textContent = currentEmail.to || '-';
  document.getElementById('viewCC').textContent = currentEmail.cc || '-';
  document.getElementById('viewBCC').textContent = currentEmail.bcc || '-';
  document.getElementById('viewDate').textContent = new Date(currentEmail.created_at || currentEmail.sent_at).toLocaleString();
  
  const statusBadges = [];
  if (currentEmail.draft) statusBadges.push('Draft');
  if (currentEmail.inbound) statusBadges.push('Received');
  if (currentEmail.opened) statusBadges.push('Opened');
  if (currentEmail.replied) statusBadges.push('Replied');
  if (!currentEmail.inbound && !currentEmail.draft) statusBadges.push('Sent');
  document.getElementById('viewStatus').textContent = statusBadges.join(', ') || 'None';
  
  document.getElementById('viewBody').textContent = currentEmail.body || 'No content';
  
  // Show attachments
  const attachmentsSection = document.getElementById('viewAttachments');
  const attachmentsList = document.getElementById('attachmentsList');
  
  if (currentEmail.attachments && currentEmail.attachments.length > 0) {
    attachmentsList.innerHTML = currentEmail.attachments.map(att => `
      <div class="attachment-item">
        <span class="attachment-icon">üìé</span>
        <div class="attachment-info">
          <div class="attachment-name">${att.name || att.filename}</div>
          <div class="attachment-size">${formatFileSize(att.size || 0)}</div>
        </div>
        <button class="download-btn" onclick="downloadAttachment('${att.url}', '${att.name || att.filename}')">‚¨áÔ∏è Download</button>
      </div>
    `).join('');
    attachmentsSection.style.display = 'block';
  } else {
    attachmentsSection.style.display = 'none';
  }
  
  // Update list selection and mark as read
  renderEmailList();
  
  if (currentEmail.inbound && !currentEmail.opened) {
    markAsRead();
  }
}
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function downloadAttachment(url, filename) {
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.target = '_blank';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  showStatus('Downloading: ' + filename);
}

function getConversationContext() {
  if (!currentEmail) return '';
  
  // Get last 2 lines of conversation for context
  const body = currentEmail.body || '';
  const lines = body.split('\n').filter(line => line.trim());
  const lastTwoLines = lines.slice(-2).join('\n');
  
  return lastTwoLines ? `\n\nContext from previous message:\n${lastTwoLines}` : '';
}

function showComposeForm(replyTo = null, forwardFrom = null, replyAll = false) {
  const readingPane = document.getElementById('readingPane');
  const emailView = document.getElementById('emailViewTemplate');
  const composeForm = document.getElementById('composeForm');
  const readingPaneTitle = document.getElementById('readingPaneTitle');
  const readingPaneActions = document.getElementById('readingPaneActions');
  
  emailView.classList.remove('active');
  readingPane.classList.remove('empty');
  composeForm.classList.add('active');
  readingPaneActions.style.display = 'none';
  
  // Clear form
  document.getElementById('emailComposeForm').reset();
  document.getElementById('composeFrom').value = CUSTOMER_ID;
  attachedFiles = [];
  updateAttachmentDisplay();
  currentDraftId = null;
  
  // Hide CC/BCC fields
  document.getElementById('ccBccFields').classList.remove('active');
  
  // Ensure contacts datalist is populated
  if (contacts.length > 0) {
    const datalist = document.getElementById('contactsList');
    if (datalist && datalist.children.length === 0) {
      datalist.innerHTML = contacts.map(contact => {
        const email = contact.email || '';
        const name = contact.name || contact.first_name || '';
        const company = contact.company || '';
        const display = name ? `${name} <${email}>` : email;
        return `<option value="${email}">${display}${company ? ' - ' + company : ''}</option>`;
      }).join('');
    }
  }
  
  if (preloadedContact) {
    document.getElementById('composeTo').value = preloadedContact.email || '';
    document.getElementById('composeSubject').value = `Re: ${preloadedContact.company || preloadedContact.name}`;
    preloadedContact = null;
  }
  
  if (replyTo) {
    // Reply mode
    document.getElementById('composeTo').value = replyTo.from || '';
    document.getElementById('composeSubject').value = 'Re: ' + (replyTo.subject || '').replace(/^re:\s*/i, '');
    
    // IMPROVED TEMPLATE with company name and context
    const companyName = replyTo.from ? replyTo.from.split('@')[1].split('.')[0] : 'there';
    const context = getConversationContext();
    
    document.getElementById('composeBody').value = `\n\n${context}\n\n--- Original Message ---\nFrom: ${replyTo.from}\nDate: ${new Date(replyTo.created_at).toLocaleString()}\nSubject: ${replyTo.subject}\n\n${replyTo.body}`;
    readingPaneTitle.textContent = '‚Ü©Ô∏è Reply to Email';
    currentMode = 'reply';
    
    // REPLY ALL - add CC recipients
    if (replyAll && replyTo.cc) {
      document.getElementById('composeCC').value = replyTo.cc;
      toggleCCBCC();
    }
  } else if (forwardFrom) {
    // Forward mode
    document.getElementById('composeSubject').value = 'Fwd: ' + (forwardFrom.subject || '').replace(/^fwd:\s*/i, '');
    document.getElementById('composeBody').value = `\n\n--- Forwarded Message ---\nFrom: ${forwardFrom.from}\nDate: ${new Date(forwardFrom.created_at).toLocaleString()}\nSubject: ${forwardFrom.subject}\n\n${forwardFrom.body}`;
    readingPaneTitle.textContent = '‚û°Ô∏è Forward Email';
    currentMode = 'forward';
    
    if (forwardFrom.attachments && forwardFrom.attachments.length > 0) {
      attachedFiles = [...forwardFrom.attachments];
      updateAttachmentDisplay();
    }
  } else {
    // New compose mode
    document.getElementById('composeSubject').value = '';
    document.getElementById('composeBody').value = '';
    readingPaneTitle.textContent = '‚úâÔ∏è Compose New Email';
    currentMode = 'compose';
  }
  
  // AUTO-SIGNATURE - append signature to body
  applySignatureToBody();
}

function applySignatureToBody() {
  if (userSignature) {
    const bodyField = document.getElementById('composeBody');
    const currentBody = bodyField.value;
    
    // Only add signature if it's not already there
    if (!currentBody.includes(userSignature)) {
      bodyField.value = currentBody + '\n\n' + userSignature;
    }
  }
}

function toggleCCBCC() {
  const ccBccFields = document.getElementById('ccBccFields');
  ccBccFields.classList.toggle('active');
}

function replyToEmail() {
  if (currentEmail) {
    showComposeForm(currentEmail, null, false);
  }
}

function replyAllToEmail() {
  if (currentEmail) {
    showComposeForm(currentEmail, null, true);
  }
}

function forwardEmail() {
  if (currentEmail) {
    showComposeForm(null, currentEmail);
  }
}

function cancelCompose() {
  const readingPane = document.getElementById('readingPane');
  const emailView = document.getElementById('emailViewTemplate');
  const composeForm = document.getElementById('composeForm');
  
  composeForm.classList.remove('active');
  
  if (currentEmail) {
    emailView.classList.add('active');
    readingPane.classList.remove('empty');
  } else {
    emailView.classList.remove('active');
    readingPane.classList.add('empty');
  }
  
  currentMode = 'compose';
  currentDraftId = null;
}

async function sendEmail(event) {
  event.preventDefault();
  
  const emailData = {
    customer_id: CUSTOMER_ID,
    from: document.getElementById('composeFrom').value,
    to: document.getElementById('composeTo').value,
    cc: document.getElementById('composeCC').value || null,
    bcc: document.getElementById('composeBCC').value || null,
    subject: document.getElementById('composeSubject').value,
    body: document.getElementById('composeBody').value,
    attachments: attachedFiles,
    draft: false
  };
  
  try {
    const response = await fetch(ENDPOINTS.sendEmail, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(emailData)
    });
    
    if (response.ok) {
      showStatus('‚úÖ Email sent successfully!');
      
      // DELETE DRAFT WHEN SENT
      if (currentDraftId) {
        await deleteEmailById(currentDraftId);
        currentDraftId = null;
      }
      
      cancelCompose();
      await loadEmails();
    } else {
      showStatus('Failed to send email', true);
    }
  } catch (error) {
    console.error('Error sending email:', error);
    showStatus('Error sending email', true);
  }
}

async function saveDraft() {
  const draftData = {
    customer_id: CUSTOMER_ID,
    id: currentDraftId,
    from: document.getElementById('composeFrom').value,
    to: document.getElementById('composeTo').value,
    cc: document.getElementById('composeCC').value || null,
    bcc: document.getElementById('composeBCC').value || null,
    subject: document.getElementById('composeSubject').value,
    body: document.getElementById('composeBody').value,
    attachments: attachedFiles,
    draft: true
  };
  
  try {
    const response = await fetch(ENDPOINTS.saveDraft, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(draftData)
    });
    
    if (response.ok) {
      const result = await response.json();
      currentDraftId = result.draft_id;
      showStatus('üíæ Draft saved');
      await loadEmails();
    } else {
      showStatus('Failed to save draft', true);
    }
  } catch (error) {
    console.error('Error saving draft:', error);
    showStatus('Error saving draft', true);
  }
}

async function scheduleEmail() {
  const time = prompt('When should this email be sent? (YYYY-MM-DD HH:MM format)');
  if (!time) return;
  
  const emailData = {
    customer_id: CUSTOMER_ID,
    from: document.getElementById('composeFrom').value,
    to: document.getElementById('composeTo').value,
    cc: document.getElementById('composeCC').value || null,
    bcc: document.getElementById('composeBCC').value || null,
    subject: document.getElementById('composeSubject').value,
    body: document.getElementById('composeBody').value,
    attachments: attachedFiles,
    scheduled_time: time
  };
  
  try {
    const response = await fetch(ENDPOINTS.scheduleEmail, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(emailData)
    });
    
    if (response.ok) {
      showStatus('‚è∞ Email scheduled');
      cancelCompose();
      await loadEmails();
    } else {
      showStatus('Failed to schedule email', true);
    }
  } catch (error) {
    console.error('Error scheduling email:', error);
    showStatus('Error scheduling email', true);
  }
}

async function aiAssist(action) {
  const tone = document.getElementById('aiTone').value;
  if (!tone && action !== 'format') {
    showStatus('Please select an AI tone first', true);
    return;
  }
  
  const currentBody = document.getElementById('composeBody').value;
  const subject = document.getElementById('composeSubject').value;
  const recipient = document.getElementById('composeTo').value;
  
  const assistData = {
    action: action,
    tone: tone,
    subject: subject,
    body: currentBody,
    recipient: recipient,
    customer_id: CUSTOMER_ID
  };
  
  try {
    showStatus('ü§ñ AI is working...');
    const response = await fetch(ENDPOINTS.aiAssist, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(assistData)
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('AI Assist Response:', result); // Debug log
      
      // Handle both response formats from n8n
      const emailBody = result.email_body_plain || result.body || result.content || '';
      const emailSubject = result.email_subject || result.subject || '';
      
      if (action === 'generate') {
        document.getElementById('composeBody').value = emailBody;
        if (emailSubject) {
          document.getElementById('composeSubject').value = emailSubject;
        }
      } else if (action === 'improve' || action === 'format') {
        document.getElementById('composeBody').value = emailBody;
      }
      
      showStatus('‚ú® AI assistance applied!');
    } else {
      const errorText = await response.text();
      console.error('AI Assist failed:', errorText);
      showStatus('AI assistance failed', true);
    }
  } catch (error) {
    console.error('Error with AI assist:', error);
    showStatus('AI assistance error', true);
  }
}

  async function toggleAutoReply(enabled) {
  try {
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/emails/aireply', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ 
        customer_id: CUSTOMER_ID,
        aireply: enabled
      })
    });
    
    if (response.ok) {
      showStatus(enabled ? '‚úÖ Auto-Reply enabled!' : '‚è∏Ô∏è Auto-Reply disabled');
    } else {
      showStatus('Failed to update auto-reply', true);
      document.getElementById('autoReplyToggle').checked = !enabled;
    }
  } catch (error) {
    console.error('Error:', error);
    showStatus('Auto-reply error', true);
    document.getElementById('autoReplyToggle').checked = !enabled;
  }
}
  
async function markAsRead() {
  if (!currentEmail) return;
  
  try {
    await fetch(ENDPOINTS.markRead, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({
        customer_id: CUSTOMER_ID,
        email_id: currentEmail.id
      })
    });
    
    currentEmail.opened = true;
    await loadEmails();
  } catch (error) {
    console.error('Error marking as read:', error);
  }
}

async function deleteEmail() {
  if (!currentEmail) return;
  
  if (!confirm('Are you sure you want to delete this email?')) return;
  
  await deleteEmailById(currentEmail.id);
  
  currentEmail = null;
  cancelCompose();
  await loadEmails();
}

async function deleteEmailById(emailId) {
  try {
    await fetch(ENDPOINTS.deleteEmail, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({
        customer_id: CUSTOMER_ID,
        email_id: emailId
      })
    });
    
    showStatus('üóëÔ∏è Email deleted');
  } catch (error) {
    console.error('Error deleting email:', error);
    showStatus('Delete failed', true);
  }
}

async function refreshEmails() {
  showStatus('üîÑ Refreshing emails...');
  await loadEmails();
  showStatus('‚úÖ Emails refreshed');
}

function openEmailModal() {
  if (!currentEmail) return;
  
  const modalBody = document.getElementById('modalBody');
  modalBody.innerHTML = `
    <div class="field-group">
      <div class="field-label">Email ID</div>
      <div class="field-value">${currentEmail.id}</div>
    </div>
    <div class="field-group">
      <div class="field-label">From</div>
      <div class="field-value">${currentEmail.from || 'N/A'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">To</div>
      <div class="field-value">${currentEmail.to || 'N/A'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">CC</div>
      <div class="field-value">${currentEmail.cc || 'None'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">BCC</div>
      <div class="field-value">${currentEmail.bcc || 'None'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Subject</div>
      <div class="field-value">${currentEmail.subject || 'No subject'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Created</div>
      <div class="field-value">${currentEmail.created_at ? new Date(currentEmail.created_at).toLocaleString() : 'N/A'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Sent</div>
      <div class="field-value">${currentEmail.sent_at ? new Date(currentEmail.sent_at).toLocaleString() : 'Not sent'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Opened</div>
      <div class="field-value">${currentEmail.opened_at ? new Date(currentEmail.opened_at).toLocaleString() : 'Not opened'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Replied</div>
      <div class="field-value">${currentEmail.replied_at ? new Date(currentEmail.replied_at).toLocaleString() : 'Not replied'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Type</div>
      <div class="field-value">${currentEmail.inbound ? 'Inbound' : currentEmail.draft ? 'Draft' : 'Outbound'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Attachments</div>
      <div class="field-value">${currentEmail.attachments && currentEmail.attachments.length > 0 ? currentEmail.attachments.map(a => a.name).join(', ') : 'None'}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Body</div>
      <div class="field-value">${currentEmail.body || 'No content'}</div>
    </div>
  `;
  
  document.getElementById('emailModal').style.display = 'block';
}

function closeEmailModal() {
  document.getElementById('emailModal').style.display = 'none';
}

function filterModalContent() {
  const searchTerm = document.getElementById('modalSearch').value.toLowerCase();
  const fieldGroups = document.querySelectorAll('#modalBody .field-group');
  
  fieldGroups.forEach(group => {
    const text = group.textContent.toLowerCase();
    group.style.display = text.includes(searchTerm) ? 'block' : 'none';
  });
}

function editSignature() {
  document.getElementById('signatureText').value = userSignature;
  document.getElementById('signatureModal').style.display = 'block';
}

function closeSignatureModal() {
  document.getElementById('signatureModal').style.display = 'none';
}

function saveSignature() {
  userSignature = document.getElementById('signatureText').value;
  localStorage.setItem(`signature_${CUSTOMER_ID}`, userSignature);
  updateSignaturePreview();
  closeSignatureModal();
  showStatus('üíæ Signature saved');
}

function updateSignaturePreview() {
  const preview = document.getElementById('signaturePreview');
  preview.textContent = userSignature || 'No signature set';
}

function showFileSelector() {
  const fileListBody = document.getElementById('fileListBody');
  
  if (mediaFiles.length === 0) {
    fileListBody.innerHTML = '<div class="loading">No files available</div>';
  } else {
    fileListBody.innerHTML = mediaFiles.map(file => `
      <div class="file-item" data-file-id="${file.id}" onclick="toggleFileSelection('${file.id}')">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">${getFileIcon(file.type)}</span>
          <div style="flex: 1;">
            <div style="font-weight: 500;">${file.name}</div>
            <div style="font-size: 12px; color: #666;">${formatFileSize(file.size)} ‚Ä¢ ${file.type}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  document.getElementById('fileSelectorModal').style.display = 'block';
}

function closeFileSelector() {
  document.getElementById('fileSelectorModal').style.display = 'none';
  selectedFiles = [];
  document.querySelectorAll('.file-item').forEach(item => {
    item.classList.remove('selected');
  });
}

function toggleFileSelection(fileId) {
  const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
  const index = selectedFiles.indexOf(fileId);
  
  if (index > -1) {
    selectedFiles.splice(index, 1);
    fileItem.classList.remove('selected');
  } else {
    selectedFiles.push(fileId);
    fileItem.classList.add('selected');
  }
}

function attachSelectedFiles() {
  selectedFiles.forEach(fileId => {
    const file = mediaFiles.find(f => f.id === fileId);
    if (file && !attachedFiles.find(f => f.id === fileId)) {
      attachedFiles.push(file);
    }
  });
  
  updateAttachmentDisplay();
  closeFileSelector();
  showStatus(`üìé ${selectedFiles.length} file(s) attached`);
}

function handleFileUpload() {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.onchange = async (e) => {
    const files = Array.from(e.target.files);
    for (const file of files) {
      attachedFiles.push({
        id: 'upload_' + Date.now() + '_' + Math.random(),
        name: file.name,
        size: file.size,
        type: file.type,
        file: file
      });
    }
    updateAttachmentDisplay();
    showStatus(`üì§ ${files.length} file(s) uploaded`);
  };
  input.click();
}

function removeAttachment(fileId) {
  attachedFiles = attachedFiles.filter(f => f.id !== fileId);
  updateAttachmentDisplay();
}

function updateAttachmentDisplay() {
  const display = document.getElementById('attachmentDisplay');
  
  if (attachedFiles.length === 0) {
    display.innerHTML = '';
    return;
  }
  
  display.innerHTML = attachedFiles.map(file => `
    <div class="attachment-tag">
      <span>${getFileIcon(file.type)} ${file.name}</span>
      <button onclick="removeAttachment('${file.id}')">√ó</button>
    </div>
  `).join('');
}

function filterFileList() {
  const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
  const fileItems = document.querySelectorAll('.file-item');
  
  fileItems.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
  });
}

function getFileIcon(type) {
  if (!type) return 'üìÑ';
  if (type.startsWith('image/')) return 'üñºÔ∏è';
  if (type.startsWith('video/')) return 'üé•';
  if (type.startsWith('audio/')) return 'üéµ';
  if (type.includes('pdf')) return 'üìï';
  if (type.includes('word') || type.includes('document')) return 'üìò';
  if (type.includes('excel') || type.includes('spreadsheet')) return 'üìä';
  if (type.includes('powerpoint') || type.includes('presentation')) return 'üìä';
  return 'üìÑ';
}

function setupFileAttachmentDragDrop() {
  const composeBody = document.getElementById('composeBody');
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    composeBody.addEventListener(eventName, preventDefaults, false);
  });
  
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  ['dragenter', 'dragover'].forEach(eventName => {
    composeBody.addEventListener(eventName, () => {
      composeBody.style.background = '#e3f2fd';
    });
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    composeBody.addEventListener(eventName, () => {
      composeBody.style.background = '';
    });
  });
  
  composeBody.addEventListener('drop', async (e) => {
    const files = Array.from(e.dataTransfer.files);
    for (const file of files) {
      attachedFiles.push({
        id: 'drop_' + Date.now() + '_' + Math.random(),
        name: file.name,
        size: file.size,
        type: file.type,
        file: file
      });
    }
    updateAttachmentDisplay();
    showStatus(`üìé ${files.length} file(s) attached`);
  });
}

function startTour() {
  const intro = introJs();
  intro.setOptions({
    showProgress: true,
    showBullets: false,
    exitOnOverlayClick: false,
    doneLabel: 'Finish',
    nextLabel: 'Next ‚Üí',
    prevLabel: '‚Üê Back'
  });
  
  intro.oncomplete(() => {
    localStorage.setItem(`tour_completed_messages_${CUSTOMER_ID}`, 'true');
    showStatus('üéì Tour completed! You\'re ready to use Messages.');
  });
  
  intro.onexit(() => {
    localStorage.setItem(`tour_completed_messages_${CUSTOMER_ID}`, 'true');
  });
  
  intro.start();
}

function hasCompletedTour() {
  return localStorage.getItem(`tour_completed_messages_${CUSTOMER_ID}`) === 'true';
}

function setupEventListeners() {
  // Close modals when clicking outside - with delay to prevent instant close
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        setTimeout(() => {
          modal.style.display = 'none';
        }, 200);
      }
    });
  });
  
  setupFileAttachmentDragDrop();
}

// Victory Vision Chat Widget
class VictoryVisionChat {
  constructor() {
    this.isOpen = false;
    this.isTyping = false;
    this.apiEndpoint = ENDPOINTS.chatMessage;
    this.customerId = null;
    this.authToken = null;
    this.conversationId = null;
    this.messageCount = 0;
    this.init();
  }

  init() {
    this.toggle = document.getElementById('vvChatToggle');
    this.container = document.getElementById('vvChatContainer');
    this.messages = document.getElementById('vvChatMessages');
    this.input = document.getElementById('vvChatInput');
    this.sendBtn = document.getElementById('vvChatSend');
    this.minimize = document.getElementById('vvChatMinimize');
    this.typing = document.getElementById('vvChatTyping');
    this.error = document.getElementById('vvChatError');
    this.notification = document.getElementById('vvNotificationBadge');
    this.toggleIcon = document.getElementById('vvToggleIcon');

    this.setupEventListeners();
    this.getCustomerAuth();
    this.conversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    this.setupAutoResize();
  }

  setupEventListeners() {
    this.toggle.addEventListener('click', () => this.toggleChat());
    this.minimize.addEventListener('click', () => this.closeChat());
    this.sendBtn.addEventListener('click', () => this.sendMessage());
    this.input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.sendMessage();
      }
    });
    this.input.addEventListener('input', () => {
      this.sendBtn.disabled = !this.input.value.trim();
    });
  }

  setupAutoResize() {
    this.input.addEventListener('input', () => {
      this.input.style.height = 'auto';
      this.input.style.height = Math.min(this.input.scrollHeight, 80) + 'px';
    });
  }

  getCustomerAuth() {
    this.customerId = CUSTOMER_ID;
    this.authToken = authToken;
  }

  toggleChat() {
    if (this.isOpen) {
      this.closeChat();
    } else {
      this.openChat();
    }
  }

  openChat() {
    this.isOpen = true;
    this.container.classList.add('open');
    this.toggle.classList.add('active');
    this.toggleIcon.textContent = '‚úï';
    this.input.focus();
    this.hideNotification();
    this.scrollToBottom();
  }

  closeChat() {
    this.isOpen = false;
    this.container.classList.remove('open');
    this.toggle.classList.remove('active');
    this.toggleIcon.textContent = 'üí¨';
    this.hideError();
  }

  async sendMessage() {
    const message = this.input.value.trim();
    if (!message || this.isTyping) return;

    this.addMessage(message, 'user');
    this.input.value = '';
    this.input.style.height = 'auto';
    this.sendBtn.disabled = true;
    this.showTyping();

    try {
      const response = await this.callChatAPI(message);
      this.hideTyping();
      
      if (response && response.reply) {
        this.addMessage(response.reply, 'bot');
      } else {
        throw new Error('Invalid response format');
      }
    } catch (error) {
      this.hideTyping();
      console.error('Chat API error:', error);
      this.addMessage("I'm sorry, I'm having trouble connecting right now. Please try again in a moment.", 'bot');
      this.showError('Failed to send message. Please try again.');
    }
  }

  async callChatAPI(message) {
    const payload = {
      message: message,
      customer_id: this.customerId || 'anonymous',
      conversation_id: this.conversationId,
      timestamp: new Date().toISOString(),
      page_url: window.location.href,
      user_agent: navigator.userAgent
    };

    const headers = {
      'Content-Type': 'application/json',
      'X-Customer-ID': this.customerId || 'anonymous',
      'X-Conversation-ID': this.conversationId
    };

    if (this.authToken) {
      headers['Authorization'] = `Bearer ${this.authToken}`;
    }

    const response = await fetch(this.apiEndpoint, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    return await response.json();
  }

  addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `vv-chat-message ${sender}`;
    messageDiv.innerHTML = this.sanitizeText(text);
    this.messages.appendChild(messageDiv);
    this.scrollToBottom();
    this.messageCount++;
    setTimeout(() => this.scrollToBottom(), 100);
  }

  sanitizeText(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
  }

  showTyping() {
    this.isTyping = true;
    this.typing.classList.add('show');
    this.scrollToBottom();
  }

  hideTyping() {
    this.isTyping = false;
    this.typing.classList.remove('show');
  }

  showError(message) {
    this.error.textContent = message;
    this.error.style.display = 'block';
    setTimeout(() => this.hideError(), 5000);
  }

  hideError() {
    this.error.style.display = 'none';
  }

  showNotification() {
    this.notification.style.display = 'flex';
  }

  hideNotification() {
    this.notification.style.display = 'none';
  }

  scrollToBottom() {
    this.messages.scrollTop = this.messages.scrollHeight;
  }

  sendQuickMessage(message) {
    this.input.value = message;
    this.sendMessage();
  }
}

async function init() {
  try {
    const isAuthenticated = await checkAuthentication();
    
    if (!isAuthenticated) {
      console.log('Not authenticated, redirecting to login');
      redirectToLogin();
      return;
    }
    
    console.log('User authenticated, initializing page...');
    setupEventListeners();
    
    const contactData = sessionStorage.getItem('messageContact');
    if (contactData) {
      preloadedContact = JSON.parse(contactData);
      sessionStorage.removeItem('messageContact');
    }
    
    // Load all data
    await Promise.all([
      loadUserData(),
      loadContacts(),
      loadMediaFiles(),
      loadEmails()
    ]);
    
    console.log('Messages page loaded successfully');
    
    if (!hasCompletedTour()) {
      setTimeout(() => startTour(), 1000);
    }
    
    if (preloadedContact) {
      setTimeout(() => showComposeForm(), 500);
    }
  } catch (error) {
    console.error('Error initializing:', error);
    showStatus('Failed to initialize. Please refresh.', true);
  }
}

const VVChat = new VictoryVisionChat();
window.VVChat = VVChat;

// Session check every 5 minutes
setInterval(async function() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session || !session.user) {
      console.warn('Session expired during periodic check');
      redirectToLogin();
    } else {
      authToken = session.access_token;
      CUSTOMER_ID = session.user.email;
    }
  } catch (e) {
    console.error('Session check failed:', e);
  }
}, 300000);

// Check auth when page becomes visible again
document.addEventListener('visibilitychange', async function() {
  if (!document.hidden) {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session || !session.user) {
        redirectToLogin();
      } else {
        authToken = session.access_token;
        CUSTOMER_ID = session.user.email;
      }
    } catch (e) {
      console.error('Visibility auth check failed:', e);
    }
  }
});

window.selectEmail = selectEmail;
window.showComposeForm = showComposeForm;
window.replyToEmail = replyToEmail;
window.replyAllToEmail = replyAllToEmail;
window.forwardEmail = forwardEmail;
window.markAsRead = markAsRead;
window.deleteEmail = deleteEmail;
window.openEmailModal = openEmailModal;
window.closeEmailModal = closeEmailModal;
window.saveDraft = saveDraft;
window.scheduleEmail = scheduleEmail;
window.cancelCompose = cancelCompose;
window.aiAssist = aiAssist;
window.toggleAutoReply = toggleAutoReply;
window.refreshEmails = refreshEmails;
window.applyFilters = applyFilters;
window.clearFilters = clearFilters;
window.startTour = startTour;
window.toggleCCBCC = toggleCCBCC;
window.showFileSelector = showFileSelector;
window.closeFileSelector = closeFileSelector;
window.attachSelectedFiles = attachSelectedFiles;
window.handleFileUpload = handleFileUpload;
window.removeAttachment = removeAttachment;
window.editSignature = editSignature;
window.closeSignatureModal = closeSignatureModal;
window.saveSignature = saveSignature;
window.toggleFileSelection = toggleFileSelection;
window.downloadAttachment = downloadAttachment;
window.filterModalContent = filterModalContent;
window.filterFileList = filterFileList;

document.addEventListener('DOMContentLoaded', init);

setTimeout(() => {
  if (!VVChat.isOpen && VVChat.messageCount === 0) {
    VVChat.showNotification();
  }
}, 10000);

</script>

</body>
</html>
