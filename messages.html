<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Enhanced email communications - Victory Vision"/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision - Messages</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f2f1;
      height: 100vh;
      overflow: hidden;
    }

    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .navbar nav ul li {
      margin: 0 15px;
    }

    .navbar nav ul li a {
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .navbar nav ul li a:hover,
    .navbar nav ul li a.active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-weight: bold;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }

    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }

    .logo img {
      height: 45px;
      width: auto;
    }

    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 280px 420px 1fr;
      height: calc(100vh - 70px);
      background: white;
      overflow: hidden;
    }

    /* Left Sidebar */
    .sidebar {
      background: #faf9f8;
      border-right: 1px solid #edebe9;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #edebe9;
    }

    .compose-btn {
      width: 100%;
      background: #0078d4;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }

    .compose-btn:hover {
      background: #106ebe;
    }

    .folder-nav {
      flex: 1;
      padding: 10px 0;
    }

    .folder-item {
      display: flex;
      align-items: center;
      padding: 8px 20px;
      cursor: pointer;
      color: #323130;
      font-size: 14px;
      transition: background 0.2s;
      gap: 10px;
    }

    .folder-item:hover {
      background: #f3f2f1;
    }

    .folder-item.active {
      background: #deecf9;
      color: #0078d4;
      border-right: 3px solid #0078d4;
    }

    .folder-icon {
      width: 16px;
      text-align: center;
    }

    .folder-count {
      margin-left: auto;
      background: #0078d4;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Email List Panel */
    .email-list-panel {
      background: white;
      border-right: 1px solid #edebe9;
      display: flex;
      flex-direction: column;
    }

    .email-list-header {
      padding: 15px 20px;
      border-bottom: 1px solid #edebe9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .email-list-title {
      font-size: 18px;
      font-weight: 600;
      color: #323130;
    }

    .email-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      background: none;
      border: 1px solid #d1d1d1;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: #323130;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: #f3f2f1;
      border-color: #c8c6c4;
    }

    .search-filters {
      padding: 10px 20px;
      border-bottom: 1px solid #edebe9;
      background: #faf9f8;
    }

    .search-box {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d1d1;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .search-box:focus {
      outline: none;
      border-color: #0078d4;
    }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .filter-tag {
      background: #deecf9;
      color: #0078d4;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid #c7e0f4;
      transition: all 0.2s;
    }

    .filter-tag:hover {
      background: #c7e0f4;
    }

    .filter-tag.active {
      background: #0078d4;
      color: white;
    }

    /* Email List */
    .email-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: calc(100vh - 300px);
    }

    .email-item {
      display: flex;
      flex-direction: column;
      padding: 12px 20px;
      border-bottom: 1px solid #f3f2f1;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .email-item:hover {
      background: #f9f9f9;
    }

    .email-item.selected {
      background: #deecf9;
      border-left: 3px solid #0078d4;
    }

    .email-item.unread {
      background: #fff;
      font-weight: 600;
    }

    .email-item.unread::before {
      content: '';
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      background: #0078d4;
      border-radius: 50%;
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .email-sender {
      font-size: 14px;
      color: #323130;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .email-time {
      font-size: 12px;
      color: #605e5c;
      flex-shrink: 0;
    }

    .email-subject {
      font-size: 13px;
      color: #323130;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .email-preview {
      font-size: 12px;
      color: #605e5c;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .email-status {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .status-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.delivered {
      background: #28a745;
      color: white;
    }

    .status-badge.opened {
      background: #17a2b8;
      color: white;
    }

    .status-badge.clicked {
      background: #ffc107;
      color: #333;
    }

    .status-badge.replied {
      background: #6f42c1;
      color: white;
    }

    .status-badge.draft {
      background: #dc3545;
      color: white;
    }

    /* Reading Pane */
    .reading-pane {
      background: white;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      max-height: calc(100vh - 70px);
    }

    .reading-header {
      padding: 20px 30px;
      border-bottom: 1px solid #edebe9;
      background: #faf9f8;
    }

    .reading-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .reading-btn {
      background: white;
      border: 1px solid #d1d1d1;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      color: #323130;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .reading-btn:hover {
      background: #f3f2f1;
    }

    .reading-btn.primary {
      background: #0078d4;
      color: white;
      border-color: #0078d4;
    }

    .reading-btn.primary:hover {
      background: #106ebe;
    }

    .email-subject-display {
      font-size: 20px;
      font-weight: 600;
      color: #323130;
      margin-bottom: 10px;
    }

    .email-meta {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 8px 15px;
      font-size: 13px;
    }

    .meta-label {
      color: #605e5c;
      font-weight: 500;
    }

    .meta-value {
      color: #323130;
    }

    /* Tracking display */
    .tracking-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border: 1px solid #e9ecef;
    }

    .tracking-title {
      font-weight: 600;
      color: #495057;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tracking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .tracking-item {
      background: white;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }

    .tracking-label {
      font-size: 11px;
      color: #6c757d;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .tracking-value {
      font-size: 13px;
      color: #495057;
      font-weight: 500;
    }

    .tracking-value.positive {
      color: #28a745;
    }

    .tracking-value.negative {
      color: #dc3545;
    }

    .email-body-container {
      flex: 1;
      padding: 30px;
    }

    .email-body {
      line-height: 1.6;
      color: #323130;
      white-space: pre-wrap;
      font-size: 14px;
      min-height: 200px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }

    .email-body img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin: 10px 0;
    }

    /* Compose Form */
    .compose-form {
      background: white;
      height: 100%;
      display: none;
      flex-direction: column;
    }

    .compose-form.active {
      display: flex;
    }

    .compose-header {
      padding: 20px 30px;
      border-bottom: 1px solid #edebe9;
      background: #faf9f8;
    }

    .compose-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .compose-fields {
      padding: 0 30px;
      border-bottom: 1px solid #edebe9;
    }

    .compose-field {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f2f1;
    }

    .field-label {
      width: 80px;
      font-size: 14px;
      color: #605e5c;
      font-weight: 500;
    }

    .field-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      color: #323130;
      padding: 4px 8px;
    }

    .field-input:focus {
      background: #f9f9f9;
      border-radius: 2px;
    }

    .to-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .email-tag {
      background: #deecf9;
      color: #0078d4;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .remove-tag {
      cursor: pointer;
      font-weight: bold;
    }

    .compose-body-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .compose-body {
      flex: 1;
      border: none;
      outline: none;
      padding: 30px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.6;
      resize: none;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #605e5c;
      text-align: center;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #323130;
    }

    .empty-subtitle {
      font-size: 14px;
    }

    /* Status Messages */
    .status-message {
      position: fixed;
      top: 80px;
      right: 20px;
      max-width: 400px;
      padding: 12px 16px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 3000;
      display: none;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .status-success {
      background: #dff6dd;
      color: #107c10;
      border: 1px solid #92c5f7;
    }

    .status-error {
      background: #fde7e9;
      color: #a80000;
      border: 1px solid #fdb9c3;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-container {
        grid-template-columns: 250px 1fr;
      }
      
      .email-list-panel {
        display: none;
      }
      
      .email-list-panel.show-mobile {
        display: flex;
      }
      
      .reading-pane {
        display: none;
      }
      
      .reading-pane.show-mobile {
        display: flex;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
      <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>
      <li><a href="contacts">Contacts</a></li>
      <li><a href="messages" class="active">Messages</a></li>
      <li><a href="ads">Ads</a></li>
      <li><a href="settings">Settings</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <button onclick="startTour()" style="background: #28a745; padding: 6px 12px; font-size: 11px; margin-left: 10px;" id="tourButton">
      📖 Tour
    </button>
    <div id="subscriptionMedallion" class="subscription-medallion">
      <span class="plan-name">Bronze</span>
    </div>
  </div>
</header>

<div class="main-container">
  <!-- Left Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <button class="compose-btn" onclick="showCompose()">
        ✏️ New Message
      </button>
    </div>
    
    <div class="folder-nav">
      <div class="folder-item active" onclick="selectFolder('inbox')" data-folder="inbox">
        <span class="folder-icon">📥</span>
        <span>Inbox</span>
        <span class="folder-count" id="inboxCount">0</span>
      </div>
      <div class="folder-item" onclick="selectFolder('sent')" data-folder="sent">
        <span class="folder-icon">📤</span>
        <span>Sent Items</span>
        <span class="folder-count" id="sentCount">0</span>
      </div>
      <div class="folder-item" onclick="selectFolder('drafts')" data-folder="drafts">
        <span class="folder-icon">📝</span>
        <span>Drafts</span>
        <span class="folder-count" id="draftsCount">0</span>
      </div>
      <div class="folder-item" onclick="selectFolder('delivered')" data-folder="delivered">
        <span class="folder-icon">📫</span>
        <span>Delivered</span>
        <span class="folder-count" id="deliveredCount">0</span>
      </div>
      <div class="folder-item" onclick="selectFolder('opened')" data-folder="opened">
        <span class="folder-icon">👁️</span>
        <span>Opened</span>
        <span class="folder-count" id="openedCount">0</span>
      </div>
      <div class="folder-item" onclick="selectFolder('clicked')" data-folder="clicked">
        <span class="folder-icon">🖱️</span>
        <span>Clicked</span>
        <span class="folder-count" id="clickedCount">0</span>
      </div>
      <div class="folder-item" onclick="selectFolder('all')" data-folder="all">
        <span class="folder-icon">📊</span>
        <span>All Mail</span>
        <span class="folder-count" id="allCount">0</span>
      </div>
    </div>
  </div>

  <!-- Email List Panel -->
  <div class="email-list-panel">
    <div class="email-list-header">
      <h1 class="email-list-title" id="folderTitle">Inbox</h1>
      <div class="email-actions">
        <button class="action-btn" onclick="refreshEmails()">🔄</button>
        <button class="action-btn" onclick="markAllRead()">✓ All</button>
      </div>
    </div>

    <div class="search-filters">
      <input type="text" class="search-box" id="emailSearch" placeholder="Search emails..." onkeyup="searchEmails()">
      <div class="filter-tags" id="filterTags">
        <!-- Dynamic contact tags will be populated here -->
      </div>
    </div>

    <div class="email-list" id="emailList">
      <div style="text-align: center; padding: 40px; color: #605e5c;">
        Loading emails...
      </div>
    </div>
  </div>

  <!-- Reading Pane -->
  <div class="reading-pane" id="readingPane">
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">📧</div>
      <div class="empty-title">Select an email to read</div>
      <div class="empty-subtitle">Choose a message from your inbox to view it here</div>
    </div>

    <!-- Email View -->
    <div id="emailView" style="display: none; height: 100%; flex-direction: column;">
      <div class="reading-header">
        <div class="reading-actions">
          <button class="reading-btn primary" onclick="replyToEmail()">
            ↩️ Reply
          </button>
          <button class="reading-btn" onclick="forwardEmail()">
            ➡️ Forward
          </button>
          <button class="reading-btn" onclick="deleteCurrentEmail()">
            🗑️ Delete
          </button>
          <button class="reading-btn" onclick="markAsRead()">
            ✓ Mark Read
          </button>
        </div>
        
        <div class="email-subject-display" id="emailSubject"></div>
        
        <div class="email-meta">
          <span class="meta-label">To:</span>
          <span class="meta-value" id="emailTo"></span>
          <span class="meta-label">Date:</span>
          <span class="meta-value" id="emailDate"></span>
        </div>

        <!-- Enhanced Tracking Section -->
        <div class="tracking-section">
          <div class="tracking-title">
            📊 Email Tracking
          </div>
          <div class="tracking-grid">
            <div class="tracking-item">
              <div class="tracking-label">Delivered</div>
              <div class="tracking-value" id="emailDelivered">Not delivered</div>
            </div>
            <div class="tracking-item">
              <div class="tracking-label">Opened</div>
              <div class="tracking-value" id="emailOpened">Not opened</div>
            </div>
            <div class="tracking-item">
              <div class="tracking-label">Clicked</div>
              <div class="tracking-value" id="emailClicked">No clicks</div>
            </div>
            <div class="tracking-item">
              <div class="tracking-label">Replied</div>
              <div class="tracking-value" id="emailReplied">No reply</div>
            </div>
          </div>
        </div>
      </div>

      <div class="email-body-container">
        <div class="email-body" id="emailBody"></div>
      </div>
    </div>

    <!-- Compose Form -->
    <div class="compose-form" id="composeForm">
      <div class="compose-header">
        <div class="compose-actions">
          <button class="reading-btn primary" onclick="sendEmail()">📤 Send</button>
          <button class="reading-btn" onclick="saveDraft()">💾 Save Draft</button>
          <button class="reading-btn" onclick="cancelCompose()">❌ Cancel</button>
        </div>
      </div>

      <div class="compose-fields">
        <div class="compose-field">
          <span class="field-label">From:</span>
          <input type="email" class="field-input" id="composeFrom" readonly>
        </div>
        <div class="compose-field">
          <span class="field-label">To:</span>
          <div class="to-input-container">
            <div id="selectedEmails"></div>
            <input type="text" class="field-input" id="composeToInput" placeholder="Enter email addresses...">
          </div>
        </div>
        <div class="compose-field">
          <span class="field-label">Subject:</span>
          <input type="text" class="field-input" id="composeSubject" placeholder="Email subject...">
        </div>
      </div>

      <div class="compose-body-container">
        <textarea class="compose-body" id="composeBody" placeholder="Write your message here..."></textarea>
      </div>
    </div>
  </div>
</div>

<!-- Status Message -->
<div id="statusMessage" class="status-message"></div>

<script>
// Supabase configuration
const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// API endpoints
const ENDPOINTS = {
  getUserData: 'https://victoryvision.app.n8n.cloud/webhook/user/get',
  getEmails: 'https://victoryvision.app.n8n.cloud/webhook/emails/get',
  getContacts: 'https://victoryvision.app.n8n.cloud/webhook/contacts/get',
  sendEmail: 'https://victoryvision.app.n8n.cloud/webhook/emails/send',
  deleteEmail: 'https://victoryvision.app.n8n.cloud/webhook/emails/delete',
  markAsRead: 'https://victoryvision.app.n8n.cloud/webhook/emails/mark-read'
};

// Global variables
let CUSTOMER_ID = null;
let authToken = null;
let allEmails = [];
let filteredEmails = [];
let allContacts = [];
let selectedEmail = null;
let currentFolder = 'inbox';
let selectedEmailAddresses = [];
let userData = null;

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const isAuthenticated = await checkAuthentication();
    if (isAuthenticated) {
      await Promise.all([
        loadUserData(),
        loadContacts(),
        loadEmails()
      ]);
    } else {
      redirectToLogin();
    }
  } catch (error) {
    console.error('Initialization failed:', error);
    showStatus('Failed to initialize. Please refresh the page.', true);
  }
});

// Authentication
async function checkAuthentication() {
  try {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    if (error) throw error;
    
    if (session?.user) {
      CUSTOMER_ID = session.user.email;
      authToken = session.access_token;
      document.getElementById('userEmail').textContent = CUSTOMER_ID;
      return true;
    }
    return false;
  } catch (e) {
    console.error('Auth error:', e);
    return false;
  }
}

function redirectToLogin() {
  localStorage.removeItem('vv_session');
  window.location.href = 'login.html';
}

// API calls
async function apiCall(endpoint, data = {}) {
  try {
    const url = endpoint.includes('/user/get') ? 
      `${endpoint}?customer_id=${encodeURIComponent(CUSTOMER_ID)}` : 
      endpoint;
    
    const requestOptions = {
      method: endpoint.includes('/user/get') ? 'GET' : 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Customer-ID': CUSTOMER_ID,
        'Authorization': authToken ? `Bearer ${authToken}` : ''
      }
    };

    if (!endpoint.includes('/user/get')) {
      requestOptions.body = JSON.stringify({
        customer_id: CUSTOMER_ID,
        ...data
      });
    }

    const response = await fetch(url, requestOptions);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}

// Load user data
async function loadUserData() {
  try {
    const response = await apiCall(ENDPOINTS.getUserData);
    userData = Array.isArray(response) ? response[0] : response;
    
    // Update subscription medallion
    const medallion = document.getElementById('subscriptionMedallion');
    const plan = userData.subscription_plan || 'Bronze';
    medallion.className = `subscription-medallion ${plan.toLowerCase()}`;
    medallion.querySelector('.plan-name').textContent = plan;
    
    // Set compose from email
    const fromEmail = userData.vv_email || userData.email || CUSTOMER_ID;
    document.getElementById('composeFrom').value = fromEmail;
    
  } catch (error) {
    console.error('Error loading user data:', error);
  }
}

// Load contacts
async function loadContacts() {
  try {
    const data = await apiCall(ENDPOINTS.getContacts);
    allContacts = Array.isArray(data) ? data : (data.contacts || []);
    console.log(`Loaded ${allContacts.length} contacts`);
    generateContactTags();
  } catch (error) {
    console.error('Error loading contacts:', error);
    allContacts = [];
  }
}

// Load emails using CORRECT database field names
async function loadEmails() {
  try {
    const data = await apiCall(ENDPOINTS.getEmails);
    allEmails = Array.isArray(data) ? data : (data.emails || []);
    
    // DEBUG: Log the actual data structure
    console.log('DEBUG: Raw API response:', data);
    if (allEmails.length > 0) {
      console.log('DEBUG: First email:', allEmails[0]);
      console.log('DEBUG: Email fields:', Object.keys(allEmails[0]));
      console.log('DEBUG: subject value:', allEmails[0].subject);
      console.log('DEBUG: body value:', allEmails[0].body);
      console.log('DEBUG: from value:', allEmails[0].from);
      console.log('DEBUG: to value:', allEmails[0].to);
    }
    
    // Sort by date
    allEmails.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    updateFolderCounts();
    filterEmailsByFolder(currentFolder);
    
    console.log(`Loaded ${allEmails.length} emails`);
  } catch (error) {
    console.error('Error loading emails:', error);
    allEmails = [];
    renderEmailList();
  }
}

// Generate contact tags
function generateContactTags() {
  const contactTags = new Set();
  
  allContacts.forEach(contact => {
    if (contact.tags) {
      const tags = Array.isArray(contact.tags) ? contact.tags : contact.tags.split(',');
      tags.forEach(tag => {
        if (tag.trim()) contactTags.add(tag.trim());
      });
    }
  });
  
  const filterTags = document.getElementById('filterTags');
  filterTags.innerHTML = '';
  
  [...contactTags].slice(0, 12).forEach(tag => {
    const tagEl = document.createElement('div');
    tagEl.className = 'filter-tag';
    tagEl.textContent = tag;
    tagEl.onclick = () => filterByTag(tag);
    filterTags.appendChild(tagEl);
  });
}

// Update folder counts using CORRECT field names
function updateFolderCounts() {
  const inboxEmails = allEmails.filter(email => {
    const isInbound = email.from !== (userData?.vv_email);
    return isInbound && !email.opened_at;
  });
  
  const sentEmails = allEmails.filter(email => {
    const isOutbound = email.from === (userData?.vv_email);
    return isOutbound && email.body && email.sent_at;
  });
  
  const draftEmails = allEmails.filter(email => !email.sent_at || !email.body);
  const deliveredEmails = allEmails.filter(email => email.delivered_at);
  const openedEmails = allEmails.filter(email => email.opened_at);
  const clickedEmails = allEmails.filter(email => email.clicked_at);
  
  document.getElementById('inboxCount').textContent = inboxEmails.length;
  document.getElementById('sentCount').textContent = sentEmails.length;
  document.getElementById('draftsCount').textContent = draftEmails.length;
  document.getElementById('deliveredCount').textContent = deliveredEmails.length;
  document.getElementById('openedCount').textContent = openedEmails.length;
  document.getElementById('clickedCount').textContent = clickedEmails.length;
  document.getElementById('allCount').textContent = allEmails.length;
}

// Enhanced folder filtering using CORRECT field names
function filterEmailsByFolder(folder) {
  currentFolder = folder;
  
  // Update active folder
  document.querySelectorAll('.folder-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-folder="${folder}"]`).classList.add('active');
  
  switch (folder) {
    case 'inbox':
      filteredEmails = allEmails.filter(email => {
        const isInbound = email.from !== (userData?.vv_email);
        return isInbound;
      });
      document.getElementById('folderTitle').textContent = 'Inbox';
      break;
    case 'sent':
      filteredEmails = allEmails.filter(email => {
        const isOutbound = email.from === (userData?.vv_email);
        return isOutbound && email.body && email.sent_at;
      });
      document.getElementById('folderTitle').textContent = 'Sent Items';
      break;
    case 'drafts':
      filteredEmails = allEmails.filter(email => !email.sent_at || !email.body);
      document.getElementById('folderTitle').textContent = 'Drafts';
      break;
    case 'delivered':
      filteredEmails = allEmails.filter(email => email.delivered_at);
      document.getElementById('folderTitle').textContent = 'Delivered Emails';
      break;
    case 'opened':
      filteredEmails = allEmails.filter(email => email.opened_at);
      document.getElementById('folderTitle').textContent = 'Opened Emails';
      break;
    case 'clicked':
      filteredEmails = allEmails.filter(email => email.clicked_at);
      document.getElementById('folderTitle').textContent = 'Clicked Emails';
      break;
    case 'all':
      filteredEmails = [...allEmails];
      document.getElementById('folderTitle').textContent = 'All Mail';
      break;
  }
  
  renderEmailList();
}

// Render email list using CORRECT field names
function renderEmailList() {
  const emailList = document.getElementById('emailList');
  
  if (filteredEmails.length === 0) {
    emailList.innerHTML = `<div style="text-align: center; padding: 40px; color: #605e5c;">No emails found</div>`;
    return;
  }
  
  emailList.innerHTML = '';
  
  filteredEmails.forEach((email) => {
    const isSelected = selectedEmail && selectedEmail.id === email.id;
    const isInbound = email.from !== (userData?.vv_email);
    const isUnread = !email.opened_at && isInbound;
    const sender = isInbound ? (email.from || 'Unknown') : (email.to || 'Unknown');
    
    const emailDiv = document.createElement('div');
    emailDiv.className = `email-item ${isSelected ? 'selected' : ''} ${isUnread ? 'unread' : ''}`;
    emailDiv.onclick = () => selectEmail(email.id);
    
    // Create status badges
    const statusBadges = [];
    if (email.delivered_at) statusBadges.push('<span class="status-badge delivered">Delivered</span>');
    if (email.opened_at) statusBadges.push('<span class="status-badge opened">Opened</span>');
    if (email.clicked_at) statusBadges.push('<span class="status-badge clicked">Clicked</span>');
    if (email.replied_at) statusBadges.push('<span class="status-badge replied">Replied</span>');
    if (!email.sent_at || !email.body) statusBadges.push('<span class="status-badge draft">Draft</span>');
    
    emailDiv.innerHTML = `
      <div class="email-header">
        <div class="email-sender">${sender}</div>
        <div class="email-time">${formatDateShort(email.created_at)}</div>
      </div>
      <div class="email-subject">${email.subject || 'No Subject'}</div>
      <div class="email-preview">${getEmailPreview(email.body)}</div>
      <div class="email-status">
        ${statusBadges.join('')}
      </div>
    `;
    
    emailList.appendChild(emailDiv);
  });
}

// Select and display email using CORRECT field names
async function selectEmail(emailId) {
  const email = allEmails.find(e => e.id === emailId);
  if (!email) return;
  
  selectedEmail = email;
  
  // Update selection in list
  document.querySelectorAll('.email-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  event.target.closest('.email-item').classList.add('selected');
  
  // Show email view
  showEmailView(email);
  
  // Mark as read if unread
  if (!email.opened_at && email.from !== (userData?.vv_email)) {
    try {
      await apiCall(ENDPOINTS.markAsRead, { email_id: emailId });
      email.opened_at = new Date().toISOString();
      updateFolderCounts();
      renderEmailList();
    } catch (error) {
      console.error('Error marking as read:', error);
    }
  }
}

// Show email view using CORRECT field names
function showEmailView(email) {
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('emailView').style.display = 'flex';
  document.getElementById('composeForm').classList.remove('active');
  
  // Populate email details
  document.getElementById('emailSubject').textContent = email.subject || 'No Subject';
  document.getElementById('emailTo').textContent = email.to || 'Unknown';
  document.getElementById('emailDate').textContent = formatDateFull(email.created_at);
  
  // Enhanced tracking display
  document.getElementById('emailDelivered').textContent = email.delivered_at ? 
    formatDateFull(email.delivered_at) : 'Not delivered';
  document.getElementById('emailDelivered').className = email.delivered_at ? 
    'tracking-value positive' : 'tracking-value negative';
    
  document.getElementById('emailOpened').textContent = email.opened_at ? 
    formatDateFull(email.opened_at) : 'Not opened';
  document.getElementById('emailOpened').className = email.opened_at ? 
    'tracking-value positive' : 'tracking-value negative';
    
  document.getElementById('emailClicked').textContent = email.clicked_at ? 
    formatDateFull(email.clicked_at) : 'No clicks';
  document.getElementById('emailClicked').className = email.clicked_at ? 
    'tracking-value positive' : 'tracking-value negative';
    
  document.getElementById('emailReplied').textContent = email.replied_at ? 
    formatDateFull(email.replied_at) : 'No reply';
  document.getElementById('emailReplied').className = email.replied_at ? 
    'tracking-value positive' : 'tracking-value negative';
  
  // Handle email body
  const emailBody = document.getElementById('emailBody');
  let bodyContent = email.body || 'No content';
  
  // Simple image detection and embedding
  const imageRegex = /(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|bmp|webp))/gi;
  bodyContent = bodyContent.replace(imageRegex, '<img src="$1" alt="Email Image" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 4px;">');
  
  emailBody.innerHTML = bodyContent;
}

// Show compose form using CORRECT field names
function showCompose(replyTo = null, forward = null) {
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('emailView').style.display = 'none';
  document.getElementById('composeForm').classList.add('active');
  
  // Clear form
  document.getElementById('composeToInput').value = '';
  document.getElementById('composeSubject').value = '';
  document.getElementById('composeBody').value = '';
  selectedEmailAddresses = [];
  updateSelectedEmails();
  
  if (replyTo) {
    // Reply mode
    selectedEmailAddresses = [replyTo.from];
    updateSelectedEmails();
    document.getElementById('composeSubject').value = 'Re: ' + (replyTo.subject || '').replace(/^re:\s*/i, '');
    document.getElementById('composeBody').value = `\n\n--- Original Message ---\nFrom: ${replyTo.from}\nDate: ${formatDateFull(replyTo.created_at)}\nSubject: ${replyTo.subject}\n\n${replyTo.body}`;
  } else if (forward) {
    // Forward mode
    document.getElementById('composeSubject').value = 'Fwd: ' + (forward.subject || '').replace(/^fwd?:\s*/i, '');
    document.getElementById('composeBody').value = `\n\n--- Forwarded Message ---\nFrom: ${forward.from}\nTo: ${forward.to}\nDate: ${formatDateFull(forward.created_at)}\nSubject: ${forward.subject}\n\n${forward.body}`;
  }
}

// Search emails using CORRECT field names
function searchEmails() {
  const query = document.getElementById('emailSearch').value.toLowerCase();
  
  if (!query) {
    filterEmailsByFolder(currentFolder);
    return;
  }
  
  filteredEmails = filteredEmails.filter(email => {
    const searchText = `${email.from || ''} ${email.to || ''} ${email.subject || ''} ${email.body || ''}`.toLowerCase();
    return searchText.includes(query);
  });
  
  renderEmailList();
}

// Filter emails by tag using CORRECT field names
function filterByTag(tag) {
  const tagElement = event.target;
  tagElement.classList.toggle('active');
  
  if (tagElement.classList.contains('active')) {
    const contactsWithTag = allContacts.filter(contact => {
      if (contact.tags) {
        const tags = Array.isArray(contact.tags) ? contact.tags : contact.tags.split(',');
        return tags.some(t => t.trim() === tag);
      }
      return false;
    });
    
    const contactEmails = contactsWithTag.map(c => c.email).filter(Boolean);
    
    filteredEmails = filteredEmails.filter(email => {
      return contactEmails.includes(email.from) || contactEmails.includes(email.to);
    });
  } else {
    filterEmailsByFolder(currentFolder);
  }
  
  renderEmailList();
}

// Email composition functions
function updateSelectedEmails() {
  const container = document.getElementById('selectedEmails');
  container.innerHTML = selectedEmailAddresses.map((email, index) => `
    <div class="email-tag">
      ${email}
      <span class="remove-tag" onclick="removeEmailAddress(${index})">×</span>
    </div>
  `).join('');
}

function removeEmailAddress(index) {
  selectedEmailAddresses.splice(index, 1);
  updateSelectedEmails();
}

// Enhanced email sending using CORRECT field names
async function sendEmail() {
  const recipients = selectedEmailAddresses.join(', ');
  const subject = document.getElementById('composeSubject').value;
  const body = document.getElementById('composeBody').value;
  
  if (!recipients || !subject || !body) {
    showStatus('Please fill in all required fields', true);
    return;
  }
  
  try {
    const emailData = {
      to_email: recipients,
      subject: subject,
      body: body,
      campaign: 'Direct Message'
    };

    await apiCall(ENDPOINTS.sendEmail, emailData);
    
    showStatus('Email sent successfully!', false);
    cancelCompose();
    await loadEmails();
  } catch (error) {
    console.error('Error sending email:', error);
    showStatus('Error sending email: ' + error.message, true);
  }
}

function cancelCompose() {
  document.getElementById('composeForm').classList.remove('active');
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('emailView').style.display = 'none';
}

function replyToEmail() {
  if (selectedEmail) {
    showCompose(selectedEmail);
  }
}

function forwardEmail() {
  if (selectedEmail) {
    showCompose(null, selectedEmail);
  }
}

async function deleteCurrentEmail() {
  if (!selectedEmail) return;
  
  if (!confirm('Are you sure you want to delete this email?')) return;
  
  try {
    await apiCall(ENDPOINTS.deleteEmail, { email_id: selectedEmail.id });
    
    allEmails = allEmails.filter(e => e.id !== selectedEmail.id);
    filteredEmails = filteredEmails.filter(e => e.id !== selectedEmail.id);
    
    selectedEmail = null;
    document.getElementById('emptyState').style.display = 'flex';
    document.getElementById('emailView').style.display = 'none';
    
    updateFolderCounts();
    renderEmailList();
    showStatus('Email deleted successfully', false);
  } catch (error) {
    console.error('Error deleting email:', error);
    showStatus('Error deleting email', true);
  }
}

async function markAsRead() {
  if (selectedEmail && !selectedEmail.opened_at) {
    try {
      await apiCall(ENDPOINTS.markAsRead, { email_id: selectedEmail.id });
      selectedEmail.opened_at = new Date().toISOString();
      updateFolderCounts();
      renderEmailList();
      showStatus('Email marked as read', false);
    } catch (error) {
      console.error('Error marking as read:', error);
      showStatus('Error marking email as read', true);
    }
  }
}

async function markAllRead() {
  const unreadEmails = filteredEmails.filter(email => !email.opened_at && email.from !== (userData?.vv_email));
  
  if (unreadEmails.length === 0) {
    showStatus('No unread emails to mark', false);
    return;
  }
  
  if (!confirm(`Mark ${unreadEmails.length} emails as read?`)) return;
  
  try {
    for (const email of unreadEmails) {
      await apiCall(ENDPOINTS.markAsRead, { email_id: email.id });
      email.opened_at = new Date().toISOString();
    }
    
    updateFolderCounts();
    renderEmailList();
    showStatus(`${unreadEmails.length} emails marked as read`, false);
  } catch (error) {
    console.error('Error marking emails as read:', error);
    showStatus('Error marking emails as read', true);
  }
}

async function refreshEmails() {
  await loadEmails();
  showStatus('Emails refreshed', false);
}

function saveDraft() {
  showStatus('Draft saving not implemented yet', false);
}

function startTour() {
  showStatus('Tour feature not implemented yet', false);
}

function showStatus(message, isError = false) {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.textContent = message;
  statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
  statusDiv.style.display = 'block';
  setTimeout(() => statusDiv.style.display = 'none', 5000);
}

// Utility functions
function formatDateShort(dateStr) {
  if (!dateStr) return 'Unknown';
  
  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = Math.abs(now - date);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return date.toLocaleDateString();
}

function formatDateFull(dateStr) {
  if (!dateStr) return 'Unknown';
  
  const date = new Date(dateStr);
  return date.toLocaleString([], {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function getEmailPreview(body) {
  if (!body) return 'No content';
  return body.length > 100 ? body.substring(0, 100) + '...' : body;
}

// Global functions for onclick handlers
window.selectFolder = filterEmailsByFolder;
window.selectEmail = selectEmail;
window.showCompose = showCompose;
window.sendEmail = sendEmail;
window.saveDraft = saveDraft;
window.cancelCompose = cancelCompose;
window.replyToEmail = replyToEmail;
window.forwardEmail = forwardEmail;
window.deleteCurrentEmail = deleteCurrentEmail;
window.markAsRead = markAsRead;
window.markAllRead = markAllRead;
window.refreshEmails = refreshEmails;
window.searchEmails = searchEmails;
window.filterByTag = filterByTag;
window.removeEmailAddress = removeEmailAddress;
window.startTour = startTour;

</script>
</body>
</html>
