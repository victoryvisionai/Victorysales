<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Manage your contacts and generate new prospects."/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Contacts</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="icon" href="data:," />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .navbar nav ul li {
      margin: 0 10px;
    }
    .navbar nav ul li a {
      color: white;
      text-decoration: none;
    }
    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      position: relative;
      border: none;
      transition: all 0.3s ease;
    }
    .subscription-medallion.bronze {
      background: linear-gradient(45deg, #CD7F32, #A0522D);
    }
    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }
    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }
    .subscription-medallion:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }
    .content {
      padding: 20px 4px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .page-header {
      margin-bottom: 30px;
    }
    .page-title {
      font-size: 2.5rem;
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      font-size: 1.1rem;
      color: #666;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
      border-radius: 8px 8px 0 0;
    }
    .linkedin-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    .generate-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      display: block;
      margin: 20px auto;
    }
    .generate-btn:hover {
      background: linear-gradient(135deg, #218838, #1e7e34);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .generate-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    button {
      background: #0A3161;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 2px;
    }
    button:hover {
      background: #083050;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    .filter-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
      margin-bottom: 20px;
    }
    .bulk-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .table-container {
      overflow-x: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .contacts-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }
    .contacts-table th,
    .contacts-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
      font-size: 13px;
    }
    .contacts-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #0A3161;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    .contacts-table tr:hover {
      background-color: #f8f9fa;
    }
    .contacts-table tbody tr {
      cursor: pointer;
    }
    .checkbox-cell {
      width: 40px;
      text-align: center;
    }
    .contact-name {
      font-weight: 600;
      color: #0A3161;
    }
    .revenue-cell {
      color: #28a745;
      font-weight: 600;
    }
    .tag {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      display: inline-block;
      margin: 1px;
    }
    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.1rem;
      color: #666;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }
    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #0A3161;
    }
    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      max-width: 400px;
      z-index: 1000;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border-radius: 8px;
      width: 95%;
      max-width: 1000px;
      max-height: 95vh;
      overflow-y: auto;
    }
    .modal-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      opacity: 0.8;
    }
    .modal-body {
      padding: 20px;
    }
    .contact-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .detail-group {
      margin-bottom: 15px;
    }
    .detail-label {
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 5px;
      font-size: 12px;
      text-transform: uppercase;
    }
    .detail-value {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      min-height: 20px;
    }
    .modal-section {
      border-top: 2px solid #dee2e6;
      padding-top: 20px;
      margin-top: 20px;
    }
    .modal-section h3 {
      color: #0A3161;
      margin-bottom: 15px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #28a745;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .email-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      background: #f8f9fa;
    }
    .email-item {
      padding: 8px;
      margin-bottom: 5px;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .email-item:hover {
      background: #e3f2fd;
    }
    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
    }
    footer a {
      color: #fff;
      margin-right: 15px;
      text-decoration: none;
    }
    @media (max-width: 768px) {
      .content {
        padding: 10px 5px;
      }
      .page-title {
        font-size: 2rem;
      }
      .linkedin-inputs {
        grid-template-columns: 1fr;
      }
      .filter-section {
        grid-template-columns: 1fr;
      }
      .bulk-actions {
        flex-direction: column;
        align-items: stretch;
      }
      .modal-content {
        width: 98%;
        margin: 5% auto;
      }
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
      <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>
      <li><a href="contacts">Contacts</a></li>
      <li><a href="ads">Ads</a></li>
      <li><a href="ai">🤖 AI</a></li>
      <li><a href="settings">⚙️</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <button class="subscription-medallion" id="subscriptionMedallion" onclick="window.location.href='settings'">
      <span class="plan-name">BRONZE</span>
      <span class="credits" id="contactCredits">20 contacts</span>
    </button>
  </div>
</header>

<div class="content">
  <header class="page-header">
    <h1 class="page-title">Contact Management</h1>
    <p class="page-subtitle">Generate new contacts and manage your prospect database</p>
  </header>

  <!-- Lead Generation Section -->
  <section class="card">
    <div class="section-header">
      <h3>🎯 Generate New Contacts</h3>
    </div>
    
    <p style="margin-bottom: 20px; color: #666;">
      Enter up to 5 LinkedIn profile URLs of your ideal customers. Our AI will find similar prospects that are a perfect fit for your business.
      <span id="contactLimitText">You can generate up to 20 new contacts with your Bronze plan.</span>
    </p>
    
    <div class="linkedin-inputs">
      <div class="form-group">
        <label for="linkedin1">LinkedIn Profile URL 1</label>
        <input type="url" id="linkedin1" placeholder="https://linkedin.com/in/profile-name">
      </div>
      <div class="form-group">
        <label for="linkedin2">LinkedIn Profile URL 2</label>
        <input type="url" id="linkedin2" placeholder="https://linkedin.com/in/profile-name">
      </div>
      <div class="form-group">
        <label for="linkedin3">LinkedIn Profile URL 3</label>
        <input type="url" id="linkedin3" placeholder="https://linkedin.com/in/profile-name">
      </div>
      <div class="form-group">
        <label for="linkedin4">LinkedIn Profile URL 4</label>
        <input type="url" id="linkedin4" placeholder="https://linkedin.com/in/profile-name">
      </div>
      <div class="form-group">
        <label for="linkedin5">LinkedIn Profile URL 5</label>
        <input type="url" id="linkedin5" placeholder="https://linkedin.com/in/profile-name">
      </div>
    </div>
    
    <button id="generateBtn" class="generate-btn">🚀 Generate New Contacts</button>
  </section>

  <!-- Contacts Management Section -->
  <section class="card">
    <div class="section-header">
      <h3>👥 Your Contacts Database</h3>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
      <div class="form-group">
        <label for="searchFilter">Search</label>
        <input type="text" id="searchFilter" placeholder="Search contacts...">
      </div>
      <div class="form-group">
        <label for="industryFilter">Industry</label>
        <select id="industryFilter">
          <option value="">All Industries</option>
        </select>
      </div>
      <div class="form-group">
        <label for="cityFilter">City</label>
        <select id="cityFilter">
          <option value="">All Cities</option>
        </select>
      </div>
      <button id="refreshBtn">🔄 Refresh</button>
      <button id="clearFiltersBtn" class="secondary">Clear Filters</button>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions">
      <button id="selectAllBtn" class="secondary">Select All</button>
      <button id="deselectAllBtn" class="secondary">Deselect All</button>
      <button id="aiOutreachBtn" class="success">🤖 AI Outreach Selected</button>
      <button id="deleteSelectedBtn" class="danger">🗑️ Delete Selected</button>
      <span id="selectedCount" style="margin-left: 10px; color: #666;">0 selected</span>
    </div>

    <!-- Contacts Table -->
    <div class="table-container">
      <table class="contacts-table">
        <thead>
          <tr>
            <th class="checkbox-cell">
              <input type="checkbox" id="selectAllCheckbox">
            </th>
            <th>Name</th>
            <th>Title</th>
            <th>Company</th>
            <th>Domain</th>
            <th>Industry</th>
            <th>Tags</th>
            <th>Revenue</th>
            <th>Employees</th>
            <th>City</th>
            <th>Last Responded</th>
            <th>Last Emailed</th>
          </tr>
        </thead>
        <tbody id="contactsTableBody">
          <tr>
            <td colspan="12" class="loading">Loading your contacts...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Status Messages -->
  <div id="statusMessage" class="status-message"></div>
</div>

<!-- Contact Details Modal -->
<div id="contactModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Contact Details</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Contact details will be loaded here -->
    </div>
  </div>
</div>

<footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
// Supabase configuration
const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Global variables
let CUSTOMER_ID = null;
let authToken = null;
let userSubscription = 'bronze';
let contactCredits = 20;
let allContacts = [];
let filteredContacts = [];
let selectedContacts = new Set();
let currentContact = null;

// Authentication
async function checkAuthentication() {
  try {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    if (error || !session) {
      console.error('Auth error:', error);
      return false;
    }

    if (session && session.user) {
      CUSTOMER_ID = session.user.email;
      authToken = session.access_token;
      document.getElementById('userEmail').textContent = CUSTOMER_ID;
      await loadUserProfile();
      return true;
    }

    return false;
  } catch (e) {
    console.error('Auth check error:', e);
    return false;
  }
}

async function loadUserProfile() {
  try {
    const response = await fetch(`https://victoryvision.app.n8n.cloud/webhook/user/get?customer_id=${encodeURIComponent(CUSTOMER_ID)}`);
    if (response.ok) {
      const data = await response.json();
      userSubscription = data.subscription_plan || 'bronze';
      contactCredits = data.contact_credits || 20;
      updateSubscriptionDisplay();
    }
  } catch (error) {
    console.error('Error loading user profile:', error);
  }
}

function updateSubscriptionDisplay() {
  const medallion = document.getElementById('subscriptionMedallion');
  const planName = medallion.querySelector('.plan-name');
  const creditsSpan = document.getElementById('contactCredits');
  const limitText = document.getElementById('contactLimitText');
  
  medallion.className = `subscription-medallion ${userSubscription}`;
  planName.textContent = userSubscription.toUpperCase();
  creditsSpan.textContent = `${contactCredits} contacts`;
  
  const limits = {
    bronze: 20,
    silver: 50,
    gold: 200
  };
  const limit = limits[userSubscription] || 20;
  limitText.textContent = `You can generate up to ${limit} new contacts with your ${userSubscription.charAt(0).toUpperCase() + userSubscription.slice(1)} plan.`;
  
  document.getElementById('generateBtn').textContent = `🚀 Generate ${limit} New Contacts`;
}

function redirectToLogin() {
  window.location.href = 'login.html';
}

// Load contacts
async function loadContacts() {
  try {
    console.log('Loading contacts for customer:', CUSTOMER_ID);
    
    if (!CUSTOMER_ID) {
      console.error('No customer ID, cannot load contacts');
      return;
    }
    
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/get', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ customer_id: CUSTOMER_ID })
    });

    console.log('Load contacts response status:', response.status);

    if (!response.ok) {
      throw new Error('Failed to load contacts');
    }

    const data = await response.json();
    console.log('Contacts data received:', data);
    
    allContacts = Array.isArray(data) ? data : (data.contacts || []);
    filteredContacts = [...allContacts];
    
    console.log(`Loaded ${allContacts.length} contacts`);
    
    populateFilterOptions();
    renderContactsTable();
    showStatus(`Loaded ${allContacts.length} contacts`, false);
    
  } catch (error) {
    console.error('Error loading contacts:', error);
    showStatus('Error loading contacts: ' + error.message, true);
    // Still render empty table
    allContacts = [];
    filteredContacts = [];
    renderContactsTable();
  }
}

// Generate new contacts
async function generateNewContacts() {
  console.log('Generate button clicked');
  const generateBtn = document.getElementById('generateBtn');
  
  try {
    generateBtn.disabled = true;
    generateBtn.textContent = '🔄 Generating Contacts...';
    
    const linkedinUrls = [];
    for (let i = 1; i <= 5; i++) {
      const urlInput = document.getElementById(`linkedin${i}`);
      if (urlInput && urlInput.value) {
        const url = urlInput.value.trim();
        if (url) linkedinUrls.push(url);
      }
    }

    console.log('LinkedIn URLs collected:', linkedinUrls);

    if (linkedinUrls.length === 0) {
      throw new Error('Please enter at least one LinkedIn URL');
    }

    if (!CUSTOMER_ID) {
      throw new Error('Not authenticated. Please refresh the page.');
    }

    console.log('Sending request to contacts/look');
    
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/look', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        customer_id: CUSTOMER_ID,
        linkedin_urls: linkedinUrls
      })
    });

    console.log('Response status:', response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Error response:', errorText);
      throw new Error(`Failed to generate contacts: ${response.status}`);
    }

    showStatus('Successfully generating contacts! They will appear shortly.', false);
    
    // Clear inputs
    for (let i = 1; i <= 5; i++) {
      const input = document.getElementById(`linkedin${i}`);
      if (input) input.value = '';
    }
    
    // Reload contacts after a delay
    setTimeout(() => {
      console.log('Reloading contacts...');
      loadContacts();
    }, 3000);
    
  } catch (error) {
    console.error('Error generating contacts:', error);
    showStatus(error.message || 'Error generating contacts', true);
  } finally {
    generateBtn.disabled = false;
    updateSubscriptionDisplay();
  }
}

// Render contacts table
function renderContactsTable() {
  const tbody = document.getElementById('contactsTableBody');
  
  if (filteredContacts.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="12" class="empty-state">
          <h3>No contacts found</h3>
          <p>Generate new contacts or adjust your filters.</p>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = filteredContacts.map(contact => `
    <tr data-contact-id="${contact.id}" onclick="showContactDetails('${contact.id}', event)">
      <td class="checkbox-cell" onclick="event.stopPropagation()">
        <input type="checkbox" 
               value="${contact.id}" 
               ${selectedContacts.has(contact.id) ? 'checked' : ''}
               onchange="toggleContactSelection('${contact.id}')">
      </td>
      <td class="contact-name">${contact.name || 'N/A'}</td>
      <td>${contact.title || 'N/A'}</td>
      <td>${contact.company || 'N/A'}</td>
      <td>${contact.domain || 'N/A'}</td>
      <td>${contact.industry || 'N/A'}</td>
      <td>${formatTags(contact.tags)}</td>
      <td>${(contact.annual_revenue)}</td>
      <td>${contact.employee_count || 'N/A'}</td>
      <td>${contact.city || 'N/A'}</td>
      <td>${formatDate(contact.last_responded)}</td>
      <td>${formatDate(contact.last_emailed_date)}</td>
    </tr>
  `).join('');
}

// Show contact details modal
async function showContactDetails(contactId, event) {
  if (event) event.stopPropagation();
  
  const contact = allContacts.find(c => c.id === contactId);
  if (!contact) return;
  
  currentContact = contact;
  document.getElementById('modalTitle').textContent = contact.name || 'Contact Details';
  
  const modalBody = document.getElementById('modalBody');
  modalBody.innerHTML = `
    <div class="contact-details">
      ${renderDetailField('Name', contact.name)}
      ${renderDetailField('Title', contact.title)}
      ${contact.logo_url ? `<div class="detail-group"><div class="detail-label">Logo</div><div class="detail-value"><img src="${contact.logo_url}" style="max-width: 100px;" alt="Logo"></div></div>` : ''}
      ${renderDetailField('Company', contact.company)}
      ${renderDetailField('Domain', contact.domain)}
      ${renderDetailField('Industry', contact.industry)}
      ${renderDetailField('Tags', contact.tags)}
      ${renderDetailField('Annual Revenue', contact.annual_revenue)}
      ${renderDetailField('Employee Count', contact.employee_count)}
      ${renderDetailField('Email', contact.email)}
      ${renderDetailField('LinkedIn', contact.linkedin, true)}
      ${renderDetailField('City', contact.city)}
      ${renderDetailField('Phone Number', contact.phone_number)}
      ${renderDetailField('Last Responded', formatDate(contact.last_responded))}
      ${renderDetailField('Last Emailed', formatDate(contact.last_emailed_date))}
      ${renderDetailField('Conversation Summary', contact.conversation_summary)}
      ${renderDetailField('Personal Summary', contact.personal_summary)}
      ${renderDetailField('Company Summary', contact.company_summary)}
      ${renderDetailField('Created', formatDate(contact.created))}
      ${renderDetailField('Address', contact.address)}
      ${renderDetailField('School Name', contact.school_name)}
      ${renderDetailField('Followers', contact.num_followers)}
      ${renderDetailField('Personal Priorities', contact.personal_priorities)}
    </div>
    
    <div class="modal-section">
      <h3>📧 Automation Settings</h3>
      <div style="display: flex; gap: 30px; margin-top: 15px;">
        <label style="display: flex; align-items: center; gap: 10px;">
          <span>AI Email Outreach</span>
          <label class="toggle-switch">
            <input type="checkbox" id="aiEmailToggle" ${contact.ai_email ? 'checked' : ''} onchange="toggleAIEmail()">
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label style="display: flex; align-items: center; gap: 10px;">
          <span>Newsletter</span>
          <label class="toggle-switch">
            <input type="checkbox" id="newsletterToggle" ${contact.newsletter ? 'checked' : ''} onchange="toggleNewsletter()">
            <span class="toggle-slider"></span>
          </label>
        </label>
      </div>
    </div>
    
    <div class="modal-section">
      <h3>✉️ Email Communication</h3>
      <div style="margin-top: 15px;">
        <button onclick="draftAIEmail()" class="success">🤖 Draft AI Email</button>
        <button onclick="loadEmailHistory()" class="secondary">📧 Load Email History</button>
      </div>
      <div id="emailContent" style="margin-top: 20px;"></div>
    </div>
  `;
  
  document.getElementById('contactModal').style.display = 'block';
}

function renderDetailField(label, value, isLink = false) {
  if (!value) return '';
  
  const displayValue = isLink && value.startsWith('http') ? 
    `<a href="${value}" target="_blank" style="color: #0A3161;">${value}</a>` : 
    value;
  
  return `
    <div class="detail-group">
      <div class="detail-label">${label}</div>
      <div class="detail-value">${displayValue}</div>
    </div>
  `;
}

// Format helpers
function formatTags(tags) {
  if (!tags) return 'N/A';
  return tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join(' ');
}

function formatDate(dateStr) {
  if (!dateStr) return 'Never';
  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = Math.abs(now - date);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  
  return date.toLocaleDateString();
}

// Contact selection
function toggleContactSelection(contactId) {
  if (selectedContacts.has(contactId)) {
    selectedContacts.delete(contactId);
  } else {
    selectedContacts.add(contactId);
  }
  updateSelectedCount();
}

function selectAll() {
  filteredContacts.forEach(contact => selectedContacts.add(contact.id));
  renderContactsTable();
  updateSelectedCount();
}

function deselectAll() {
  selectedContacts.clear();
  renderContactsTable();
  updateSelectedCount();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = `${selectedContacts.size} selected`;
  document.getElementById('selectAllCheckbox').checked = selectedContacts.size === filteredContacts.length && filteredContacts.length > 0;
}

// AI Outreach
async function performAIOutreach() {
  if (selectedContacts.size === 0) {
    showStatus('Please select contacts for AI outreach', true);
    return;
  }

  try {
    const selectedContactsList = Array.from(selectedContacts).map(id => 
      allContacts.find(c => c.id === id)
    ).filter(c => c && c.email);

    for (const contact of selectedContactsList) {
      await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/ai-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          customer_id: CUSTOMER_ID,
          email: contact.email
        })
      });
    }
    
    showStatus(`AI outreach initiated for ${selectedContactsList.length} contacts`, false);
    selectedContacts.clear();
    updateSelectedCount();
    
  } catch (error) {
    console.error('Error performing AI outreach:', error);
    showStatus('Error performing AI outreach', true);
  }
}

// Delete selected
async function deleteSelectedContacts() {
  if (selectedContacts.size === 0) {
    showStatus('Please select contacts to delete', true);
    return;
  }

  if (!confirm(`Delete ${selectedContacts.size} selected contacts?`)) {
    return;
  }

  try {
    for (const contactId of selectedContacts) {
      await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          customer_id: CUSTOMER_ID,
          contact_id: contactId
        })
      });
    }

    showStatus(`Deleted ${selectedContacts.size} contacts`, false);
    selectedContacts.clear();
    await loadContacts();
    
  } catch (error) {
    console.error('Error deleting contacts:', error);
    showStatus('Error deleting contacts', true);
  }
}

// Email functions
async function toggleAIEmail() {
  const isEnabled = document.getElementById('aiEmailToggle').checked;
  
  try {
    if (isEnabled) {
      await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/ai-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          customer_id: CUSTOMER_ID,
          email: currentContact.email
        })
      });
    }
    
    currentContact.ai_email = isEnabled;
    showStatus(`AI email ${isEnabled ? 'enabled' : 'disabled'}`, false);
    
  } catch (error) {
    console.error('Error toggling AI email:', error);
    showStatus('Error updating AI email setting', true);
  }
}

function toggleNewsletter() {
  const isEnabled = document.getElementById('newsletterToggle').checked;
  currentContact.newsletter = isEnabled;
  showStatus(`Newsletter ${isEnabled ? 'enabled' : 'disabled'}`, false);
}

async function draftAIEmail() {
  try {
    const emailContent = document.getElementById('emailContent');
    emailContent.innerHTML = '<div class="loading">Generating AI email draft...</div>';
    
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/user-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        customer_id: CUSTOMER_ID,
        email_to: currentContact.email
      })
    });

    if (!response.ok) {
      throw new Error('Failed to generate email draft');
    }

    const result = await response.json();
    
    emailContent.innerHTML = `
      <div class="form-group">
        <label>To:</label>
        <input type="email" id="emailTo" value="${currentContact.email}" readonly style="background: #f8f9fa;">
      </div>
      <div class="form-group">
        <label>Subject:</label>
        <input type="text" id="emailSubject" value="${result.subject || ''}">
      </div>
      <div class="form-group">
        <label>Message:</label>
        <textarea id="emailBody" rows="10">${result.body || ''}</textarea>
      </div>
      <button onclick="sendEmail()" class="success">📤 Send Email</button>
      <button onclick="cancelEmail()" class="secondary">Cancel</button>
    `;
    
  } catch (error) {
    console.error('Error drafting email:', error);
    showStatus('Error generating email draft', true);
  }
}

async function loadEmailHistory() {
  try {
    const emailContent = document.getElementById('emailContent');
    emailContent.innerHTML = '<div class="loading">Loading email history...</div>';
    
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/get-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        customer_id: CUSTOMER_ID,
        email: currentContact.email
      })
    });

    if (!response.ok) {
      throw new Error('Failed to load email history');
    }

    const emails = await response.json();
    
    if (!emails || emails.length === 0) {
      emailContent.innerHTML = '<p style="color: #666;">No email history found.</p>';
      return;
    }
    
    emailContent.innerHTML = `
      <div class="email-list">
        ${emails.map(email => `
          <div class="email-item">
            <div style="display: flex; justify-content: space-between;">
              <strong>${email.subject || 'No subject'}</strong>
              <span style="font-size: 11px; color: #999;">${formatDate(email.date)}</span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 4px;">
              ${email.body ? email.body.substring(0, 100) + '...' : 'No content'}
            </div>
          </div>
        `).join('')}
      </div>
    `;
    
  } catch (error) {
    console.error('Error loading email history:', error);
    showStatus('Error loading email history', true);
  }
}

async function sendEmail() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  
  if (!subject || !body) {
    showStatus('Please enter subject and message', true);
    return;
  }
  
  try {
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/contacts/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        customer_id: CUSTOMER_ID,
        email_to: currentContact.email,
        subject: subject,
        body: body
      })
    });

    if (!response.ok) {
      throw new Error('Failed to send email');
    }

    showStatus('Email sent successfully!', false);
    document.getElementById('emailContent').innerHTML = '';
    
  } catch (error) {
    console.error('Error sending email:', error);
    showStatus('Error sending email', true);
  }
}

function cancelEmail() {
  document.getElementById('emailContent').innerHTML = '';
}

function closeModal() {
  document.getElementById('contactModal').style.display = 'none';
  currentContact = null;
}

// Filters
function populateFilterOptions() {
  const industries = [...new Set(allContacts.map(c => c.industry).filter(Boolean))].sort();
  const cities = [...new Set(allContacts.map(c => c.city).filter(Boolean))].sort();
  
  const industryFilter = document.getElementById('industryFilter');
  industryFilter.innerHTML = '<option value="">All Industries</option>';
  industries.forEach(industry => {
    industryFilter.innerHTML += `<option value="${industry}">${industry}</option>`;
  });
  
  const cityFilter = document.getElementById('cityFilter');
  cityFilter.innerHTML = '<option value="">All Cities</option>';
  cities.forEach(city => {
    cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
  });
}

function applyFilters() {
  const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
  const industry = document.getElementById('industryFilter').value;
  const city = document.getElementById('cityFilter').value;

  filteredContacts = allContacts.filter(contact => {
    if (searchTerm) {
      const searchableText = [
        contact.name || '',
        contact.title || '',
        contact.company || '',
        contact.email || '',
        contact.industry || '',
        contact.tags || ''
      ].join(' ').toLowerCase();
      
      if (!searchableText.includes(searchTerm)) {
        return false;
      }
    }

    if (industry && contact.industry !== industry) {
      return false;
    }

    if (city && contact.city !== city) {
      return false;
    }

    return true;
  });

  renderContactsTable();
}

function clearFilters() {
  document.getElementById('searchFilter').value = '';
  document.getElementById('industryFilter').value = '';
  document.getElementById('cityFilter').value = '';
  applyFilters();
}

// Status messages
function showStatus(message, isError = false) {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.textContent = message;
  statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
  statusDiv.style.display = 'block';
  
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 5000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', async () => {
  console.log('Page loaded, initializing...');
  
  try {
    const isAuthenticated = await checkAuthentication();
    console.log('Authentication status:', isAuthenticated);
    
    if (isAuthenticated) {
      // Setup event listeners
      const generateBtn = document.getElementById('generateBtn');
      if (generateBtn) {
        console.log('Setting up generate button listener');
        generateBtn.addEventListener('click', generateNewContacts);
      } else {
        console.error('Generate button not found');
      }
      
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadContacts);
      }
      
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearFilters);
      }
      
      const selectAllBtn = document.getElementById('selectAllBtn');
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', selectAll);
      }
      
      const deselectAllBtn = document.getElementById('deselectAllBtn');
      if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', deselectAll);
      }
      
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
          if (e.target.checked) selectAll();
          else deselectAll();
        });
      }
      
      const aiOutreachBtn = document.getElementById('aiOutreachBtn');
      if (aiOutreachBtn) {
        aiOutreachBtn.addEventListener('click', performAIOutreach);
      }
      
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', deleteSelectedContacts);
      }
      
      const searchFilter = document.getElementById('searchFilter');
      if (searchFilter) {
        searchFilter.addEventListener('input', applyFilters);
      }
      
      const industryFilter = document.getElementById('industryFilter');
      if (industryFilter) {
        industryFilter.addEventListener('change', applyFilters);
      }
      
      const cityFilter = document.getElementById('cityFilter');
      if (cityFilter) {
        cityFilter.addEventListener('change', applyFilters);
      }
      
      // Modal close
      window.addEventListener('click', (event) => {
        const modal = document.getElementById('contactModal');
        if (event.target === modal) {
          closeModal();
        }
      });
      
      // Load initial data
      await loadContacts();
    } else {
      console.log('Not authenticated, redirecting to login');
      redirectToLogin();
    }
  } catch (error) {
    console.error('Error initializing:', error);
    showStatus('Failed to initialize. Please refresh.', true);
  }
});

// Session check
setInterval(async () => {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      redirectToLogin();
    }
  } catch (e) {
    console.error('Session check failed:', e);
  }
}, 300000);
</script>

</body>
</html>
