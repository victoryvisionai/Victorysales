<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Manage your contacts and email workflows."/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Contacts</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@telnyx/webrtc@2/lib/bundle.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
  
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .navbar nav ul li {
      margin: 0 10px;
    }
    .navbar nav ul li a {
      color: white;
      text-decoration: none;
    }
    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      position: relative;
      border: none;
      transition: all 0.3s ease;
    }
    .subscription-medallion.bronze {
      background: linear-gradient(45deg, #CD7F32, #A0522D);
    }
    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }
    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }
    .subscription-medallion:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .subscription-medallion .plan-name {
      font-weight: bold;
    }
    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }
    .content {
      padding: 20px 4px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .page-header {
      margin-bottom: 30px;
    }
    .page-title {
      font-size: 2.5rem;
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      font-size: 1.1rem;
      color: #6699cc;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
      border-radius: 8px 8px 0 0;
    }
    .credits-display {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      text-align: center;
    }
    .credits-number {
      font-size: 1.4em;
      font-weight: bold;
      color: #0A3161;
    }
    .credits-label {
      font-size: 0.85em;
      color: #6699cc;
      margin-top: 2px;
    }
    .linkedin-input-section {
      display: grid;
      grid-template-columns: 1fr 150px;
      gap: 15px;
      margin-bottom: 20px;
      align-items: end;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
      position: relative;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .generate-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      display: block;
      margin: 20px auto;
    }
    .generate-btn:hover {
      background: linear-gradient(135deg, #218838, #1e7e34);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .generate-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
/* Call Modal Improvements */
#callScript {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.8 !important;
  letter-spacing: 0.3px;
}

#callScript strong,
#callScript b {
  color: #0A3161;
  font-weight: 600;
}

/* Call Notes Styling */
#callNotes {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  resize: vertical;
  border: 2px solid #dee2e6;
  transition: border-color 0.2s;
}

#callNotes:focus {
  border-color: #0A3161;
  outline: none;
  box-shadow: 0 0 0 3px rgba(10, 49, 97, 0.1);
}

/* Better button spacing */
.modal-body button {
  transition: all 0.2s;
}

.modal-body button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
    /* Loading spinner for script generation */
.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #0A3161;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
    .add-contact-section {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      background: #0A3161;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 2px;
    }
    button:hover {
      background: #083050;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    button.warning {
      background: #ffc107;
      color: #212529;
    }
    button.warning:hover {
      background: #e0a800;
    }
    button.info {
      background: #17a2b8;
    }
    button.info:hover {
      background: #138496;
    }
    /* Updated filter section to match media page design */
    .filter-section {
      display: grid;
      grid-template-columns: 180px 180px 180px 180px 180px 180px 130px 130px auto auto;
      gap: 10px;
      align-items: end;
      margin-bottom: 20px;
    }
    .bulk-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      justify-content: space-between;
    }
    .bulk-actions-left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .bulk-actions-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .workflow-section {
      background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #bb133e;
    }
    .workflow-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .workflow-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    .workflow-item:hover {
      background: #f0f8ff;
      border-color: #0A3161;
    }
    .workflow-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .workflow-item label {
      margin: 0;
      cursor: pointer;
      flex: 1;
    }
    .column-selector {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #dee2e6;
    }
    .column-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .column-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    .column-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .table-container {
      overflow-x: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-height: 70vh;
      overflow-y: auto;
    }
    .contacts-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }
    .contacts-table th,
    .contacts-table td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
      font-size: 12px;
      white-space: nowrap;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .contacts-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #0A3161;
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
    }
    .contacts-table th:hover {
      background: #e9ecef;
    }
    .contacts-table tr:hover {
      background-color: #f8f9fa;
    }
    .contacts-table tbody tr {
      cursor: pointer;
    }
    .checkbox-cell {
      width: 40px;
      text-align: center;
    }
    .contact-name {
      font-weight: 600;
      color: #0A3161;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .revenue-cell {
      color: #28a745;
      font-weight: 600;
    }
    .workflow-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
      display: inline-block;
      margin: 1px;
    }
    .workflow-badge.active {
      background: #28a745;
      color: white;
    }
    .sort-indicator {
      display: inline-block;
      margin-left: 5px;
      opacity: 0.5;
    }
    .sort-indicator.active {
      opacity: 1;
    }
    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.1rem;
      color: #6699cc;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #6699cc;
    }
    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #0A3161;
    }
    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      max-width: 400px;
      z-index: 1000;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border-radius: 8px;
      width: 95%;
      max-width: 1000px;
      max-height: 95vh;
      overflow-y: auto;
    }
    .modal-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      opacity: 0.8;
    }
    .modal-body {
      padding: 20px;
    }
    .contact-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .detail-group {
      margin-bottom: 15px;
    }
    .detail-label {
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 5px;
      font-size: 12px;
      text-transform: uppercase;
    }
    .detail-value {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      min-height: 20px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #dee2e6;
      flex-wrap: wrap;
    }
    .csv-sample {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    .csv-sample h4 {
      margin: 0 0 10px 0;
      color: #0A3161;
    }
    .csv-sample code {
      display: block;
      background: white;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }
    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
    }
    footer a {
      color: #fff;
      margin-right: 15px;
      text-decoration: none;
    }
    
    /* Help icon styles */
    .help-icon {
      position: relative;
      display: inline-block;
      margin-left: 5px;
      cursor: pointer;
      color: #6c757d;
      font-size: 14px;
      user-select: none;
    }
    
    .help-tooltip {
      visibility: hidden;
      width: 250px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1001;
      bottom: 125%;
      left: 50%;
      margin-left: -125px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .help-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    
    .help-icon:hover .help-tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    /* Date filter styles */
    .date-filter-group {
      display: flex;
      gap: 5px;
      align-items: end;
    }
    
    .date-filter-group input[type="date"] {
      width: 130px;
      font-size: 12px;
      padding: 6px;
    }
    
    /* Intro.js custom styling */
    .introjs-tooltip {
      max-width: 350px;
      font-size: 14px;
    }

    .introjs-button {
      background: #0A3161 !important;
      border: 1px solid #0A3161 !important;
      color: white !important;
      padding: 8px 15px !important;
      border-radius: 4px !important;
    }

    .introjs-button:hover {
      background: #083050 !important;
      border-color: #083050 !important;
    }

    .introjs-skipbutton {
      background: #6c757d !important;
      border-color: #6c757d !important;
    }

    .introjs-progressbar {
      background-color: #0A3161 !important;
    }
    
    @media (max-width: 1024px) {
      .filter-section {
        grid-template-columns: repeat(2, 1fr);
      }
      .workflow-list {
        grid-template-columns: 1fr;
      }
      .bulk-actions {
        flex-direction: column;
        align-items: stretch;
      }
      .bulk-actions-left,
      .bulk-actions-right {
        justify-content: center;
      }
    }
    
    @media (max-width: 768px) {
      .content {
        padding: 10px 5px;
      }
      .page-title {
        font-size: 2rem;
      }
      .linkedin-input-section {
        grid-template-columns: 1fr;
      }
      .filter-section {
        grid-template-columns: 1fr;
      }
      .bulk-actions {
        flex-direction: column;
        align-items: stretch;
      }
      .modal-content {
        width: 98%;
        margin: 5% auto;
      }
      .add-contact-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
    <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>
      <li><a href="contacts">Contacts</a></li>
      <li><a href="ads">Ads</a></li>
      <li><a href="messages">Messages</a></li>
      <li><a href="meetings">Meetings</a></li>
      <li><a href="ai">Analytics</a></li>
      <li><a href="settings">Settings</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <button onclick="startTour()" style="background: #0A3161; padding: 6px 12px; font-size: 11px; margin-left: 10px;" id="tourButton">
      üìñ Take Tour
    </button>
    <div id="subscriptionMedallion" class="subscription-medallion bronze">
      <span class="plan-name">Bronze</span>
      <span class="credits" id="Credits">20 contacts</span>
    </div>
  </div>
</header>
<div class="content">
 <header class="page-header">
    <h1 class="page-title">Contact Management</h1>
    <p class="page-subtitle">Generate new contacts and manage your prospect database with AI workflows</p>
  </header>

  <!-- Lead Generation Section - COMPACT -->
  <section class="card" data-intro="Generate new contacts by entering a LinkedIn profile URL of your ideal customer. Our AI will find similar prospects that match your target profile." data-step="1">
    <div class="section-header">
      <h3>üéØ Contact Management Tools</h3>
    </div>
    
    <!-- COMPACT LAYOUT: Buttons Left, Instructions Right -->
    <div style="display: grid; grid-template-columns: 240px 1fr; gap: 25px; align-items: start; padding: 20px 0;">
      
      <!-- LEFT COLUMN: Action Buttons -->
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button onclick="showAddContactModal()" style="background: #0A3161; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%;">
          ‚ûï Add Contact Manually
        </button>
        
        <button onclick="document.getElementById('csvFileInput').click()" style="background: #6c757d; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%;">
          üìÑ Upload CSV
        </button>
        
        <button onclick="downloadCsvTemplate()" style="background: #0A3161; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%;">
          üì• Download Template
        </button>
      </div>
      
      <!-- RIGHT COLUMN: Instructions -->
      <div style="padding-left: 10px; border-left: 3px solid #0A3161;">
        <h4 style="margin: 0 0 12px 0; color: #0A3161; font-size: 1.1rem;">Quick Actions</h4>
        
        <div style="margin-bottom: 15px;">
          <strong style="color: #0A3161;">‚ûï Add Manually:</strong>
          <p style="margin: 5px 0 0 0; color: #6699cc; font-size: 0.9rem; line-height: 1.5;">
            Add individual contacts one at a time with full details and custom fields.
          </p>
        </div>
        
        <div style="margin-bottom: 15px;">
          <strong style="color: #0A3161;">üìÑ Upload CSV:</strong>
          <p style="margin: 5px 0 0 0; color: #6699cc; font-size: 0.9rem; line-height: 1.5;">
            Bulk import contacts from a CSV file. Required columns: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">email</code>, <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">name</code>. Optional: address, title, domain, phone, linkedin, company, city, industry, tags, customer_journey, last_opened_date, last_called, logo_url.
          </p>
        </div>
        
        <div>
          <strong style="color: #0A3161;">üì• Download Template:</strong>
          <p style="margin: 5px 0 0 0; color: #6699cc; font-size: 0.9rem; line-height: 1.5;">
            Get a pre-formatted CSV template with sample data and proper column headers to ensure successful imports.
          </p>
        </div>
      </div>
    </div>
    
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
  </section>

  <script>
  function downloadCsvTemplate() {
    const csvContent = `email,name,phone,linkedin,company,city,industry,tags,customer_journey,logo_url
john@company.com,John Smith,+1-555-0123,https://linkedin.com/in/johnsmith,Company Inc,San Francisco,Technology,"hot-lead,decision-maker","Had great meeting about Q4 goals",https://company.com/logo.png
jane@business.com,Jane Doe,+1-555-0124,https://linkedin.com/in/janedoe,Business LLC,New York,Finance,"warm-lead,interested","Interested in our services, follow up next week",`;
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'victory-vision-contacts-template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
  }
  </script>
  <!-- Contacts Management Section -->
  <section class="card">
    <div class="section-header">
      <h3>üë• Your Contacts Database</h3>
    </div>
    
    <!-- Email Workflows Section -->
    <div class="workflow-section" data-intro="Select email workflows to enroll your contacts. Choose multiple workflows and then use the 'Enroll in Workflows' button to automate your outreach." data-step="3">
      <h4 style="margin: 0 0 15px 0; color: #0A3161;">üìß Available Email Workflows</h4>
      <div class="workflow-list" id="workflowList">
        <div class="workflow-item">
          <input type="checkbox" id="workflow_ads" value="ads">
          <label for="workflow_ads">üì∫ Ad Outreach - Share hyper personalized ads</label>
        </div>
        <div class="workflow-item">
          <input type="checkbox" id="workflow_nurture" value="nurture">
          <label for="workflow_nurture">üå± Lead Nurture - Educational content sequence</label>
        </div>
        <div class="workflow-item">
          <input type="checkbox" id="workflow_meeting" value="meeting">
          <label for="workflow_meeting">üìÖ Schedule Meeting Request</label>
        </div>
        <div class="workflow-item">
          <input type="checkbox" id="workflow_followup" value="followup">
          <label for="workflow_followup">üîÑ Follow-up Sequence - Re-engage prospects</label>
        </div>
    <div class="workflow-item">
          <input type="checkbox" id="workflow_newsletter" value="newsletter">
          <label for="workflow_newsletter">üì∞ Newsletter - Send to newsletter subscribers</label>
        </div>
      </div>
      
      <!-- NEW: Custom Email Campaign Button -->
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="showCustomCampaignModal()" class="success" style="background: #0A3161;">
          ‚ú® Create Custom Email Campaign
        </button>
      </div>
    </div>

    <!-- Column Selector -->
    <div class="column-selector" data-intro="Customize which contact fields are displayed in the table. Show only the information most relevant to your business needs." data-step="4">
      <h4 style="margin: 0 0 10px 0; color: #0A3161;">‚öôÔ∏è Customize Table Columns</h4>
      <div class="column-list" id="columnList">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section" data-intro="Filter your contacts by industry, location, revenue, dates and more. Use these filters to segment your audience for targeted outreach." data-step="5">
      <div class="form-group">
        <label for="searchFilter">Search</label>
        <input type="text" id="searchFilter" placeholder="Search contacts...">
      </div>
      <div class="form-group">
        <label for="industryFilter">Industry</label>
        <select id="industryFilter">
          <option value="">All Industries</option>
        </select>
      </div>
      <div class="form-group">
        <label for="cityFilter">City</label>
        <select id="cityFilter">
          <option value="">All Cities</option>
        </select>
      </div>
      <div class="form-group">
        <label for="revenueFilter">Revenue</label>
        <select id="revenueFilter">
          <option value="">All Revenue</option>
          <option value="0-1M">$0-1M</option>
          <option value="1M-10M">$1M-10M</option>
          <option value="10M-50M">$10M-50M</option>
          <option value="50M+">$50M+</option>
        </select>
      </div>
   <div class="form-group">
        <label for="schoolFilter">School</label>
        <select id="schoolFilter">
          <option value="">All Schools</option>
        </select>
      </div>
      <div class="form-group">
        <label for="workflowFilter">Workflow</label>
        <select id="workflowFilter">
          <option value="">All Workflows</option>
          <option value="ads">Ad Outreach</option>
          <option value="nurture">Lead Nurture</option>
          <option value="meeting">Meeting Request</option>
          <option value="followup">Follow-up</option>
        </select>
      </div>
      
    <div class="form-group">
        <label for="tagsFilter">Tags</label>
        <select id="tagsFilter">
          <option value="">All Tags</option>
        </select>
      </div>
      <div class="form-group">
        <label for="createdFromFilter">Created From</label>
        <input type="date" id="createdFromFilter">
      </div>
      <div class="form-group">
        <label for="createdToFilter">Created To</label>
        <input type="date" id="createdToFilter">
      </div>
      <button id="refreshBtn">üîÑ Refresh</button>
      <button id="clearFiltersBtn" class="secondary">Clear Filters</button>
      </div>
    <!-- Bulk Actions -->
    <div class="bulk-actions" data-intro="Select multiple contacts and perform bulk actions like enrolling in workflows, enriching data, or deleting contacts." data-step="6">
      <div class="bulk-actions-left">
        <button id="selectAllBtn" class="secondary">Select All</button>
        <button id="deselectAllBtn" class="secondary">Deselect All</button>
        <button id="enrollWorkflowsBtn" class="success">üìß Enroll in Workflows</button>
        <button id="enrichContactsBtn" class="success">üîç Enrich Selected</button>
        <button id="lookAlikeBtn" class="success" style="background: #17a2b8;">üîé Look Alike</button>
        <button id="deleteSelectedBtn" class="danger">üóëÔ∏è Delete Selected</button>
        <span id="selectedCount" style="margin-left: 10px; color: #6699cc;">0 selected</span>
      </div>
      <div class="bulk-actions-right">
        <button id="expandContactBtn" class="success" style="background: #17a2b8;">üîç Expand Contact</button>
      </div>
    </div>

    <!-- Contacts Table -->
    <div class="table-container" data-intro="Your contacts database with sortable columns. Click any contact to view detailed information and send personal messages." data-step="7">
      <table class="contacts-table">
        <thead>
          <tr id="tableHeader">
            <th class="checkbox-cell">
              <input type="checkbox" id="selectAllCheckbox">
            </th>
            <!-- Dynamic columns will be inserted here -->
          </tr>
        </thead>
        <tbody id="contactsTableBody">
          <tr>
            <td colspan="20" class="loading">Loading your contacts...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Status Messages -->
  <div id="statusMessage" class="status-message"></div>
</div>

<!-- Contact Details Modal -->
<div id="contactModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Contact Details</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Contact details will be loaded here -->
    </div>
  </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚ûï Add New Contact</h2>
      <span class="close" onclick="closeAddContactModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="addContactForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group">
            <label for="name">
              Full Name *
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Enter the contact's full name as it appears on their LinkedIn profile or business card.</span>
              </span>
            </label>
            <input type="text" id="name" name="name" required placeholder="John Smith">
          </div>
          <div class="form-group">
            <label for="email">
              Email
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Primary business email address for this contact. This will be used for email campaigns.</span>
              </span>
            </label>
            <input type="email" id="email" name="email" placeholder="john@company.com">
          </div>
          <div class="form-group">
            <label for="title">
              Title
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Job title or position within their company (e.g., CEO, Marketing Director, VP Sales).</span>
              </span>
            </label>
            <input type="text" id="title" name="title" placeholder="CEO">
          </div>
          <div class="form-group">
            <label for="company">
              Company
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Name of the company where this contact works.</span>
              </span>
            </label>
            <input type="text" id="company" name="company" placeholder="Company Inc">
          </div>
          <div class="form-group">
            <label for="domain">
              Domain
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Company website domain (e.g., company.com). Used for company research and email verification.</span>
              </span>
            </label>
            <input type="text" id="domain" name="domain" placeholder="company.com">
          </div>
          <div class="form-group">
            <label for="phone_number">
              Phone
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Business phone number including country code if international.</span>
              </span>
            </label>
            <input type="tel" id="phone_number" name="phone_number" placeholder="+1-555-0123">
          </div>
          <div class="form-group">
            <label for="linkedin">
              LinkedIn URL
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Full LinkedIn profile URL. Used for additional research and personalization.</span>
              </span>
            </label>
            <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/profile">
          </div>
          <div class="form-group">
            <label for="industry">
              Industry
              <span class="help-icon">‚ùì
                <span class="help-tooltip">The industry or sector this contact's company operates in (e.g., Technology, Healthcare, Finance).</span>
              </span>
            </label>
            <input type="text" id="industry" name="industry" placeholder="Technology">
          </div>
          <div class="form-group">
            <label for="city">
              City
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Primary city where this contact is located or works.</span>
              </span>
            </label>
            <input type="text" id="city" name="city" placeholder="San Francisco">
          </div>
          <div class="form-group">
            <label for="annual_revenue">
              Annual Revenue
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Estimated annual revenue of the contact's company. Use format like $5M, $10.5M, or $1.2B.</span>
              </span>
            </label>
            <input type="text" id="annual_revenue" name="annual_revenue" placeholder="$5M">
          </div>
          <div class="form-group">
            <label for="employee_count">
              Employee Count
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Approximate number of employees at the contact's company.</span>
              </span>
            </label>
            <input type="number" id="employee_count" name="employee_count" placeholder="50">
          </div>
          <div class="form-group">
            <label for="client_won_date">
              Client Won Date
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Date when this contact became a client (if applicable). Leave blank for prospects.</span>
              </span>
            </label>
            <input type="date" id="client_won_date" name="client_won_date">
          </div>
        </div>
        <div class="form-group">
        <label for="client_ann_est">
              Estimated Annual Revenue from Customer
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Amount of revenue customer should generate each year.</span>
              </span>
            </label>
            <input type="text" id="client_ann_est" name="client_ann_est">
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
          <div class="form-group">
            <label for="customer_journey">
              Customer Journey
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Summary of all previous conversations, meetings, and interactions with this contact.</span>
              </span>
            </label>
            <textarea id="customer_journey" name="customer_journey" placeholder="Summary of all communication..."></textarea>
          </div>
          <div class="form-group">
            <label for="personal_summary">
              Personal Summary
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Personal background, interests, family details, hobbies, or other personal information about the contact.</span>
              </span>
            </label>
            <textarea id="personal_summary" name="personal_summary" placeholder="Brief personal background..."></textarea>
          </div>
          <div class="form-group">
            <label for="company_summary">
              Company Summary
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Overview of the contact's company, their business model, recent news, or company challenges.</span>
              </span>
            </label>
            <textarea id="company_summary" name="company_summary" placeholder="Company overview..."></textarea>
          </div>
          <div class="form-group">
            <label for="personal_priorities">
              Personal Priorities
              <span class="help-icon">‚ùì
                <span class="help-tooltip">What matters to this contact personally - career goals, personal challenges, or individual motivations.</span>
              </span>
            </label>
            <textarea id="personal_priorities" name="personal_priorities" placeholder="What matters to them personally..."></textarea>
          </div>
          <div class="form-group">
            <label for="company_priorities">
              Company Priorities
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Current company goals, initiatives, challenges, or strategic priorities this contact is focused on.</span>
              </span>
            </label>
            <textarea id="company_priorities" name="company_priorities" placeholder="Company goals and priorities..."></textarea>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
          <div class="form-group">
            <label for="tags">
              Tags
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Comma-separated tags for organizing contacts (e.g., hot-lead, decision-maker, interested).</span>
              </span>
            </label>
            <input type="text" id="tags" name="tags" placeholder="hot-lead, decision-maker, interested">
          </div>
          <div class="form-group">
            <label for="workflow">
              Current Workflow
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Select which automated email workflow this contact should be enrolled in.</span>
              </span>
            </label>
            <select id="workflow" name="workflow">
              <option value="">None</option>
              <option value="ads">Ad Outreach</option>
              <option value="nurture">Lead Nurture</option>
              <option value="meeting">Meeting Request</option>
              <option value="followup">Follow-up</option>
            </select>
          </div>
        </div>
        
        <div style="margin-top: 15px;">
          <div class="checkbox-group">
            <input type="checkbox" id="aiemail" name="aiemail">
            <label for="aiemail">
              Enable AI Email Campaigns
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Allow AI to automatically generate and send personalized email campaigns to this contact.</span>
              </span>
            </label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="newsletter" name="newsletter">
            <label for="newsletter">
              Subscribe to Newsletter
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Add this contact to your company newsletter mailing list.</span>
              </span>
            </label>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" onclick="closeAddContactModal()" class="secondary">Cancel</button>
          <button type="submit" class="success">‚ûï Add Contact</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Custom Email Campaign Modal -->
<div id="customCampaignModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚ú® Create Custom Email Campaign</h2>
      <span class="close" onclick="closeCustomCampaignModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="customCampaignForm">
        <div class="form-group">
          <label for="campaignName">
            Campaign Name *
            <span class="help-icon">‚ùì
              <span class="help-tooltip">Give your email campaign a descriptive name for tracking purposes.</span>
            </span>
          </label>
          <input type="text" id="campaignName" name="campaignName" required placeholder="Q1 Product Launch Campaign">
        </div>
        
        <div class="form-group">
          <label for="campaignDescription">
            Campaign Description *
            <span class="help-icon">‚ùì
              <span class="help-tooltip">Describe what this email campaign should accomplish. Our AI will use this to generate personalized emails for each contact.</span>
            </span>
          </label>
          <textarea id="campaignDescription" name="campaignDescription" required 
                   placeholder="Create a warm introduction email sequence highlighting our new product features and benefits, focusing on how it can solve their specific business challenges. Include a call-to-action for scheduling a demo."
                   style="min-height: 120px;"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
          <div class="form-group">
            <label for="emailCount">
              Number of Emails in Sequence *
              <span class="help-icon">‚ùì
                <span class="help-tooltip">How many emails should be in this automated sequence? (1-10 emails)</span>
              </span>
            </label>
            <select id="emailCount" name="emailCount" required>
              <option value="1">1 Email</option>
              <option value="2">2 Emails</option>
              <option value="3" selected>3 Emails</option>
              <option value="4">4 Emails</option>
              <option value="5">5 Emails</option>
              <option value="6">6 Emails</option>
              <option value="7">7 Emails</option>
              <option value="8">8 Emails</option>
              <option value="9">9 Emails</option>
              <option value="10">10 Emails</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="emailTone">
              Email Tone
              <span class="help-icon">‚ùì
                <span class="help-tooltip">Choose the tone for your email campaign.</span>
              </span>
            </label>
            <select id="emailTone" name="emailTone">
              <option value="professional">Professional</option>
              <option value="friendly" selected>Friendly</option>
              <option value="casual">Casual</option>
              <option value="formal">Formal</option>
            </select>
          </div>
          
          <!-- NEW: Schedule Start Date -->
          <div class="form-group">
            <label for="scheduleStartDate">
              Start Date *
              <span class="help-icon">‚ùì
                <span class="help-tooltip">When should this campaign begin sending? Default is immediately.</span>
              </span>
            </label>
            <input type="datetime-local" id="scheduleStartDate" name="scheduleStartDate" required>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" onclick="closeCustomCampaignModal()" class="secondary">Cancel</button>
          <button type="submit" class="success" style="background: #fd7e14;">‚ú® Create Campaign</button>
        </div>
      </form>
    </div>
  </div>
</div>        
     
<!-- SMS Modal -->
<div id="smsModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2>üí¨ Send SMS to <span id="smsContactName"></span></h2>
      <span class="close" onclick="closeSMSModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="smsMessage">Message</label>
        <textarea id="smsMessage" placeholder="Type your message or use AI to generate..." style="min-height: 120px;"></textarea>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 15px;">
        <div style="display: flex; gap: 10px;">
          <button onclick="generateAISMS()" class="success" style="background: #17a2b8;">
            ü§ñ AI Generate
          </button>
          <button id="aiReviseBtn" onclick="reviseAISMS()" class="warning" style="display: none;">
            ‚ú® AI Revise
          </button>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="closeSMSModal()" class="secondary">Cancel</button>
          <button onclick="sendSMS()" class="success">üì§ Send SMS</button>
        </div>
      </div>
      
      <div id="smsStatus" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
    </div>
  </div>
</div>
<!-- Look Alike Modal -->
<div id="lookAlikeModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2>üîé Generate Look-Alike Contacts</h2>
      <span class="close" onclick="closeLookAlikeModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 20px; color: #6699cc;">
        AI will analyze your selected contact(s) and find similar prospects based on their profile characteristics.
      </p>
      
      <div class="form-group">
        <label for="lookAlikeCount">
          Number of Leads to Generate
          <span class="help-icon">‚ùì
            <span class="help-tooltip">Choose how many similar contacts you want to find. Each contact uses 1 credit.</span>
          </span>
        </label>
        <select id="lookAlikeCount">
          <option value="5" selected>5 Leads</option>
          <option value="10">10 Leads</option>
          <option value="15">15 Leads</option>
          <option value="20">20 Leads</option>
          <option value="25">25 Leads</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="lookAlikeGeography">
          Target Geography
          <span class="help-icon">‚ùì
            <span class="help-tooltip">Specify the geographic area to search for similar contacts. You can enter cities, states, regions, or "USA" for nationwide search.</span>
          </span>
        </label>
        <input type="text" 
               id="lookAlikeGeography" 
               placeholder="e.g., California, New York City, Southeast USA, USA" 
               value="USA"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        <div style="font-size: 12px; color: #6699cc; margin-top: 5px;">
          Examples: "California", "New York, New Jersey", "Southeast USA", "San Francisco Bay Area", "USA"
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button onclick="closeLookAlikeModal()" class="secondary">Cancel</button>
        <button onclick="generateLookAlikeContacts()" class="success" style="background: #17a2b8;">üîé Generate</button>
      </div>
    </div>
  </div>
</div>
  
<!-- Hidden audio element for WebRTC calls -->
<audio id="remoteAudio" autoplay playsinline></audio>
<!-- Call Control Modal -->
<div id="callModal" class="modal">
  <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header" style="background: linear-gradient(135deg, #28a745, #20c997);">
      <h2>üìû Call in Progress</h2>
      <span class="close" onclick="closeCallModal()">&times;</span>
    </div>
    <div class="modal-body">
      
      <!-- Contact Info & Status -->
      <div style="text-align: center; padding: 20px 0; border-bottom: 2px solid #e9ecef;">
        <h3 id="callContactName" style="color: #0A3161; margin: 5px 0;">Contact Name</h3>
        <div id="callStatus" style="font-size: 16px; color: #6699cc; margin: 8px 0;">Connecting...</div>
        <div id="callDuration" style="font-size: 28px; font-weight: bold; color: #0A3161; margin: 10px 0;">00:00</div>
      </div>
      
      <!-- Call Script Section -->
      <div id="callScriptSection" style="background: #f8f9fa; border: 2px solid #0A3161; border-radius: 8px; padding: 20px; margin: 25px 0;">
        <h4 style="margin: 0 0 15px 0; color: #0A3161; font-size: 16px; display: flex; align-items: center; gap: 8px;">
          üìã Call Script
        </h4>
        <div id="callScript" style="font-size: 14px; line-height: 1.8; color: #333; white-space: pre-wrap;">
          Loading script...
        </div>
        
        <!-- Skip Wait Button -->
        <button id="skipWaitBtn" onclick="skipScriptWait()" 
                style="display: none; margin-top: 15px; width: 100%; padding: 10px;" 
                class="secondary">
          ‚è≠Ô∏è Start Call Now (Skip Wait)
        </button>
      </div>
      
      <!-- Call Controls -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0;">
        <button id="muteBtn" onclick="toggleMute()" class="secondary" style="padding: 12px; font-size: 15px;">
          üé§ Mute
        </button>
        <button id="holdBtn" onclick="toggleHold()" class="secondary" style="padding: 12px; font-size: 15px;">
          ‚è∏Ô∏è Hold
        </button>
        <button onclick="hangupCall()" class="danger" style="grid-column: span 2; padding: 15px; font-size: 16px;">
          üìû Hang Up
        </button>
      </div>
      
      <!-- Call Notes -->
      <div class="form-group" style="margin-top: 25px;">
        <label for="callNotes" style="font-size: 16px; font-weight: 600; margin-bottom: 10px; display: block;">
          üìù Call Notes
        </label>
        <textarea id="callNotes" 
                  placeholder="Take notes during the call..." 
                  style="min-height: 120px; font-size: 14px; line-height: 1.6; padding: 12px;"></textarea>
        <div style="font-size: 12px; color: #6699cc; margin-top: 5px;">
          üí° Tip: Note key points, objections, and next steps
        </div>
      </div>
      
    </div>
  </div>
</div>
  
  <footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
// Supabase configuration
const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// API endpoints 
const ENDPOINTS = {
  getUserData: 'https://victoryvision.app.n8n.cloud/webhook/user/get',
  getContacts: 'https://victoryvision.app.n8n.cloud/webhook/contacts/get',
  generateContacts: 'https://victoryvision.app.n8n.cloud/webhook/contacts/look',
  addContact: 'https://victoryvision.app.n8n.cloud/webhook/contacts/add',
  updateContact: 'https://victoryvision.app.n8n.cloud/webhook/contacts/update',
  enrichContacts: 'https://victoryvision.app.n8n.cloud/webhook/contacts/enrich',
  uploadCSV: 'https://victoryvision.app.n8n.cloud/webhook/contacts/upload-csv',
  enrollAds: 'https://victoryvision.app.n8n.cloud/webhook/emails/ad-campaign',
  enrollNurture: 'https://victoryvision.app.n8n.cloud/webhook/emails/nurture',
  enrollMeeting: 'https://victoryvision.app.n8n.cloud/webhook/emails/meeting',
  enrollFollowup: 'https://victoryvision.app.n8n.cloud/webhook/emails/followup',
  enrollNewsletter: 'https://victoryvision.app.n8n.cloud/webhook/emails/newsletter',
  removeContact: 'https://victoryvision.app.n8n.cloud/webhook/contacts/remove',
  // NEW ENDPOINTS
  customEmailCampaign: 'https://victoryvision.app.n8n.cloud/webhook/emails/usergenerated',
  createPresentation: 'https://victoryvision.app.n8n.cloud/webhook/presentations/create',
  createSMS: 'https://victoryvision.app.n8n.cloud/webhook/sms/create',
  makeCall: 'https://victoryvision.app.n8n.cloud/webhook/call/make',
  generateScript: 'https://victoryvision.app.n8n.cloud/webhook/call/script'
};

// Global variables
let CUSTOMER_ID = null;
let authToken = null;
let userCredits = { credits: 0 };
let allContacts = [];
let filteredContacts = [];
let selectedContacts = new Set();
let currentContact = null;
let sortField = null;
let sortDirection = 'asc';

// Available table columns with display names
const availableColumns = {
  created: 'Created',
  name: 'Name',
  title: 'Title', 
  company: 'Company',
  domain: 'Domain',
  email: 'Email',
  phone_number: 'Phone',
  industry: 'Industry',
  annual_revenue: 'Revenue',
  employee_count: 'Employees',
  city: 'City',
  school_name: 'School',
  workflow_status: 'Active Workflows',
  last_responded: 'Last Responded',
  last_emailed_date: 'Last Emailed',
  linkedin: 'LinkedIn',
  tags: 'Tags',
  last_opened_date: 'Opened',
  last_called: 'Called',
  customer_journey:'Customer Journey',
  personal_summary: 'Personal Summary',
  company_summary: 'Company Summary',
  personal_priorities: 'Personal Priorities',
  company_priorities: 'Company Priorities',
  client_won_date: 'Client Won Date',
  aiemail: 'AI Email',
  newsletter: 'Newsletter',
  client_ann_est: 'Est. Revenue to Me'
};

// Default visible columns
let visibleColumns = ['last_responded','last_opened_date','last_emailed_date','last_called','name', 'title', 'company', 'email', 'industry', 'tags', 'city','created'];
// Rate limiting
const rateLimiter = {
  calls: [],
  maxCalls: 100,
  windowMs: 60000,
  canMakeCall: function() {
    const now = Date.now();
    this.calls = this.calls.filter(time => time > (now - this.windowMs));
    if (this.calls.length >= this.maxCalls) {
      return false;
    }
    this.calls.push(now);
    return true;
  }
};
// Input sanitization
function sanitizeInput(value) {
  if (typeof value !== 'string') return value;
  return value
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/javascript:/gi, '')
    .replace(/on\w+\s*=/gi, '')
    .trim();
}

function formatDateTime(dateString) {
  if (!dateString || dateString === 'null' || dateString === '') return 'Never';
  
  const date = new Date(dateString);
  
  // Check if date is valid
  if (isNaN(date.getTime())) return dateString;
  
  // Format: MM/DD/YYYY HH:MM AM/PM
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12 || 12;
  
  return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
}
// Draggable columns functionality
let draggedColumn = null;

function makeColumnsDraggable() {
  const headers = document.querySelectorAll('#tableHeader th:not(.checkbox-cell)');
  
  headers.forEach((header, index) => {
    header.draggable = true;
    header.style.cursor = 'move';
    
    header.addEventListener('dragstart', (e) => {
      draggedColumn = index;
      e.dataTransfer.effectAllowed = 'move';
      header.style.opacity = '0.5';
    });
    
    header.addEventListener('dragend', (e) => {
      header.style.opacity = '1';
    });
    
    header.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    
    header.addEventListener('drop', (e) => {
      e.preventDefault();
      const targetIndex = Array.from(headers).indexOf(header);
      
      if (draggedColumn !== null && draggedColumn !== targetIndex) {
        // Reorder visibleColumns array
        const movedColumn = visibleColumns[draggedColumn];
        visibleColumns.splice(draggedColumn, 1);
        visibleColumns.splice(targetIndex, 0, movedColumn);
        
        // Re-render table
        renderTableHeader();
        renderContactsTable();
        makeColumnsDraggable();
      }
    });
  });
}  
// Tour completion tracking
function completeTour() {
  localStorage.setItem('vv_tour_completed_' + window.location.pathname, 'true');
}

function hasCompletedTour() {
  return localStorage.getItem('vv_tour_completed_' + window.location.pathname) === 'true';
}

function startTour() {
  introJs().setOptions({
    showProgress: true,
    showBullets: false,
    exitOnOverlayClick: false,
    nextLabel: 'Next ‚Üí',
    prevLabel: '‚Üê Back',
    doneLabel: 'Complete!',
    skipLabel: 'Skip Tour'
  }).oncomplete(completeTour).onexit(completeTour).start();
}

async function checkAuthentication() {
  console.log('checkAuthentication START');
  try {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    console.log('Session:', session);
    
    if (error) {
      console.error('Auth error:', error);
      return false;
    }

    if (session && session.user) {
      CUSTOMER_ID = session.user.email;
      authToken = session.access_token;
      
      const userEmailEl = document.getElementById('userEmail');
      if (userEmailEl) {
        userEmailEl.textContent = CUSTOMER_ID;
      }
      
      console.log('Auth successful, CUSTOMER_ID:', CUSTOMER_ID);
      return true;
    }

    console.log('No session found');
    return false;
  } catch (e) {
    console.error('Auth check error:', e);
    return false;
  }
}
function redirectToLogin() {
  localStorage.removeItem('vv_session');
  window.location.href = 'login.html';
}

// API call function with rate limiting and error handling
async function apiCall(endpoint, data = {}) {
  if (!rateLimiter.canMakeCall()) {
    throw new Error('Rate limit exceeded. Please wait before making more requests.');
  }

  try {
    const url = endpoint.includes('/user/get') ? 
      `${endpoint}?customer_id=${encodeURIComponent(CUSTOMER_ID)}` : 
      endpoint;
    
    const requestOptions = {
      method: endpoint.includes('/user/get') ? 'GET' : 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Customer-ID': CUSTOMER_ID,
        'Authorization': authToken ? `Bearer ${authToken}` : ''
      }
    };

    if (!endpoint.includes('/user/get')) {
      requestOptions.body = JSON.stringify({
        customer_id: CUSTOMER_ID,
        ...data
      });
    }

    const response = await fetch(url, requestOptions);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}

async function loadUserData() {
  try {
    const response = await apiCall(ENDPOINTS.getUserData);
    console.log('Raw user response:', response);
    
    const userData = Array.isArray(response) ? response[0] : response;
    console.log('User data:', userData);
  
    // Universal credits system
    userCredits = {
      credits: userData.credits || 0
    };
    
    // Store user's VV number and Telnyx info
    window.userVVNumber = userData.vvnumber || null;
    window.userConnectionId = userData.number_id || null;
window.userWebRTCUsername = userData.name ? userData.name.replace(/[\s,]+/g, '') : userData.email;
    window.userWebRTCPassword = userData.sip_password
    // Update subscription medallion
    const medallion = document.getElementById('subscriptionMedallion');
    const plan = userData.subscription_plan || 'Bronze';
    medallion.className = `subscription-medallion ${plan.toLowerCase()}`;
    medallion.querySelector('.plan-name').textContent = plan;
    
    updateCreditsDisplay();
  } catch (error) {
    console.error('Error loading user data:', error);
    showStatus('Error loading user data: ' + error.message, true);
  }
}

  function updateCreditsDisplay() {
  const creditsDisplay = document.getElementById('CreditsDisplay');
  const creditsSpan = document.getElementById('Credits');
  
  if (creditsDisplay) {
    creditsDisplay.textContent = userCredits.credits;
  }
  if (creditsSpan) {
    creditsSpan.textContent = `${userCredits.credits} credits`;
  }
  }
    
async function loadContacts() {
  try {
    console.log('Loading contacts for customer:', CUSTOMER_ID);
    
    if (!CUSTOMER_ID) {
      console.error('No customer ID, cannot load contacts');
      return;
    }
    
    const data = await apiCall(ENDPOINTS.getContacts);
    console.log('Contacts data received:', data);
    
    allContacts = Array.isArray(data) ? data : (data.contacts || []);
    
    if (allContacts.length > 0) {
      console.log('First contact structure:', allContacts[0]);
      console.log('First contact keys:', Object.keys(allContacts[0]));
    }
    
    allContacts = allContacts.map((contact, index) => ({
      ...contact,
      workflow_status: contact.workflow_status || null,
      contact_id: contact.id || contact.contact_id || contact.email || `contact_${index}`
    }));
    
    filteredContacts = [...allContacts];
    
    console.log(`Loaded ${allContacts.length} contacts`);
    
    populateFilterOptions();
    renderContactsTable();
    showStatus(`Loaded ${allContacts.length} contacts`, false);
    
  } catch (error) {
    console.error('Error loading contacts:', error);
    showStatus('Error loading contacts: ' + error.message, true);
    allContacts = [];
    filteredContacts = [];
    renderContactsTable();
  }
}


// NEW: Custom Email Campaign Functions
function showCustomCampaignModal() {
  document.getElementById('customCampaignModal').style.display = 'block';
// Set default start date to now
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Adjust for timezone
  document.getElementById('scheduleStartDate').value = now.toISOString().slice(0, 16);
}

function closeCustomCampaignModal() {
  const modal = document.getElementById('customCampaignModal');
  modal.style.display = 'none';
  document.getElementById('customCampaignForm').reset();
}

// Add contact manually
function showAddContactModal() {
  document.getElementById('addContactModal').style.display = 'block';
}

function closeAddContactModal() {
  const modal = document.getElementById('addContactModal');
  modal.style.display = 'none';
  document.getElementById('addContactForm').reset();
  document.getElementById('addContactForm').removeAttribute('data-contact-id');
  document.querySelector('#addContactModal .modal-header h2').textContent = '‚ûï Add New Contact';
  document.querySelector('#addContactModal button[type="submit"]').textContent = '‚ûï Add Contact';
}

async function handleContactForm(formData, isUpdate = false, contactId = null) {
  try {
    const contactData = {};
    for (let [key, value] of formData.entries()) {
      if (key === 'aiemail' || key === 'newsletter') {
        contactData[key] = true;
      } else {
        contactData[key] = value;
      }
    }
    
    if (!contactData.aiemail) contactData.aiemail = false;
    if (!contactData.newsletter) contactData.newsletter = false;

    if (isUpdate) {
      contactData.contact_id = contactId;
    }

    console.log('Contact data being sent:', contactData);

    // FIX: Use correct endpoint
    const endpoint = isUpdate ? ENDPOINTS.updateContact : ENDPOINTS.addContact;
    console.log('Using endpoint:', endpoint); // Debug log
    
    const result = await apiCall(endpoint, contactData);

    if (result.success !== false) {
      showStatus(`Contact ${isUpdate ? 'updated' : 'added'} successfully!`, false);
      closeAddContactModal();
      await loadContacts();
    } else {
      throw new Error(result.message || `Failed to ${isUpdate ? 'update' : 'add'} contact`);
    }

  } catch (error) {
    console.error(`Error ${isUpdate ? 'updating' : 'adding'} contact:`, error);
    showStatus(`Error ${isUpdate ? 'updating' : 'adding'} contact: ` + error.message, true);
  }
}

// Expand contact button functionality
function expandFirstSelectedContact() {
  if (selectedContacts.size === 0) {
    showStatus('Please select a contact first by checking the checkbox in any row.', true);
    return;
  }
  
  const firstSelectedId = Array.from(selectedContacts)[0];
  const contact = allContacts.find(c => c.id === firstSelectedId);
  
  if (contact) {
    showContactDetails(contact.id);
  } else {
    showStatus('Contact not found.', true);
  }
}

// CSV Upload functionality
function setupCSVUpload() {
  const csvInput = document.getElementById('csvFileInput');
  csvInput.addEventListener('change', handleCSVFile);
}
// Look Alike Modal Functions
function showLookAlikeModal() {
  if (selectedContacts.size === 0) {
    showStatus('Please select at least one contact to find look-alikes', true);
    return;
  }
  document.getElementById('lookAlikeModal').style.display = 'block';
}

function closeLookAlikeModal() {
  document.getElementById('lookAlikeModal').style.display = 'none';
}

async function generateLookAlikeContacts() {
  if (selectedContacts.size === 0) {
    showStatus('Please select contacts first', true);
    return;
  }
  
  const leadCount = parseInt(document.getElementById('lookAlikeCount').value) || 5;
  const geography = document.getElementById('lookAlikeGeography').value.trim() || 'USA';
  
  try {
    const selectedContactsList = Array.from(selectedContacts).map(id => 
      allContacts.find(c => c.contact_id === id || c.id === id || c.email === id)
    ).filter(c => c);
    
    if (selectedContactsList.length === 0) {
      showStatus('No valid contacts selected', true);
      return;
    }
    
    showStatus(`Generating ${leadCount} look-alike contacts in ${geography}...`, false);
    closeLookAlikeModal();
    
    const result = await apiCall(ENDPOINTS.generateContacts, {
      contact_ids: selectedContactsList.map(c => c.contact_id || c.id || c.email),
      num_leads: leadCount,
      geography: geography
    });
    
    if (result.success !== false) {
      showStatus(`Generating ${leadCount} look-alike contacts in ${geography}! They will appear shortly.`, false);
      
      selectedContacts.clear();
      updateSelectedCount();
      
      setTimeout(() => loadContacts(), 3000);
    } else {
      throw new Error(result.message || 'Look-alike generation failed');
    }
    
  } catch (error) {
    console.error('Error generating look-alikes:', error);
    showStatus('Error: ' + error.message, true);
  }
}
  async function handleCSVFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (!file.name.endsWith('.csv')) {
    showStatus('Please select a CSV file', true);
    return;
  }

  try {
    const csvText = await file.text();
    const result = await apiCall(ENDPOINTS.uploadCSV, { 
      csv_data: csvText,
      filename: file.name
    });

    if (result.success !== false) {
      showStatus(`CSV uploaded successfully! Processing ${result.count || 'multiple'} contacts.`, false);
      await loadContacts();
    } else {
      throw new Error(result.message || 'CSV upload failed');
    }

  } catch (error) {
    console.error('Error uploading CSV:', error);
    showStatus('Error uploading CSV: ' + error.message, true);
  }

  event.target.value = '';
}

// Enrich contacts
async function enrichSelectedContacts() {
  if (selectedContacts.size === 0) {
    showStatus('Please select contacts to enrich', true);
    return;
  }
  try {
    const selectedContactsList = Array.from(selectedContacts).map(id => 
      allContacts.find(c => 
        c.contact_id === id || 
        c.id === id || 
        c.email === id || 
        c.linkedin === id
      )
    ).filter(c => c);
    
    if (selectedContactsList.length === 0) {
      showStatus('No valid contacts selected for enrichment', true);
      return;
    }
    
// Show immediate feedback
    showStatus(`Enriching ${selectedContactsList.length} contacts...`, false);
    
    // Process 5 at a time instead of 1 (5x faster)
    const BATCH_SIZE = 5;
    let completed = 0;
    
    for (let i = 0; i < selectedContactsList.length; i += BATCH_SIZE) {
      const batch = selectedContactsList.slice(i, i + BATCH_SIZE);
      
      await Promise.all(batch.map(contact => {
        const enrichmentData = {
          contact: {
            id: contact.contact_id || contact.id || contact.email,
            email: contact.email || '',
            linkedin: contact.linkedin || '',
            name: contact.name || '',
            domain: contact.domain || '',
            address: contact.address || '',
            tags: contact.tags || '',
            notes: contact.notes || '',
            industry: contact.industry || '',
            title: contact.title || '',
            company: contact.company || ''
          }
        };
        console.log('Enriching contact:', enrichmentData);
        return apiCall(ENDPOINTS.enrichContacts, enrichmentData).catch(err => {
          console.error('Enrich failed:', err);
        });
      }));
      
      completed += batch.length;
      showStatus(`Enriched ${completed} of ${selectedContactsList.length} contacts...`, false);
    }
    
    showStatus(`Enrichment complete! ${selectedContactsList.length} contacts processed.`, false);
    selectedContacts.clear();
    updateSelectedCount();
    setTimeout(() => loadContacts(), 5000);

} catch (error) {
    console.error('Error enriching contacts:', error);
    showStatus('Error enriching contacts: ' + error.message, true);
  }
}
    
// Show contact details modal
function showContactDetails(contactId, event) {
  console.log('showContactDetails called with:', contactId, event);
  
  if (event && event.target.type === 'checkbox') {
    console.log('Checkbox clicked, not opening modal');
    return;
  }
  if (event) event.stopPropagation();
  
  const contact = allContacts.find(c => 
    c.contact_id === contactId || 
    c.id === contactId || 
    c.email === contactId
  );
  
  console.log('Found contact:', contact);
  
  if (!contact) {
    console.error('No contact found for ID:', contactId);
    return;
  }
  
  currentContact = contact;
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modal = document.getElementById('contactModal');
  
  modalTitle.textContent = contact.name || 'Contact Details';
  
  modalBody.innerHTML = `
    <div class="contact-details">
      ${Object.entries(contact).map(([key, value]) => {
        if (!value || key === 'id' || key === 'contact_id' || value === 'null' || value === '') return '';
        const label = availableColumns[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        return renderDetailField(label, value, key === 'linkedin' || key === 'email');
      }).join('')}
    </div>
    
    <div class="modal-actions">
      <button onclick="sendEmailToContact('${contact.email || ''}')" class="success" style="background: #17a2b8;">‚úâÔ∏è Send Email</button>
      <button onclick="createMeetingForContact('${contactId}')" class="success" style="background: #0A3161;">üìÖ Create Meeting</button>
      <button onclick="createSMSForContact('${contactId}')" class="success" style="background: #ffc107; color: #000;">üí¨ Send SMS</button>
      <button onclick="makeCallToContact('${contactId}')" class="success" style="background: #dc3545;">üìû Make Call</button>
      <button onclick="editContact('${contactId}')" class="success">‚úèÔ∏è Edit Contact</button>
      <button onclick="deleteContact('${contactId}')" class="danger">üóëÔ∏è Delete Contact</button>
    </div>
  `;
  
  modal.style.display = 'block';
}

function renderDetailField(label, value, isLink = false) {
  if (!value || value === 'null' || value === '') return '';
  
  const displayValue = isLink && value.toString().startsWith('http') ? 
    `<a href="${value}" target="_blank" style="color: #0A3161;">${value}</a>` : 
    value;
  
  return `
    <div class="detail-group">
      <div class="detail-label">${label}</div>
      <div class="detail-value">${displayValue}</div>
    </div>
  `;
}

// Email button redirects to messages page with compose open
function sendEmailToContact(email) {
  if (!email) {
    showStatus('Contact email not available', true);
    return;
  }
  
  // Store contact info for messages page
  sessionStorage.setItem('composeToEmail', email);
  if (currentContact) {
    sessionStorage.setItem('composeToName', currentContact.name || '');
  }
  
  // Redirect to messages page
  window.location.href = '/messages';
  closeModal();
}

// NEW: Contact action functions
async function createMeetingForContact(contactId) {
  const contact = allContacts.find(c => c.contact_id === contactId || c.id === contactId);
  if (!contact) return;
  
  try {
    await apiCall(ENDPOINTS.enrollMeeting, { 
      contact_id: contactId,
      email: contact.email,
      name: contact.name
    });
    showStatus('Meeting request sent successfully!', false);
    closeModal();
  } catch (error) {
    console.error('Error creating meeting:', error);
    showStatus('Error creating meeting: ' + error.message, true);
  }
}
async function createSMSForContact(contactId) {
  const contact = allContacts.find(c => c.contact_id === contactId || c.id === contactId);
  if (!contact || !contact.phone_number) {
    showStatus('No phone number available for this contact', true);
    return;
  }
  
  // Store contact info for SMS modal
  currentSMSContact = contact;
  
  // Show SMS modal
  document.getElementById('smsContactName').textContent = contact.name || contact.email;
  document.getElementById('smsMessage').value = '';
  document.getElementById('aiReviseBtn').style.display = 'none';
  document.getElementById('smsModal').style.display = 'block';  
  closeModal(); // Close contact details modal
}
function editContact(contactId) {
  const contact = allContacts.find(c => 
    c.contact_id === contactId || 
    c.id === contactId || 
    c.email === contactId
  );
  if (!contact) return;
 const contactDetailsModal = document.getElementById('contactModal');
  if (contactDetailsModal) {
    contactDetailsModal.style.display = 'none';
  }  
  const modal = document.getElementById('addContactModal');
  const form = document.getElementById('addContactForm');
  
  // Reset and populate form
  form.reset();
  
  // Populate all fields
  document.getElementById('name').value = contact.name || '';
  document.getElementById('email').value = contact.email || '';
  document.getElementById('title').value = contact.title || '';
  document.getElementById('company').value = contact.company || '';
  document.getElementById('domain').value = contact.domain || '';
  document.getElementById('phone_number').value = contact.phone_number || '';
  document.getElementById('linkedin').value = contact.linkedin || '';
  document.getElementById('industry').value = contact.industry || '';
  document.getElementById('city').value = contact.city || '';
  document.getElementById('annual_revenue').value = contact.annual_revenue || '';
  document.getElementById('employee_count').value = contact.employee_count || '';
  document.getElementById('client_won_date').value = contact.client_won_date || '';
  document.getElementById('last_opened_date').value = contact.last_opened_date || '';
  document.getElementById('last_called').value = contact.last_called || '';
  document.getElementById('customer_journey').value = contact.customer_journey || '';
  document.getElementById('personal_summary').value = contact.personal_summary || '';
  document.getElementById('company_summary').value = contact.company_summary || '';
  // document.getElementById('created').value = contact.created || ''; // ‚ùå REMOVE THIS LINE  
  document.getElementById('personal_priorities').value = contact.personal_priorities || '';
  document.getElementById('company_priorities').value = contact.company_priorities || '';
  document.getElementById('tags').value = contact.tags || '';
  document.getElementById('workflow').value = contact.workflow || '';
  document.getElementById('aiemail').checked = contact.aiemail || false;
  document.getElementById('newsletter').checked = contact.newsletter || false;
  
  // Set EDIT mode
  document.querySelector('#addContactModal .modal-header h2').textContent = '‚úèÔ∏è Edit Contact';
  document.querySelector('#addContactModal button[type="submit"]').textContent = 'üíæ Update Contact';
  form.setAttribute('data-contact-id', contactId);
  
  // Show modal
  modal.style.display = 'block';
}
async function deleteContact(contactId) {
  if (!confirm('Are you sure you want to delete this contact?')) {
    return;
  }
  
  try {
    await apiCall(ENDPOINTS.removeContact, {
      contact_id: contactId
    });
    
    showStatus('Contact deleted successfully!', false);
    closeModal();
    await loadContacts();
    
  } catch (error) {
    console.error('Error deleting contact:', error);
    showStatus('Error deleting contact: ' + error.message, true);
  }
}

// Modal only closes on Cancel, X, or Esc key
function closeModal() {
  const modal = document.getElementById('contactModal');
  if (modal) {
    modal.style.display = 'none';
  }
  currentContact = null;
}

// Column management
function initializeColumnSelector() {
  const columnList = document.getElementById('columnList');
  
  Object.entries(availableColumns).forEach(([key, label]) => {
    const item = document.createElement('div');
    item.className = 'column-item';
    item.innerHTML = `
      <input type="checkbox" id="col_${key}" value="${key}" ${visibleColumns.includes(key) ? 'checked' : ''}>
      <label for="col_${key}">${label}</label>
    `;
    columnList.appendChild(item);
    
    item.querySelector('input').addEventListener('change', updateVisibleColumns);
  });
}

function updateVisibleColumns() {
  const checkboxes = document.querySelectorAll('#columnList input[type="checkbox"]');
  visibleColumns = Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.value);
  
  if (!visibleColumns.includes('name')) {
    visibleColumns.unshift('name');
  }
  
  renderTableHeader();
  renderContactsTable();
}

function renderTableHeader() {
  const header = document.getElementById('tableHeader');
  
  let headerHTML = `
    <th class="checkbox-cell">
      <input type="checkbox" id="selectAllCheckbox">
    </th>
  `;
  
  visibleColumns.forEach(column => {
    const label = availableColumns[column];
    const sortIcon = getSortIcon(column);
    headerHTML += `
      <th onclick="sortBy('${column}')" style="cursor: pointer;">
        ${label} ${sortIcon}
      </th>
    `;
  });
  
  header.innerHTML = headerHTML;
  
  document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
    if (e.target.checked) selectAll();
    else deselectAll();
  });
 // Enable draggable columns
  makeColumnsDraggable();
}

function getSortIcon(column) {
  if (sortField !== column) {
    return '<span class="sort-indicator">‚ÜïÔ∏è</span>';
  }
  return `<span class="sort-indicator active">${sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>`;
}

function sortBy(field) {
  if (sortField === field) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortField = field;
    sortDirection = 'asc';
  }
  
  filteredContacts.sort((a, b) => {
    let aVal = a[field] || '';
    let bVal = b[field] || '';
    
    if (field === 'annual_revenue' || field === 'employee_count') {
      aVal = parseFloat(aVal.toString().replace(/[^0-9.]/g, '')) || 0;
      bVal = parseFloat(bVal.toString().replace(/[^0-9.]/g, '')) || 0;
    } else if (field === 'last_responded' || field === 'last_emailed_date' || field === 'client_won_date') {
      aVal = aVal ? new Date(aVal).getTime() : 0;
      bVal = bVal ? new Date(bVal).getTime() : 0;
    } else {
      aVal = aVal.toString().toLowerCase();
      bVal = bVal.toString().toLowerCase();
    }
    
    if (sortDirection === 'asc') {
      return aVal > bVal ? 1 : -1;
    } else {
      return aVal < bVal ? 1 : -1;
    }
  });
  
  renderTableHeader();
  renderContactsTable();
}

// Render contacts table
function renderContactsTable() {
  const tbody = document.getElementById('contactsTableBody');
  
  if (filteredContacts.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="${visibleColumns.length + 1}" class="empty-state">
          <h3>No contacts found</h3>
          <p>Generate new contacts or adjust your filters.</p>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = filteredContacts.map(contact => {
    const contactId = contact.contact_id || contact.id || contact.email;
    
    let rowHTML = `
      <tr data-contact-id="${contactId}">
        <td class="checkbox-cell">
          <input type="checkbox" 
                 value="${contactId}" 
                 ${selectedContacts.has(contactId) ? 'checked' : ''}
                 onchange="toggleContactSelection('${contactId}')">
        </td>
    `;
    
    visibleColumns.forEach(column => {
      rowHTML += `<td>${formatCellValue(contact, column)}</td>`;
    });
    
    rowHTML += '</tr>';
    return rowHTML;
  }).join('');
  
  // Add click event listeners after rendering
  const rows = tbody.querySelectorAll('tr[data-contact-id]');
  
  rows.forEach(row => {
    const contactId = row.getAttribute('data-contact-id');
    
    row.addEventListener('click', (event) => {
      if (event.target.type === 'checkbox' || event.target.tagName === 'A') {
        return;
      }
      
      if (!contactId || contactId === 'undefined') {
        console.error('No valid contact ID found on row');
        return;
      }
      
      showContactDetails(contactId, event);
    });
    
    row.style.cursor = 'pointer';
  });
}
function formatCityState(contact) {
  // Priority: location > city+state > address parsing
  if (contact.location && contact.location.includes(',')) {
    const parts = contact.location.split(',').map(s => s.trim());
    if (parts.length >= 2) {
      return `${parts[0]}, ${parts[1]}`;
    }
  }
  
  if (contact.city && contact.state) {
    return `${contact.city}, ${contact.state}`;
  }
  
  if (contact.address) {
    const match = contact.address.match(/,\s*([^,]+),\s*([A-Z]{2})/);
    if (match) {
      return `${match[1]}, ${match[2]}`;
    }
  }
  
  return contact.city || contact.location || 'N/A';
}

function formatCellValue(contact, column) {
  const value = contact[column];
  
  switch (column) {
    case 'name':
      return `<span class="contact-name">${value || 'N/A'}</span>`;
    case 'annual_revenue':
      return `<span class="revenue-cell">${formatRevenue(value)}</span>`;
    case 'workflow_status':
      return formatWorkflowBadges(value);
    case 'linkedin':
      return value ? `<a href="${value}" target="_blank" style="color: #0A3161;" onclick="event.stopPropagation();">View</a>` : 'N/A';
    case 'email':
      return value ? `<a href="mailto:${value}" style="color: #0A3161;" onclick="event.stopPropagation();">${value}</a>` : 'N/A';
    case 'created':
      return formatDateTime(value);
    case 'last_responded':
    case 'last_emailed_date':
    case 'client_won_date':
      return formatDate(value);
    case 'tags':
      return formatTags(value);
    case 'city':
      return formatCityState(contact);
    case 'aiemail':
    case 'newsletter':
      return value ? '‚úÖ' : '‚ùå';
    default:
      return value || 'N/A';
  }
}
function formatCellValue(contact, column) {
  const value = contact[column];
  
  switch (column) {
    case 'name':
      return `<span class="contact-name">${value || 'N/A'}</span>`;
    case 'annual_revenue':
      return `<span class="revenue-cell">${formatRevenue(value)}</span>`;
    case 'workflow_status':
      return formatWorkflowBadges(value);
    case 'linkedin':
      return value ? `<a href="${value}" target="_blank" style="color: #0A3161;" onclick="event.stopPropagation();">View</a>` : 'N/A';
    case 'email':
      return value ? `<a href="mailto:${value}" style="color: #0A3161;" onclick="event.stopPropagation();">${value}</a>` : 'N/A';
   case 'created':
      return formatDateTime(value);
    case 'last_responded':
    case 'last_emailed_date':
    case 'client_won_date':
      return formatDate(value);
    case 'city':
        return formatCityState(contact);
    case 'tags':
      return formatTags(value);
    case 'aiemail':
    case 'newsletter':
      return value ? '‚úÖ' : '‚ùå';
    default:
      return value || 'N/A';
  }
}

function formatRevenue(revenue) {
  if (!revenue) return 'N/A';
  const num = parseFloat(revenue.toString().replace(/[^0-9.]/g, ''));
  if (num >= 1000000) {
    return `${(num / 1000000).toFixed(1)}M`;
  } else if (num >= 1000) {
    return `${(num / 1000).toFixed(0)}K`;
  }
  return `${num}`;
}

function formatWorkflowBadges(workflows) {
  if (!workflows || workflows === 'null' || workflows === '') {
    return '<span style="color: #999; font-style: italic;">None</span>';
  }
  
  return workflows.split(',')
    .filter(w => w.trim() && w.trim() !== 'null')
    .map(workflow => `<span class="workflow-badge active">${workflow.trim()}</span>`)
    .join(' ') || '<span style="color: #999; font-style: italic;">None</span>';
}

function formatTags(tags) {
  if (!tags) return 'N/A';
  return tags.split(',').map(tag => `<span class="workflow-badge">${tag.trim()}</span>`).join(' ');
}

function formatDate(dateStr) {
  if (!dateStr) return 'Never';
  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = Math.abs(now - date);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  
  return date.toLocaleDateString();
}

function toggleContactSelection(contactId) {
  if (selectedContacts.has(contactId)) {
    selectedContacts.delete(contactId);
  } else {
    selectedContacts.add(contactId);
  }
  updateSelectedCount();
}

function selectAll() {
  filteredContacts.forEach(contact => {
    const id = contact.contact_id || contact.id || contact.email;
    selectedContacts.add(id);
  });
  renderContactsTable();
  updateSelectedCount();
}

function deselectAll() {
  selectedContacts.clear();
  renderContactsTable();
  updateSelectedCount();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = `${selectedContacts.size} selected`;
  document.getElementById('selectAllCheckbox').checked = selectedContacts.size === filteredContacts.length && filteredContacts.length > 0;
}

async function enrollInWorkflows() {
  const selectedWorkflows = getSelectedWorkflows();
  
  if (selectedContacts.size === 0) {
    showStatus('Please select contacts to enroll', true);
    return;
  }
  
  if (selectedWorkflows.length === 0) {
    showStatus('Please select at least one workflow', true);
    return;
  }
  
  try {
    const selectedContactsList = Array.from(selectedContacts).map(id => 
      allContacts.find(c => 
        c.contact_id === id || 
        c.id === id || 
        c.email === id
      )
    ).filter(c => c && c.email);

for (const workflow of selectedWorkflows) {
      let endpoint;
      let useCustomCampaign = false;
      let campaignPrompt = '';
      
      switch(workflow) {
        case 'ads':
          endpoint = ENDPOINTS.enrollAds;
          break;
        case 'nurture':
          useCustomCampaign = true;
          campaignPrompt = 'Create a thoughtful lead nurture email sequence that provides valuable educational content. Focus on building trust and demonstrating expertise without being overly promotional. Include helpful tips, industry insights, and resources that genuinely help the recipient solve their problems.';
          break;
        case 'meeting':
          endpoint = ENDPOINTS.enrollMeeting;
          break;
     case 'newsletter':
          endpoint = ENDPOINTS.enrollNewsletter;
          break;
        case 'followup':
          useCustomCampaign = true;
          campaignPrompt = 'Create a professional follow-up email sequence to re-engage prospects who have gone quiet. Be respectful of their time while reminding them of the value you can provide. Include a soft call-to-action and make it easy for them to respond or schedule a conversation.';
          break;
        default:
          endpoint = ENDPOINTS.enrollNurture;
      }
      
      if (useCustomCampaign) {
        try {
          await apiCall(ENDPOINTS.customEmailCampaign, {
            campaign_name: workflow === 'nurture' ? 'Lead Nurture Sequence' : 'Follow-up Sequence',
            description: campaignPrompt,
            email_count: 3,
            tone: 'professional',
            schedule_start_date: new Date().toISOString(),
            selected_contacts: selectedContactsList.map(c => c.contact_id || c.id || c.email)
          });
          
          for (const contact of selectedContactsList) {
            const currentWorkflows = contact.workflow_status ? 
              contact.workflow_status.split(',').filter(w => w.trim() && w !== 'null') : [];
            if (!currentWorkflows.includes(workflow)) {
              currentWorkflows.push(workflow);
              contact.workflow_status = currentWorkflows.join(',');
            }
            contact.last_emailed_date = new Date().toISOString();
          }
          
        } catch (workflowError) {
          console.error(`Error enrolling in ${workflow}:`, workflowError);
        }
      } else {
        for (const contact of selectedContactsList) {
          try {
            await apiCall(endpoint, {
              email: contact.email,
              name: contact.name,
              workflow: workflow,
              contact_id: contact.contact_id || contact.id || contact.email
            });
            
            const currentWorkflows = contact.workflow_status ? 
              contact.workflow_status.split(',').filter(w => w.trim() && w !== 'null') : [];
            if (!currentWorkflows.includes(workflow)) {
              currentWorkflows.push(workflow);
              contact.workflow_status = currentWorkflows.join(',');
            }
            
            contact.last_emailed_date = new Date().toISOString();
            
          } catch (workflowError) {
            console.error(`Error enrolling ${contact.email} in ${workflow}:`, workflowError);
          }
        }
      }
    }    
    showStatus(`Enrolled ${selectedContactsList.length} contacts in ${selectedWorkflows.length} workflows`, false);
    selectedContacts.clear();
    updateSelectedCount();
    renderContactsTable();
    
    document.querySelectorAll('#workflowList input[type="checkbox"]').forEach(cb => cb.checked = false);
    
  } catch (error) {
    console.error('Error enrolling in workflows:', error);
    showStatus('Error enrolling contacts in workflows: ' + error.message, true);
  }
}

function getSelectedWorkflows() {
  return Array.from(document.querySelectorAll('#workflowList input[type="checkbox"]:checked'))
    .map(cb => cb.value);
}

function populateFilterOptions() {
  const industries = [...new Set(allContacts.map(c => c.industry).filter(Boolean))].sort();
  const cities = [...new Set(allContacts.map(c => c.city).filter(Boolean))].sort();
  const schools = [...new Set(allContacts.map(c => c.school_name).filter(Boolean))].sort();
  const tags = [...new Set(allContacts.flatMap(c => (c.tags || '').split(',').filter(tag => tag.trim())))].sort();
  
  populateSelect('industryFilter', industries);
  populateSelect('cityFilter', cities);
  populateSelect('schoolFilter', schools);
  populateSelect('tagsFilter', tags);
}

function populateSelect(selectId, options) {
  const select = document.getElementById(selectId);
  const currentValue = select.value;
  const defaultOption = select.querySelector('option[value=""]').textContent;
  
  select.innerHTML = `<option value="">${defaultOption}</option>`;
  options.forEach(option => {
    select.innerHTML += `<option value="${option}">${option}</option>`;
  });
  
  select.value = currentValue;
}

function applyFilters() {
  const searchTerm = sanitizeInput(document.getElementById('searchFilter').value.toLowerCase());
  const industry = document.getElementById('industryFilter').value;
  const city = document.getElementById('cityFilter').value;
  const revenue = document.getElementById('revenueFilter').value;
  const school = document.getElementById('schoolFilter').value;
  const workflow = document.getElementById('workflowFilter').value;
  const tags = document.getElementById('tagsFilter').value;
  const createdFrom = document.getElementById('createdFromFilter').value;
  const createdTo = document.getElementById('createdToFilter').value;
  filteredContacts = allContacts.filter(contact => {
    if (searchTerm) {
      const searchableText = [
        contact.name || '',
        contact.title || '',
        contact.company || '',
        contact.email || '',
        contact.industry || '',
        contact.tags || ''
      ].join(' ').toLowerCase();
      
      if (!searchableText.includes(searchTerm)) {
        return false;
      }
    }

    if (industry && contact.industry !== industry) return false;
    if (city && contact.city !== city) return false;
    if (school && contact.school_name !== school) return false;

    if (revenue) {
      const contactRevenue = parseFloat((contact.annual_revenue || '0').toString().replace(/[^0-9.]/g, ''));
      switch (revenue) {
        case '0-1M':
          if (contactRevenue >= 1000000) return false;
          break;
        case '1M-10M':
          if (contactRevenue < 1000000 || contactRevenue >= 10000000) return false;
          break;
        case '10M-50M':
          if (contactRevenue < 10000000 || contactRevenue >= 50000000) return false;
          break;
        case '50M+':
          if (contactRevenue < 50000000) return false;
          break;
      }
    }

    if (workflow) {
      const contactWorkflows = (contact.workflow_status || '').split(',').filter(w => w.trim() && w !== 'null');
      if (!contactWorkflows.includes(workflow)) return false;
    }

    if (tags) {
      const contactTags = (contact.tags || '').split(',').filter(t => t.trim());
      if (!contactTags.includes(tags)) return false;
    }

    // Date filter for created field
    if (createdFrom || createdTo) {
      const contactCreated = contact.created ? new Date(contact.created) : null;
      if (!contactCreated) return false;
      
      if (createdFrom) {
        const fromDate = new Date(createdFrom);
        fromDate.setHours(0, 0, 0, 0);
        if (contactCreated < fromDate) return false;
      }
      
      if (createdTo) {
        const toDate = new Date(createdTo);
        toDate.setHours(23, 59, 59, 999);
        if (contactCreated > toDate) return false;
      }
    }
    return true;
  });

  renderContactsTable();
}

function clearFilters() {
  document.getElementById('searchFilter').value = '';
  document.getElementById('industryFilter').value = '';
  document.getElementById('cityFilter').value = '';
  document.getElementById('revenueFilter').value = '';
  document.getElementById('schoolFilter').value = '';
  document.getElementById('workflowFilter').value = '';
  document.getElementById('tagsFilter').value = '';
  document.getElementById('createdFromFilter').value = '';
  document.getElementById('createdToFilter').value = '';
  applyFilters();
}

async function deleteSelectedContacts() {
  if (selectedContacts.size === 0) {
    showStatus('Please select contacts to delete', true);
    return;
  }
  if (!confirm(`Delete ${selectedContacts.size} selected contacts?`)) return;
  try {
    for (const contactId of selectedContacts) {
      await apiCall(ENDPOINTS.removeContact, { contact_id: contactId });
    }
    showStatus(`Deleted ${selectedContacts.size} contacts`, false);
    selectedContacts.clear();
    await loadContacts();
  } catch (error) {
    console.error('Error deleting contacts:', error);
    showStatus('Error deleting contacts', true);
  }
}

function showStatus(message, isError = false) {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.textContent = message;
  statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
  statusDiv.style.display = 'block';
  setTimeout(() => statusDiv.style.display = 'none', 5000);
}

function setupEventListeners() {
  document.getElementById('expandContactBtn').addEventListener('click', expandFirstSelectedContact);
  document.getElementById('addContactForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const contactId = e.target.getAttribute('data-contact-id');
    if (contactId) {
      await handleContactForm(formData, true, contactId);
    } else {
      await handleContactForm(formData, false);
    }
  });
document.getElementById('customCampaignForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (selectedContacts.size === 0) {
    showStatus('Please select contacts to send the campaign to', true);
    return;
  }
  const formData = new FormData(e.target);
  const campaignData = {
    campaign_name: formData.get('campaignName'),
    description: formData.get('campaignDescription'),
    email_count: parseInt(formData.get('emailCount')),
    tone: formData.get('emailTone'),
    schedule_start_date: formData.get('scheduleStartDate'), // ‚úÖ ADD THIS
    selected_contacts: Array.from(selectedContacts)
  };
  try {
    await apiCall(ENDPOINTS.customEmailCampaign, campaignData);
    showStatus(`Custom email campaign "${campaignData.campaign_name}" scheduled successfully!`, false);
    closeCustomCampaignModal();
    selectedContacts.clear();
    updateSelectedCount();
  } catch (error) {
    showStatus('Error creating campaign: ' + error.message, true);
  }
});
  
  document.getElementById('refreshBtn').addEventListener('click', loadContacts);
  document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
  document.getElementById('selectAllBtn').addEventListener('click', selectAll);
  document.getElementById('deselectAllBtn').addEventListener('click', deselectAll);
  document.getElementById('enrollWorkflowsBtn').addEventListener('click', enrollInWorkflows);
  document.getElementById('enrichContactsBtn').addEventListener('click', enrichSelectedContacts);
  document.getElementById('lookAlikeBtn').addEventListener('click', showLookAlikeModal);
  document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedContacts);
  let searchTimeout;
  document.getElementById('searchFilter').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 300);
  });
['industryFilter', 'cityFilter', 'revenueFilter', 'schoolFilter', 'workflowFilter', 'tagsFilter', 'createdFromFilter', 'createdToFilter'].forEach(id => {
    const element = document.getElementById(id);
    if (element) element.addEventListener('change', applyFilters);
  });
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      closeModal();
      closeAddContactModal();
      closeCustomCampaignModal();
    }
  });
  setupCSVUpload();
}

async function init() {
  console.log('========== INIT STARTING ==========');
  try {
    console.log('Step 1: Calling checkAuthentication...');
    const isAuthenticated = await checkAuthentication();
    console.log('Step 2: isAuthenticated =', isAuthenticated);
    console.log('Step 3: CUSTOMER_ID =', CUSTOMER_ID);
    
    if (isAuthenticated) {
      console.log('Step 4: Auth SUCCESS - initializing...');
      initializeColumnSelector();
      renderTableHeader();
      setupEventListeners();
      
      console.log('Step 5: Loading user data and contacts...');
      await Promise.all([loadUserData(), loadContacts()]);
      console.log('Step 6: Data loaded successfully');
      
      // Initialize WebRTC after user data loads
      if (window.userVVNumber) {
        initializeTelnyxWebRTC().catch(err => console.warn('WebRTC init failed:', err));
      }
      
      if (!hasCompletedTour()) {
        setTimeout(() => startTour(), 1000);
      }
    } else {
      console.log('Step 4: Auth FAILED - redirecting');
      redirectToLogin();
    }
  } catch (error) {
    console.error('ERROR in init():', error);
    showStatus('Failed to initialize. Please refresh.', true);
  }
}

setInterval(async function() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      redirectToLogin();
    } else {
      authToken = session.access_token;
    }
  } catch (e) {
    console.error('Session check failed:', e);
  }
}, 300000);

document.addEventListener('visibilitychange', async function() {
  if (!document.hidden) {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        redirectToLogin();
      } else {
        authToken = session.access_token;
      }
    } catch (e) {
      console.error('Visibility auth check failed:', e);
    }
  }
});

// SMS Modal Functions
let currentSMSContact = null;

function closeSMSModal() {
  document.getElementById('smsModal').style.display = 'none';
  document.getElementById('smsMessage').value = '';
  document.getElementById('aiReviseBtn').style.display = 'none';
  currentSMSContact = null;
}

async function generateAISMS() {
  if (!currentSMSContact) {
    showStatus('No contact selected', true);
    return;
  }
  
  const statusDiv = document.getElementById('smsStatus');
  statusDiv.textContent = 'Generating AI message...';
  statusDiv.style.display = 'block';
  statusDiv.style.background = '#d1ecf1';
  statusDiv.style.color = '#0c5460';
  
  try {
    const response = await apiCall('https://victoryvision.app.n8n.cloud/webhook/sms/ai', {
      contact_id: currentSMSContact.contact_id || currentSMSContact.id,
      contact_name: currentSMSContact.name,
      phone: currentSMSContact.phone_number,
      contact_info: {
        title: currentSMSContact.title,
        company: currentSMSContact.company,
        industry: currentSMSContact.industry
      }
    });
    
    console.log('AI SMS Response:', response);
    
 // Handle array response from n8n
const data = Array.isArray(response) ? response[0] : response;
const aiMessage = data.message || data.sms || data.body || data.text || '';    

    if (!aiMessage) {
      throw new Error('No message returned from AI');
    }
    
    document.getElementById('smsMessage').value = aiMessage;
    document.getElementById('aiReviseBtn').style.display = 'inline-block';
    
    statusDiv.textContent = 'AI message generated! Edit if needed.';
    statusDiv.style.background = '#d4edda';
    statusDiv.style.color = '#155724';
    
    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
  } catch (error) {
    console.error('Error generating AI SMS:', error);
    statusDiv.textContent = 'Error: ' + error.message;
    statusDiv.style.background = '#f8d7da';
    statusDiv.style.color = '#721c24';
  }
}

async function reviseAISMS() {
  await generateAISMS(); // Just regenerate with same logic
}

async function sendSMS() {
  if (!currentSMSContact) return;
  
  const message = document.getElementById('smsMessage').value.trim();
  if (!message) {
    showStatus('Please enter a message or generate one with AI', true);
    return;
  }
  
  // Show immediate feedback
  const statusDiv = document.getElementById('smsStatus');
  statusDiv.textContent = 'Sending SMS...';
  statusDiv.style.display = 'block';
  statusDiv.style.background = '#d1ecf1';
  statusDiv.style.color = '#0c5460';
  
  try {
    // Don't await - send and close immediately
    apiCall(ENDPOINTS.createSMS, {
      contact_id: currentSMSContact.contact_id || currentSMSContact.id,
      phone: currentSMSContact.phone_number,
      name: currentSMSContact.name,
      message: message
    }).then(() => {
      console.log('SMS sent successfully');
    }).catch(err => {
      console.error('SMS send error:', err);
    });
    
    // Close modal immediately - don't wait for response
    showStatus('SMS sending...', false);
    closeSMSModal();
    
  } catch (error) {
    console.error('Error sending SMS:', error);
    showStatus('Error sending SMS: ' + error.message, true);
  }
}
// Call Control Functions
let currentCallContact = null;
let callStartTime = null;
let callTimer = null;
let callControlId = null;
let isMuted = false;
let isRecording = false;
let isOnHold = false;

function closeCallModal() {
  if (callTimer) clearInterval(callTimer);
  document.getElementById('callModal').style.display = 'none';
  currentCallContact = null;
  callStartTime = null;
  callControlId = null;
}

function startCallTimer() {
  if (callTimer) clearInterval(callTimer);
  callStartTime = Date.now();
  
  callTimer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('callDuration').textContent = 
      `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, 1000);
}

// WebRTC Client - Global
let telnyxClient = null;
let currentCall = null;

// Format phone number to E.164 format for Telnyx
function formatPhoneE164(phoneNumber) {
  if (!phoneNumber) return null;
  
  // Remove all non-digit characters except leading +
  let cleaned = phoneNumber.replace(/[^\d+]/g, '');
  
  // Remove leading + if present (we'll add it back)
  if (cleaned.startsWith('+')) {
    cleaned = cleaned.substring(1);
  }
  
  // If it doesn't start with country code, assume US (1)
  if (cleaned.length === 10) {
    cleaned = '1' + cleaned;
  }
  
  // Add the + prefix
  return '+' + cleaned;
}

async function initializeTelnyxWebRTC() {
  if (telnyxClient) return;
  
  if (!window.userVVNumber || !window.userWebRTCPassword) {
    console.warn('WebRTC not configured for this user');
    return;
  }
  
  try {
   telnyxClient = new window.TelnyxWebRTC.TelnyxRTC({
      login: window.userWebRTCUsername,
      password: window.userWebRTCPassword,
      ringtoneFile: null,
      ringbackFile: null
    });
    
    telnyxClient.on('telnyx.ready', () => {
      console.log('Telnyx WebRTC ready');
    });
    
    telnyxClient.on('telnyx.error', (error) => {
  console.error('Telnyx error FULL DETAILS:', JSON.stringify(error, null, 2));
  showStatus('WebRTC error: ' + (error.message || JSON.stringify(error)), true);
});
    
    telnyxClient.on('telnyx.notification', (notification) => {
      handleCallNotification(notification);
    });
    
    await telnyxClient.connect();
    console.log('WebRTC client connected');
    
  } catch (error) {
    console.error('Error initializing WebRTC:', error);
    showStatus('Failed to initialize calling: ' + error.message, true);
  }
}
function handleCallNotification(notification) {
  console.log('Call notification:', notification);
  
  if (notification.type === 'callUpdate') {
    handleCallUpdate(notification.call);
  } else if (notification.type === 'userMediaError') {
    showStatus('Microphone access denied', true);
    closeCallModal();
  }
}

function handleCallUpdate(call) {
  const state = call.state;
  
  switch(state) {
    case 'new':
      document.getElementById('callStatus').textContent = 'Calling...';
      break;
      
    case 'trying':
      document.getElementById('callStatus').textContent = 'Ringing...';
      break;
      
    case 'early':
      document.getElementById('callStatus').textContent = 'Connecting...';
      break;
      
    case 'active':
      document.getElementById('callStatus').textContent = 'Connected';
      startCallTimer();
      
      // CRITICAL FIX: Attach remote audio stream
      attachRemoteAudio(call);
      break;
      
    case 'held':
      document.getElementById('callStatus').textContent = 'On Hold';
      break;
      
    case 'hangup':
    case 'destroy':
      handleCallEnded();
      break;
  }
}

// NEW FUNCTION: Attach remote audio to audio element
function attachRemoteAudio(call) {
  try {
    const audioElement = document.getElementById('remoteAudio');
    
    if (!audioElement) {
      console.error('Remote audio element not found!');
      return;
    }
    
    // Get the remote stream from the call
    const remoteStream = call.remoteStream;
    
    if (remoteStream) {
      // Attach stream to audio element
      audioElement.srcObject = remoteStream;
      audioElement.play().catch(err => {
        console.error('Error playing remote audio:', err);
      });
      
      console.log('Remote audio attached successfully');
    } else {
      console.warn('No remote stream available yet');
    }
  } catch (error) {
    console.error('Error attaching remote audio:', error);
  }
}
  async function makeCallToContact(contactId) {
  const contact = allContacts.find(c => c.contact_id === contactId || c.id === contactId);
  if (!contact || !contact.phone_number) {
    showStatus('No phone number available', true);
    return;
  }
  
  if (!window.userVVNumber) {
    showStatus('Please assign a phone number in Settings to enable calling', true);
    return;
  }
  
  if (!telnyxClient) {
    showStatus('Phone system not connected. Please refresh the page.', true);
    return;
  }
  
  try {
    // STEP 1: Show modal with "Preparing..." message
    currentCallContact = contact;
    isMuted = false;
    isOnHold = false;
    
    document.getElementById('callContactName').textContent = contact.name || contact.email;
    document.getElementById('callStatus').textContent = 'üîÑ Preparing Call Script...';
    document.getElementById('callDuration').textContent = '00:00';
    document.getElementById('callNotes').value = '';
    document.getElementById('muteBtn').textContent = 'üé§ Mute';
    document.getElementById('muteBtn').style.background = '#6c757d';
    document.getElementById('holdBtn').textContent = '‚è∏Ô∏è Hold';
    
    // Show "Generating script..." in script section
    const scriptElement = document.getElementById('callScript');
    if (scriptElement) {
      scriptElement.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><br>Generating AI call script...</div>';
    }
    
    // Show modal
    document.getElementById('callModal').style.display = 'block';
    
    // Close contact details modal
    const contactModal = document.getElementById('contactModal');
    if (contactModal) {
      contactModal.style.display = 'none';
    }
    
    // STEP 2: Fire webhook to generate script
    showStatus('Generating call script...', false);
    
    const scriptResponse = await fetch(ENDPOINTS.generateScript, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
     phone_number: contact.phone_number,
      customer_id: CUSTOMER_ID
      })
    });
    
    const scriptData = await scriptResponse.json();
    
// STEP 3: Update script in modal
if (scriptData.success && scriptElement) {
  // Add formatting in frontend since we stripped it all
  let formattedScript = scriptData.script
    // Split into sections and add structure
    .replace(/OPENING:/gi, '\n\nüìû OPENING:\n')
    .replace(/KEY TALKING POINTS:/gi, '\n\nüí° KEY TALKING POINTS:\n')
    .replace(/CLOSING QUESTION:/gi, '\n\nüéØ CLOSING QUESTION:\n')
    .replace(/CLOSING:/gi, '\n\nüéØ CLOSING:\n')
    // Add bullets
    .replace(/- /g, '\n  ‚Ä¢ ')
    // Clean up
    .trim();

      scriptElement.textContent =  formattedScript;
    } else if (scriptElement) {
      // Fallback to existing script
      if (contact.script && contact.script.trim()) {
        scriptElement.textContent = contact.script;
      } else if (contact.call_script_suggestions && contact.call_script_suggestions.trim()) {
        scriptElement.textContent = contact.call_script_suggestions;
      } else {
        scriptElement.textContent = 'No script available. Use standard discovery approach.';
      }
    }
    
    // STEP 4: Wait 10 seconds (give rep time to review)
    // Replace the countdown section with:
document.getElementById('callStatus').textContent = 'üìñ Review script - Call starting soon...';
document.getElementById('skipWaitBtn').style.display = 'block'; // Show skip button
skipWait = false; // Reset

let countdown = 10;
currentCountdownInterval = setInterval(() => {
  if (skipWait) {
    clearInterval(currentCountdownInterval);
    return;
  }
  
  countdown--;
  document.getElementById('callStatus').textContent = `üìñ Review script - Starting in ${countdown}s...`;
  
  if (countdown <= 0) {
    clearInterval(currentCountdownInterval);
    document.getElementById('skipWaitBtn').style.display = 'none';
  }
}, 1000);

await new Promise(resolve => {
  const checkSkip = setInterval(() => {
    if (skipWait || countdown <= 0) {
      clearInterval(checkSkip);
      resolve();
    }
  }, 100);
});
    
    // STEP 5: Initialize Telnyx and make the call
    await initializeTelnyxWebRTC();
    
    document.getElementById('callStatus').textContent = 'Calling...';
    
    currentCall = telnyxClient.newCall({
      destinationNumber: formatPhoneE164(contact.phone_number),
      callerNumber: formatPhoneE164(window.userVVNumber),
      audio: true,
      video: false
    });
    
    console.log('Call initiated successfully');
      
  } catch (error) {
    console.error('Error making call:', error);
    showStatus('Error making call: ' + error.message, true);
    closeCallModal();
  }
}
    
    // Close contact details modal
    const contactModal = document.getElementById('contactModal');
    if (contactModal) {
      contactModal.style.display = 'none';
    }
// Skip wait variables and function
let skipWait = false;
let currentCountdownInterval = null;

function skipScriptWait() {
  skipWait = true;
  if (currentCountdownInterval) {
    clearInterval(currentCountdownInterval);
  }
  document.getElementById('skipWaitBtn').style.display = 'none';
  document.getElementById('callStatus').textContent = 'Calling...';
}

function toggleMute() {
  if (!currentCall) return;
  try {
    if (isMuted) {
      currentCall.unmute();
      isMuted = false;
      document.getElementById('muteBtn').textContent = 'üé§ Mute';
      document.getElementById('muteBtn').style.background = '#6c757d';
    } else {
      currentCall.mute();
      isMuted = true;
      document.getElementById('muteBtn').textContent = 'üîá Unmute';
      document.getElementById('muteBtn').style.background = '#dc3545';
    }
  } catch (error) {
    console.error('Error toggling mute:', error);
  }
}

function toggleHold() {
  if (!currentCall) return;
  try {
    if (isOnHold) {
      currentCall.unhold();
      isOnHold = false;
      document.getElementById('holdBtn').textContent = '‚è∏Ô∏è Hold';
      document.getElementById('callStatus').textContent = 'Connected';
    } else {
      currentCall.hold();
      isOnHold = true;
      document.getElementById('holdBtn').textContent = '‚ñ∂Ô∏è Resume';
      document.getElementById('callStatus').textContent = 'On Hold';
    }
  } catch (error) {
    console.error('Error toggling hold:', error);
  }
}

  
async function hangupCall() {
  if (!currentCall) {
    closeCallModal();
    return;
  }
  
  try {
    currentCall.hangup();
    
    const notes = document.getElementById('callNotes').value.trim();
    if (notes && currentCallContact) {
      await apiCall(ENDPOINTS.updateContact, {
        contact_id: currentCallContact.contact_id || currentCallContact.id,
        customer_journey: (currentCallContact.customer_journey || '') + '\n\n' + 
          `Call ${new Date().toLocaleDateString()}: ${notes}`
      });
    }
    
    showStatus('Call ended', false);
  } catch (error) {
    console.error('Error hanging up:', error);
  } finally {
    handleCallEnded();
  }
}

function handleCallEnded() {
  if (callTimer) clearInterval(callTimer);
  closeCallModal();
  currentCall = null;
}

function handleCallStatusUpdate(event) {
  // For future webhook integration
  console.log('Call status update:', event);
}

      
  
window.showContactDetails = showContactDetails;
window.toggleContactSelection = toggleContactSelection;
window.sortBy = sortBy;
window.closeModal = closeModal;
window.showAddContactModal = showAddContactModal;
window.closeAddContactModal = closeAddContactModal;
window.editContact = editContact;
window.deleteContact = deleteContact;
window.sendEmailToContact = sendEmailToContact;
window.startTour = startTour;
window.expandFirstSelectedContact = expandFirstSelectedContact;
window.showCustomCampaignModal = showCustomCampaignModal;
window.closeCustomCampaignModal = closeCustomCampaignModal;
  window.showLookAlikeModal = showLookAlikeModal;
window.closeLookAlikeModal = closeLookAlikeModal;
window.generateLookAlikeContacts = generateLookAlikeContacts;
window.createMeetingForContact = createMeetingForContact;
window.createSMSForContact = createSMSForContact;
window.makeCallToContact = makeCallToContact;
window.closeSMSModal = closeSMSModal;
window.generateAISMS = generateAISMS;
window.reviseAISMS = reviseAISMS;
window.sendSMS = sendSMS;
window.closeCallModal = closeCallModal;
window.toggleMute = toggleMute;
window.toggleHold = toggleHold;
window.hangupCall = hangupCall;
window.handleCallStatusUpdate = handleCallStatusUpdate;
document.addEventListener('DOMContentLoaded', init);

</script> 
</body>
</html>
