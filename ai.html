<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Victory Vision AI Sales Intelligence Dashboard - Meeting-aware lead scoring with real-time action queues"/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Sales Intelligence Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      color: #333;
    }

    .navbar {
      background: #0A3161;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .navbar .logo img {
      height: 50px;
      width: auto;
    }

    .navbar nav ul {
      display: flex;
      list-style: none;
      gap: 25px;
      margin: 0;
      padding: 0;
    }

    .navbar nav ul li a {
      color: white;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .navbar nav ul li a.active,
    .navbar nav ul li a:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }

    .subscription-medallion.bronze {
      background: linear-gradient(45deg, #CD7F32, #A0522D);
    }

    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }

    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }

    .tour-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .tour-btn:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-header {
      background: white;
      border-radius: 10px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .page-header h1 {
      font-size: 2rem;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .page-header p {
      color: #718096;
      font-size: 1.1rem;
    }

    /* Smart Quick Filters */
    .filters-section {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .filters-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #4a5568;
      font-size: 0.9rem;
    }

    .filter-input, .filter-select {
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: #667eea;
    }

    .filter-tags {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .filter-tag {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .filter-tag.active {
      background: #667eea;
      color: white;
    }

    .filter-tag.inactive {
      background: #f7fafc;
      color: #4a5568;
      border-color: #cbd5e0;
    }

    .filter-tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* AI Insights */
    .ai-insights {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
    }

    .ai-insights h3 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .insight-item {
      background: #f8f9ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .insight-text {
      flex: 1;
      font-size: 0.95rem;
      color: #2d3748;
    }

    .priority-score {
      background: linear-gradient(45deg, #ff6b6b, #ffa726);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      min-width: 60px;
      text-align: center;
    }

    /* Performance Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .metric-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .metric-label {
      color: #718096;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .metric-trend {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .metric-trend.up {
      color: #38a169;
    }

    .metric-trend.down {
      color: #e53e3e;
    }

    /* Main Dashboard Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    /* Focus Now Section */
    .focus-section {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .focus-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
    }

    .focus-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
    }

    .focus-toggle {
      display: flex;
      gap: 10px;
    }

    .toggle-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-btn.active {
      background: #667eea;
      color: white;
    }

    .toggle-btn.inactive {
      background: #f7fafc;
      color: #4a5568;
    }

    /* Lead Cards */
    .lead-card {
      background: #f8f9ff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
    }

    .lead-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .lead-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .lead-score {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
      margin-right: 15px;
    }

    .lead-info {
      flex: 1;
    }

    .lead-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .lead-details {
      color: #718096;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }

    .lead-summary {
      color: #4a5568;
      font-size: 0.85rem;
      font-style: italic;
      margin-bottom: 10px;
    }

    .lead-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge.warning {
      background: #fed7ae;
      color: #744210;
    }

    .badge.info {
      background: #bee3f8;
      color: #2a4365;
    }

    .badge.danger {
      background: #fed7d7;
      color: #742a2a;
    }

    .lead-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn.primary {
      background: #667eea;
      color: white;
    }

    .action-btn.success {
      background: #38a169;
      color: white;
    }

    .action-btn.warning {
      background: #ffa726;
      color: white;
    }

    .action-btn.secondary {
      background: #6c757d;
      color: white;
    }

    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .next-meeting {
      color: #667eea;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 8px;
    }

    /* Bottleneck Map */
    .bottleneck-section {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .bottleneck-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .funnel-container {
      margin-bottom: 20px;
    }

    .funnel-stage {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .stage-bar {
      height: 30px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      margin-right: 15px;
    }

    .stage-metrics {
      font-size: 0.85rem;
      color: #4a5568;
    }

    .alert-box {
      background: #fed7d7;
      border: 1px solid #fc8181;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .alert-title {
      font-weight: 600;
      color: #742a2a;
      margin-bottom: 5px;
    }

    .alert-text {
      color: #742a2a;
      font-size: 0.9rem;
    }

    .sla-metrics {
      background: #f0fff4;
      border: 1px solid #68d391;
      border-radius: 8px;
      padding: 15px;
    }

    .sla-title {
      font-weight: 600;
      color: #22543d;
      margin-bottom: 10px;
    }

    .sla-metric {
      color: #22543d;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    /* Action Queue */
    .action-queue {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .queue-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .queue-item {
      border-radius: 8px;
      padding: 15px;
      border-left: 4px solid;
    }

    .queue-item.urgent {
      background: #fff5f5;
      border-left-color: #fc8181;
    }

    .queue-item.important {
      background: #fffbeb;
      border-left-color: #f6ad55;
    }

    .queue-item.normal {
      background: #f0fff4;
      border-left-color: #68d391;
    }

    .queue-item.info {
      background: #e6fffa;
      border-left-color: #4fd1c7;
    }

    .queue-header {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .queue-description {
      font-size: 0.85rem;
      color: #4a5568;
      margin-bottom: 10px;
    }

    .queue-action {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      color: white;
    }

    /* Asset Hotbar */
    .asset-hotbar {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .asset-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .asset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .asset-card {
      background: #f8f9ff;
      border-radius: 8px;
      padding: 15px;
      border: 2px solid #e2e8f0;
      cursor: grab;
      transition: all 0.3s ease;
    }

    .asset-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-color: #667eea;
    }

    .asset-card:active {
      cursor: grabbing;
    }

    .asset-preview {
      width: 100%;
      height: 60px;
      background: #cbd5e0;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4a5568;
      font-size: 0.8rem;
    }

    .asset-info {
      font-weight: 600;
      font-size: 0.9rem;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .asset-stats {
      font-size: 0.8rem;
      color: #718096;
      margin-bottom: 8px;
    }

    .asset-tags {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .asset-tag {
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Timeline and Compose */
    .timeline-compose {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .timeline-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .timeline-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    .timeline-container {
      background: #f7fafc;
      border-radius: 8px;
      padding: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .timeline-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e2e8f0;
    }

    .timeline-item:last-child {
      border-bottom: none;
    }

    .timeline-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-text {
      font-size: 0.85rem;
      color: #4a5568;
      line-height: 1.4;
    }

    .compose-container {
      background: #f8f9ff;
      border-radius: 8px;
      padding: 20px;
    }

    .compose-field {
      margin-bottom: 15px;
    }

    .compose-label {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .compose-input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      font-size: 0.9rem;
    }

    .compose-textarea {
      width: 100%;
      height: 80px;
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      font-size: 0.9rem;
      resize: vertical;
    }

    .compose-actions {
      display: flex;
      gap: 10px;
    }

    .compose-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .compose-btn.primary {
      background: #667eea;
      color: white;
    }

    .compose-btn.success {
      background: #38a169;
      color: white;
    }

    /* Workflow Performance */
    .workflow-section {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .workflow-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .workflow-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .workflow-card {
      background: #f8f9ff;
      border-radius: 8px;
      padding: 20px;
      border-left: 5px solid #667eea;
    }

    .workflow-name {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }

    .workflow-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .workflow-stat {
      font-size: 0.85rem;
      color: #4a5568;
    }

    .workflow-stat strong {
      color: #2d3748;
      font-weight: 600;
    }

    /* Loading and Status */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
      text-align: center;
      display: none;
    }

    .status-success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .status-error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }

    .auth-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0A3161;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    /* Footer */
    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
      border-radius: 8px;
    }

    footer a {
      color: #fff;
      margin: 0 15px;
      text-decoration: none;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .timeline-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .navbar {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }

      .navbar nav ul {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }

      .queue-grid {
        grid-template-columns: 1fr;
      }

      .asset-grid {
        grid-template-columns: 1fr;
      }

      .workflow-grid {
        grid-template-columns: 1fr;
      }

      .lead-actions {
        flex-direction: column;
        gap: 8px;
      }

      .action-btn {
        width: 100%;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.5rem;
      }

      .metric-value {
        font-size: 1.8rem;
      }

      .lead-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .lead-score {
        margin-right: 0;
      }
    }
  </style>
</head>
<body>

<!-- Authentication Loading Screen -->
<div id="authLoading" class="auth-loading">
  <div class="spinner"></div>
  <p>Verifying authentication...</p>
</div>

<!-- Navigation -->
<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo" 
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22><rect width=%2250%22 height=%2250%22 fill=%22%230A3161%22 /><text x=%2210%22 y=%2230%22 font-size=%2225%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
      <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>   
      <li><a href="ads">Ads</a></li>
      <li><a href="contacts">Contacts</a></li>
      <li><a href="messages">Messages</a></li>
      <li><a href="ai" class="active">AI Analytics</a></li>
      <li><a href="settings">Settings</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail" class="user-email"></span>
    <div id="subscriptionMedallion" class="subscription-medallion bronze">
      <span class="plan-name">Bronze</span>
    </div>
    <button onclick="startTour()" class="tour-btn">
      Take Tour
    </button>
  </div>
</header>

<div class="container">
  <!-- Status Message -->
  <div id="statusMessage" class="status-message"></div>

  <!-- Page Header -->
  <div class="page-header" data-intro="Welcome to your AI Sales Intelligence Dashboard! This page provides meeting-aware lead scoring and automated action recommendations." data-step="1">
    <h1>AI Sales Intelligence Dashboard</h1>
    <p>Meeting-aware lead scoring with real-time action queues</p>
  </div>

  <!-- Smart Quick Filters -->
  <div class="filters-section" data-intro="Use these smart filters to drill down from macro analysis (100K+ emails) to micro focus (top prospects). Filters are designed for high-volume email operations." data-step="2">
    <div class="filters-title">Smart Quick Filters (Macro → Micro)</div>
    
    <div class="filters-grid">
      <div class="filter-group">
        <label class="filter-label">Search Prospects</label>
        <input type="text" id="searchInput" class="filter-input" placeholder="Name, company, or email...">
      </div>
      <div class="filter-group">
        <label class="filter-label">Activity Window</label>
        <select id="activityFilter" class="filter-select">
          <option value="24">Last 24 hours</option>
          <option value="72">Last 3 days</option>
          <option value="168">Last 7 days</option>
          <option value="720">Last 30 days</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Workflow</label>
        <select id="workflowFilter" class="filter-select">
          <option value="">All Workflows</option>
          <option value="cold_outreach">Cold Outreach</option>
          <option value="warm_leads">Warm Leads</option>
          <option value="product_demo">Product Demo</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Priority Level</label>
        <select id="priorityFilter" class="filter-select">
          <option value="hot">Hot Prospects Only</option>
          <option value="warm">Warm Prospects</option>
          <option value="all">All Prospects</option>
        </select>
      </div>
    </div>

    <div class="filter-tags">
      <div class="filter-tag active" data-filter="meeting_week">Meeting This Week</div>
      <div class="filter-tag inactive" data-filter="rsvp_yes">RSVP Yes</div>
      <div class="filter-tag inactive" data-filter="no_show">No-Show</div>
      <div class="filter-tag inactive" data-filter="clicked_24h">Clicked <24h</div>
      <div class="filter-tag inactive" data-filter="opened_no_reply">Opened No Reply</div>
      <div class="filter-tag inactive" data-filter="no_response_7d">No Response 7d</div>
    </div>
  </div>

  <!-- AI Insights -->
  <div class="ai-insights" data-intro="AI-powered recommendations based on your email engagement data, meeting schedules, and conversation summaries. These insights help you prioritize your time for maximum revenue impact." data-step="3">
    <h3>🧠 AI Priority Recommendations</h3>
    <div id="aiRecommendations">
      <div class="insight-item">
        <div class="insight-text">Sarah Johnson (TechCorp) - High engagement, schedule meeting NOW</div>
        <div class="priority-score">96</div>
      </div>
      <div class="insight-item">
        <div class="insight-text">Mike Chen (StartupXYZ) - 3 opens, no reply - try different subject line</div>
        <div class="priority-score">78</div>
      </div>
      <div class="insight-item">
        <div class="insight-text">Campaign "Q1 Demo" underperforming - optimize send times</div>
        <div class="priority-score">Alert</div>
      </div>
    </div>
  </div>

  <!-- Performance Metrics -->
  <div class="metrics-grid" data-intro="Key performance indicators updated in real-time. These metrics help you track the effectiveness of your high-volume email campaigns." data-step="4">
    <div class="metric-card">
      <div class="metric-value" id="emailsSentToday">1,247</div>
      <div class="metric-label">Emails Sent Today</div>
      <div class="metric-trend up">↗ +23% vs yesterday</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="openRate24h">34.2%</div>
      <div class="metric-label">Open Rate (24h)</div>
      <div class="metric-trend up">↗ +2.1% vs avg</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="replyRate">8.7%</div>
      <div class="metric-label">Reply Rate</div>
      <div class="metric-trend up">↗ +1.3% vs avg</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="meetingsScheduled">23</div>
      <div class="metric-label">Meetings Scheduled</div>
      <div class="metric-trend up">↗ +5 today</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="pipelineValue">$847K</div>
      <div class="metric-label">Pipeline Value</div>
      <div class="metric-trend up">↗ +$125K week</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="hotProspects">87</div>
      <div class="metric-label">Hot Prospects</div>
      <div class="metric-trend up">↗ +12 today</div>
    </div>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Focus Now Section -->
    <div class="focus-section" data-intro="Your top-priority leads ranked by AI scoring algorithm that considers email engagement, meeting status, and revenue potential. Focus your energy here for maximum ROI." data-step="5">
      <div class="focus-header">
        <div class="focus-title">🎯 Focus Now - Meeting-Aware Lead Scoring</div>
        <div class="focus-toggle">
          <button class="toggle-btn active" onclick="setFocusView('top5')">Top 5</button>
          <button class="toggle-btn inactive" onclick="setFocusView('top25')">Top 25</button>
        </div>
      </div>
      
      <div id="focusLeads">
        <!-- Lead cards will be populated here -->
      </div>
    </div>

    <!-- Bottleneck Map & SLA -->
    <div class="bottleneck-section" data-intro="Conversion funnel analysis showing where prospects drop off in your sales process. Red alerts highlight underperforming stages that need attention." data-step="6">
      <div class="bottleneck-title">📊 Bottleneck Map & SLA Metrics</div>
      
      <div class="funnel-container">
        <div class="funnel-stage">
          <div class="stage-bar" style="background: #667eea; width: 200px;">Delivered: 12,847</div>
          <div class="stage-metrics">(100%)</div>
        </div>
        <div class="funnel-stage">
          <div class="stage-bar" style="background: #38a169; width: 160px;">Opened: 4,384</div>
          <div class="stage-metrics">(34.1%)</div>
        </div>
        <div class="funnel-stage">
          <div class="stage-bar" style="background: #ffa726; width: 80px;">Clicked: 892</div>
          <div class="stage-metrics">(6.9%)</div>
        </div>
        <div class="funnel-stage">
          <div class="stage-bar" style="background: #e53e3e; width: 40px;">Replied: 267</div>
          <div class="stage-metrics">(2.1%)</div>
        </div>
        <div class="funnel-stage">
          <div class="stage-bar" style="background: #764ba2; width: 20px;">Meetings: 89</div>
          <div class="stage-metrics">(0.7%)</div>
        </div>
        <div class="funnel-stage">
          <div class="stage-bar" style="background: #28a745; width: 15px;">Won: 23</div>
          <div class="stage-metrics">(0.2%)</div>
        </div>
      </div>

      <div class="alert-box">
        <div class="alert-title">🚨 Performance Alert</div>
        <div class="alert-text">Click→Meeting conversion down 23% vs 7-day average</div>
      </div>

      <div class="sla-metrics">
        <div class="sla-title">⏱️ SLA Metrics</div>
        <div class="sla-metric">Time to first open: 4.2h average</div>
        <div class="sla-metric">Open→Reply: 18h median</div>
        <div class="sla-metric">Reply→Meeting: 2.3d median</div>
        <div class="sla-metric">Attendance rate: 87% (7d)</div>
      </div>
    </div>
  </div>

  <!-- Next Best Action Queue -->
  <div class="action-queue" data-intro="Automated action recommendations based on prospect behavior and engagement patterns. Each queue provides 1-click actions to maximize your conversion rates." data-step="7">
    <div class="queue-title">⚡ Next Best Action Queue (Auto-Generated)</div>
    
    <div class="queue-grid">
      <div class="queue-item urgent">
        <div class="queue-header">Schedule Meeting Now (12)</div>
        <div class="queue-description">Clicked <48h, no future meeting</div>
        <button class="queue-action" style="background: #fc8181;">Send Calendar</button>
      </div>
      
      <div class="queue-item important">
        <div class="queue-header">Nudge Reply (8)</div>
        <div class="queue-description">Opened 2-3x, no reply</div>
        <button class="queue-action" style="background: #f6ad55;">Follow Up</button>
      </div>
      
      <div class="queue-item normal">
        <div class="queue-header">Call Today (5)</div>
        <div class="queue-description">Clicked <24h, has phone</div>
        <button class="queue-action" style="background: #68d391;">Call</button>
      </div>
      
      <div class="queue-item info">
        <div class="queue-header">Confirm Attendance (7)</div>
        <div class="queue-description">Meeting <48h, no RSVP</div>
        <button class="queue-action" style="background: #4fd1c7;">Confirm</button>
      </div>
      
      <div class="queue-item important">
        <div class="queue-header">No-Show Recovery (3)</div>
        <div class="queue-description">Past meeting, no attendance</div>
        <button class="queue-action" style="background: #d69e2e;">Rebook</button>
      </div>
      
      <div class="queue-item normal">
        <div class="queue-header">Post-Meeting Follow-up (4)</div>
        <div class="queue-description">Meeting completed, no follow-up</div>
        <button class="queue-action" style="background: #38a169;">Send Recap</button>
      </div>
    </div>
  </div>

  <!-- Asset Hotbar -->
  <div class="asset-hotbar" data-intro="Your highest-performing marketing assets ranked by clicks and engagement. Drag assets to the compose bar for context-aware email creation." data-step="8">
    <div class="asset-title">🎯 Asset Hotbar (Drag to Compose)</div>
    
    <div class="asset-grid">
      <div class="asset-card" draggable="true">
        <div class="asset-preview">📹 Video</div>
        <div class="asset-info">Demo Video</div>
        <div class="asset-stats">234 clicks • 89% completion</div>
        <div class="asset-tags">
          <span class="asset-tag" style="background: #38a169; color: white;">Casino</span>
        </div>
      </div>
      
      <div class="asset-card" draggable="true">
        <div class="asset-preview">📊 Calculator</div>
        <div class="asset-info">ROI Calculator</div>
        <div class="asset-stats">189 clicks • High conversion</div>
        <div class="asset-tags">
          <span class="asset-tag" style="background: #667eea; color: white;">Legal</span>
        </div>
      </div>
      
      <div class="asset-card" draggable="true">
        <div class="asset-preview">📄 Case Study</div>
        <div class="asset-info">Success Story</div>
        <div class="asset-stats">156 clicks • 92% read rate</div>
        <div class="asset-tags">
          <span class="asset-tag" style="background: #ffa726; color: white;">Founder</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Timeline & Compose -->
  <div class="timeline-compose" data-intro="Thread-aware timeline shows all touchpoints with selected prospects. The AI compose bar generates context-aware emails based on conversation history and engagement patterns." data-step="9">
    <div class="timeline-title">📅 Live Timeline (Thread-Aware) + Context-Aware Compose</div>
    
    <div class="timeline-grid">
      <div>
        <h4 style="margin-bottom: 15px; color: #2d3748;">Sarah Johnson - TechCorp Timeline</h4>
        <div class="timeline-container">
          <div class="timeline-item">
            <div class="timeline-dot" style="background: #667eea;"></div>
            <div class="timeline-content">
              <div class="timeline-text">Jan 15, 2:34 PM - Email sent "Q1 Demo Invitation"</div>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-dot" style="background: #38a169;"></div>
            <div class="timeline-content">
              <div class="timeline-text">Jan 15, 3:12 PM - Opened email (2 times)</div>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-dot" style="background: #ffa726;"></div>
            <div class="timeline-content">
              <div class="timeline-text">Jan 15, 4:45 PM - Clicked calendar link</div>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-dot" style="background: #e53e3e;"></div>
            <div class="timeline-content">
              <div class="timeline-text">Jan 16, 9:22 AM - Meeting scheduled: Tomorrow 2PM</div>
            </div>
          </div>
        </div>
      </div>
      
      <div>
        <h4 style="margin-bottom: 15px; color: #2d3748;">AI Compose (Context-Aware)</h4>
        <div class="compose-container">
          <div class="compose-field">
            <div class="compose-label">To:</div>
            <input type="text" class="compose-input" value="Sarah Johnson (CEO, TechCorp)" readonly>
          </div>
          <div class="compose-field">
            <div class="compose-label">Subject:</div>
            <input type="text" class="compose-input" value="Confirm tomorrow's demo + agenda preview">
          </div>
          <div class="compose-field">
            <div class="compose-label">Message:</div>
            <textarea class="compose-textarea" placeholder="AI-generated: Hi Sarah, looking forward to our demo tomorrow at 2 PM. I've attached the ROI calculator you showed interest in..."></textarea>
          </div>
          <div class="compose-actions">
            <button class="compose-btn primary">Send</button>
            <button class="compose-btn success">+ Demo Video</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Workflow Performance -->
  <div class="workflow-section" data-intro="Campaign performance overview showing only active workflows with significant email volume. Focus on workflows that drive the most meetings and revenue." data-step="10">
    <div class="workflow-title">📊 Workflow Performance (Active Campaigns Only)</div>
    
    <div class="workflow-grid">
      <div class="workflow-card">
        <div class="workflow-name">Q1 Product Demo</div>
        <div class="workflow-stats">
          <div class="workflow-stat">Sent: <strong>2,847</strong></div>
          <div class="workflow-stat">Opens: <strong>978 (34.4%)</strong></div>
          <div class="workflow-stat">Replies: <strong>89 (3.1%)</strong></div>
          <div class="workflow-stat">Meetings: <strong>23</strong></div>
          <div class="workflow-stat">Pipeline: <strong>$342K</strong></div>
          <div class="workflow-stat">Won: <strong>$89K</strong></div>
        </div>
      </div>
      
      <div class="workflow-card">
        <div class="workflow-name">Cold Outreach - Tech</div>
        <div class="workflow-stats">
          <div class="workflow-stat">Sent: <strong>5,234</strong></div>
          <div class="workflow-stat">Opens: <strong>1,456 (27.8%)</strong></div>
          <div class="workflow-stat">Replies: <strong>134 (2.6%)</strong></div>
          <div class="workflow-stat">Meetings: <strong>34</strong></div>
          <div class="workflow-stat">Pipeline: <strong>$287K</strong></div>
          <div class="workflow-stat">Won: <strong>$67K</strong></div>
        </div>
      </div>
      
      <div class="workflow-card">
        <div class="workflow-name">Feature Announcement</div>
        <div class="workflow-stats">
          <div class="workflow-stat">Sent: <strong>1,567</strong></div>
          <div class="workflow-stat">Opens: <strong>623 (39.8%)</strong></div>
          <div class="workflow-stat">Replies: <strong>45 (2.9%)</strong></div>
          <div class="workflow-stat">Meetings: <strong>12</strong></div>
          <div class="workflow-stat">Pipeline: <strong>$89K</strong></div>
          <div class="workflow-stat">Won: <strong>$23K</strong></div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
// Supabase configuration
const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// API endpoints
const ENDPOINTS = {
  getEmails: 'https://victoryvision.app.n8n.cloud/webhook/emails/get',
  getContacts: 'https://victoryvision.app.n8n.cloud/webhook/contacts/get',
  getMeetings: 'https://victoryvision.app.n8n.cloud/webhook/meetings/get',
  getMeetingInvites: 'https://victoryvision.app.n8n.cloud/webhook/meeting_invites/get',
  getCampaignFiles: 'https://victoryvision.app.n8n.cloud/webhook/media/get',
  getUser: 'https://victoryvision.app.n8n.cloud/webhook/user/get',
  sendEmail: 'https://victoryvision.app.n8n.cloud/webhook/emails/send',
  scheduleEmail: 'https://victoryvision.app.n8n.cloud/webhook/emails/schedule'
};

// Global variables
let CUSTOMER_ID = null;
let authToken = null;
let allEmails = [];
let allContacts = [];
let allMeetings = [];
let allMeetingInvites = [];
let allCampaignFiles = [];
let focusView = 'top5';
let filteredProspects = [];

// Rate limiting
const rateLimiter = {
  calls: [],
  maxCalls: 20,
  windowMs: 60000,
  canMakeCall: function() {
    const now = Date.now();
    this.calls = this.calls.filter(time => time > (now - this.windowMs));
    return this.calls.length < this.maxCalls;
  }
};

// Input sanitization
function sanitizeInput(value) {
  if (typeof value !== 'string') return value;
  return value
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/[<>'"&]/g, function(match) {
      const escape = {
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#x27;',
        '&': '&amp;'
      };
      return escape[match];
    });
}

// Authentication
async function checkAuthentication() {
  try {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    if (error) {
      console.error('Auth error:', error);
      return false;
    }

    if (session && session.user) {
      CUSTOMER_ID = session.user.email;
      authToken = session.access_token;
      document.getElementById('userEmail').textContent = CUSTOMER_ID;
      return true;
    }

    return false;
  } catch (e) {
    console.error('Auth check error:', e);
    return false;
  }
}

function redirectToLogin() {
  localStorage.removeItem('vv_session');
  window.location.href = 'login.html';
}

// API call function
async function apiCall(endpoint, method = 'GET', data = {}) {
  if (!rateLimiter.canMakeCall()) {
    throw new Error('Rate limit exceeded. Please wait before making more requests.');
  }

  try {
    const url = method === 'GET' ? 
      `${endpoint}?customer_id=${encodeURIComponent(CUSTOMER_ID)}` : 
      endpoint;
    
    const requestOptions = {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-Customer-ID': CUSTOMER_ID,
        'Authorization': authToken ? `Bearer ${authToken}` : ''
      }
    };

    if (method !== 'GET') {
      requestOptions.body = JSON.stringify({
        customer_id: CUSTOMER_ID,
        ...data
      });
    }

    rateLimiter.calls.push(Date.now());
    const response = await fetch(url, requestOptions);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}

// Lead scoring algorithm
function calculateLeadScore(contact, emails, meetings, meetingInvites) {
  let score = 0;
  const now = new Date();
  const last72h = new Date(now.getTime() - (72 * 60 * 60 * 1000));
  const last14d = new Date(now.getTime() - (14 * 24 * 60 * 60 * 1000));

  // Email engagement scoring
  const contactEmails = emails.filter(email => 
    email.to_email === contact.email || email.to === contact.email
  );

  // Recent click activity (+45)
  const recentClicks = contactEmails.some(email => 
    (email.clicked_at && new Date(email.clicked_at) > last72h) ||
    (contact.last_clicked_date && new Date(contact.last_clicked_date) > last72h)
  );
  if (recentClicks) score += 45;

  // Recent open activity (+30)
  const recentOpens = contactEmails.some(email => 
    (email.opened_at && new Date(email.opened_at) > last72h) ||
    (contact.last_opened_date && new Date(contact.last_opened_date) > last72h)
  );
  if (recentOpens) score += 30;

  // Multiple opens (+15)
  const totalOpens = contactEmails.reduce((sum, email) => sum + (email.opens || 0), 0);
  if (totalOpens >= 3) score += 15;

  // Multiple clicks (+10)
  const totalClicks = contactEmails.reduce((sum, email) => sum + (email.clicks || 0), 0);
  if (totalClicks >= 2) score += 10;

  // Conversation summary keywords (+10)
  const summary = (contact.conversation_summary || '').toLowerCase();
  if (summary.includes('schedule') || summary.includes('call') || summary.includes('demo')) {
    score += 10;
  }

  // Future meetings (+20)
  const futureMeetings = meetings.filter(meeting => 
    meeting.customer_id === CUSTOMER_ID &&
    meeting.contact_email === contact.email &&
    meeting.status === 'scheduled' &&
    new Date(meeting.start_at) > now
  );
  if (futureMeetings.length > 0) score += 20;

  // RSVP yes (+10)
  const rsvpYes = meetingInvites.some(invite => 
    invite.contact_email === contact.email && invite.rsvp === 'yes'
  );
  if (rsvpYes) score += 10;

  // Penalties
  // Old last email (-10)
  if (contact.last_emailed_date && new Date(contact.last_emailed_date) < last14d) {
    score -= 10;
  }

  // No engagement (-15)
  if (!contact.last_responded && totalOpens === 0 && totalClicks === 0) {
    score -= 15;
  }

  return Math.max(0, score);
}

// Create lead card HTML
function createLeadCard(contact, score, emails, meetings) {
  const contactEmails = emails.filter(email => 
    email.to_email === contact.email || email.to === contact.email
  );
  
  const futureMeetings = meetings.filter(meeting => 
    meeting.contact_email === contact.email &&
    meeting.status === 'scheduled' &&
    new Date(meeting.start_at) > new Date()
  );

  const nextMeeting = futureMeetings.length > 0 ? 
    new Date(futureMeetings[0].start_at).toLocaleString() : null;

  // Generate badges
  const badges = [];
  const now = new Date();
  const last24h = new Date(now.getTime() - (24 * 60 * 60 * 1000));
  
  if (contact.last_opened_date && new Date(contact.last_opened_date) > last24h) {
    badges.push('<span class="badge info">Opened <24h</span>');
  }
  
  if (contact.last_clicked_date && new Date(contact.last_clicked_date) > last24h) {
    badges.push('<span class="badge warning">Clicked <24h</span>');
  }
  
  if (contact.last_responded) {
    badges.push('<span class="badge success">Replied</span>');
  }
  
  if (nextMeeting) {
    badges.push('<span class="badge info">Meeting Set</span>');
  }
  
  const last7d = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
  if (!contact.last_responded && (!contact.last_emailed_date || new Date(contact.last_emailed_date) < last7d)) {
    badges.push('<span class="badge danger">No response 7d</span>');
  }

  return `
    <div class="lead-card" data-contact-id="${contact.id}">
      <div class="lead-header">
        <div class="lead-score">${score}</div>
        <div class="lead-info">
          <div class="lead-name">${sanitizeInput(contact.name || 'Unknown')}</div>
          <div class="lead-details">${sanitizeInput(contact.title || '')} • ${sanitizeInput(contact.company || '')} • ${sanitizeInput(contact.city || '')} • ${sanitizeInput(contact.email || '')}</div>
          <div class="lead-summary">"${sanitizeInput(contact.conversation_summary || 'No conversation summary available')}"</div>
        </div>
      </div>
      
      <div class="lead-badges">
        ${badges.join('')}
      </div>
      
      <div class="lead-actions">
        <button class="action-btn primary" onclick="sendCalendar('${contact.email}')">Calendar</button>
        <button class="action-btn success" onclick="sendAsset('${contact.email}')">Asset</button>
        <button class="action-btn warning" onclick="callContact('${contact.phone_number}')">Call</button>
        <button class="action-btn secondary" onclick="snoozeContact('${contact.id}')">Snooze</button>
      </div>
      
      ${nextMeeting ? `<div class="next-meeting">Next: ${nextMeeting}</div>` : ''}
    </div>
  `;
}

// Load all data
async function loadAllData() {
  try {
    showStatus('Loading AI analytics data...', false);

    // Load data from all endpoints
    const [emailsResponse, contactsResponse, meetingsResponse, meetingInvitesResponse, campaignFilesResponse, userResponse] = await Promise.allSettled([
      apiCall(ENDPOINTS.getEmails),
      apiCall(ENDPOINTS.getContacts),
      apiCall(ENDPOINTS.getMeetings).catch(() => ({ meetings: [] })),
      apiCall(ENDPOINTS.getMeetingInvites).catch(() => ({ meeting_invites: [] })),
      apiCall(ENDPOINTS.getCampaignFiles).catch(() => ({ campaign_files: [] })),
      apiCall(ENDPOINTS.getUser)
    ]);

    // Process responses
    if (emailsResponse.status === 'fulfilled') {
      allEmails = Array.isArray(emailsResponse.value) ? emailsResponse.value : 
                 emailsResponse.value.emails || [];
    }

    if (contactsResponse.status === 'fulfilled') {
      allContacts = Array.isArray(contactsResponse.value) ? contactsResponse.value : 
                   contactsResponse.value.contacts || [];
    }

    if (meetingsResponse.status === 'fulfilled') {
      allMeetings = Array.isArray(meetingsResponse.value) ? meetingsResponse.value : 
                   meetingsResponse.value.meetings || [];
    }

    if (meetingInvitesResponse.status === 'fulfilled') {
      allMeetingInvites = Array.isArray(meetingInvitesResponse.value) ? meetingInvitesResponse.value : 
                         meetingInvitesResponse.value.meeting_invites || [];
    }

    if (campaignFilesResponse.status === 'fulfilled') {
      allCampaignFiles = Array.isArray(campaignFilesResponse.value) ? campaignFilesResponse.value : 
                        campaignFilesResponse.value.campaign_files || [];
    }

    if (userResponse.status === 'fulfilled') {
      const userData = Array.isArray(userResponse.value) ? userResponse.value[0] : userResponse.value;
      updateSubscriptionMedallion(userData?.subscription_plan || 'Bronze');
    }

    console.log('Data loaded:', { 
      emails: allEmails.length, 
      contacts: allContacts.length, 
      meetings: allMeetings.length,
      meetingInvites: allMeetingInvites.length,
      campaignFiles: allCampaignFiles.length
    });

    // Process and display data
    processProspects();
    updateMetrics();
    updateAssetHotbar();
    
    showStatus('AI analytics loaded successfully!', false);
    setTimeout(() => document.getElementById('statusMessage').style.display = 'none', 3000);

  } catch (error) {
    console.error('Error loading data:', error);
    showStatus('Error loading analytics data: ' + error.message, true);
  }
}

// Process prospects with lead scoring
function processProspects() {
  const scoredProspects = allContacts.map(contact => {
    const score = calculateLeadScore(contact, allEmails, allMeetings, allMeetingInvites);
    return { ...contact, lead_score: score };
  });

  // Sort by lead score (highest first)
  filteredProspects = scoredProspects.sort((a, b) => b.lead_score - a.lead_score);
  
  updateFocusLeads();
}

// Update focus leads display
function updateFocusLeads() {
  const count = focusView === 'top5' ? 5 : 25;
  const topProspects = filteredProspects.slice(0, count);
  
  const focusContainer = document.getElementById('focusLeads');
  focusContainer.innerHTML = topProspects.map(contact => 
    createLeadCard(contact, contact.lead_score, allEmails, allMeetings)
  ).join('');
}

// Update metrics
function updateMetrics() {
  // Calculate email metrics from last 24 hours
  const now = new Date();
  const last24h = new Date(now.getTime() - (24 * 60 * 60 * 1000));
  
  const recentEmails = allEmails.filter(email => 
    email.sent_at && new Date(email.sent_at) > last24h
  );
  
  document.getElementById('emailsSentToday').textContent = recentEmails.length.toLocaleString();
  
  // Calculate open rate
  const totalOpens = allEmails.reduce((sum, email) => sum + (email.opens || 0), 0);
  const openRate = allEmails.length > 0 ? ((totalOpens / allEmails.length) * 100).toFixed(1) : 0;
  document.getElementById('openRate24h').textContent = `${openRate}%`;
  
  // Calculate reply rate
  const totalReplies = allEmails.filter(email => email.replied_at).length;
  const replyRate = allEmails.length > 0 ? ((totalReplies / allEmails.length) * 100).toFixed(1) : 0;
  document.getElementById('replyRate').textContent = `${replyRate}%`;
  
  // Calculate meetings
  const scheduledMeetings = allMeetings.filter(meeting => 
    meeting.status === 'scheduled' && new Date(meeting.start_at) > now
  );
  document.getElementById('meetingsScheduled').textContent = scheduledMeetings.length;
  
  // Calculate pipeline value
  const pipelineValue = allContacts.reduce((sum, contact) => 
    sum + (parseFloat(contact.client_ann_est) || 0), 0
  );
  document.getElementById('pipelineValue').textContent = `${(pipelineValue / 1000).toFixed(0)}K`;
  
  // Hot prospects (score > 70)
  const hotProspects = filteredProspects.filter(prospect => prospect.lead_score > 70);
  document.getElementById('hotProspects').textContent = hotProspects.length;
}

// Update asset hotbar
function updateAssetHotbar() {
  // Sort campaign files by clicks
  const topAssets = allCampaignFiles
    .filter(file => file.clicks > 0)
    .sort((a, b) => b.clicks - a.clicks)
    .slice(0, 6);
  
  if (topAssets.length === 0) return;
  
  const assetGrid = document.querySelector('.asset-grid');
  assetGrid.innerHTML = topAssets.map(asset => `
    <div class="asset-card" draggable="true" data-asset-id="${asset.id}">
      <div class="asset-preview">
        ${asset.file_type === 'video' ? '📹 Video' : 
          asset.file_type === 'image' ? '🖼️ Image' : 
          asset.file_type === 'pdf' ? '📄 PDF' : '📊 File'}
      </div>
      <div class="asset-info">${sanitizeInput(asset.name)}</div>
      <div class="asset-stats">${asset.clicks} clicks • ${asset.viewers || 0} views</div>
      <div class="asset-tags">
        ${asset.metadata ? `<span class="asset-tag" style="background: #667eea; color: white;">${sanitizeInput(asset.metadata)}</span>` : ''}
      </div>
    </div>
  `).join('');
}

// Update subscription medallion
function updateSubscriptionMedallion(plan) {
  const medallion = document.getElementById('subscriptionMedallion');
  const planName = medallion.querySelector('.plan-name');
  
  const validPlans = ['Bronze', 'Silver', 'Gold'];
  const safePlan = validPlans.includes(plan) ? plan : 'Bronze';
  
  medallion.className = `subscription-medallion ${safePlan.toLowerCase()}`;
  planName.textContent = safePlan;
}

// Show status messages
function showStatus(message, isError = false) {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.textContent = message;
  statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
  statusDiv.style.display = 'block';
  
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 5000);
}

// Focus view toggle
function setFocusView(view) {
  focusView = view;
  
  // Update button states
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.className = 'toggle-btn inactive';
  });
  
  event.target.className = 'toggle-btn active';
  
  updateFocusLeads();
}

// Filter functionality
function setupFilters() {
  // Search filter
  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('activityFilter').addEventListener('change', applyFilters);
  document.getElementById('workflowFilter').addEventListener('change', applyFilters);
  document.getElementById('priorityFilter').addEventListener('change', applyFilters);
  
  // Filter tags
  document.querySelectorAll('.filter-tag').forEach(tag => {
    tag.addEventListener('click', function() {
      this.classList.toggle('active');
      this.classList.toggle('inactive');
      applyFilters();
    });
  });
}

function applyFilters() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const activityHours = parseInt(document.getElementById('activityFilter').value);
  const workflow = document.getElementById('workflowFilter').value;
  const priority = document.getElementById('priorityFilter').value;
  
  const activeTags = Array.from(document.querySelectorAll('.filter-tag.active'))
    .map(tag => tag.dataset.filter);

  const now = new Date();
  const activityCutoff = new Date(now.getTime() - (activityHours * 60 * 60 * 1000));

  let filtered = allContacts.map(contact => {
    const score = calculateLeadScore(contact, allEmails, allMeetings, allMeetingInvites);
    return { ...contact, lead_score: score };
  });

  // Apply filters
  if (searchTerm) {
    filtered = filtered.filter(contact => 
      (contact.name || '').toLowerCase().includes(searchTerm) ||
      (contact.company || '').toLowerCase().includes(searchTerm) ||
      (contact.email || '').toLowerCase().includes(searchTerm)
    );
  }

  if (workflow) {
    filtered = filtered.filter(contact => 
      contact.workflow === workflow
    );
  }

  // Activity filter
  filtered = filtered.filter(contact => {
    if (!contact.last_opened_date && !contact.last_clicked_date) return false;
    
    const lastActivity = Math.max(
      contact.last_opened_date ? new Date(contact.last_opened_date).getTime() : 0,
      contact.last_clicked_date ? new Date(contact.last_clicked_date).getTime() : 0
    );
    
    return lastActivity > activityCutoff.getTime();
  });

  // Priority filter
  if (priority === 'hot') {
    filtered = filtered.filter(contact => contact.lead_score > 70);
  } else if (priority === 'warm') {
    filtered = filtered.filter(contact => contact.lead_score > 40 && contact.lead_score <= 70);
  }

  // Tag filters
  activeTags.forEach(tag => {
    switch(tag) {
      case 'meeting_week':
        const weekStart = new Date();
        const weekEnd = new Date(weekStart.getTime() + (7 * 24 * 60 * 60 * 1000));
        filtered = filtered.filter(contact => {
          return allMeetings.some(meeting => 
            meeting.contact_email === contact.email &&
            new Date(meeting.start_at) >= weekStart &&
            new Date(meeting.start_at) <= weekEnd
          );
        });
        break;
      case 'rsvp_yes':
        filtered = filtered.filter(contact => {
          return allMeetingInvites.some(invite => 
            invite.contact_email === contact.email && invite.rsvp === 'yes'
          );
        });
        break;
      case 'clicked_24h':
        const last24h = new Date(now.getTime() - (24 * 60 * 60 * 1000));
        filtered = filtered.filter(contact => 
          contact.last_clicked_date && new Date(contact.last_clicked_date) > last24h
        );
        break;
    }
  });

  filteredProspects = filtered.sort((a, b) => b.lead_score - a.lead_score);
  updateFocusLeads();
}

// Action functions
async function sendCalendar(email) {
  try {
    showStatus('Sending calendar invite...', false);
    
    const response = await apiCall(ENDPOINTS.sendEmail, 'POST', {
      to: email,
      subject: 'Meeting Request - Victory Vision Demo',
      body: 'I would like to schedule a meeting to discuss how Victory Vision can help your business.',
      template: 'calendar_invite'
    });
    
    showStatus('Calendar invite sent successfully!', false);
  } catch (error) {
    showStatus('Error sending calendar invite: ' + error.message, true);
  }
}

async function sendAsset(email) {
  try {
    showStatus('Sending asset...', false);
    
    // Get the best performing asset for this contact
    const topAsset = allCampaignFiles
      .filter(file => file.clicks > 0)
      .sort((a, b) => b.clicks - a.clicks)[0];
    
    if (!topAsset) {
      showStatus('No assets available', true);
      return;
    }
    
    const response = await apiCall(ENDPOINTS.sendEmail, 'POST', {
      to: email,
      subject: `${topAsset.name} - As Requested`,
      body: `I thought you might find this ${topAsset.name} helpful for your business.`,
      attachment_url: topAsset.URL
    });
    
    showStatus('Asset sent successfully!', false);
  } catch (error) {
    showStatus('Error sending asset: ' + error.message, true);
  }
}

function callContact(phoneNumber) {
  if (!phoneNumber) {
    showStatus('No phone number available for this contact', true);
    return;
  }
  
  // Open phone dialer
  window.location.href = `tel:${phoneNumber}`;
  showStatus('Opening phone dialer...', false);
}

function snoozeContact(contactId) {
  // Add to snooze list (implement based on your needs)
  showStatus('Contact snoozed for 24 hours', false);
}

// Tour functionality
function startTour() {
  introJs().setOptions({
    showProgress: true,
    showBullets: false,
    exitOnOverlayClick: false,
    nextLabel: 'Next →',
    prevLabel: '← Back',
    doneLabel: 'Complete Tour!',
    skipLabel: 'Skip Tour'
  }).start();
}

// Initialize page
document.addEventListener('DOMContentLoaded', async function() {
  document.getElementById('authLoading').style.display = 'flex';
  
  try {
    const isAuthenticated = await checkAuthentication();
    
    if (isAuthenticated) {
      document.getElementById('authLoading').style.display = 'none';
      setupFilters();
      await loadAllData();
    } else {
      redirectToLogin();
    }
  } catch (e) {
    console.error('Initialization failed:', e);
    redirectToLogin();
  }
});

// Session management
setInterval(async function() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      redirectToLogin();
    }
  } catch (e) {
    console.error('Session check failed:', e);
    redirectToLogin();
  }
}, 300000); // Check every 5 minutes

// Drag and drop for assets
document.addEventListener('dragstart', function(e) {
  if (e.target.classList.contains('asset-card')) {
    e.dataTransfer.setData('text/plain', e.target.dataset.assetId);
  }
});

document.addEventListener('dragover', function(e) {
  if (e.target.closest('.compose-container')) {
    e.preventDefault();
  }
});

document.addEventListener('drop', function(e) {
  if (e.target.closest('.compose-container')) {
    e.preventDefault();
    const assetId = e.dataTransfer.getData('text/plain');
    const asset = allCampaignFiles.find(file => file.id == assetId);
    
    if (asset) {
      const textarea = e.target.closest('.compose-container').querySelector('.compose-textarea');
      textarea.value += `\n\n[Attached: ${asset.name}]`;
      showStatus('Asset attached to email', false);
    }
  }
});

</script>
</body>
</html>
