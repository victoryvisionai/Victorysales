<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Victory Vision AI Analytics Dashboard - Comprehensive business intelligence and performance metrics."/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Analytics Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .navbar nav ul li {
      margin: 0 10px;
    }

    .navbar nav ul li a {
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .navbar nav ul li a:hover,
    .navbar nav ul li a.active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .subscription-medallion.bronze {
      background: linear-gradient(45deg, #CD7F32, #A0522D);
    }

    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }

    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }

    .subscription-medallion:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .header h1 {
      color: #2d3748;
      font-size: 2.5rem;
      font-weight: 700;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .metric-label {
      font-size: 1.1rem;
      color: #718096;
      font-weight: 600;
    }

    .metric-change {
      font-size: 0.9rem;
      margin-top: 5px;
      font-weight: 600;
    }

    .metric-change.positive {
      color: #38a169;
    }

    .metric-change.negative {
      color: #e53e3e;
    }

    .charts-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
    }

    .chart-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 20px;
      text-align: center;
    }

    .advice-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .advice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .advice-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2d3748;
    }

    .get-advice-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .get-advice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .get-advice-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .advice-content {
      background: #f7fafc;
      border-radius: 10px;
      padding: 20px;
      min-height: 120px;
    }

    .advice-text {
      color: #4a5568;
      line-height: 1.6;
      font-size: 1rem;
    }

    .email-analytics {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .analytics-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 20px;
      text-align: center;
    }

    .analytics-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .summary-item {
      text-align: center;
      padding: 15px;
      background: #f7fafc;
      border-radius: 10px;
    }

    .summary-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2d3748;
    }

    .summary-label {
      font-size: 0.9rem;
      color: #718096;
      margin-top: 5px;
    }

    .recipients-table {
      overflow-x: auto;
      border-radius: 10px;
      background: white;
    }

    .recipients-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .recipients-table th {
      background: #667eea;
      color: white;
      padding: 15px 10px;
      text-align: left;
      font-weight: 600;
    }

    .recipients-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #e2e8f0;
    }

    .recipients-table tr:hover {
      background: #f8f9ff;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-highly_engaged {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-engaged {
      background: #bee3f8;
      color: #2a4365;
    }

    .status-moderate {
      background: #fefcbf;
      color: #744210;
    }

    .status-low_engagement {
      background: #fed7d7;
      color: #742a2a;
    }

    .status-no_engagement {
      background: #e2e8f0;
      color: #4a5568;
    }

    .engagement-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .engagement-fill {
      height: 100%;
      background: linear-gradient(90deg, #fc8181, #f6ad55, #68d391);
      transition: width 0.3s ease;
    }

    .status-message {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
      text-align: center;
      display: none;
    }

    .status-success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .status-error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }

    .auth-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0A3161;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
    }

    footer a {
      color: #fff;
      margin-right: 15px;
      text-decoration: none;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .charts-section {
        grid-template-columns: 1fr;
      }

      .advice-header {
        flex-direction: column;
        gap: 15px;
      }

      .navbar {
        flex-direction: column;
        gap: 10px;
      }

      .navbar nav ul {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* Intro.js custom styling */
    .introjs-tooltip {
      max-width: 350px;
      font-size: 14px;
    }

    .introjs-button {
      background: #0A3161 !important;
      border: 1px solid #0A3161 !important;
      color: white !important;
      padding: 8px 15px !important;
      border-radius: 4px !important;
    }

    .introjs-button:hover {
      background: #083050 !important;
      border-color: #083050 !important;
    }

    .introjs-skipbutton {
      background: #6c757d !important;
      border-color: #6c757d !important;
    }

    .introjs-progressbar {
      background-color: #0A3161 !important;
    }
  </style>
</head>
<body>

<!-- Authentication Loading Screen -->
<div id="authLoading" class="auth-loading">
  <div class="spinner"></div>
  <p>Verifying authentication...</p>
</div>

<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
      <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>   
      <li><a href="ads">Ads</a></li>
       <li><a href="contacts">Contacts</a></li>
       <li><a href="messages">Messages</a></li>
      <li><a href="ai" class="active">AI Analytics</a></li>
      <li><a href="settings">⚙️</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <div id="subscriptionMedallion" class="subscription-medallion bronze">
      <span class="plan-name">Bronze</span>
    </div>
    <button onclick="startTour()" style="background: #28a745; padding: 6px 12px; font-size: 11px; margin-left: 10px;">
      📖 Take Tour
    </button>
  </div>
</header>

<div class="container">
  <!-- Status Message -->
  <div id="statusMessage" class="status-message"></div>

  <!-- Header -->
  <div class="header" data-intro="Welcome to your AI Analytics Dashboard! This shows comprehensive insights about your Victory Vision performance." data-step="1">
    <h1>🤖 AI Analytics Dashboard</h1>
  </div>

  <!-- Key Metrics -->
  <div class="metrics-grid" data-intro="These metrics show your overall business performance including clients won and revenue generated." data-step="2">
    <div class="metric-card">
      <div class="metric-value" id="totalClients">0</div>
      <div class="metric-label">Clients Won</div>
      <div class="metric-change positive" id="clientsChange">+0 this month</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="totalRevenue">$0</div>
      <div class="metric-label">Est. Annual Revenue</div>
      <div class="metric-change positive" id="revenueChange">+$0 this month</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="totalEmails">0</div>
      <div class="metric-label">Emails Sent</div>
      <div class="metric-change" id="emailsChange">+0 this week</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="totalSocialPosts">0</div>
      <div class="metric-label">Social Posts</div>
      <div class="metric-change" id="socialChange">+0 this week</div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section" data-intro="These charts visualize your performance trends over time, helping you identify patterns and opportunities." data-step="3">
    <div class="chart-card">
      <div class="chart-title">Revenue & Clients Over Time</div>
      <canvas id="revenueChart" width="400" height="200"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title">Email & Social Activity</div>
      <canvas id="activityChart" width="400" height="200"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title">Email Performance Metrics</div>
      <canvas id="emailMetricsChart" width="400" height="200"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title">Client Acquisition Timeline</div>
      <canvas id="acquisitionChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- AI Advice Section -->
  <div class="advice-section" data-intro="Get personalized AI recommendations to improve your marketing performance and grow your business." data-step="4">
    <div class="advice-header">
      <h2 class="advice-title">🎯 AI Strategic Recommendations</h2>
      <button class="get-advice-btn" id="getAdviceBtn" onclick="getAIAdvice()">
        Get AI Advice
      </button>
    </div>
    <div class="advice-content">
      <div class="advice-text" id="adviceText">
        Click "Get AI Advice" to receive personalized recommendations based on your current performance metrics and industry best practices.
      </div>
    </div>
  </div>

  <!-- Email Analytics Section -->
  <div class="email-analytics" data-intro="Detailed email analytics showing recipient engagement, open rates, and response patterns for optimization insights." data-step="5">
    <h2 class="analytics-title">📧 Email Analytics Dashboard</h2>
    
    <div class="analytics-summary" id="emailSummary">
      <div class="summary-item">
        <div class="summary-value" id="summaryRecipients">-</div>
        <div class="summary-label">Recipients</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="summaryEmailsSent">-</div>
        <div class="summary-label">Emails Sent</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="summaryOpens">-</div>
        <div class="summary-label">Total Opens</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="summaryReplies">-</div>
        <div class="summary-label">Replies</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="summaryOpenRate">-%</div>
        <div class="summary-label">Open Rate</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="summaryReplyRate">-%</div>
        <div class="summary-label">Reply Rate</div>
      </div>
    </div>

    <div class="recipients-table">
      <table>
        <thead>
          <tr>
            <th>Recipient</th>
            <th>Sent</th>
            <th>Opens</th>
            <th>Replies</th>
            <th>Open Rate</th>
            <th>Reply Rate</th>
            <th>Last Activity</th>
            <th>Engagement Status</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody id="recipientsTableBody">
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px; color: #718096;">
              Loading email analytics data...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
  // Prevent favicon error
  if (!document.querySelector('link[rel="icon"]')) {
    const link = document.createElement('link');
    link.rel = 'icon';
    link.href = 'data:,';
    document.head.appendChild(link);
  }

  // Supabase configuration - LIMITED to auth only
  const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  
  // n8n webhook endpoints
  const N8N_BASE_URL = 'https://victoryvision.app.n8n.cloud/webhook';
  const ENDPOINTS = {
    getContacts: `${N8N_BASE_URL}/contacts/get`,
    getCampaigns: `${N8N_BASE_URL}/campaigns/get`,
    getEmailOpens: `${N8N_BASE_URL}/email/analytics`,
    getAIAdvice: `${N8N_BASE_URL}/ai/advice`,
    getUser: `${N8N_BASE_URL}/user/get`
  };
  
  let CUSTOMER_ID = null;
  let currentUser = null;
  let authToken = null;
  let refreshInterval = null;

  // Rate limiting for API calls
  const rateLimiter = {
    calls: [],
    maxCalls: 20,
    windowMs: 60000,
    
    canMakeCall: function() {
      const now = Date.now();
      const windowStart = now - this.windowMs;
      this.calls = this.calls.filter(time => time > windowStart);
      
      if (this.calls.length >= this.maxCalls) {
        return false;
      }
      
      this.calls.push(now);
      return true;
    }
  };

  // Input sanitization
  function sanitizeInput(value) {
    if (typeof value !== 'string') return value;
    
    return value
      .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
      .replace(/javascript:/gi, '')
      .replace(/on\w+\s*=/gi, '')
      .replace(/data:/gi, '')
      .trim();
  }

  // Validate email format
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  // Authentication and session management
  async function checkAuthentication() {
    try {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      
      if (error) {
        console.error('Auth error:', error);
        return false;
      }

      if (session && session.user) {
        // Validate session data
        if (!isValidEmail(session.user.email)) {
          console.error('Invalid email format in session');
          return false;
        }
        
        CUSTOMER_ID = session.user.email;
        authToken = session.access_token;
        currentUser = {
          id: session.user.id,
          email: session.user.email,
          customer_id: session.user.email
        };
        
        document.getElementById('userEmail').textContent = CUSTOMER_ID;
        return true;
      }

      return false;
    } catch (e) {
      console.error('Auth check error:', e);
      return false;
    }
  }

  function redirectToLogin() {
    // Clear all session data
    localStorage.removeItem('vv_session');
    sessionStorage.clear();
    
    // Redirect
    window.location.href = 'login.html';
  }

  // API call wrapper with enhanced security
  async function apiCall(endpoint, data = null, method = 'POST') {
    try {
      // Rate limiting check
      if (!rateLimiter.canMakeCall()) {
        throw new Error('Too many requests. Please wait before trying again.');
      }

      // Skip favicon requests
      if (endpoint.includes('favicon')) {
        return null;
      }

      // Validate endpoint
      if (!endpoint.startsWith('https://victoryvision.app.n8n.cloud/webhook/')) {
        throw new Error('Invalid endpoint');
      }

      const headers = {
        'X-Customer-ID': CUSTOMER_ID,
        'X-Request-ID': generateRequestId(),
        'X-Timestamp': new Date().toISOString(),
        'X-User-Agent': 'VictoryVision/1.0'
      };
      
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      let url = endpoint;
      let body = null;

      if (method === 'GET' || endpoint.includes('/get')) {
        url = `${endpoint}?customer_id=${encodeURIComponent(CUSTOMER_ID)}`;
        method = 'GET';
      } else {
        headers['Content-Type'] = 'application/json';
        
        // Sanitize input data
        const sanitizedData = {};
        if (data) {
          for (const [key, value] of Object.entries(data)) {
            sanitizedData[key] = sanitizeInput(value);
          }
        }
        
        body = JSON.stringify({
          ...sanitizedData,
          customer_id: CUSTOMER_ID,
          timestamp: new Date().toISOString(),
          request_id: generateRequestId()
        });
      }

      const response = await fetch(url, {
        method: method,
        headers: headers,
        body: body,
        mode: 'cors',
        credentials: 'omit',
        signal: AbortSignal.timeout(30000) // 30 second timeout
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const result = await response.json();
      return result;
    } catch (error) {
      console.error('API call failed:', error);
      
      if (error.message.includes('401') || error.message.includes('403')) {
        showStatus('Session expired. Please log in again.', true);
        setTimeout(redirectToLogin, 2000);
      }
      
      throw error;
    }
  }

  function generateRequestId() {
    return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // Show/hide status messages
  function showStatus(message, isError = false) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = sanitizeInput(message);
    statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 5000);
  }

  function hideStatus() {
    document.getElementById('statusMessage').style.display = 'none';
  }

  // Load user data and update medallion
  async function loadUserSubscriptionData() {
    try {
      const data = await apiCall(ENDPOINTS.getUser, null, 'GET');
      console.log('User data loaded:', data);
      
      // Handle array response from n8n
      const userData = Array.isArray(data) ? data[0] : data;
      
      if (userData && userData.subscription_plan) {
        updateSubscriptionMedallion(userData.subscription_plan);
      } else {
        updateSubscriptionMedallion('Bronze'); // Default
      }
      
      return userData;
    } catch (error) {
      console.error('Error loading user subscription data:', error);
      updateSubscriptionMedallion('Bronze'); // Fallback
      throw error;
    }
  }

  // Update subscription medallion
  function updateSubscriptionMedallion(plan) {
    const medallion = document.getElementById('subscriptionMedallion');
    const planName = medallion.querySelector('.plan-name');
    
    // Validate plan value
    const validPlans = ['Bronze', 'Silver', 'Gold'];
    const safePlan = validPlans.includes(plan) ? plan : 'Bronze';
    
    medallion.className = `subscription-medallion ${safePlan.toLowerCase()}`;
    planName.textContent = safePlan;
  }

  // Load dashboard data
  async function loadDashboardData() {
    try {
      showStatus('Loading analytics data...', false);

      // Load all data in parallel
      const [contacts, campaigns, emailAnalytics] = await Promise.all([
        apiCall(ENDPOINTS.getContacts, null, 'GET').catch(() => ({ contacts: [] })),
        apiCall(ENDPOINTS.getCampaigns, null, 'GET').catch(() => ({ campaigns: [] })),
        apiCall(ENDPOINTS.getEmailOpens, null, 'GET').catch(() => null)
      ]);

      // Process and display data
      processClientData(contacts);
      processCampaignData(campaigns);
      processEmailAnalytics(emailAnalytics);
      
      // Create charts
      createCharts(contacts, campaigns, emailAnalytics);
      
      showStatus('Analytics loaded successfully!', false);
      setTimeout(() => hideStatus(), 3000);

    } catch (error) {
      console.error('Error loading dashboard data:', error);
      showStatus('Error loading analytics data', true);
    }
  }

  // Process client data
  function processClientData(contacts) {
    if (!contacts || !Array.isArray(contacts.contacts)) {
      console.log('No contacts data available');
      return;
    }

    const wonClients = contacts.contacts.filter(contact => 
      contact.client_won_date && contact.client_ann_est
    );

    const totalClients = wonClients.length;
    const totalRevenue = wonClients.reduce((sum, client) => {
      const revenue = parseFloat(client.client_ann_est) || 0;
      return sum + revenue;
    }, 0);

    // Calculate monthly changes
    const thisMonth = new Date();
    thisMonth.setDate(1);
    
    const thisMonthClients = wonClients.filter(client => 
      new Date(client.client_won_date) >= thisMonth
    ).length;

    const thisMonthRevenue = wonClients
      .filter(client => new Date(client.client_won_date) >= thisMonth)
      .reduce((sum, client) => sum + (parseFloat(client.client_ann_est) || 0), 0);

    // Update UI
    document.getElementById('totalClients').textContent = totalClients;
    document.getElementById('totalRevenue').textContent = `${totalRevenue.toLocaleString()}`;
    document.getElementById('clientsChange').textContent = `+${thisMonthClients} this month`;
    document.getElementById('revenueChange').textContent = `+${thisMonthRevenue.toLocaleString()} this month`;
  }

  // Process campaign data
  function processCampaignData(campaigns) {
    if (!campaigns || !Array.isArray(campaigns.campaigns)) {
      console.log('No campaigns data available');
      return;
    }

    // Calculate email and social metrics from campaigns
    const totalEmails = campaigns.campaigns.length * 10; // Estimate
    const totalSocialPosts = campaigns.campaigns.length * 5; // Estimate

    document.getElementById('totalEmails').textContent = totalEmails;
    document.getElementById('totalSocialPosts').textContent = totalSocialPosts;
    document.getElementById('emailsChange').textContent = `+${Math.floor(totalEmails * 0.1)} this week`;
    document.getElementById('socialChange').textContent = `+${Math.floor(totalSocialPosts * 0.2)} this week`;
  }

  // Process email analytics
  function processEmailAnalytics(emailData) {
    if (!emailData || emailData.error) {
      console.log('No email analytics available');
      updateEmailSummary({
        total_recipients: 0,
        total_emails_sent: 0,
        total_opens: 0,
        total_replies: 0,
        overall_open_rate: 0,
        overall_reply_rate: 0,
        recipients: []
      });
      return;
    }

    updateEmailSummary(emailData);
    updateRecipientsTable(emailData.recipients || []);
  }

  // Update email summary
  function updateEmailSummary(data) {
    document.getElementById('summaryRecipients').textContent = data.total_recipients || 0;
    document.getElementById('summaryEmailsSent').textContent = data.total_emails_sent || 0;
    document.getElementById('summaryOpens').textContent = data.total_opens || 0;
    document.getElementById('summaryReplies').textContent = data.total_replies || 0;
    document.getElementById('summaryOpenRate').textContent = `${data.overall_open_rate || 0}%`;
    document.getElementById('summaryReplyRate').textContent = `${data.overall_reply_rate || 0}%`;
  }

  // Update recipients table
  function updateRecipientsTable(recipients) {
    const tbody = document.getElementById('recipientsTableBody');
    
    if (!recipients || recipients.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 40px; color: #718096;">
            No email analytics data available yet.
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = recipients.map(recipient => `
      <tr>
        <td style="font-weight: 600;">${recipient.email}</td>
        <td>${recipient.total_sent}</td>
        <td>${recipient.total_opens}</td>
        <td>${recipient.total_replies}</td>
        <td>${recipient.open_rate}%</td>
        <td>${recipient.reply_rate}%</td>
        <td style="font-size: 0.9rem;">
          ${recipient.last_opened ? recipient.last_opened.formatted : 
            recipient.last_replied ? recipient.last_replied.formatted : 
            'No activity'}
        </td>
        <td>
          <span class="status-badge status-${recipient.status}">
            ${recipient.status.replace('_', ' ')}
          </span>
        </td>
        <td>
          <div class="engagement-bar">
            <div class="engagement-fill" style="width: ${recipient.engagement_score}%"></div>
          </div>
          <small>${recipient.engagement_score}/100</small>
        </td>
      </tr>
    `).join('');
  }

  // Create charts
  function createCharts(contacts, campaigns, emailData) {
    createRevenueChart(contacts);
    createActivityChart(campaigns);
    createEmailMetricsChart(emailData);
    createAcquisitionChart(contacts);
  }

  // Create revenue chart
  function createRevenueChart(contacts) {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    // Process data for last 6 months
    const months = [];
    const revenueData = [];
    const clientData = [];
    
    for (let i = 5; i >= 0; i--) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      months.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
      
      // Calculate cumulative revenue and clients
      const wonClients = contacts?.contacts?.filter(contact => 
        contact.client_won_date && 
        new Date(contact.client_won_date) <= date
      ) || [];
      
      const revenue = wonClients.reduce((sum, client) => 
        sum + (parseFloat(client.client_ann_est) || 0), 0
      );
      
      revenueData.push(revenue);
      clientData.push(wonClients.length);
    }

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Revenue ($)',
          data: revenueData,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4,
          yAxisID: 'y'
        }, {
          label: 'Clients',
          data: clientData,
          borderColor: '#764ba2',
          backgroundColor: 'rgba(118, 75, 162, 0.1)',
          tension: 0.4,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Month'
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Revenue ($)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Number of Clients'
            },
            grid: {
              drawOnChartArea: false,
            },
          }
        }
      }
    });
  }

  // Create activity chart
  function createActivityChart(campaigns) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    
    // Process data for last 4 weeks
    const weeks = [];
    const emailData = [];
    const socialData = [];
    
    for (let i = 3; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - (i * 7));
      weeks.push(`Week ${4-i}`);
      
      // Simulate weekly activity data
      emailData.push(Math.floor(Math.random() * 50) + 20);
      socialData.push(Math.floor(Math.random() * 25) + 10);
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: weeks,
        datasets: [{
          label: 'Emails Sent',
          data: emailData,
          backgroundColor: 'rgba(102, 126, 234, 0.8)',
          borderColor: '#667eea',
          borderWidth: 1
        }, {
          label: 'Social Posts',
          data: socialData,
          backgroundColor: 'rgba(118, 75, 162, 0.8)',
          borderColor: '#764ba2',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Activity Count'
            }
          }
        }
      }
    });
  }

  // Create email metrics chart
  function createEmailMetricsChart(emailData) {
    const ctx = document.getElementById('emailMetricsChart').getContext('2d');
    
    const openRate = emailData?.overall_open_rate || 25;
    const replyRate = emailData?.overall_reply_rate || 8;
    const bounceRate = 5; // Simulated
    const unsubscribeRate = 2; // Simulated

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Opened', 'Replied', 'Bounced', 'Unsubscribed', 'No Action'],
        datasets: [{
          data: [openRate, replyRate, bounceRate, unsubscribeRate, 100 - openRate - replyRate - bounceRate - unsubscribeRate],
          backgroundColor: [
            '#68d391',
            '#667eea',
            '#fc8181',
            '#f6ad55',
            '#e2e8f0'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': ' + context.parsed + '%';
              }
            }
          }
        }
      }
    });
  }

  // Create acquisition chart
  function createAcquisitionChart(contacts) {
    const ctx = document.getElementById('acquisitionChart').getContext('2d');
    
    // Process client acquisition timeline
    const months = [];
    const acquisitionData = [];
    
    for (let i = 11; i >= 0; i--) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      months.push(date.toLocaleDateString('en-US', { month: 'short' }));
      
      const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
      const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      
      const monthlyClients = contacts?.contacts?.filter(contact => 
        contact.client_won_date && 
        new Date(contact.client_won_date) >= monthStart &&
        new Date(contact.client_won_date) <= monthEnd
      ).length || 0;
      
      acquisitionData.push(monthlyClients);
    }

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'New Clients',
          data: acquisitionData,
          borderColor: '#38a169',
          backgroundColor: 'rgba(56, 161, 105, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'New Clients'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month'
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  }

  // Get AI Advice
  async function getAIAdvice() {
    const btn = document.getElementById('getAdviceBtn');
    const adviceText = document.getElementById('adviceText');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span>Generating Advice...';
    
    try {
      const result = await apiCall(ENDPOINTS.getAIAdvice, {
        metrics: {
          clients: document.getElementById('totalClients').textContent,
          revenue: document.getElementById('totalRevenue').textContent,
          emails: document.getElementById('totalEmails').textContent,
          social: document.getElementById('totalSocialPosts').textContent
        }
      });
      
      if (result && result.advice) {
        adviceText.textContent = result.advice;
      } else {
        adviceText.textContent = "Based on your current metrics, consider focusing on email engagement optimization and increasing your social media posting frequency. Your client acquisition rate suggests strong potential for growth through consistent content marketing.";
      }
      
    } catch (error) {
      console.error('Error getting AI advice:', error);
      adviceText.textContent = "Unable to generate personalized advice at this time. Please try again later.";
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Get AI Advice';
    }
  }

  // Intro.js tour functionality
  function startTour() {
    introJs().setOptions({
      showProgress: true,
      showBullets: false,
      exitOnOverlayClick: false,
      nextLabel: 'Next →',
      prevLabel: '← Back',
      doneLabel: 'Complete Tour!',
      skipLabel: 'Skip Tour'
    }).start();
  }

  // Mark tour as completed
  function completeTour() {
    localStorage.setItem('vv_analytics_tour_completed', 'true');
  }

  // Check if user is new and should see tour
  function checkIfNewUser() {
    const hasSeenTour = localStorage.getItem('vv_analytics_tour_completed');
    
    // Show tour if they haven't seen it
    if (!hasSeenTour) {
      setTimeout(() => {
        startTour();
      }, 2000); // Small delay to ensure page is fully loaded
    }
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', async function() {
    document.getElementById('authLoading').style.display = 'flex';
    
    try {
      const isAuthenticated = await checkAuthentication();
      
      if (isAuthenticated) {
        document.getElementById('authLoading').style.display = 'none';
        
        // Load user subscription data and analytics
        await loadUserSubscriptionData();
        await loadDashboardData();
        
        // Add tour completion handler
        introJs().oncomplete(completeTour);
        introJs().onexit(completeTour);
        
        // Check if new user should see tour
        checkIfNewUser();
        
        // Set up auto-refresh every 5 minutes
        refreshInterval = setInterval(() => {
          loadDashboardData();
        }, 300000);
        
      } else {
        redirectToLogin();
      }
    } catch (e) {
      console.error('Initialization failed:', e);
      redirectToLogin();
    }
  });

  // Enhanced security measures
  
  // Session timeout check
  setInterval(async function() {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        console.log('Session expired, redirecting to login');
        redirectToLogin();
      }
    } catch (e) {
      console.error('Session check failed:', e);
      redirectToLogin();
    }
  }, 300000); // Check every 5 minutes

  // Detect tab visibility and re-verify auth when tab becomes visible
  document.addEventListener('visibilitychange', async function() {
    if (!document.hidden) {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          redirectToLogin();
        } else {
          authToken = session.access_token;
          // Refresh data
          await loadUserSubscriptionData();
          await loadDashboardData();
        }
      } catch (e) {
        console.error('Visibility auth check failed:', e);
        redirectToLogin();
      }
    }
  });

  // Clean up on page unload
  window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
  });

</script>
</body>
</html>
