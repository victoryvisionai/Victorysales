<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Manage your social media posts and analytics."/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Social Media</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .navbar nav ul li {
      margin: 0 10px;
    }
    .navbar nav ul li a {
      color: white;
      text-decoration: none;
    }
    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .navbar .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      position: relative;
      border: none;
      transition: all 0.3s ease;
    }
    .subscription-medallion.bronze {
      background: linear-gradient(45deg, #CD7F32, #A0522D);
    }
    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }
    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }
    .subscription-medallion:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }
    .content {
      padding: 20px 4px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .page-header {
      margin-bottom: 30px;
    }
    .page-title {
      font-size: 2.5rem;
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      font-size: 1.1rem;
      color: #666;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .ai-toggle-label {
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .toggle-switch.active {
      background: #28a745;
    }
    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-switch.active .toggle-slider {
      transform: translateX(26px);
    }
    .credits-display {
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 8px 12px;
      text-align: center;
      min-width: 80px;
    }
    .credits-number {
      font-size: 1.2em;
      font-weight: bold;
      color: white;
    }
    .credits-label {
      font-size: 0.7em;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Enhanced Content Creation Hub */
    .content-hub {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .create-post-section {
      background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #bb133e;
    }
    .ai-assistant-panel {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #0A3161;
    }
    .ai-assistant-panel h4 {
      margin: 0 0 10px 0;
      color: #0A3161;
    }
    .ai-btn {
      background: linear-gradient(135deg, #bb133e, #8b0f2e);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin: 5px 5px 0 0;
      transition: all 0.2s ease;
    }
    .ai-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(187, 19, 62, 0.3);
    }
    
    /* Enhanced Post Composer with larger text area */
    .post-composer {
      background: white;
      border-radius: 8px;
      padding: 15px;
    }
    .post-composer textarea {
      width: 100%;
      min-height: 400px; /* Increased from 100px to 400px - 4x bigger */
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      resize: vertical;
      font-family: inherit;
      box-sizing: border-box;
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Post Input Modal */
    .post-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .post-modal-content {
      background: white;
      margin: 2% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .modal-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #edebe9;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Upload Post Example Modal */
    .upload-example-modal {
      display: none;
      position: fixed;
      z-index: 2001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .upload-example-content {
      background: white;
      margin: 2% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .upload-example-form {
      padding: 20px;
      display: grid;
      gap: 15px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }

    /* Monthly Calendar */
    .calendar-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #bb133e;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .calendar-nav {
      background: #0A3161;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .calendar-nav:hover {
      background: #083050;
    }
    .calendar-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #0A3161;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #dee2e6;
      border-radius: 6px;
      overflow: hidden;
    }
    .calendar-day-header {
      background: #0A3161;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }
    .calendar-day {
      background: white;
      padding: 8px;
      min-height: 80px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .calendar-day:hover {
      background: #f8f9fa;
    }
    .calendar-day.other-month {
      background: #f8f9fa;
      color: #6c757d;
    }
    .calendar-day.today {
      background: #e3f2fd;
      border: 2px solid #0A3161;
    }
    .calendar-day-number {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .calendar-post {
      background: #bb133e;
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      margin-bottom: 2px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .calendar-post:hover {
      background: #8b0f2e;
    }

    /* Date Time Picker */
    .datetime-picker {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .datetime-picker input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .platform-selector {
      margin: 15px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .platform-toggle {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }
    .platform-toggle.active {
      background: #0A3161;
      color: white;
      border-color: #0A3161;
    }
    .schedule-options {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* Media Upload Section */
    .media-upload-section {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #28a745;
    }
    .upload-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 15px;
    }
    .upload-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .upload-btn:hover {
      background: #218838;
    }
    .upload-btn.secondary {
      background: #6c757d;
    }
    .upload-btn.secondary:hover {
      background: #5a6268;
    }
    .attached-media {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .attached-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      color: #323130;
    }
    .remove-media {
      cursor: pointer;
      color: #dc3545;
      font-weight: bold;
    }

    /* Enhanced Analytics */
    .analytics-widget {
      background: white;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #28a745;
    }
    .best-times-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .time-slot {
      padding: 10px;
      text-align: center;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
    }
    .time-slot.optimal {
      background: #28a745;
      color: white;
    }
    .time-slot.good {
      background: #ffc107;
      color: #333;
    }
    .time-slot.average {
      background: #f8f9fa;
      color: #666;
    }
    
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #0A3161;
      transition: transform 0.2s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 5px;
    }
    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }
    
    .filter-section {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto auto auto;
      gap: 15px;
      align-items: end;
      margin-bottom: 20px;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background: #0A3161;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 5px 0 0;
    }
    button:hover {
      background: #083050;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    button.warning {
      background: #ffc107;
      color: #333;
    }
    button.warning:hover {
      background: #e0a800;
    }
    
    .social-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .social-table th {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      cursor: pointer;
    }
    .social-table th:hover {
      background: linear-gradient(135deg, #083050, #154a7d);
    }
    .social-table td {
      padding: 15px;
      border-bottom: 1px solid #dee2e6;
      vertical-align: top;
    }
    .social-table tr {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .social-table tr:hover {
      background-color: #f8f9fa;
    }
    .social-table tr.expanded {
      background-color: #e3f2fd;
    }
    .platform-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      color: white;
    }
    .platform-badge.twitter {
      background: #1DA1F2;
    }
    .platform-badge.linkedin {
      background: #0077B5;
    }
    .platform-badge.instagram {
      background: #E4405F;
    }
    .platform-badge.youtube {
      background: #FF0000;
    }
    .platform-badge.facebook {
      background: #1877F2;
    }
    .platform-badge.tiktok {
      background: #000000;
    }
    .platform-badge.default {
      background: #6c757d;
    }
    .post-title {
      font-weight: 600;
      color: #0A3161;
      margin-bottom: 5px;
    }
    .post-preview {
      color: #666;
      font-size: 0.9em;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .engagement-stats {
      display: flex;
      gap: 15px;
    }
    .engagement-item {
      text-align: center;
    }
    .engagement-number {
      font-weight: bold;
      color: #0A3161;
      display: block;
    }
    .engagement-label {
      font-size: 0.7em;
      color: #666;
      text-transform: uppercase;
    }
    
    /* Revenue tracking */
    .revenue-badge {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin-top: 5px;
      display: inline-block;
    }

    /* Media Display */
    .post-media {
      margin-top: 10px;
      max-width: 200px;
    }
    .post-media img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .post-media video {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .media-placeholder {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
      color: #6c757d;
      font-size: 0.9em;
    }
    
    .expanded-content {
      display: none;
      background: #f8f9fa;
      border-top: 2px solid #0A3161;
    }
    .expanded-content.show {
      display: table-row;
    }
    .expanded-details {
      padding: 20px;
      background: white;
      margin: 10px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .detail-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid #0A3161;
    }
    .detail-label {
      font-weight: bold;
      color: #0A3161;
      margin-bottom: 5px;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-value {
      color: #333;
      word-break: break-word;
    }
    .post-url {
      color: #0A3161;
      text-decoration: underline;
      cursor: pointer;
    }
    .post-url:hover {
      color: #083050;
    }

    /* File Browser Modal */
    .file-browser-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
    }
    .file-browser-content {
      background: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 8px;
      width: 90%;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .file-browser-header {
      background: #faf9f8;
      padding: 20px 24px;
      border-bottom: 1px solid #edebe9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-browser-title {
      font-size: 18px;
      font-weight: 600;
      color: #323130;
    }
    .file-browser-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #605e5c;
      padding: 4px;
    }
    .file-browser-body {
      padding: 24px;
    }
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }
    .file-card {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .file-card:hover {
      border-color: #0A3161;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .file-card.selected {
      border-color: #0A3161;
      background: #e3f2fd;
      box-shadow: 0 0 0 2px #0A3161;
    }
    .file-preview {
      width: 100%;
      height: 100px;
      background: #f8f9fa;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .file-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      border-radius: 4px;
    }
    .file-preview video {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      border-radius: 4px;
    }
    .file-icon {
      font-size: 32px;
      color: #6c757d;
    }
    .file-info {
      text-align: center;
    }
    .file-name {
      font-size: 12px;
      font-weight: 500;
      color: #323130;
      margin-bottom: 2px;
      word-break: break-word;
    }
    .file-size {
      font-size: 10px;
      color: #8a8886;
    }
    .btn-secondary {
      background: white;
      color: #323130;
      border: 1px solid #d1d1d1;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary {
      background: #0A3161;
      color: white;
      border: 1px solid #0A3161;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.1rem;
      color: #666;
    }
    .loading::before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ddd;
      border-top: 2px solid #0A3161;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }
    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #0A3161;
    }
    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
      position: fixed;
      top: 80px;
      right: 20px;
      max-width: 400px;
      z-index: 1000;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
    }
    footer a {
      color: #fff;
      margin-right: 15px;
      text-decoration: none;
    }
    
    /* Intro.js styling */
    .introjs-tooltip {
      max-width: 350px;
      font-size: 14px;
    }
    .introjs-button {
      background: #0A3161 !important;
      border: 1px solid #0A3161 !important;
      color: white !important;
      padding: 8px 15px !important;
      border-radius: 4px !important;
    }
    .introjs-button:hover {
      background: #083050 !important;
    }
    .introjs-progressbar {
      background-color: #0A3161 !important;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .content {
        padding: 10px 5px;
      }
      .page-title {
        font-size: 2rem;
      }
      .content-hub {
        grid-template-columns: 1fr;
      }
      .stats-section {
        grid-template-columns: repeat(2, 1fr);
      }
      .filter-section {
        grid-template-columns: 1fr;
      }
      .engagement-stats {
        flex-direction: column;
        gap: 8px;
      }
      .social-table {
        font-size: 0.9em;
      }
      .social-table th,
      .social-table td {
        padding: 10px 8px;
      }
      .detail-grid {
        grid-template-columns: 1fr;
      }
      .header-controls {
        flex-direction: column;
        gap: 10px;
      }
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        font-size: 12px;
      }
      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }
      .post-modal-content,
      .upload-example-content {
        width: 95%;
        margin: 5% auto;
      }
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="logo">
    <img class="logo-image" src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
      <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>
      <li><a href="ads">Ads</a></li>
       <li><a href="contacts">Contacts</a></li>
       <li><a href="messages">Messages</a></li>
    <li><a href="settings">Settings</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <button onclick="startTour()" style="background: #28a745; padding: 6px 12px; font-size: 11px; margin-left: 10px;" id="tourButton">
      üìñ Take Tour
    </button>
    <div id="subscriptionMedallion" class="subscription-medallion bronze">
      <span class="plan-name">Bronze</span>
    </div>
  </div>
</header>

<div class="content">
  <header class="page-header">
    <h1 class="page-title">Social Media Command Center</h1>
    <p class="page-subtitle">Create, schedule, and analyze your social media presence with AI-powered insights</p>
  </header>

  <!-- Enhanced Stats Overview -->
  <section class="stats-section" data-intro="Your social media performance dashboard shows real-time metrics across all platforms." data-step="1">
    <div class="stat-card">
      <div class="stat-number" id="totalPosts">0</div>
      <div class="stat-label">Total Posts</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalEngagements">0</div>
      <div class="stat-label">Total Engagements</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalShares">0</div>
      <div class="stat-label">Total Shares</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalClicks">0</div>
      <div class="stat-label">Total Clicks</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalRevenue">$0</div>
      <div class="stat-label">Revenue Generated</div>
    </div>
  </section>

  <!-- Enhanced Content Creation Hub -->
  <section class="content-hub" data-intro="Create and schedule posts across all your social platforms with AI assistance and media uploads." data-step="2">
    <div class="create-post-section">
      <h3 style="margin: 0 0 15px 0; color: #0A3161;">üöÄ AI-Powered Content Creator</h3>
      
      <div class="ai-assistant-panel">
        <h4>ü§ñ AI Writing Assistant</h4>
        <button class="ai-btn" onclick="generateCaption()">‚ú® Generate Caption</button>
      <button class="ai-btn" onclick="suggestHashtags()">üè∑Ô∏è Smart Hashtags</button> 
        <button class="ai-btn" onclick="optimizeForPlatform()">üéØ Optimize Content</button>
    <button class="ai-btn" onclick="getTrendingTopics()">üìà Trending Topics</button> 
      </div>

      <!-- Media Upload Section -->  
      <div class="media-upload-section">
        <h4>üìÅ Media & Files</h4>
        <div class="upload-controls">
          <button class="upload-btn" onclick="openFileBrowser()">üìÇ Browse Media</button>
          <button class="upload-btn secondary" onclick="uploadNewFile()">üì§ Upload New</button>
          <button class="upload-btn warning" onclick="openUploadExampleModal()">üìã Upload Post Example</button>
          <input type="file" id="fileUploadInput" style="display: none;" multiple accept="image/*,video/*" onchange="handleFileUpload(event)">
        </div>
        <div class="attached-media" id="attachedMedia">
          <!-- Attached media will appear here -->
        </div>
      </div>
      
      <div class="post-composer">
        <textarea id="postContent" placeholder="What's happening? Our AI can help you craft the perfect message..." onclick="openPostModal()"></textarea>
        
        <div class="platform-selector">
          <div class="platform-toggle active" data-platform="linkedin">
            <span>üíº</span> LinkedIn
          </div>
          <div class="platform-toggle" data-platform="twitter">
            <span>ùïè</span> Twitter
          </div>
          <div class="platform-toggle" data-platform="instagram">
            <span>üì∑</span> Instagram
          </div>
          <div class="platform-toggle" data-platform="youtube">
            <span>‚ñ∂Ô∏è</span> YouTube
          </div>
          <div class="platform-toggle" data-platform="facebook">
            <span>üìò</span> Facebook
          </div>
        </div>
        
        <div class="schedule-options">
          <button class="success" onclick="postNow()">üì§ Post Now</button>
          <button onclick="openScheduleModal()">‚è∞ Schedule</button>
          <button class="secondary" onclick="saveDraft()">üíæ Save Draft</button>
        </div>
      </div>
    </div>

    <div class="analytics-widget" data-intro="See optimal posting times and performance insights." data-step="3">
      <h3 style="margin: 0 0 15px 0; color: #0A3161;">‚è∞ Best Times to Post</h3>
      <p style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;">Based on your audience activity</p>
      
      <div class="best-times-grid">
        <div class="time-slot optimal">9 AM<br><small>Peak</small></div>
        <div class="time-slot good">12 PM<br><small>Good</small></div>
        <div class="time-slot optimal">6 PM<br><small>Peak</small></div>
        <div class="time-slot average">11 PM<br><small>Low</small></div>
      </div>
      
      <p style="margin: 15px 0 0 0; color: #666; font-size: 0.8em;">
        üü¢ Peak engagement ‚Ä¢ üü° Good performance ‚Ä¢ ‚ö™ Average reach
      </p>
    </div>
  </section>

  <!-- Monthly Calendar Section -->
  <section class="calendar-section" data-intro="View your scheduled posts in a monthly calendar view. Click on any post to edit or reschedule." data-step="4">
    <div class="calendar-header">
      <button class="calendar-nav" onclick="previousMonth()">‚Üê Previous</button>
      <h3 class="calendar-title" id="calendarTitle">January 2025</h3>
      <button class="calendar-nav" onclick="nextMonth()">Next ‚Üí</button>
    </div>
    
    <div class="calendar-grid" id="calendarGrid">
      <!-- Calendar will be generated here -->
    </div>
  </section>

  <!-- Control Section with AI Toggle -->
  <section class="card">
    <div class="section-header">
      <h3>üì± Social Media Management</h3>
      <div class="header-controls">
        <div class="credits-display">
          <div class="credits-number" id="socialCredits">Loading...</div>
          <div class="credits-label">Social Credits</div>
        </div>
        <div class="ai-toggle-container" data-intro="Enable AI Auto Post to automatically create and schedule content." data-step="5">
          <span class="ai-toggle-label">ü§ñ AI Auto Post</span>
          <div class="toggle-switch" id="aiToggle" onclick="toggleAIPost()">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="filter-section" data-intro="Filter your posts by platform or search for specific content." data-step="6">
      <div class="form-group">
        <label for="platformFilter">Platform</label>
        <select id="platformFilter">
          <option value="">All Platforms</option>
          <option value="twitter">Twitter</option>
          <option value="linkedin">LinkedIn</option>
          <option value="instagram">Instagram</option>
          <option value="youtube">YouTube</option>
          <option value="facebook">Facebook</option>
          <option value="tiktok">TikTok</option>
        </select>
      </div>
      <div class="form-group">
        <label for="performanceFilter">Performance</label>
        <select id="performanceFilter">
          <option value="">All Posts</option>
          <option value="high">High Performing (Top Third)</option>
          <option value="medium">Medium Performing (Middle Third)</option>
          <option value="low">Low Performing (Bottom Third)</option>
        </select>
      </div>
      <div class="form-group">
        <label for="searchFilter">Search</label>
        <input type="text" id="searchFilter" placeholder="Search posts...">
      </div>
      <button id="refreshSocial">üîÑ Refresh</button>
      <button id="clearFilters" class="secondary">Clear Filters</button>
      <button id="updatePosts" class="warning" onclick="openUpdatePostsModal()">üìù Update Posts</button>
    </div>
  </section>

  <!-- Social Posts Table -->
  <section id="socialContainer" data-intro="Your complete social media post history with performance analytics and revenue tracking." data-step="7">
    <div class="loading">Loading your social media posts...</div>
  </section>

  <!-- Status Messages -->
  <div id="statusMessage" class="status-message"></div>
</div>

<!-- Enhanced Post Input Modal -->
<div id="postModal" class="post-modal">
  <div class="post-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚ú® Create Your Social Media Post</h2>
      <button class="modal-close" onclick="closePostModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="modalPostContent">Post Content</label>
        <textarea id="modalPostContent" placeholder="What's happening? Share your thoughts, insights, or updates with your audience..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Select Platforms</label>
        <div class="platform-selector" id="modalPlatformSelector">
          <div class="platform-toggle active" data-platform="linkedin">
            <span>üíº</span> LinkedIn
          </div>
          <div class="platform-toggle" data-platform="twitter">
            <span>ùïè</span> Twitter
          </div>
          <div class="platform-toggle" data-platform="instagram">
            <span>üì∑</span> Instagram
          </div>
          <div class="platform-toggle" data-platform="youtube">
            <span>‚ñ∂Ô∏è</span> YouTube
          </div>
          <div class="platform-toggle" data-platform="facebook">
            <span>üìò</span> Facebook
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="modalHashtags">Hashtags</label>
        <input type="text" id="modalHashtags" placeholder="#hashtag1 #hashtag2 #hashtag3">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closePostModal()">Cancel</button>
      <button class="btn-primary" onclick="savePostFromModal()">Save & Close</button>
    </div>
  </div>
</div>

<!-- Schedule Post Modal -->
<div id="scheduleModal" class="post-modal">
  <div class="post-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚è∞ Schedule Your Post</h2>
      <button class="modal-close" onclick="closeScheduleModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="scheduleDate">Schedule Date & Time</label>
        <div class="datetime-picker">
          <input type="date" id="scheduleDate" min="" value="">
          <input type="time" id="scheduleTime" value="09:00">
        </div>
      </div>
      
      <div class="form-group">
        <label>Post Preview</label>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
          <div id="schedulePreview">Your post content will appear here...</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
      <button class="btn-primary" onclick="confirmSchedulePost()">üìÖ Schedule Post</button>
    </div>
  </div>
</div>

<!-- Upload Post Example Modal -->
<div id="uploadExampleModal" class="upload-example-modal">
  <div class="upload-example-content">
    <div class="modal-header">
      <h2 class="modal-title">üìã Upload Post Example</h2>
      <button class="modal-close" onclick="closeUploadExampleModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form class="upload-example-form" id="uploadExampleForm">
        <div class="form-group">
          <label for="exampleTitle">Post Title</label>
          <input type="text" id="exampleTitle" placeholder="Enter a descriptive title for this post">
        </div>
        
        <div class="form-group">
          <label for="examplePlatform">Platform</label>
          <select id="examplePlatform">
            <option value="linkedin">LinkedIn</option>
            <option value="twitter">Twitter</option>
            <option value="instagram">Instagram</option>
            <option value="youtube">YouTube</option>
            <option value="facebook">Facebook</option>
            <option value="tiktok">TikTok</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="exampleContent">Post Content</label>
          <textarea id="exampleContent" placeholder="Enter the full post content..."></textarea>
        </div>
        
        <div class="form-group">
          <label for="exampleHashtags">Hashtags</label>
          <input type="text" id="exampleHashtags" placeholder="#hashtag1 #hashtag2 #hashtag3">
        </div>
        
        <div class="form-group">
          <label for="exampleUrl">Post URL (if published)</label>
          <input type="url" id="exampleUrl" placeholder="https://...">
        </div>
        
        <div class="form-group">
          <label for="exampleEngagements">Engagements</label>
          <input type="number" id="exampleEngagements" placeholder="0" min="0">
        </div>
        
        <div class="form-group">
          <label for="exampleShares">Shares</label>
          <input type="number" id="exampleShares" placeholder="0" min="0">
        </div>
        
        <div class="form-group">
          <label for="exampleClicks">Clicks</label>
          <input type="number" id="exampleClicks" placeholder="0" min="0">
        </div>
        
        <div class="form-group">
          <label for="exampleRevenue">Revenue Generated ($)</label>
          <input type="number" id="exampleRevenue" placeholder="0.00" min="0" step="0.01">
        </div>
        
        <div class="form-group">
          <label for="exampleMediaUrl">Media URL</label>
          <input type="url" id="exampleMediaUrl" placeholder="https://... (image or video URL)">
        </div>
        
        <div class="form-group">
          <label for="exampleNotes">Notes</label>
          <textarea id="exampleNotes" placeholder="Additional notes about this post..." style="min-height: 80px;"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeUploadExampleModal()">Cancel</button>
      <button class="btn-primary" onclick="savePostExample()">üíæ Save Post Example</button>
    </div>
  </div>
</div>

<!-- Update Posts Modal -->
<div id="updatePostsModal" class="post-modal">
  <div class="post-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üìù Update Posts</h2>
      <button class="modal-close" onclick="closeUpdatePostsModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 20px;">
        <h4>Drafts & Scheduled Posts</h4>
        <div id="updatePostsList">
          <!-- List of drafts and scheduled posts will appear here -->
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeUpdatePostsModal()">Close</button>
    </div>
  </div>
</div>

<!-- File Browser Modal -->
<div id="fileBrowserModal" class="file-browser-modal">
  <div class="file-browser-content">
    <div class="file-browser-header">
      <h2 class="file-browser-title">Select Media to Attach</h2>
      <button class="file-browser-close" onclick="closeFileBrowser()">√ó</button>
    </div>
    <div class="file-browser-body">
      <div class="file-grid" id="fileGrid">
        <!-- Campaign files will be loaded here -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeFileBrowser()">Cancel</button>
      <button class="btn-primary" onclick="attachSelectedFiles()">Attach Selected</button>
    </div>
  </div>
</div>

<footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
  // Supabase configuration for auth only
  const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  
  // Enhanced n8n endpoints
  const ENDPOINTS = {
    getUserData: 'https://victoryvision.app.n8n.cloud/webhook/user/get',
    getSocial: 'https://victoryvision.app.n8n.cloud/webhook/socials/get',
    getMedia: 'https://victoryvision.app.n8n.cloud/webhook/media/get',
    aiPost: 'https://victoryvision.app.n8n.cloud/webhook/user/aipost',
    createPost: 'https://victoryvision.app.n8n.cloud/webhook/social/create-post',
    schedulePost: 'https://victoryvision.app.n8n.cloud/webhook/social/schedule',
    optimizeContent: 'https://victoryvision.app.n8n.cloud/webhook/social/optimize',
    uploadMedia: 'https://victoryvision.app.n8n.cloud/webhook/media/upload',
    getDrafts: 'https://victoryvision.app.n8n.cloud/webhook/social/drafts',
    
    generateCaption: 'https://victoryvision.app.n8n.cloud/webhook/social/generate-caption',
    suggestHashtags: 'https://victoryvision.app.n8n.cloud/webhook/social/hashtags',
    getTrending: 'https://victoryvision.app.n8n.cloud/webhook/social/trending',
   
    updatePost: 'https://victoryvision.app.n8n.cloud/webhook/social/update',
    savePostExample: 'https://victoryvision.app.n8n.cloud/webhook/social/save-example'
  };
  
  let CUSTOMER_ID = null;
  let authToken = null;
  let userCredits = { social_credits: 0 };
  let aiPostEnabled = false;
  let selectedPlatforms = ['linkedin'];

  // State management
  let allSocialPosts = [];
  let filteredSocialPosts = [];
  let expandedRows = new Set();
  let campaignFiles = [];
  let attachedFiles = [];
  let selectedFiles = [];
  let currentDate = new Date();
  let scheduledPosts = {};
  let drafts = [];
  let performanceThresholds = { high: 0, medium: 0, low: 0 };

  // DOM elements
  const socialContainer = document.getElementById('socialContainer');
  const platformFilter = document.getElementById('platformFilter');
  const performanceFilter = document.getElementById('performanceFilter');
  const searchFilter = document.getElementById('searchFilter');
  const refreshSocialBtn = document.getElementById('refreshSocial');
  const clearFiltersBtn = document.getElementById('clearFilters');
  const aiToggle = document.getElementById('aiToggle');
  const postContent = document.getElementById('postContent');

  // Tour completion tracking
  function completeTour() {
    localStorage.setItem('vv_tour_completed_' + window.location.pathname, 'true');
  }

  function hasCompletedTour() {
    return localStorage.getItem('vv_tour_completed_' + window.location.pathname) === 'true';
  }

  function startTour() {
    introJs().setOptions({
      showProgress: true,
      showBullets: false,
      exitOnOverlayClick: false,
      nextLabel: 'Next ‚Üí',
      prevLabel: '‚Üê Back',
      doneLabel: 'Complete!',
      skipLabel: 'Skip Tour'
    }).oncomplete(completeTour).onexit(completeTour).start();
  }

  // Authentication
  async function checkAuthentication() {
    try {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      
      if (error) {
        console.error('Auth error:', error);
        return false;
      }

      if (session && session.user) {
        CUSTOMER_ID = session.user.email;
        authToken = session.access_token;
        document.getElementById('userEmail').textContent = CUSTOMER_ID;
        return true;
      }

      return false;
    } catch (e) {
      console.error('Auth check error:', e);
      return false;
    }
  }

  function redirectToLogin() {
    localStorage.removeItem('vv_session');
    window.location.href = 'login.html';
  }

  // API call function
  async function apiCall(endpoint, data = {}) {
    try {
      const isGetRequest = endpoint.includes('/user/get') || endpoint.includes('/socials/get') || endpoint.includes('/drafts');
      
      const url = isGetRequest ? 
        `${endpoint}?customer_id=${encodeURIComponent(CUSTOMER_ID)}` : 
        endpoint;
      
      const requestOptions = {
        method: isGetRequest ? 'GET' : 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Customer-ID': CUSTOMER_ID,
          'Authorization': authToken ? `Bearer ${authToken}` : ''
        }
      };

      if (!isGetRequest) {
        requestOptions.body = JSON.stringify({
          customer_id: CUSTOMER_ID,
          ...data
        });
      }

      const response = await fetch(url, requestOptions);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      return await response.json();
    } catch (error) {
      console.error('API call failed:', error);
      throw error;
    }
  }

  // Calculate performance thresholds
  function calculatePerformanceThresholds() {
    if (allSocialPosts.length === 0) {
      performanceThresholds = { high: 0, medium: 0, low: 0 };
      return;
    }

    const engagementScores = allSocialPosts.map(post => {
      const engagements = parseInt(post.engagements) || 0;
      const clicks = parseInt(post.clicks) || 0;
      const shares = parseInt(post.shares) || 0;
      return engagements + clicks + shares;
    }).sort((a, b) => b - a);

    const third = Math.floor(engagementScores.length / 3);
    performanceThresholds = {
      high: engagementScores[third - 1] || 0,
      medium: engagementScores[third * 2 - 1] || 0,
      low: 0
    };
  }

  // Load user data and credits
  async function loadUserData() {
    try {
      const response = await apiCall(ENDPOINTS.getUserData);
      console.log('Raw response:', response);
      
      const userData = Array.isArray(response) ? response[0] : response;
      console.log('User data:', userData);
      
      userCredits = {
        social_credits: userData.social_credits || 0
      };
      
      // Update subscription medallion
      const medallion = document.getElementById('subscriptionMedallion');
      const plan = userData.subscription_plan || 'bronze';
      medallion.className = `subscription-medallion ${plan.toLowerCase()}`;
      medallion.querySelector('.plan-name').textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
      
      // Update AI post status
      aiPostEnabled = userData.ai_auto_post === true || userData.ai_auto_post === 'true';
      updateAIToggleDisplay();
      
      updateCreditsDisplay();
    } catch (error) {
      console.error('Error loading user data:', error);
      showStatus('Error loading user data: ' + error.message, true);
    }
  }

  // Load campaign files for media browser
  async function loadCampaignFiles() {
    try {
      const data = await apiCall(ENDPOINTS.getMedia);
      campaignFiles = Array.isArray(data) ? data : (data.files || []);
      console.log(`Loaded ${campaignFiles.length} campaign files`);
    } catch (error) {
      console.error('Error loading campaign files:', error);
      campaignFiles = [];
    }
  }

  // Load drafts and scheduled posts
  async function loadDrafts() {
    try {
      const data = await apiCall(ENDPOINTS.getDrafts);
      drafts = Array.isArray(data) ? data : (data.drafts || []);
      console.log(`Loaded ${drafts.length} drafts`);
    } catch (error) {
      console.error('Error loading drafts:', error);
      drafts = [];
    }
  }

  // Update credits display
  function updateCreditsDisplay() {
    const socialCreditsElement = document.getElementById('socialCredits');
    if (socialCreditsElement) {
      socialCreditsElement.textContent = userCredits.social_credits;
    }
  }

  // Update AI toggle display
  function updateAIToggleDisplay() {
    if (aiPostEnabled) {
      aiToggle.classList.add('active');
    } else {
      aiToggle.classList.remove('active');
    }
  }

  // Toggle AI auto post
  async function toggleAIPost() {
    try {
      const newStatus = !aiPostEnabled;
      
      const result = await apiCall(ENDPOINTS.aiPost, {
        ai_auto_post: newStatus
      });
      
      if (result.success !== false) {
        aiPostEnabled = newStatus;
        updateAIToggleDisplay();
        showStatus(`AI Auto Post ${newStatus ? 'enabled' : 'disabled'}!`);
      } else {
        throw new Error(result.message || 'Failed to update AI auto post setting');
      }
    } catch (error) {
      console.error('Error toggling AI post:', error);
      showStatus('Error updating AI auto post: ' + error.message, true);
    }
  }

  // Enhanced Post Modal Functions
  function openPostModal() {
    const modal = document.getElementById('postModal');
    const modalContent = document.getElementById('modalPostContent');
    modalContent.value = postContent.value;
    modal.style.display = 'block';
  }

  function closePostModal() {
    document.getElementById('postModal').style.display = 'none';
  }

  function savePostFromModal() {
    const modalContent = document.getElementById('modalPostContent');
    const hashtags = document.getElementById('modalHashtags').value;
    
    let content = modalContent.value;
    if (hashtags.trim()) {
      content += '\n\n' + hashtags;
    }
    
    postContent.value = content;
    closePostModal();
  }

  // Schedule Modal Functions
  function openScheduleModal() {
    if (!postContent.value.trim()) {
      showStatus('Please enter some content first', true);
      return;
    }
    
    const modal = document.getElementById('scheduleModal');
    const preview = document.getElementById('schedulePreview');
    const dateInput = document.getElementById('scheduleDate');
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
    dateInput.value = today;
    
    preview.textContent = postContent.value;
    modal.style.display = 'block';
  }

  function closeScheduleModal() {
    document.getElementById('scheduleModal').style.display = 'none';
  }

  async function confirmSchedulePost() {
    const scheduleDate = document.getElementById('scheduleDate').value;
    const scheduleTime = document.getElementById('scheduleTime').value;
    
    if (!scheduleDate || !scheduleTime) {
      showStatus('Please select both date and time', true);
      return;
    }
    
    const scheduledDateTime = `${scheduleDate} ${scheduleTime}`;
    
    try {
      showStatus('Scheduling post...', false);
      const result = await apiCall(ENDPOINTS.schedulePost, {
        content: postContent.value,
        platforms: selectedPlatforms,
        scheduled_for: scheduledDateTime,
        attachments: attachedFiles
      });
      
      if (result.success !== false) {
        showStatus(`Post scheduled for ${scheduledDateTime}!`);
        postContent.value = '';
        attachedFiles = [];
        updateAttachmentDisplay();
        closeScheduleModal();
        await loadSocialPosts();
        renderCalendar();
      } else {
        showStatus('Post scheduling failed. Try again.', true);
      }
    } catch (error) {
      console.error('Error scheduling post:', error);
      showStatus('Error scheduling post: ' + error.message, true);
    }
  }

  // Upload Example Modal Functions
  function openUploadExampleModal() {
    document.getElementById('uploadExampleModal').style.display = 'block';
  }

  function closeUploadExampleModal() {
    document.getElementById('uploadExampleModal').style.display = 'none';
    document.getElementById('uploadExampleForm').reset();
  }

  async function savePostExample() {
    const form = document.getElementById('uploadExampleForm');
    const formData = new FormData(form);
    
    const postData = {
      title: document.getElementById('exampleTitle').value,
      platform: document.getElementById('examplePlatform').value,
      message: document.getElementById('exampleContent').value,
      hashtag: document.getElementById('exampleHashtags').value,
      URL: document.getElementById('exampleUrl').value,
      engagements: parseInt(document.getElementById('exampleEngagements').value) || 0,
      shares: parseInt(document.getElementById('exampleShares').value) || 0,
      clicks: parseInt(document.getElementById('exampleClicks').value) || 0,
      revenue: parseFloat(document.getElementById('exampleRevenue').value) || 0,
      media_URL: document.getElementById('exampleMediaUrl').value,
      notes: document.getElementById('exampleNotes').value,
      created_at: new Date().toISOString(),
      example: true
    };
    
    try {
      showStatus('Saving post example...', false);
      const result = await apiCall(ENDPOINTS.savePostExample, postData);
      
      if (result.success !== false) {
        showStatus('Post example saved successfully!');
        closeUploadExampleModal();
        await loadSocialPosts();
        applyFilters();
      } else {
        showStatus('Failed to save post example. Try again.', true);
      }
    } catch (error) {
      console.error('Error saving post example:', error);
      showStatus('Error saving post example: ' + error.message, true);
    }
  }

  // Update Posts Modal Functions
  async function openUpdatePostsModal() {
    await loadDrafts();
    const modal = document.getElementById('updatePostsModal');
    const list = document.getElementById('updatePostsList');
    
    if (drafts.length === 0) {
      list.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No drafts or scheduled posts found.</p>';
    } else {
      list.innerHTML = drafts.map((draft, index) => `
        <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin-bottom: 10px; background: white;">
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
            <div>
              <strong>${draft.title || 'Untitled Post'}</strong>
              <span style="margin-left: 10px; font-size: 12px; background: #0A3161; color: white; padding: 2px 6px; border-radius: 10px;">
                ${draft.status || 'Draft'}
              </span>
            </div>
            <div style="margin-left: auto;">
              <button onclick="editDraft(${index})" style="background: #ffc107; color: #333; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px;">Edit</button>
              <button onclick="deleteDraft(${index})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Delete</button>
            </div>
          </div>
          <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
            ${(draft.message || '').substring(0, 100)}${draft.message && draft.message.length > 100 ? '...' : ''}
          </div>
          <div style="font-size: 12px; color: #666;">
            Platform: ${draft.platform || 'Multiple'} | 
            ${draft.scheduled_for ? `Scheduled: ${new Date(draft.scheduled_for).toLocaleString()}` : 'Draft'}
          </div>
        </div>
      `).join('');
    }
    
    modal.style.display = 'block';
  }

  function closeUpdatePostsModal() {
    document.getElementById('updatePostsModal').style.display = 'none';
  }

  async function editDraft(index) {
    const draft = drafts[index];
    postContent.value = draft.message || '';
    
    if (draft.hashtag) {
      postContent.value += '\n\n' + draft.hashtag;
    }
    
    closeUpdatePostsModal();
    showStatus('Draft loaded for editing');
  }

  async function deleteDraft(index) {
    if (!confirm('Are you sure you want to delete this draft?')) return;
    
    try {
      const draft = drafts[index];
      const result = await apiCall(ENDPOINTS.updatePost, {
        id: draft.id,
        action: 'delete'
      });
      
      if (result.success !== false) {
        showStatus('Draft deleted successfully');
        await loadDrafts();
        openUpdatePostsModal(); // Refresh the modal
      } else {
        showStatus('Failed to delete draft', true);
      }
    } catch (error) {
      console.error('Error deleting draft:', error);
      showStatus('Error deleting draft: ' + error.message, true);
    }
  }

  // Calendar Functions
  function renderCalendar() {
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarTitle = document.getElementById('calendarTitle');
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    calendarTitle.textContent = new Date(year, month).toLocaleDateString('en-US', { 
      month: 'long', 
      year: 'numeric' 
    });
    
    // Clear existing calendar
    calendarGrid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
      const dayHeader = document.createElement('div');
      dayHeader.className = 'calendar-day-header';
      dayHeader.textContent = day;
      calendarGrid.appendChild(dayHeader);
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    
    // Add empty cells for days before first day of month
    for (let i = 0; i < firstDay; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.className = 'calendar-day other-month';
      calendarGrid.appendChild(emptyDay);
    }
    
    // Add days of month
    for (let day = 1; day <= daysInMonth; day++) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      
      const currentDateForDay = new Date(year, month, day);
      
      // Check if this is today
      if (currentDateForDay.toDateString() === today.toDateString()) {
        dayElement.classList.add('today');
      }
      
      dayElement.innerHTML = `<div class="calendar-day-number">${day}</div>`;
      
      // Add scheduled posts for this day
      const dateKey = currentDateForDay.toISOString().split('T')[0];
      const postsForDay = allSocialPosts.filter(post => {
        if (!post.scheduled_for) return false;
        const postDate = new Date(post.scheduled_for).toISOString().split('T')[0];
        return postDate === dateKey;
      });
      
      postsForDay.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'calendar-post';
        postElement.textContent = (post.title || post.message || 'Scheduled Post').substring(0, 15) + '...';
        postElement.onclick = (e) => {
          e.stopPropagation();
          openPostDetails(post);
        };
        dayElement.appendChild(postElement);
      });
      
      dayElement.onclick = () => {
        if (currentDateForDay >= today) {
          selectCalendarDate(currentDateForDay);
        }
      };
      
      calendarGrid.appendChild(dayElement);
    }
  }

  function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  }

  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  }

  function selectCalendarDate(date) {
    const dateString = date.toISOString().split('T')[0];
    document.getElementById('scheduleDate').value = dateString;
    openScheduleModal();
  }

  function openPostDetails(post) {
    alert(`Post Details:\n\nTitle: ${post.title || 'Untitled'}\nPlatform: ${post.platform}\nScheduled: ${new Date(post.scheduled_for).toLocaleString()}\n\nContent: ${post.message || 'No content'}`);
  }

  // File attachment functions
  function openFileBrowser() {
    const modal = document.getElementById('fileBrowserModal');
    const fileGrid = document.getElementById('fileGrid');
    
    if (campaignFiles.length === 0) {
      fileGrid.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #605e5c; grid-column: 1 / -1;">
          <div style="font-size: 24px; margin-bottom: 10px;">üìÅ</div>
          <div>No files available</div>
          <div style="font-size: 12px; margin-top: 5px;">Upload files through the Media page first</div>
        </div>
      `;
    } else {
      fileGrid.innerHTML = campaignFiles.map(file => {
        const isImage = file.mime_type && file.mime_type.includes('image');
        const isVideo = file.mime_type && file.mime_type.includes('video');
        
        return `
          <div class="file-card" data-file-id="${file.id}" onclick="toggleFileSelection('${file.id}')">
            <div class="file-preview">
              ${isImage ? `<img src="${file.URL}" alt="${file.name}" loading="lazy">` :
                isVideo ? `<video src="${file.URL}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>` :
                `<div class="file-icon">${getFileIconFromMimeType(file.mime_type)}</div>`}
            </div>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.file_size)}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    selectedFiles = [];
    modal.style.display = 'block';
  }

  function closeFileBrowser() {
    document.getElementById('fileBrowserModal').style.display = 'none';
    selectedFiles = [];
  }

  function toggleFileSelection(fileId) {
    const fileCard = document.querySelector(`[data-file-id="${fileId}"]`);
    const index = selectedFiles.indexOf(fileId);
    
    if (index > -1) {
      selectedFiles.splice(index, 1);
      fileCard.classList.remove('selected');
    } else {
      selectedFiles.push(fileId);
      fileCard.classList.add('selected');
    }
  }

  function attachSelectedFiles() {
    selectedFiles.forEach(fileId => {
      const file = campaignFiles.find(f => f.id === fileId);
      if (file && !attachedFiles.find(af => af.id === fileId)) {
        attachedFiles.push({
          id: file.id,
          name: file.name,
          url: file.URL,
          size: file.file_size,
          type: 'media',
          mimeType: file.mime_type
        });
      }
    });
    
    updateAttachmentDisplay();
    closeFileBrowser();
  }

  function uploadNewFile() {
    document.getElementById('fileUploadInput').click();
  }

  function handleFileUpload(event) {
    const files = Array.from(event.target.files);
    
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result.split(',')[1];
        
        attachedFiles.push({
          id: 'upload_' + Date.now() + '_' + Math.random(),
          name: file.name,
          size: file.size,
          type: 'upload',
          base64: base64Data,
          mimeType: file.type,
          url: e.target.result
        });
        
        updateAttachmentDisplay();
      };
      reader.readAsDataURL(file);
    });
    
    event.target.value = '';
  }

  function updateAttachmentDisplay() {
    const container = document.getElementById('attachedMedia');
    
    if (attachedFiles.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    container.innerHTML = attachedFiles.map((file, index) => {
      const isImage = file.mimeType && file.mimeType.includes('image');
      const isVideo = file.mimeType && file.mimeType.includes('video');
      
      return `
        <div class="attached-item">
          ${isImage ? 'üñºÔ∏è' : isVideo ? 'üé•' : getFileIconFromMimeType(file.mimeType)}
          <span>${file.name}</span>
          <span class="remove-media" onclick="removeAttachment(${index})">√ó</span>
        </div>
      `;
    }).join('');
  }

  function removeAttachment(index) {
    attachedFiles.splice(index, 1);
    updateAttachmentDisplay();
  }

  function getFileIconFromMimeType(mimeType) {
    if (!mimeType) return 'üìÑ';
    
    const type = mimeType.toLowerCase();
    if (type.includes('image')) return 'üñºÔ∏è';
    if (type.includes('video')) return 'üé•';
    if (type.includes('audio')) return 'üéµ';
    if (type.includes('pdf')) return 'üìï';
    if (type.includes('doc') || type.includes('word')) return 'üìò';
    if (type.includes('sheet') || type.includes('excel')) return 'üìó';
    if (type.includes('presentation') || type.includes('powerpoint')) return 'üìô';
    if (type.includes('zip') || type.includes('rar')) return 'üóúÔ∏è';
    return 'üìÑ';
  }

  function formatFileSize(bytes) {
    if (!bytes) return 'Unknown size';
    
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
  }

  // AI-powered content creation functions
async function generateCaption() {
  try {
    console.log('Starting caption generation...'); // Debug log
    showStatus('Generating AI caption...', false);
    
    const result = await apiCall(ENDPOINTS.generateCaption, {
      content: postContent.value,
      platforms: selectedPlatforms,
      tone: 'professional'
    });
    
    console.log('Caption result:', result); // Debug log
    
    if (result.caption) {
      postContent.value = result.caption;
      showStatus('AI caption generated successfully!');
    } else {
      showStatus('No caption generated. Try adding some initial content.', true);
    }
  } catch (error) {
    console.error('Error generating caption:', error);
    showStatus('Error generating caption: ' + error.message, true);
  }
}
  async function suggestHashtags() {
    try {
      if (!postContent.value.trim()) {
        showStatus('Please enter some content first', true);
        return;
      }
      
      showStatus('Generating smart hashtags...', false);
      const result = await apiCall(ENDPOINTS.suggestHashtags, {
        content: postContent.value,
        platforms: selectedPlatforms
      });
      
      if (result.hashtags) {
        const currentContent = postContent.value;
        const hashtagsText = '\n\n' + result.hashtags.join(' ');
        postContent.value = currentContent + hashtagsText;
        showStatus('Smart hashtags added!');
      } else {
        showStatus('No hashtags generated. Try more specific content.', true);
      }
    } catch (error) {
      console.error('Error suggesting hashtags:', error);
      showStatus('Error generating hashtags: ' + error.message, true);
    }
  }

  async function optimizeForPlatform() {
    try {
      if (!postContent.value.trim()) {
        showStatus('Please enter some content first', true);
        return;
      }
      
      showStatus('Optimizing content for selected platforms...', false);
      const result = await apiCall(ENDPOINTS.optimizeContent, {
        content: postContent.value,
        platforms: selectedPlatforms
      });
      
      if (result.optimized_content) {
        postContent.value = result.optimized_content;
        showStatus('Content optimized for selected platforms!');
      } else {
        showStatus('Content optimization not available right now.', true);
      }
    } catch (error) {
      console.error('Error optimizing content:', error);
      showStatus('Error optimizing content: ' + error.message, true);
    }
  }

  async function getTrendingTopics() {
    try {
      showStatus('Finding trending topics...', false);
      const result = await apiCall(ENDPOINTS.getTrending, {
        platforms: selectedPlatforms,
        industry: 'business'
      });
      
      if (result.topics && result.topics.length > 0) {
        const topicsText = 'Trending: ' + result.topics.slice(0, 3).join(', ');
        showStatus(`${topicsText}`);
      } else {
        showStatus('No trending topics found. Try again later.', true);
      }
    } catch (error) {
      console.error('Error getting trending topics:', error);
      showStatus('Error getting trending topics: ' + error.message, true);
    }
  }

  // Platform selector functionality
  function setupPlatformSelector() {
    const platformToggles = document.querySelectorAll('.platform-toggle');
    
    platformToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const platform = toggle.dataset.platform;
        
        if (toggle.classList.contains('active')) {
          if (selectedPlatforms.length > 1) {
            toggle.classList.remove('active');
            selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
          }
        } else {
          toggle.classList.add('active');
          selectedPlatforms.push(platform);
        }
        
        console.log('Selected platforms:', selectedPlatforms);
      });
    });

    // Setup modal platform selector
    const modalPlatformToggles = document.querySelectorAll('#modalPlatformSelector .platform-toggle');
    modalPlatformToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const platform = toggle.dataset.platform;
        
        if (toggle.classList.contains('active')) {
          if (selectedPlatforms.length > 1) {
            toggle.classList.remove('active');
            selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
          }
        } else {
          toggle.classList.add('active');
          selectedPlatforms.push(platform);
        }
      });
    });
  }

  // Post creation functions
  async function postNow() {
    if (!postContent.value.trim()) {
      showStatus('Please enter some content first', true);
      return;
    }
    
    try {
      showStatus('Publishing post...', false);
      const result = await apiCall(ENDPOINTS.createPost, {
        content: postContent.value,
        platforms: selectedPlatforms,
        schedule_type: 'immediate',
        attachments: attachedFiles
      });
      
      if (result.success !== false) {
        showStatus(`Post published to ${selectedPlatforms.join(', ')}!`);
        postContent.value = '';
        attachedFiles = [];
        updateAttachmentDisplay();
        await loadSocialPosts();
      } else {
        showStatus('Post publishing failed. Try again.', true);
      }
    } catch (error) {
      console.error('Error posting now:', error);
      showStatus('Error publishing post: ' + error.message, true);
    }
  }

  function saveDraft() {
    if (!postContent.value.trim()) {
      showStatus('Nothing to save', true);
      return;
    }
    
    const draft = {
      content: postContent.value,
      platforms: selectedPlatforms,
      attachments: attachedFiles,
      timestamp: new Date().toISOString()
    };
    
    let savedDrafts = JSON.parse(localStorage.getItem('social_drafts') || '[]');
    savedDrafts.push(draft);
    localStorage.setItem('social_drafts', JSON.stringify(savedDrafts));
    
    showStatus('Draft saved locally!');
  }

  // Load social posts from n8n webhook
  async function loadSocialPosts() {
    try {
      const response = await apiCall(ENDPOINTS.getSocial);
      console.log('Response from n8n:', response);
      
      if (response && Array.isArray(response)) {
        allSocialPosts = response;
      } else if (response && response.posts && Array.isArray(response.posts)) {
        allSocialPosts = response.posts;
      } else if (response && response.social && Array.isArray(response.social)) {
        allSocialPosts = response.social;
      } else {
        console.log('Unexpected response structure:', response);
        allSocialPosts = [];
      }

      console.log(`Loaded ${allSocialPosts.length} social posts`);
      calculatePerformanceThresholds();
      filteredSocialPosts = [...allSocialPosts];
      updateStats();
      
    } catch (error) {
      console.error('Error loading social posts:', error);
      allSocialPosts = [];
      filteredSocialPosts = [];
    }
  }

  // Update stats
  function updateStats() {
    const totalPosts = allSocialPosts.length;
    const totalEngagements = allSocialPosts.reduce((sum, post) => sum + (parseInt(post.engagements) || 0), 0);
    const totalShares = allSocialPosts.reduce((sum, post) => sum + (parseInt(post.shares) || 0), 0);
    const totalClicks = allSocialPosts.reduce((sum, post) => sum + (parseInt(post.clicks) || 0), 0);
    const totalRevenue = allSocialPosts.reduce((sum, post) => sum + (parseFloat(post.revenue) || 0), 0);

    document.getElementById('totalPosts').textContent = totalPosts.toLocaleString();
    document.getElementById('totalEngagements').textContent = totalEngagements.toLocaleString();
    document.getElementById('totalShares').textContent = totalShares.toLocaleString();
    document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
    document.getElementById('totalRevenue').textContent = `${totalRevenue.toLocaleString()}`;
  }

  // Apply filters with improved performance filtering
  function applyFilters() {
    const platform = platformFilter.value.toLowerCase();
    const performance = performanceFilter.value;
    const searchTerm = searchFilter.value.toLowerCase();

    filteredSocialPosts = allSocialPosts.filter(post => {
      // Platform filter
      if (platform && post.platform && !post.platform.toLowerCase().includes(platform)) {
        return false;
      }

      // Performance filter based on thirds
      if (performance) {
        const engagements = parseInt(post.engagements) || 0;
        const clicks = parseInt(post.clicks) || 0;
        const shares = parseInt(post.shares) || 0;
        const totalMetric = engagements + clicks + shares;
        
        switch (performance) {
          case 'high':
            if (totalMetric < performanceThresholds.high) return false;
            break;
          case 'medium':
            if (totalMetric < performanceThresholds.medium || totalMetric >= performanceThresholds.high) return false;
            break;
          case 'low':
            if (totalMetric >= performanceThresholds.medium) return false;
            break;
        }
      }

      // Search filter
      if (searchTerm) {
        const searchableText = [
          post.title || '',
          post.message || '',
          post.hashtag || '',
          post.key_words || ''
        ].join(' ').toLowerCase();
        
        if (!searchableText.includes(searchTerm)) {
          return false;
        }
      }

      return true;
    });

    renderSocialTable();
  }

  // Clear filters
  function clearFilters() {
    platformFilter.value = '';
    performanceFilter.value = '';
    searchFilter.value = '';
    applyFilters();
  }

  // Render social posts table
  function renderSocialTable() {
    if (filteredSocialPosts.length === 0) {
      if (allSocialPosts.length === 0) {
        showEmptyState();
      } else {
        showNoResultsState();
      }
      return;
    }

    const table = document.createElement('table');
    table.className = 'social-table';

    table.innerHTML = `
      <thead>
        <tr>
          <th onclick="sortBy('platform')">Platform</th>
          <th onclick="sortBy('title')">Post</th>
          <th onclick="sortBy('engagements')">Engagement</th>
          <th onclick="sortBy('revenue')">Revenue</th>
          <th onclick="sortBy('created_at')">Date</th>
        </tr>
      </thead>
      <tbody id="socialTableBody">
      </tbody>
    `;

    const tbody = table.querySelector('#socialTableBody');

    filteredSocialPosts.forEach((post, index) => {
      const row = createSocialRow(post, index);
      tbody.appendChild(row);
      
      const expandedRow = createExpandedRow(post, index);
      tbody.appendChild(expandedRow);
    });

    socialContainer.innerHTML = '';
    socialContainer.appendChild(table);
  }

  // Create social post table row
  function createSocialRow(post, index) {
    const row = document.createElement('tr');
    row.onclick = () => toggleExpanded(index);
    row.className = expandedRows.has(index) ? 'expanded' : '';

    let createdDate = 'Unknown';
    if (post.created_at) {
      try {
        createdDate = new Date(post.created_at).toLocaleDateString();
      } catch (e) {
        createdDate = post.created_at;
      }
    }

    const platform = (post.platform || 'default').toLowerCase();
    const platformIcon = getPlatformIcon(platform);
    const revenue = parseFloat(post.revenue) || 0;

    // Create media display
    let mediaDisplay = '';
    if (post.media_URL || post.URL) {
      const mediaUrl = post.media_URL || post.URL;
      const isImage = mediaUrl.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i);
      const isVideo = mediaUrl.match(/\.(mp4|webm|mov|avi)(\?|$)/i);
      
      if (isImage) {
        mediaDisplay = `<div class="post-media"><img src="${mediaUrl}" alt="Post media" loading="lazy"></div>`;
      } else if (isVideo) {
        mediaDisplay = `<div class="post-media"><video src="${mediaUrl}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video></div>`;
      } else {
        mediaDisplay = '<div class="media-placeholder">üîé Media attached</div>';
      }
    }

    row.innerHTML = `
      <td>
        <div class="platform-badge ${platform}">
          ${platformIcon} ${post.platform || 'Unknown'}
        </div>
      </td>
      <td>
        <div class="post-title">${post.title || 'Untitled Post'}</div>
        <div class="post-preview">${post.message || 'No message content'}</div>
        ${mediaDisplay}
      </td>
      <td>
        <div class="engagement-stats">
          <div class="engagement-item">
            <span class="engagement-number">${post.engagements || 0}</span>
            <span class="engagement-label">Likes</span>
          </div>
          <div class="engagement-item">
            <span class="engagement-number">${post.shares || 0}</span>
            <span class="engagement-label">Shares</span>
          </div>
          <div class="engagement-item">
            <span class="engagement-number">${post.clicks || 0}</span>
            <span class="engagement-label">Clicks</span>
          </div>
        </div>
      </td>
      <td>
        ${revenue > 0 ? `<div class="revenue-badge">${revenue.toFixed(2)}</div>` : '$0.00'}
      </td>
      <td>${createdDate}</td>
    `;

    return row;
  }

  // Create expanded content row
  function createExpandedRow(post, index) {
    const expandedRow = document.createElement('tr');
    expandedRow.className = `expanded-content ${expandedRows.has(index) ? 'show' : ''}`;
    
    expandedRow.innerHTML = `
      <td colspan="5">
        <div class="expanded-details">
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Platform</div>
              <div class="detail-value">${post.platform || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Post URL</div>
              <div class="detail-value">
                ${post.URL ? `<span class="post-url" onclick="openPost('${post.URL}')">${post.URL}</span>` : 'N/A'}
              </div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Revenue</div>
              <div class="detail-value">${(parseFloat(post.revenue) || 0).toFixed(2)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Hashtags</div>
              <div class="detail-value">${post.hashtag || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Keywords</div>
              <div class="detail-value">${post.key_words || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Media URL</div>
              <div class="detail-value">
                ${post.media_URL ? `<span class="post-url" onclick="openPost('${post.media_URL}')">${post.media_URL}</span>` : 'N/A'}
              </div>
            </div>
          </div>
          <div class="detail-item" style="margin-top: 15px;">
            <div class="detail-label">Full Message</div>
            <div class="detail-value">${post.message || 'N/A'}</div>
          </div>
        </div>
      </td>
    `;

    return expandedRow;
  }

  // Sorting functionality
  let sortField = null;
  let sortDirection = 'desc';

  function sortBy(field) {
    if (sortField === field) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortField = field;
      sortDirection = 'desc';
    }

    filteredSocialPosts.sort((a, b) => {
      let aVal = a[field] || '';
      let bVal = b[field] || '';

      if (field === 'engagements' || field === 'shares' || field === 'clicks' || field === 'revenue') {
        aVal = parseFloat(aVal) || 0;
        bVal = parseFloat(bVal) || 0;
      } else if (field === 'created_at') {
        aVal = new Date(aVal).getTime() || 0;
        bVal = new Date(bVal).getTime() || 0;
      } else {
        aVal = aVal.toString().toLowerCase();
        bVal = bVal.toString().toLowerCase();
      }

      if (sortDirection === 'asc') {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });

    renderSocialTable();
  }

  // Toggle expanded row
  function toggleExpanded(index) {
    if (expandedRows.has(index)) {
      expandedRows.delete(index);
    } else {
      expandedRows.add(index);
    }
    renderSocialTable();
  }

  // Open post URL
  function openPost(url) {
    if (url && url !== 'N/A') {
      window.open(url, '_blank');
    }
  }

  // Get platform icon
  function getPlatformIcon(platform) {
    switch (platform) {
      case 'twitter': return 'ùïè';
      case 'linkedin': return 'in';
      case 'instagram': return 'üì∑';
      case 'youtube': return '‚ñ∂Ô∏è';
      case 'facebook': return 'f';
      case 'tiktok': return 'üéµ';
      default: return 'üì±';
    }
  }

  function showEmptyState() {
    socialContainer.innerHTML = `
      <div class="empty-state">
        <h3>No social media posts yet</h3>
        <p>Your social media posts will appear here as your campaigns generate content.</p>
        <button onclick="generateCaption()" class="success" style="margin-top: 15px;">üöÄ Create Your First Post</button>
      </div>
    `;
  }

  function showNoResultsState() {
    socialContainer.innerHTML = `
      <div class="empty-state">
        <h3>No posts match your filters</h3>
        <p>Try adjusting your search criteria or clearing the filters.</p>
      </div>
    `;
  }

  function showStatus(message, isError = false) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = message;
    statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 5000);
  }

  // Event listeners
  function setupEventListeners() {
    refreshSocialBtn.addEventListener('click', async () => {
      await loadUserData();
      await loadSocialPosts();
      applyFilters();
      renderCalendar();
    });
    
    clearFiltersBtn.addEventListener('click', clearFilters);

    [platformFilter, performanceFilter].forEach(element => {
      element.addEventListener('change', applyFilters);
    });

    let searchTimeout;
    searchFilter.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    });

    setupPlatformSelector();

    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      const modals = [
        'fileBrowserModal',
        'postModal',
        'scheduleModal',
        'uploadExampleModal',
        'updatePostsModal'
      ];
      
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    });
  }

  // Initialize page
  async function init() {
    try {
      const isAuthenticated = await checkAuthentication();
      
      if (isAuthenticated) {
        await Promise.all([
          loadUserData(),
          loadCampaignFiles(),
          loadSocialPosts(),
          loadDrafts()
        ]);
        setupEventListeners();
        applyFilters();
        renderCalendar();
        
        if (!hasCompletedTour()) {
          setTimeout(() => {
            startTour();
          }, 1000);
        }
      } else {
        redirectToLogin();
      }
    } catch (error) {
      console.error('Error initializing page:', error);
      showStatus('Failed to load social media posts. Please refresh the page.', true);
    }
  }

  // Security checks - session validation every 5 minutes
  setInterval(async function() {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        console.log('Session expired, redirecting to login');
        redirectToLogin();
      } else {
        authToken = session.access_token;
      }
    } catch (e) {
      console.error('Session check failed:', e);
    }
  }, 300000);

  // Check auth when page becomes visible
  document.addEventListener('visibilitychange', async function() {
    if (!document.hidden) {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          redirectToLogin();
        } else {
          authToken = session.access_token;
        }
      } catch (e) {
        console.error('Visibility auth check failed:', e);
      }
    }
  });

  // Make functions globally available
  window.toggleAIPost = toggleAIPost;
  window.openPost = openPost;
  window.generateCaption = generateCaption;
  window.suggestHashtags = suggestHashtags;
  window.optimizeForPlatform = optimizeForPlatform;
  window.getTrendingTopics = getTrendingTopics;
  window.postNow = postNow;
  window.saveDraft = saveDraft;
  window.sortBy = sortBy;
  window.startTour = startTour;
  window.openFileBrowser = openFileBrowser;
  window.closeFileBrowser = closeFileBrowser;
  window.toggleFileSelection = toggleFileSelection;
  window.attachSelectedFiles = attachSelectedFiles;
  window.uploadNewFile = uploadNewFile;
  window.handleFileUpload = handleFileUpload;
  window.removeAttachment = removeAttachment;
  
  // New modal functions
  window.openPostModal = openPostModal;
  window.closePostModal = closePostModal;
  window.savePostFromModal = savePostFromModal;
  window.openScheduleModal = openScheduleModal;
  window.closeScheduleModal = closeScheduleModal;
  window.confirmSchedulePost = confirmSchedulePost;
  window.openUploadExampleModal = openUploadExampleModal;
  window.closeUploadExampleModal = closeUploadExampleModal;
  window.savePostExample = savePostExample;
  window.openUpdatePostsModal = openUpdatePostsModal;
  window.closeUpdatePostsModal = closeUpdatePostsModal;
  window.editDraft = editDraft;
  window.deleteDraft = deleteDraft;
  
  // Calendar functions
  window.previousMonth = previousMonth;
  window.nextMonth = nextMonth;
  window.selectCalendarDate = selectCalendarDate;
  window.openPostDetails = openPostDetails;

  // Initialize when DOM loads
  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
