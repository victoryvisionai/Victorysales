<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Manage and view all your AI-generated videos and images"/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision - My Media Library</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .navbar nav ul li {
      margin: 0 10px;
    }
    .navbar nav ul li a {
      color: white;
      text-decoration: none;
    }
    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }
    .content {
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    /* Filter Controls */
    .filters {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .filter-group label {
      font-size: 12px;
      color: #666;
      font-weight: bold;
    }
    .filter-group input, .filter-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    /* Media Grid */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    .media-item {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .media-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .media-preview {
      width: 100%;
      height: 200px;
      position: relative;
      overflow: hidden;
    }
    .media-preview img, .media-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .media-type-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(10, 49, 97, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .media-info {
      padding: 15px;
    }
    .media-title {
      font-size: 16px;
      font-weight: bold;
      margin: 0 0 8px 0;
      color: #333;
    }
    .media-campaign {
      font-size: 14px;
      color: #0A3161;
      margin-bottom: 8px;
    }
    .media-date {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    .media-prompt {
      font-size: 13px;
      color: #555;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      line-height: 1.4;
      max-height: 60px;
      overflow: hidden;
      position: relative;
    }
    .media-prompt.expanded {
      max-height: none;
    }
    .expand-prompt {
      color: #0A3161;
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
    }
    
    .media-metadata {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
      color: #666;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .metadata-item {
      display: flex;
      justify-content: space-between;
    }
    
    .media-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .btn-primary {
      background: #0A3161;
      color: white;
    }
    .btn-primary:hover {
      background: #083254;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #545b62;
    }
    .btn-outline {
      background: transparent;
      color: #0A3161;
      border: 1px solid #0A3161;
    }
    .btn-outline:hover {
      background: #0A3161;
      color: white;
    }
    
    /* Comment System */
    .comment-section {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .comment-section.active {
      display: block;
    }
    .comment-input {
      width: 100%;
      min-height: 60px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      margin-bottom: 8px;
    }
    .ai-edit-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .edit-type-btn {
      padding: 4px 8px;
      background: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .edit-type-btn.active {
      background: #0A3161;
      color: white;
      border-color: #0A3161;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    .modal-media {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
    }
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: white;
      cursor: pointer;
    }
    
    /* Loading States */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #666;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #0A3161;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .empty-state h3 {
      margin-bottom: 10px;
      color: #333;
    }
    
    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 15px;
      margin-top: 40px;
    }
    footer a {
      color: #fff;
      margin-right: 15px;
      text-decoration: none;
    }
  </style>
</head>
<body>
<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
      <li><a href="ai-opt">ü§ñ AI</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="videos" style="font-weight: bold;">Videos</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="ads">Ads</a></li>
      <li><a href="leads">Leads</a></li>
      <li><a href="social">Social</a></li>  
      <li><a href="settings">‚öôÔ∏è</a></li>
    </ul>
  </nav>
</header>

<div class="content">
  <div class="card">
    <h2>My Media Library</h2>
    
    <!-- Filter Controls -->
    <div class="filters">
      <div class="filter-group">
        <label>File Type</label>
        <select id="typeFilter">
          <option value="">All Types</option>
          <option value="video">Videos</option>
          <option value="image">Images</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Campaign</label>
        <select id="campaignFilter">
          <option value="">All Campaigns</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Date From</label>
        <input type="date" id="dateFromFilter">
      </div>
      
      <div class="filter-group">
        <label>Date To</label>
        <input type="date" id="dateToFilter">
      </div>
      
      <div class="filter-group">
        <label>Search</label>
        <input type="text" id="searchFilter" placeholder="Search prompts, names...">
      </div>
      
      <button class="action-btn btn-primary" onclick="applyFilters()">Apply Filters</button>
      <button class="action-btn btn-outline" onclick="clearFilters()">Clear</button>
    </div>
    
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      Loading your media...
    </div>
    
    <!-- Media Grid -->
    <div id="mediaGrid" class="media-grid" style="display: none;"></div>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <h3>No media found</h3>
      <p>Try adjusting your filters or create some new content!</p>
    </div>
  </div>
</div>

<!-- Modal for full-size viewing -->
<div id="mediaModal" class="modal">
  <button class="close-modal" onclick="closeModal()">&times;</button>
  <div class="modal-content">
    <div id="modalMediaContainer"></div>
  </div>
</div>

<footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
  let allMedia = [];
  let filteredMedia = [];
  let campaigns = [];

  document.addEventListener('DOMContentLoaded', () => {
    loadCampaigns();
    loadMedia();
    setupEventListeners();
  });

  function setupEventListeners() {
    // Auto-apply filters when typing in search
    document.getElementById('searchFilter').addEventListener('input', debounce(applyFilters, 300));
    
    // Close modal when clicking outside
    document.getElementById('mediaModal').addEventListener('click', (e) => {
      if (e.target.id === 'mediaModal') closeModal();
    });
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  async function loadCampaigns() {
    try {
      // This would connect to your Supabase campaigns table
      // For now, using mock data
      const mockCampaigns = [
        { id: '1', name: 'AI Growth Campaign' },
        { id: '2', name: 'Digital Marketing Boost' },
        { id: '3', name: 'Social Media Expansion' }
      ];
      
      campaigns = mockCampaigns;
      
      const campaignSelect = document.getElementById('campaignFilter');
      campaigns.forEach(campaign => {
        const option = document.createElement('option');
        option.value = campaign.id;
        option.textContent = campaign.name;
        campaignSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading campaigns:', error);
    }
  }

  async function loadMedia() {
    try {
      // This would connect to your Supabase campaigns_files table
      // Mock data based on your schema
      const mockMedia = [
        {
          id: '1',
          name: 'hero_video_1.mp4',
          URL: 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4',
          thumbnail_URL: '',
          file_type: 'video/mp4',
          mime_type: 'video/mp4',
          height: 720,
          width: 1280,
          duration: '15 seconds',
          file_size: '1048576',
          campaign_id: '1',
          created_at: '2025-01-01T10:00:00Z',
          prompt: 'Professional business meeting with AI-powered analytics dashboard, modern office setting, cinematic lighting, 8K quality, no text overlay'
        },
        {
          id: '2',
          name: 'hero_image_1.jpg',
          URL: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800',
          thumbnail_URL: '',
          file_type: 'image/jpeg',
          mime_type: 'image/jpeg',
          height: 600,
          width: 800,
          file_size: '524288',
          campaign_id: '1',
          created_at: '2025-01-02T14:30:00Z',
          prompt: 'Modern business analytics dashboard with holographic data visualization, professional office environment, clean design'
        },
        {
          id: '3',
          name: 'social_video_1.mp4',
          URL: 'https://sample-videos.com/zip/10/mp4/SampleVideo_640x360_1mb.mp4',
          file_type: 'video/mp4',
          mime_type: 'video/mp4',
          height: 360,
          width: 640,
          duration: '10 seconds',
          file_size: '1048576',
          campaign_id: '2',
          created_at: '2025-01-03T09:15:00Z',
          prompt: 'Dynamic social media content showing business growth metrics, vibrant colors, engaging motion graphics'
        }
      ];
      
      allMedia = mockMedia;
      filteredMedia = [...allMedia];
      renderMedia();
    } catch (error) {
      console.error('Error loading media:', error);
      showError('Failed to load media files');
    } finally {
      document.getElementById('loadingState').style.display = 'none';
    }
  }

  function applyFilters() {
    const typeFilter = document.getElementById('typeFilter').value;
    const campaignFilter = document.getElementById('campaignFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter').value;
    const dateToFilter = document.getElementById('dateToFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

    filteredMedia = allMedia.filter(item => {
      // Type filter
      if (typeFilter && !item.file_type.includes(typeFilter)) return false;
      
      // Campaign filter
      if (campaignFilter && item.campaign_id !== campaignFilter) return false;
      
      // Date filters
      const itemDate = new Date(item.created_at);
      if (dateFromFilter && itemDate < new Date(dateFromFilter)) return false;
      if (dateToFilter && itemDate > new Date(dateToFilter + 'T23:59:59')) return false;
      
      // Search filter
      if (searchFilter) {
        const searchableText = (item.name + ' ' + item.prompt).toLowerCase();
        if (!searchableText.includes(searchFilter)) return false;
      }
      
      return true;
    });

    renderMedia();
  }

  function clearFilters() {
    document.getElementById('typeFilter').value = '';
    document.getElementById('campaignFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    document.getElementById('searchFilter').value = '';
    
    filteredMedia = [...allMedia];
    renderMedia();
  }

  function renderMedia() {
    const grid = document.getElementById('mediaGrid');
    const emptyState = document.getElementById('emptyState');
    
    if (filteredMedia.length === 0) {
      grid.style.display = 'none';
      emptyState.style.display = 'block';
      return;
    }
    
    grid.style.display = 'grid';
    emptyState.style.display = 'none';
    
    grid.innerHTML = filteredMedia.map(item => createMediaCard(item)).join('');
  }

  function createMediaCard(item) {
    const isVideo = item.file_type.includes('video');
    const campaign = campaigns.find(c => c.id === item.campaign_id);
    const createdDate = new Date(item.created_at).toLocaleDateString();
    const fileSize = formatFileSize(parseInt(item.file_size));
    
    const truncatedPrompt = item.prompt.length > 100 ? 
      item.prompt.substring(0, 100) + '...' : item.prompt;
    const needsExpand = item.prompt.length > 100;

    return `
      <div class="media-item" data-id="${item.id}">
        <div class="media-preview" onclick="openModal('${item.id}')">
          ${isVideo ? 
            `<video><source src="${item.URL}" type="${item.mime_type}"></video>` :
            `<img src="${item.URL}" alt="${item.name}" loading="lazy">`
          }
          <div class="media-type-badge">${isVideo ? 'VIDEO' : 'IMAGE'}</div>
        </div>
        
        <div class="media-info">
          <h3 class="media-title">${item.name}</h3>
          <div class="media-campaign">Campaign: ${campaign?.name || 'Unknown'}</div>
          <div class="media-date">Created: ${createdDate}</div>
          
          <div class="media-prompt" id="prompt-${item.id}">
            <span id="prompt-text-${item.id}">${truncatedPrompt}</span>
            ${needsExpand ? `<span class="expand-prompt" onclick="togglePrompt('${item.id}')">Show more</span>` : ''}
          </div>
          
          <div class="media-metadata">
            <div class="metadata-item">
              <span>Dimensions:</span>
              <span>${item.width}√ó${item.height}</span>
            </div>
            <div class="metadata-item">
              <span>File Size:</span>
              <span>${fileSize}</span>
            </div>
            ${isVideo ? `
            <div class="metadata-item">
              <span>Duration:</span>
              <span>${item.duration || 'Unknown'}</span>
            </div>` : ''}
            <div class="metadata-item">
              <span>Type:</span>
              <span>${item.mime_type}</span>
            </div>
          </div>
          
          <div class="media-actions">
            <button class="action-btn btn-primary" onclick="downloadMedia('${item.URL}', '${item.name}')">
              Download
            </button>
            <button class="action-btn btn-secondary" onclick="toggleComments('${item.id}')">
              AI Edit
            </button>
            <button class="action-btn btn-outline" onclick="shareMedia('${item.id}')">
              Share
            </button>
          </div>
          
          <div class="comment-section" id="comments-${item.id}">
            <textarea class="comment-input" id="comment-${item.id}" 
              placeholder="Describe how you want to edit this ${isVideo ? 'video' : 'image'}..."></textarea>
            
            <div class="ai-edit-options">
              <button class="edit-type-btn" data-type="enhance">Enhance Quality</button>
              <button class="edit-type-btn" data-type="style">Change Style</button>
              <button class="edit-type-btn" data-type="crop">Crop/Resize</button>
              <button class="edit-type-btn" data-type="color">Color Adjust</button>
              ${isVideo ? '<button class="edit-type-btn" data-type="speed">Speed Change</button>' : ''}
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button class="action-btn btn-primary" onclick="generateEdit('${item.id}')">
                Generate Edit
              </button>
              <button class="action-btn btn-outline" onclick="toggleComments('${item.id}')">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function togglePrompt(id) {
    const promptElement = document.getElementById(`prompt-${id}`);
    const textElement = document.getElementById(`prompt-text-${id}`);
    const expandLink = promptElement.querySelector('.expand-prompt');
    const item = allMedia.find(m => m.id === id);
    
    if (promptElement.classList.contains('expanded')) {
      textElement.textContent = item.prompt.substring(0, 100) + '...';
      expandLink.textContent = 'Show more';
      promptElement.classList.remove('expanded');
    } else {
      textElement.textContent = item.prompt;
      expandLink.textContent = 'Show less';
      promptElement.classList.add('expanded');
    }
  }

  function toggleComments(id) {
    const commentsSection = document.getElementById(`comments-${id}`);
    commentsSection.classList.toggle('active');
    
    // Set up edit type buttons
    const editButtons = commentsSection.querySelectorAll('.edit-type-btn');
    editButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        editButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const commentInput = document.getElementById(`comment-${id}`);
        const editType = btn.dataset.type;
        const suggestions = {
          enhance: 'Enhance the quality and sharpness of this media',
          style: 'Change the style to be more modern and professional',
          crop: 'Crop to focus on the main subject and resize to 16:9 aspect ratio',
          color: 'Adjust colors to be more vibrant and appealing',
          speed: 'Change the video speed to create a more dynamic effect'
        };
        
        if (commentInput.value === '' || commentInput.value in Object.values(suggestions)) {
          commentInput.value = suggestions[editType];
        }
      });
    });
  }

  function openModal(id) {
    const item = allMedia.find(m => m.id === id);
    if (!item) return;
    
    const modal = document.getElementById('mediaModal');
    const container = document.getElementById('modalMediaContainer');
    const isVideo = item.file_type.includes('video');
    
    container.innerHTML = isVideo ? 
      `<video class="modal-media" controls autoplay>
         <source src="${item.URL}" type="${item.mime_type}">
       </video>` :
      `<img class="modal-media" src="${item.URL}" alt="${item.name}">`;
    
    modal.classList.add('active');
  }

  function closeModal() {
    document.getElementById('mediaModal').classList.remove('active');
  }

  function downloadMedia(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
  }

  function shareMedia(id) {
    const item = allMedia.find(m => m.id === id);
    if (navigator.share) {
      navigator.share({
        title: item.name,
        text: item.prompt,
        url: item.URL
      });
    } else {
      navigator.clipboard.writeText(item.URL);
      alert('Link copied to clipboard!');
    }
  }

  async function generateEdit(id) {
    const item = allMedia.find(m => m.id === id);
    const comment = document.getElementById(`comment-${id}`).value;
    const activeEditType = document.querySelector(`#comments-${id} .edit-type-btn.active`)?.dataset.type;
    
    if (!comment.trim()) {
      alert('Please describe how you want to edit this media');
      return;
    }
    
    try {
      // Show loading state
      const generateBtn = event.target;
      generateBtn.textContent = 'Generating...';
      generateBtn.disabled = true;
      
      // This would connect to your n8n webhook for AI editing
      const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/edit-media', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          media_id: id,
          original_url: item.URL,
          edit_instructions: comment,
          edit_type: activeEditType,
          file_type: item.file_type,
          customer_id: 'client-xyz'
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        alert('Edit request submitted! You will be notified when the edited version is ready.');
        toggleComments(id);
      } else {
        throw new Error('Failed to submit edit request');
      }
    } catch (error) {
      console.error('Error generating edit:', error);
      alert('Error submitting edit request. Please try again.');
    } finally {
      const generateBtn = event.target;
      generateBtn.textContent = 'Generate Edit';
      generateBtn.disabled = false;
    }
  }

  function showError(message) {
    const grid = document.getElementById('mediaGrid');
    grid.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${message}</p></div>`;
    grid.style.display = 'block';
  }
</script>
</body>
</html>
