<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Manage your company profile and goals."/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Company Profile</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .navbar nav ul li {
      margin: 0 10px;
    }
    .navbar nav ul li a {
      color: white;
      text-decoration: none;
    }
    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subscription-medallion {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(45deg, #CD7F32, #A0522D);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .subscription-medallion.bronze {
      background: linear-gradient(45deg, #CD7F32, #A0522D);
    }
    .subscription-medallion.silver {
      background: linear-gradient(45deg, #C0C0C0, #808080);
    }
    .subscription-medallion.gold {
      background: linear-gradient(45deg, #FFD700, #FFA500);
    }
    .subscription-medallion:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .subscription-medallion .plan-name {
      font-weight: bold;
    }
    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }
    .content {
      padding: 20px 4px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-group textarea {
      height: 80px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    .form-row-4 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 15px;
    }
    button {
      background: #0A3161;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 5px 0 0;
    }
    button:hover {
      background: #083050;
    }
    button:disabled {
      background: #B3B3B3;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    .goal-card {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      background: #f8f9fa;
    }
    .goal-card h4 {
      margin-top: 0;
      color: #0A3161;
      border-bottom: 2px solid #0A3161;
      padding-bottom: 5px;
    }
    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0A3161;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      display: none;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
    }
    footer a {
      color: #fff;
      margin-right: 15px;
      text-decoration: none;
    }
    .section-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
      border-radius: 8px 8px 0 0;
    }
    .color-palette {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .color-input {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .color-input input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .color-input input[type="text"] {
      width: 80px;
    }
    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-upload input[type="file"] {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }
    .file-upload-label {
      display: block;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      text-align: center;
      color: #666;
    }
    .file-upload-label:hover {
      background: #f8f9fa;
    }
    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    .auth-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0A3161;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    .save-all-button {
      background: #28a745;
      font-size: 16px;
      font-weight: bold;
      padding: 15px 30px;
    }
    .save-all-button:hover {
      background: #218838;
    }
  #currentGoalDisplay {
  min-height: 200px;
  max-height: 400px;
  overflow-y: auto;
  padding: 15px; 
  background: #f8f9fa; 
  border-radius: 4px; 
  border: 1px solid #e9ecef;
  line-height: 1.6;
    }
    .file-name {
      margin-top: 5px;
      font-size: 12px;
      color: #666;
    }
    .logo-preview {
      margin-top: 10px;
      max-width: 200px;
      max-height: 100px;
    }
    .logo-preview img {
      max-width: 100%;
      max-height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    .product-preview {
      margin-top: 10px;
      max-width: 150px;
      max-height: 80px;
    }
    .product-preview img {
      max-width: 100%;
      max-height: 80px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    .spinner-inline {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #0A3161;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    .product-images-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .ai-enhanced-field {
      position: relative;
    }
    .ai-enhance-button {
      position: absolute;
      right: 10px;
      top: 35px;
      background: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      z-index: 1;
    }
    .ai-enhance-button:hover {
      background: #218838;
    }
    .ai-enhance-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    /* Chat Widget Styles */
    .vv-chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10000;
      font-family: Arial, sans-serif;
    }

    .vv-chat-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      color: white;
      font-size: 24px;
    }

    .vv-chat-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }

    .vv-chat-toggle.active {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .vv-chat-container {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .vv-chat-container.open {
      display: flex;
    }

    .vv-chat-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .vv-chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .vv-chat-title {
      flex: 1;
      font-weight: bold;
      font-size: 14px;
    }

    .vv-chat-subtitle {
      font-size: 11px;
      opacity: 0.8;
    }

    .vv-chat-minimize {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .vv-chat-minimize:hover {
      background: rgba(255,255,255,0.1);
    }

    .vv-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .vv-chat-message {
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      animation: messageSlideIn 0.3s ease;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .vv-chat-message.bot {
      background: white;
      border: 1px solid #e0e0e0;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .vv-chat-message.user {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .vv-chat-input-area {
      padding: 15px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .vv-chat-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 10px 15px;
      font-size: 14px;
      resize: none;
      min-height: 20px;
      max-height: 80px;
      overflow-y: auto;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    .vv-chat-input:focus {
      border-color: #0A3161;
    }

    .vv-chat-send {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .vv-chat-send:hover:not(:disabled) {
      transform: scale(1.05);
      background: linear-gradient(135deg, #1a4c80, #0A3161);
    }

    .vv-chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .vv-chat-typing {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
      max-width: 80px;
    }

    .vv-chat-typing.show {
      display: flex;
    }

    .vv-typing-dots {
      display: flex;
      gap: 3px;
    }

    .vv-typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #0A3161;
      animation: typingBounce 1.4s infinite ease-in-out both;
    }

    .vv-typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .vv-typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typingBounce {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .vv-chat-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .vv-chat-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .vv-quick-action {
      background: #e3f2fd;
      border: 1px solid #0A3161;
      color: #0A3161;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .vv-quick-action:hover {
      background: #0A3161;
      color: white;
    }

    .vv-notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
      }
    }

    /* Intro.js custom styling */
    .introjs-tooltip {
      max-width: 350px;
      font-size: 14px;
    }

    .introjs-button {
      background: #0A3161 !important;
      border: 1px solid #0A3161 !important;
      color: white !important;
      padding: 8px 15px !important;
      border-radius: 4px !important;
    }

    .introjs-button:hover {
      background: #083050 !important;
      border-color: #083050 !important;
    }

    .introjs-skipbutton {
      background: #6c757d !important;
      border-color: #6c757d !important;
    }

    .introjs-progressbar {
      background-color: #0A3161 !important;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .content {
        padding: 10px 5px;
      }
      .form-row, .form-row-3, .form-row-4 {
        grid-template-columns: 1fr;
      }
      .navbar {
        flex-direction: column;
        gap: 10px;
      }
      .navbar nav ul {
        flex-wrap: wrap;
        justify-content: center;
      }
      .vv-chat-container {
        width: 320px;
        height: 450px;
        bottom: 70px;
        right: -10px;
      }
      .vv-chat-widget {
        bottom: 15px;
        right: 15px;
      }
      .product-images-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>    

<!-- Authentication Loading Screen -->
<div id="authLoading" class="auth-loading">
  <div class="spinner"></div>
  <p>Verifying authentication...</p>
</div>

<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
     <li><a href="companyprofile">Profile</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="media">Media</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>
      <li><a href="contacts">Contacts</a></li>
      <li><a href="ads">Ads</a></li>
      <li><a href="messages">Messages</a></li>
      <li><a href="meetings">Meetings</a></li>
      <li><a href="ai">Analytics</a></li>
      <li><a href="settings">Settings</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <div id="subscriptionMedallion" class="subscription-medallion bronze">
      <span class="plan-name">Bronze</span>
    </div>
    <button onclick="startTour()" style="background: #28a745; padding: 6px 12px; font-size: 11px; margin-left: 10px;">
      üìñ Take Tour
    </button>
  </div>
</header>

<div class="content">
  <h2>Company Profile & Goal Management</h2>
  
  <!-- Company Profile Section -->
  <div class="card">
    <!-- Domain Auto-Read Section - First Step -->
<div class="card" id="domainAutoReadCard" style="background: linear-gradient(135deg, #0A3161, #1a4c80); color: white; border: 3px solid #bb133e;">
  <div class="form-group">
    <label for="websiteDomain" style="color: white; font-size: 14px;">üöÄ Step 1: Auto-Fill Your Company Profile. Enter Your Website Domain:</label>
    <div style="display: flex; gap: 10px; align-items: center;">
      <input 
        type="text" 
        id="websiteDomain" 
        name="websiteDomain" 
        placeholder="example.com" 
        style="flex: 1; font-size: 16px; padding: 12px;"
      />
      <button 
        type="button" 
        id="autoReadWebsiteBtn" 
        onclick="autoReadWebsite()"
        style="background: #bb133e; padding: 12px 30px; font-size: 16px; font-weight: bold; min-width: 200px;"
      >
        üîç Auto-Fill Profile
      </button>
    </div>
    <small style="color: #e0e0e0; display: block; margin-top: 5px;">Example: victoryvision.app (don't include https://)</small>
  </div>
  
  <div id="autoReadLoader" class="loader" style="margin: 20px auto;"></div>
  <div id="autoReadStatus" class="status-message"></div>
</div>
    <!-- Step 2 Message -->
<div id="step2Message" class="card" style="background: linear-gradient(135deg, #0A3161, #1a4c80); color: white; border: 3px solid #28a745; display: none; text-align: center; padding: 25px;">
  <h3 style="color: white; margin: 0 0 15px 0;">‚úÖ Step 1 Complete!</h3>
  <p style="color: white; margin: 0; font-size: 1.2rem; font-weight: bold;">
    üìù Step 2: Review/Edit AI created responses below, then hit the Save button
  </p>
</div>
    <div class="section-header">
      <h3>Company Information</h3>
    </div>
    
    <form id="companyForm">
      <div class="form-row">
        <div class="form-group">
          <label for="companyName">Company Name *</label>
          <input type="hidden" id="goalModifiedFlag" value="false" />
          <input type="text" id="companyName" name="company_name" required 
                 data-intro="Start by entering your company name. This will be used across all your campaigns." 
                 data-step="1">
        </div>
        <div class="form-group">
          <label for="userTitle">Your Title *</label>
          <input type="text" id="userTitle" name="title" required 
                 data-intro="Enter your job title or role within the company." 
                 data-step="2">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="industry">Industry</label>
          <select id="industry" name="industry">
            <option value="">Select Industry</option>
            <option value="accounting">Accounting</option>
            <option value="admin-support">Admin & Support</option>
            <option value="architecture">Architecture</option>
            <option value="arts-entertainment">Arts, Entertainment & Recreation</option>
            <option value="consulting">Consulting</option>
            <option value="construction">Construction</option>
            <option value="education">Education</option>
            <option value="engineering">Engineering</option>
            <option value="finance">Finance</option>
            <option value="food-beverage">Food & Beverage</option>
            <option value="healthcare">Healthcare</option>
            <option value="investment-management">Investment Management</option>
            <option value="it">IT</option>
            <option value="legal">Legal</option>
            <option value="manufacturing">Manufacturing</option>
            <option value="marketing">Marketing</option>
            <option value="media">Media</option>
            <option value="other">Other</option>
            <option value="private-equity">Private Equity</option>
           <option value="publishing">Publishing</option>
            <option value="real-estate">Real Estate</option>
            <option value="real-estate-rental">Rental and Leasing</option>
            <option value="retail">Retail</option>
              <option value="security">Security</option>
            <option value="technology">Technology</option>
            <option value="transportation-warehousing">Transportation and Warehousing</option>
            <option value="utilities-mining">Utilities & Mining</option>
             <option value="wealth-management">Wealth Management</option>
            <option value="wholesale-trade">Wholesale Trade</option>
          </select>
        </div>
       </div>

      <div class="form-row">
        <div class="form-group">
          <label for="logoUpload">Company Logo</label>
          <div class="file-upload" data-intro="Upload your company logo. This will be automatically resized and used in your campaigns." data-step="3">
            <input type="file" id="logoUpload" name="logo_file" accept="image/*">
            <label for="logoUpload" class="file-upload-label">
              üìÅ Choose logo file (JPG, PNG, SVG)
            </label>
            <div id="logoFileName" class="file-name"></div>
            <div id="logoPreview" class="logo-preview"></div>
          </div>
        </div>
        <div class="form-group">
          <label>Brand Color Palette</label>
          <div class="color-palette">
            <div class="color-input">
              <input type="color" id="color1" name="brand_colors_1" value="#0A3161">
              <input type="text" id="color1Text" placeholder="#0A3161">
            </div>
            <div class="color-input">
              <input type="color" id="color2" name="brand_colors_2" value="#ffffff">
              <input type="text" id="color2Text" placeholder="#ffffff">
            </div>
            <div class="color-input">
              <input type="color" id="color3" name="brand_colors_3" value="#f5f5f5">
              <input type="text" id="color3Text" placeholder="#f5f5f5">
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="companyDescription">Company Description *</label>
        <textarea id="companyDescription" name="company_description" required 
                  placeholder="Describe your company, mission, and what makes you unique..." 
                  data-intro="Describe your company in detail. Our AI uses this to create targeted campaigns." 
                  data-step="4"></textarea>
      </div>

      <div class="form-group">
        <label for="productDescription">Product/Service Description *</label>
        <textarea id="productDescription" name="product_description" required 
                  placeholder="Describe your main product or service in detail..." 
                  data-intro="Explain your products or services. This helps our AI understand what to promote." 
                  data-step="5"></textarea>
      </div>

      <div class="form-group">
        <label for="icp">Ideal Customer Profile</label>
        <textarea id="icp" name="icp" 
                  placeholder="Describe your ideal customer (demographics, company size, industry, pain points, etc.)..." 
                  data-intro="Define your ideal customer profile. This helps target your campaigns to the right audience." 
                  data-step="6"></textarea>
      </div>
    </form>
  </div>

  <!-- Newsletter & Marketing Section -->
  <div class="card">
    <div class="section-header">
      <h3>Newsletter & Marketing Information</h3>
    </div>
    
    <div class="form-row">
      <div class="form-group ai-enhanced-field">
        <label for="newsletterTitle">Newsletter Title *</label>
        <input type="text" id="newsletterTitle" name="newsletter_title" 
               placeholder="Enter your newsletter title..." 
               data-intro="Create a compelling newsletter title for your campaigns." 
               data-step="7">
        <button type="button" class="ai-enhance-button" onclick="enhanceNewsletterTitle()" id="enhanceNewsletterBtn">
          ü§ñ AI Enhance
        </button>
      </div>
      <div class="form-group">
        <label for="newsletterTagline">Newsletter Tagline (Optional)</label>
        <input type="text" id="newsletterTagline" name="newsletter_tagline" 
               placeholder="Enter your newsletter tagline...">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group ai-enhanced-field">
        <label for="offer">Special Offer/Value Proposition</label>
        <textarea id="offer" name="offer" 
                  placeholder="Describe your special offer or unique value proposition..." 
                  data-intro="Define your special offer that will be polished by AI for maximum impact." 
                  data-step="8"></textarea>
        <button type="button" class="ai-enhance-button" onclick="enhanceOffer()" id="enhanceOfferBtn">
          ü§ñ AI Polish
        </button>
      </div>
      <div class="form-group">
        <label for="calendar">Calendar/Booking Link</label>
        <input type="url" id="calendar" name="calendar" 
               placeholder="https://calendly.com/yourlink or your booking URL..." 
               data-intro="Add your calendar booking link for lead conversion." 
               data-step="9">
      </div>
    </div>
  </div>

  <!-- Product Images Section -->
  <div class="card">
    <div class="section-header">
      <h3>Product Images</h3>
      <p style="margin: 5px 0 0 0; opacity: 0.9;">Upload up to 4 product images for your campaigns</p>
    </div>

    <div class="product-images-grid">
      <div class="form-group">
        <label for="productImage1">Product Image 1</label>
        <div class="file-upload">
          <input type="file" id="productImage1" name="product_image_1" accept="image/*">
          <label for="productImage1" class="file-upload-label">
            üì∏ Choose product image 1
          </label>
          <div id="productImage1FileName" class="file-name"></div>
          <div id="productImage1Preview" class="product-preview"></div>
        </div>
      </div>
      <div class="form-group">
        <label for="productImage2">Product Image 2</label>
        <div class="file-upload">
          <input type="file" id="productImage2" name="product_image_2" accept="image/*">
          <label for="productImage2" class="file-upload-label">
            üì∏ Choose product image 2
          </label>
          <div id="productImage2FileName" class="file-name"></div>
          <div id="productImage2Preview" class="product-preview"></div>
        </div>
      </div>
      <div class="form-group">
        <label for="productImage3">Product Image 3</label>
        <div class="file-upload">
          <input type="file" id="productImage3" name="product_image_3" accept="image/*">
          <label for="productImage3" class="file-upload-label">
            üì∏ Choose product image 3
          </label>
          <div id="productImage3FileName" class="file-name"></div>
          <div id="productImage3Preview" class="product-preview"></div>
        </div>
      </div>
      <div class="form-group">
        <label for="productImage4">Product Image 4</label>
        <div class="file-upload">
          <input type="file" id="productImage4" name="product_image_4" accept="image/*">
          <label for="productImage4" class="file-upload-label">
            üì∏ Choose product image 4
          </label>
          <div id="productImage4FileName" class="file-name"></div>
          <div id="productImage4Preview" class="product-preview"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Goal Management Section -->
  <div class="card">
    <div class="section-header">
      <h3>Goal Management</h3>
      <p style="margin: 5px 0 0 0; opacity: 0.9;">Create or replace your current goal</p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <!-- Current Goal Display -->
      <div class="goal-card">
        <h4>Current Goal</h4>
        <div id="currentGoalDisplay">
          <em>No goal set yet</em>
        </div>
      </div>

      <!-- New Goal Input -->
      <div class="goal-card">
        <h4>New Goal</h4>
        <form class="goal-form">
          <div class="form-group">
            <label>Goal Description (Specific) *</label>
            <textarea name="goal_description" required 
                      placeholder="What exactly do you want to achieve?" 
                      data-intro="Set a specific business goal. Our AI will create campaigns designed to achieve this goal." 
                      data-step="10"></textarea>
          </div>
          <div class="form-group">
            <label>How will you measure success? (Measurable) *</label>
            <input type="text" name="measurement" required placeholder="e.g., 30% increase in revenue, 1000 new customers">
          </div>
          <div class="form-group">
            <label>Why is this achievable? (Achievable)</label>
            <textarea name="achievable" placeholder="What resources/capabilities do you have?"></textarea>
          </div>
          <div class="form-group">
            <label>How does this relate to your business? (Relevant)</label>
            <textarea name="relationship" placeholder="How does this align with your strategy?"></textarea>
          </div>
          <div class="form-group">
            <label>Time Limit *</label>
            <input type="date" name="time_limit" required>
          </div>
        </form>
      </div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
      <button type="button" class="save-all-button" onclick="saveAllData()" 
              data-intro="Save your profile and goal. Once saved, you can start creating AI-powered campaigns!" 
              data-step="11">
        <span id="saveButtonText">üíæ Save Company Profile & Goal</span>
        <span id="saveSpinner" class="spinner-inline" style="display: none;"></span>
      </button>
    </div>
  </div>

  <!-- Status Messages -->
  <div id="statusMessage" class="status-message"></div>
  <div id="loader" class="loader"></div>
</div>

<!-- Victory Vision Chat Widget -->
<div class="vv-chat-widget" id="vvChatWidget">
  <button class="vv-chat-toggle" id="vvChatToggle" title="Chat with Victory Vision AI">
    <span id="vvToggleIcon">üí¨</span>
    <div class="vv-notification-badge" id="vvNotificationBadge" style="display: none;">1</div>
  </button>

  <div class="vv-chat-container" id="vvChatContainer">
    <div class="vv-chat-header">
      <div class="vv-chat-avatar">ü§ñ</div>
      <div>
        <div class="vv-chat-title">Victory Vision AI</div>
        <div class="vv-chat-subtitle">How can I help you today?</div>
      </div>
      <button class="vv-chat-minimize" id="vvChatMinimize" title="Minimize chat">‚úï</button>
    </div>

    <div class="vv-chat-messages" id="vvChatMessages">
      <div class="vv-chat-message bot">
        üëã Hi! I'm your Victory Vision AI assistant. I can help you with:
        <div class="vv-chat-quick-actions">
          <button class="vv-quick-action" onclick="VVChat.sendQuickMessage('How do I create a campaign?')">Create Campaigns</button>
          <button class="vv-quick-action" onclick="VVChat.sendQuickMessage('Help with my subscription')">Subscription Help</button>
          <button class="vv-quick-action" onclick="VVChat.sendQuickMessage('How to generate videos?')">Video Generation</button>
          <button class="vv-quick-action" onclick="VVChat.sendQuickMessage('Contact support')">Contact Support</button>
        </div>
      </div>
    </div>

    <div class="vv-chat-typing" id="vvChatTyping">
      <span style="font-size: 12px; color: #666;">AI is typing</span>
      <div class="vv-typing-dots">
        <div class="vv-typing-dot"></div>
        <div class="vv-typing-dot"></div>
        <div class="vv-typing-dot"></div>
      </div>
    </div>

    <div class="vv-chat-input-area">
      <textarea 
        class="vv-chat-input" 
        id="vvChatInput" 
        placeholder="Type your message here..."
        rows="1"></textarea>
      <button class="vv-chat-send" id="vvChatSend" title="Send message">‚û§</button>
    </div>

    <div class="vv-chat-error" id="vvChatError"></div>
  </div>
</div>

<footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
  // Prevent favicon error
  if (!document.querySelector('link[rel="icon"]')) {
    const link = document.createElement('link');
    link.rel = 'icon';
    link.href = 'data:,';
    document.head.appendChild(link);
  }

  // Supabase configuration - LIMITED to auth only
  const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  
  // n8n webhook endpoints
  const N8N_BASE_URL = 'https://victoryvision.app.n8n.cloud/webhook';
  const ENDPOINTS = {
    GET_USER: `${N8N_BASE_URL}/user/get`,
    UPDATE_USER: `${N8N_BASE_URL}/user/update`,
    UPLOAD_LOGO: `${N8N_BASE_URL}/user/logo`,
    UPLOAD_PRODUCT1: `${N8N_BASE_URL}/user/product-image1`,
    UPLOAD_PRODUCT2: `${N8N_BASE_URL}/user/product-image2`,
    UPLOAD_PRODUCT3: `${N8N_BASE_URL}/user/product-image3`,
    UPLOAD_PRODUCT4: `${N8N_BASE_URL}/user/product-image4`,
    NEWSLETTER_TITLE: `${N8N_BASE_URL}/newsletter/title`,
    USER_OFFER: `${N8N_BASE_URL}/user/offer`,
    USER_CALENDAR: `${N8N_BASE_URL}/user/calendar`
  };
  
  let CUSTOMER_ID = null;
  let currentUser = null;
  let authToken = null;
let userData = null; 
  let uploadedLogoFile = null;
  let uploadedProductImages = {
    product_image_1: null,
    product_image_2: null,
    product_image_3: null,
    product_image_4: null
  };

  // Rate limiting for API calls
  const rateLimiter = {
    calls: [],
    maxCalls: 20,
    windowMs: 60000,
    
    canMakeCall: function() {
      const now = Date.now();
      const windowStart = now - this.windowMs;
      this.calls = this.calls.filter(time => time > windowStart);
      
      if (this.calls.length >= this.maxCalls) {
        return false;
      }
      
      this.calls.push(now);
      return true;
    }
  };

  // Input sanitization
  function sanitizeInput(value) {
    if (typeof value !== 'string') return value;
    
    return value
      .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
      .replace(/javascript:/gi, '')
      .replace(/on\w+\s*=/gi, '')
      .replace(/data:/gi, '')
      .trim();
  }

  // Validate email format
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  // Check if profile is complete
  function isProfileComplete() {
    const companyName = document.getElementById('companyName').value;
    const userTitle = document.getElementById('userTitle').value;    
    const companyDescription = document.getElementById('companyDescription').value;
    const productDescription = document.getElementById('productDescription').value;
    const newsletterTitle = document.getElementById('newsletterTitle').value;
    
    return companyName.trim() && userTitle.trim() && companyDescription.trim() && productDescription.trim() && newsletterTitle.trim();
  }

  // Show or hide tour button based on profile completeness
  function updateTourButtonVisibility() {
    const tourButton = document.querySelector('button[onclick="startTour()"]');
    if (tourButton) {
      if (isProfileComplete()) {
        tourButton.style.display = 'none';
      } else {
        tourButton.style.display = 'inline-block';
      }
    }
  }

  // Intro.js tour functionality
  function startTour() {
    introJs().setOptions({
      showProgress: true,
      showBullets: false,
      exitOnOverlayClick: false,
      nextLabel: 'Next ‚Üí',
      prevLabel: '‚Üê Back',
      doneLabel: 'Complete Setup!',
      skipLabel: 'Skip Tour'
    }).start();
  }

  // Check if user is new and should see tour
  function checkIfNewUser() {
    const hasSeenTour = localStorage.getItem('vv_tour_completed');
    const companyName = document.getElementById('companyName').value;
    
    // Update tour button visibility
    updateTourButtonVisibility();
    
    // Show tour if they haven't seen it AND profile is empty
    if (!hasSeenTour && !companyName.trim()) {
      setTimeout(() => {
        startTour();
      }, 1000); // Small delay to ensure page is fully loaded
    }
  }

  // Mark tour as completed
  function completeTour() {
    localStorage.setItem('vv_tour_completed', 'true');
  }

  // Authentication and session management
  async function checkAuthentication() {
    try {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      
      if (error) {
        console.error('Auth error:', error);
        return false;
      }

      if (session && session.user) {
        // Validate session data
        if (!isValidEmail(session.user.email)) {
          console.error('Invalid email format in session');
          return false;
        }
        
        CUSTOMER_ID = session.user.email;
        authToken = session.access_token;
        currentUser = {
          id: session.user.id,
          email: session.user.email,
          customer_id: session.user.email
        };
        
        document.getElementById('userEmail').textContent = CUSTOMER_ID;
        return true;
      }

      return false;
    } catch (e) {
      console.error('Auth check error:', e);
      return false;
    }
  }

  function redirectToLogin() {
    // Clear all session data
    localStorage.removeItem('vv_session');
    sessionStorage.clear();
    
    // Redirect
    window.location.href = 'login.html';
  }

  // API call wrapper with enhanced security
  async function apiCall(endpoint, data = null, method = 'POST') {
    try {
      // Rate limiting check
      if (!rateLimiter.canMakeCall()) {
        throw new Error('Too many requests. Please wait before trying again.');
      }

      // Skip favicon requests
      if (endpoint.includes('favicon')) {
        return null;
      }

      // Validate endpoint
      if (!endpoint.startsWith('https://victoryvision.app.n8n.cloud/webhook/')) {
        throw new Error('Invalid endpoint');
      }

      const headers = {
        'X-Customer-ID': CUSTOMER_ID,
        'X-Request-ID': generateRequestId(),
        'X-Timestamp': new Date().toISOString(),
        'X-User-Agent': 'VictoryVision/1.0'
      };
      
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      let url = endpoint;
      let body = null;

      if (method === 'GET') {
        url = `${endpoint}?customer_id=${encodeURIComponent(CUSTOMER_ID)}`;
      } else {
        headers['Content-Type'] = 'application/json';
        
        // Sanitize input data
        const sanitizedData = {};
        if (data) {
          for (const [key, value] of Object.entries(data)) {
            sanitizedData[key] = sanitizeInput(value);
          }
        }
        
        body = JSON.stringify({
          ...sanitizedData,
          customer_id: CUSTOMER_ID,
          timestamp: new Date().toISOString(),
          request_id: generateRequestId()
        });
      }

      const response = await fetch(url, {
        method: method,
        headers: headers,
        body: body,
        mode: 'cors',
        credentials: 'omit',
        signal: AbortSignal.timeout(30000) // 30 second timeout
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const result = await response.json();
      return result;
    } catch (error) {
      console.error('API call failed:', error);
      
      if (error.message.includes('401') || error.message.includes('403')) {
        showStatus('Session expired. Please log in again.', true);
        setTimeout(redirectToLogin, 2000);
      }
      
      throw error;
    }
  }

  function generateRequestId() {
    return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // Load user data and update medallion
  async function loadUserSubscriptionData() {
    try {
      const data = await apiCall(ENDPOINTS.GET_USER, null, 'GET');
      console.log('User data loaded:', data);
      
      // Handle array response from n8n
      const userData = Array.isArray(data) ? data[0] : data;
      
      if (userData && userData.subscription_plan) {
        updateSubscriptionMedallion(userData.subscription_plan);
      } else {
        updateSubscriptionMedallion('Bronze'); // Default
      }
      
      return userData;
    } catch (error) {
      console.error('Error loading user subscription data:', error);
      updateSubscriptionMedallion('Bronze'); // Fallback
      throw error;
    }
  }

  // Update subscription medallion
  function updateSubscriptionMedallion(plan) {
    const medallion = document.getElementById('subscriptionMedallion');
    const planName = medallion.querySelector('.plan-name');
    
    // Validate plan value
    const validPlans = ['Bronze', 'Silver', 'Gold'];
    const safePlan = validPlans.includes(plan) ? plan : 'Bronze';
    
    medallion.className = `subscription-medallion ${safePlan.toLowerCase()}`;
    planName.textContent = safePlan;
  }

  // AI Enhancement Functions
  async function enhanceNewsletterTitle() {
    const titleInput = document.getElementById('newsletterTitle');
    const enhanceBtn = document.getElementById('enhanceNewsletterBtn');
    
    if (!titleInput.value.trim()) {
      showStatus('Please enter a newsletter title first', true);
      return;
    }

    enhanceBtn.disabled = true;
    enhanceBtn.innerHTML = 'üîÑ Enhancing...';

    try {
      const result = await apiCall(ENDPOINTS.NEWSLETTER_TITLE, {
        newsletter_title: titleInput.value.trim()
      });

      if (result.enhanced_title) {
        titleInput.value = result.enhanced_title;
        showStatus('Newsletter title enhanced successfully!');
      } else {
        throw new Error('No enhanced title returned');
      }
    } catch (error) {
      console.error('Error enhancing newsletter title:', error);
      showStatus('Failed to enhance newsletter title: ' + error.message, true);
    } finally {
      enhanceBtn.disabled = false;
      enhanceBtn.innerHTML = 'ü§ñ AI Enhance';
    }
  }

  async function enhanceOffer() {
    const offerInput = document.getElementById('offer');
    const enhanceBtn = document.getElementById('enhanceOfferBtn');
    
    if (!offerInput.value.trim()) {
      showStatus('Please enter an offer first', true);
      return;
    }

    enhanceBtn.disabled = true;
    enhanceBtn.innerHTML = 'üîÑ Polishing...';

    try {
      const result = await apiCall(ENDPOINTS.USER_OFFER, {
        offer: offerInput.value.trim()
      });

      if (result.polished_offer) {
        offerInput.value = result.polished_offer;
        showStatus('Offer polished successfully!');
      } else {
        throw new Error('No polished offer returned');
      }
    } catch (error) {
      console.error('Error polishing offer:', error);
      showStatus('Failed to polish offer: ' + error.message, true);
    } finally {
      enhanceBtn.disabled = false;
      enhanceBtn.innerHTML = 'ü§ñ AI Polish';
    }
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', async function() {
    document.getElementById('authLoading').style.display = 'flex';
    
    try {
      const isAuthenticated = await checkAuthentication();
      
      if (isAuthenticated) {
        document.getElementById('authLoading').style.display = 'none';
        setupColorPickers();
        setupFileUploads();
        await loadAllData();
        
        // Add tour completion handler
        introJs().oncomplete(completeTour);
        introJs().onexit(completeTour);
        
        // Add event listeners to update tour button visibility when typing
        document.getElementById('companyName').addEventListener('input', updateTourButtonVisibility);
        document.getElementById('userTitle').addEventListener('input', updateTourButtonVisibility);
        document.getElementById('companyDescription').addEventListener('input', updateTourButtonVisibility);
        document.getElementById('productDescription').addEventListener('input', updateTourButtonVisibility);
        document.getElementById('newsletterTitle').addEventListener('input', updateTourButtonVisibility);
      } else {
        redirectToLogin();
      }
    } catch (e) {
      console.error('Initialization failed:', e);
      redirectToLogin();
    }
  });

  // Color picker synchronization
  function setupColorPickers() {
    ['1', '2', '3'].forEach(num => {
      const colorInput = document.getElementById(`color${num}`);
      const textInput = document.getElementById(`color${num}Text`);
      
      colorInput.addEventListener('change', function() {
        textInput.value = this.value;
      });
      
      textInput.addEventListener('change', function() {
        // Validate color format
        if (/^#[0-9A-F]{6}$/i.test(this.value)) {
          colorInput.value = this.value;
        }
      });
    });
  }

  function setupFileUploads() {
    // Logo upload
    setupSingleFileUpload('logoUpload', 'logoFileName', 'logoPreview', ENDPOINTS.UPLOAD_LOGO, 'logo_URL');
    
    // Product image uploads
    ['1', '2', '3', '4'].forEach(num => {
      setupProductImageUpload(num);
    });
  }

  function setupSingleFileUpload(inputId, fileNameId, previewId, endpoint, responseKey) {
    const fileInput = document.getElementById(inputId);
    const fileName = document.getElementById(fileNameId);
    const preview = document.getElementById(previewId);
    
    fileInput.addEventListener('change', async function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        
        // Validate file
        if (!file.type.startsWith('image/')) {
          showStatus('Please select a valid image file', true);
          return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          showStatus('File size must be less than 5MB', true);
          return;
        }
        
        fileName.textContent = `Uploading: ${file.name}...`;
        
        try {
          const base64File = await fileToBase64(file);
          const uploadResult = await apiCall(endpoint, {
            logo_file: base64File,
            file_name: sanitizeInput(file.name),
            file_type: file.type
          }, 'POST');
          
          const fileUrl = uploadResult[responseKey] || uploadResult.url || uploadResult.URL || uploadResult.logo_url;
          
          if (fileUrl) {
            fileName.textContent = `‚úì Uploaded: ${file.name}`;
            preview.innerHTML = `<img src="${fileUrl}" alt="Uploaded file">`;
            showStatus('File uploaded successfully!');
            if (inputId === 'logoUpload') {
              uploadedLogoFile = { url: fileUrl };
            }
          } else {
            throw new Error('Upload failed - no URL returned');
          }
        } catch (error) {
          console.error('File upload failed:', error);
          fileName.textContent = `‚ùå Upload failed: ${file.name}`;
          showStatus('File upload failed: ' + error.message, true);
          if (inputId === 'logoUpload') {
            uploadedLogoFile = null;
          }
        }
      }
    });
  }

  function setupProductImageUpload(num) {
    const fileInput = document.getElementById(`productImage${num}`);
    const fileName = document.getElementById(`productImage${num}FileName`);
    const preview = document.getElementById(`productImage${num}Preview`);
    
    fileInput.addEventListener('change', async function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        
        // Validate file
        if (!file.type.startsWith('image/')) {
          showStatus('Please select a valid image file', true);
          return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          showStatus('File size must be less than 5MB', true);
          return;
        }
        
        fileName.textContent = `Uploading: ${file.name}...`;
        
        try {
          const base64File = await fileToBase64(file);
         const uploadResult = await apiCall(ENDPOINTS[`UPLOAD_PRODUCT${num}`], {
            logo_file: base64File,
            file_name: sanitizeInput(file.name),
            file_type: file.type,
            field_type: `product_image_${num}`
          }, 'POST');
          
       const fileUrl = uploadResult.URL;
          if (fileUrl) {
            fileName.textContent = `‚úì Uploaded: ${file.name}`;
            preview.innerHTML = `<img src="${fileUrl}" alt="Product image ${num}">`;
            showStatus(`Product image ${num} uploaded successfully!`);
            uploadedProductImages[`product_image_${num}`] = { url: fileUrl };
          } else {
            throw new Error('Upload failed - no URL returned');
          }
        } catch (error) {
          console.error(`Product image ${num} upload failed:`, error);
          fileName.textContent = `‚ùå Upload failed: ${file.name}`;
          showStatus(`Product image ${num} upload failed: ` + error.message, true);
          uploadedProductImages[`product_image_${num}`] = null;
        }
      } else {
        uploadedProductImages[`product_image_${num}`] = null;
        fileName.textContent = '';
        preview.innerHTML = '';
      }
    });
  }

  function showLoader() {
    document.getElementById('loader').style.display = 'block';
  }

  function hideLoader() {
    document.getElementById('loader').style.display = 'none';
  }

  function showStatus(message, isError = false) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = sanitizeInput(message);
    statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 5000);
  }

  // Convert file to base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

// FIXED: Main save function - combines company and goal
async function saveAllData() {
  const saveButton = document.querySelector('.save-all-button');
  const saveButtonText = document.getElementById('saveButtonText');
  const saveSpinner = document.getElementById('saveSpinner');
  
  // Show spinner
  saveButton.disabled = true;
  saveButtonText.style.display = 'none';
  saveSpinner.style.display = 'inline-block';
  
  try {
    const formData = new FormData(document.getElementById('companyForm'));
    const goalForm = document.querySelector('.goal-form');
    const goalFormData = new FormData(goalForm);
    
    // Validate required fields
    if (!formData.get('company_name') || !formData.get('title') || !formData.get('company_description') || !formData.get('product_description') || !document.getElementById('newsletterTitle').value.trim()) {
      throw new Error('Please fill in all required fields');
    }
    
    // Use already uploaded logo URL
    let logoUrl = '';
    if (uploadedLogoFile && uploadedLogoFile.url) {
      logoUrl = uploadedLogoFile.url;
    }
    
    // Get product image URLs
    const productImageUrls = {};
    for (let i = 1; i <= 4; i++) {
      if (uploadedProductImages[`product_image_${i}`] && uploadedProductImages[`product_image_${i}`].url) {
        productImageUrls[`product_image_${i}`] = uploadedProductImages[`product_image_${i}`].url;
      }
    }
    
    // NEW: Check if goal was manually edited
    const goalWasEdited = document.getElementById('goalModifiedFlag').value === 'true' || goalManuallyEdited;
    
    // Collect goal data based on whether it was edited
    let goalData = null;
    
    if (goalWasEdited) {
      // User edited the goal - use new data from form
      if (goalFormData.get('goal_description') && goalFormData.get('goal_description').trim()) {
        goalData = {
          goal_description: sanitizeInput(goalFormData.get('goal_description')),
          measurement: sanitizeInput(goalFormData.get('measurement')),
          achievable: sanitizeInput(goalFormData.get('achievable')),
          relationship: sanitizeInput(goalFormData.get('relationship')),
          time_limit: goalFormData.get('time_limit') || null
        };
      }
      // Reset the flag after processing
      goalManuallyEdited = false;
      document.getElementById('goalModifiedFlag').value = 'false';
    } else {
      // Goal wasn't edited - preserve existing goal from userData
      if (userData && userData.goal) {
        goalData = userData.goal;
      }
    }
    
    // FIXED: Combine all data into single payload including new fields
    const allData = {
      company_name: sanitizeInput(formData.get('company_name')),
      title: sanitizeInput(formData.get('title')),
      industry: sanitizeInput(formData.get('industry')),
      domain: sanitizeInput(formData.get('domain')),
      logo_URL: logoUrl,
      company_description: sanitizeInput(formData.get('company_description')),
      product_description: sanitizeInput(formData.get('product_description')),
      icp: sanitizeInput(formData.get('icp')),
      brand_colors: sanitizeInput(formData.get('brand_colors_1')) + ',' + 
                   sanitizeInput(formData.get('brand_colors_2')) + ',' + 
                   sanitizeInput(formData.get('brand_colors_3')),
      newsletter_title: sanitizeInput(document.getElementById('newsletterTitle').value),
      newsletter_tagline: sanitizeInput(document.getElementById('newsletterTagline').value),
      offer: sanitizeInput(document.getElementById('offer').value),
      calendar: sanitizeInput(document.getElementById('calendar').value),
      ...productImageUrls,
      goal: goalData
    };
    
    const result = await apiCall(ENDPOINTS.UPDATE_USER, allData, 'POST');
    
    if (result.success || result.status === 'success' || result.company || result.goals) {
      showStatus('Company profile and goal saved successfully!');
      await loadAllData(); // Refresh the display
    } else {
      throw new Error(result.message || 'Save failed');
    }
  } catch (error) {
    console.error('Error saving data:', error);
    showStatus('Error saving data: ' + error.message, true);
  } finally {
    // Hide spinner
    saveButton.disabled = false;
    saveButtonText.style.display = 'inline';
    saveSpinner.style.display = 'none';
  }
}
  // FIXED: Load all data function
async function loadAllData() {
  showLoader();
  
  try {
    // Load user data and update medallion - STORE GLOBALLY
    userData = await loadUserSubscriptionData();
    
    if (userData && typeof userData === 'object' && userData.company_name !== undefined) {
      
      // FIXED: Populate form fields with existing data including new fields
      document.getElementById('companyName').value = userData.company_name || '';
      document.getElementById('userTitle').value = userData.title || '';
      document.getElementById('industry').value = userData.industry || '';
      document.getElementById('companyDescription').value = userData.company_description || '';
      document.getElementById('productDescription').value = userData.product_description || userData.product_descriptions || '';
      document.getElementById('icp').value = userData.icp || '';
      
      // New fields
      document.getElementById('newsletterTitle').value = userData.newsletter_title || '';
      document.getElementById('newsletterTagline').value = userData.newsletter_tagline || '';
      document.getElementById('offer').value = userData.offer || '';
      document.getElementById('calendar').value = userData.calendar || '';
      
      // Handle brand colors
      if (userData.brand_colors) {
        const colors = userData.brand_colors.split(',');
        if (colors[0]) {
          document.getElementById('color1').value = colors[0].trim();
          document.getElementById('color1Text').value = colors[0].trim();
        }
        if (colors[1]) {
          document.getElementById('color2').value = colors[1].trim();
          document.getElementById('color2Text').value = colors[1].trim();
        }
        if (colors[2]) {
          document.getElementById('color3').value = colors[2].trim();
          document.getElementById('color3Text').value = colors[2].trim();
        }
      }
      
      // Show existing logo if available
      if (userData.logo_URL) {
        document.getElementById('logoPreview').innerHTML = `<img src="${userData.logo_URL}" alt="Company logo">`;
        document.getElementById('logoFileName').textContent = 'Current logo uploaded';
        uploadedLogoFile = { url: userData.logo_URL };
      }
      
      // Show existing product images if available
      for (let i = 1; i <= 4; i++) {
        const productImageUrl = userData[`product_image_${i}`];
        if (productImageUrl) {
          document.getElementById(`productImage${i}Preview`).innerHTML = `<img src="${productImageUrl}" alt="Product image ${i}">`;
          document.getElementById(`productImage${i}FileName`).textContent = `Current product image ${i} uploaded`;
          uploadedProductImages[`product_image_${i}`] = { url: productImageUrl };
        }
      }
    }

    // Clear goal form
    const goalForm = document.querySelector('.goal-form');
    goalForm.reset();

    // FIXED: Load and display current goal - handle both string and object
    const goalValue = userData.goal;
    if (goalValue) {
      let goalDisplay = '';
      
      // If goal is an object with fields
      if (typeof goalValue === 'object' && goalValue !== null) {
        goalDisplay = `<strong>Current Goal:</strong><br><br>`;
        if (goalValue.goal_description) goalDisplay += `<strong>Specific:</strong> ${sanitizeInput(goalValue.goal_description)}<br><br>`;
        if (goalValue.measurement) goalDisplay += `<strong>Measurable:</strong> ${sanitizeInput(goalValue.measurement)}<br><br>`;
        if (goalValue.achievable) goalDisplay += `<strong>Achievable:</strong> ${sanitizeInput(goalValue.achievable)}<br><br>`;
        if (goalValue.relationship) goalDisplay += `<strong>Relevant:</strong> ${sanitizeInput(goalValue.relationship)}<br><br>`;
        if (goalValue.time_limit) goalDisplay += `<strong>Time-bound:</strong> ${goalValue.time_limit}`;
      } 
      // If goal is a string (legacy format)
      else if (typeof goalValue === 'string' && goalValue.trim()) {
        goalDisplay = `<strong>Current Goal:</strong><br><br>${sanitizeInput(goalValue)}`;
      }
      
      document.getElementById('currentGoalDisplay').innerHTML = goalDisplay || '<em>No goal set yet</em>';
    } else {
      document.getElementById('currentGoalDisplay').innerHTML = '<em>No goal set yet</em>';
    }
    
    // Reset goal modification flag after loading
    goalManuallyEdited = false;
    if (document.getElementById('goalModifiedFlag')) {
      document.getElementById('goalModifiedFlag').value = 'false';
    }

    if (userData || goalValue) {
      showStatus('Data loaded successfully!');
    } else {
      showStatus('No existing data found. Please fill out the forms.');
    }

    // Update tour button visibility based on loaded data
    updateTourButtonVisibility();

    // Check if new user should see tour
    checkIfNewUser();
    
  } catch (error) {
    console.error('Error loading data:', error);
    showStatus('Error loading data: ' + error.message, true);
  } finally {
    hideLoader();
  }
}
  // Prevent default form submission
  document.getElementById('companyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveAllData();
  });

  // Enhanced security measures
  
  // Session timeout check
  setInterval(async function() {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        console.log('Session expired, redirecting to login');
        redirectToLogin();
      }
    } catch (e) {
      console.error('Session check failed:', e);
      redirectToLogin();
    }
  }, 300000); // Check every 5 minutes

  // Detect tab visibility and re-verify auth when tab becomes visible
  document.addEventListener('visibilitychange', async function() {
    if (!document.hidden) {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          redirectToLogin();
        } else {
          authToken = session.access_token;
          // Refresh medallion data
          await loadUserSubscriptionData();
        }
      } catch (e) {
        console.error('Visibility auth check failed:', e);
        redirectToLogin();
      }
    }
  });

  // Victory Vision Chat Widget
  class VictoryVisionChat {
    constructor() {
      this.isOpen = false;
      this.isTyping = false;
      this.apiEndpoint = 'https://victoryvision.app.n8n.cloud/webhook/chat/message';
      this.customerId = null;
      this.authToken = null;
      this.conversationId = null;
      this.messageCount = 0;
      this.init();
    }

    init() {
      this.toggle = document.getElementById('vvChatToggle');
      this.container = document.getElementById('vvChatContainer');
      this.messages = document.getElementById('vvChatMessages');
      this.input = document.getElementById('vvChatInput');
      this.sendBtn = document.getElementById('vvChatSend');
      this.minimize = document.getElementById('vvChatMinimize');
      this.typing = document.getElementById('vvChatTyping');
      this.error = document.getElementById('vvChatError');
      this.notification = document.getElementById('vvNotificationBadge');
      this.toggleIcon = document.getElementById('vvToggleIcon');

      this.setupEventListeners();
      this.getCustomerAuth();
      this.conversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      this.setupAutoResize();
    }

    setupEventListeners() {
      this.toggle.addEventListener('click', () => this.toggleChat());
      this.minimize.addEventListener('click', () => this.closeChat());
      this.sendBtn.addEventListener('click', () => this.sendMessage());
      this.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });
      this.input.addEventListener('input', () => {
        this.sendBtn.disabled = !this.input.value.trim();
      });
    }

    setupAutoResize() {
      this.input.addEventListener('input', () => {
        this.input.style.height = 'auto';
        this.input.style.height = Math.min(this.input.scrollHeight, 80) + 'px';
      });
    }

    getCustomerAuth() {
      if (typeof supabaseClient !== 'undefined') {
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
          if (session && session.user) {
            this.customerId = session.user.email;
            this.authToken = session.access_token;
          }
        });
      }
      if (typeof CUSTOMER_ID !== 'undefined') {
        this.customerId = CUSTOMER_ID;
      }
      if (typeof authToken !== 'undefined') {
        this.authToken = authToken;
      }
    }

    toggleChat() {
      if (this.isOpen) {
        this.closeChat();
      } else {
        this.openChat();
      }
    }

    openChat() {
      this.isOpen = true;
      this.container.classList.add('open');
      this.toggle.classList.add('active');
      this.toggleIcon.textContent = '‚úï';
      this.input.focus();
      this.hideNotification();
      this.scrollToBottom();
    }

    closeChat() {
      this.isOpen = false;
      this.container.classList.remove('open');
      this.toggle.classList.remove('active');
      this.toggleIcon.textContent = 'üí¨';
      this.hideError();
    }

    async sendMessage() {
      const message = this.input.value.trim();
      if (!message || this.isTyping) return;

      this.addMessage(message, 'user');
      this.input.value = '';
      this.input.style.height = 'auto';
      this.sendBtn.disabled = true;
      this.showTyping();

      try {
        const response = await this.callChatAPI(message);
        this.hideTyping();
        
        if (response && response.reply) {
          this.addMessage(response.reply, 'bot');
        } else {
          throw new Error('Invalid response format');
        }
      } catch (error) {
        this.hideTyping();
        console.error('Chat API error:', error);
        this.addMessage("I'm sorry, I'm having trouble connecting right now. Please try again in a moment.", 'bot');
        this.showError('Failed to send message. Please try again.');
      }
    }

    async callChatAPI(message) {
      const payload = {
        message: message,
        customer_id: this.customerId || 'anonymous',
        conversation_id: this.conversationId,
        timestamp: new Date().toISOString(),
        page_url: window.location.href,
        user_agent: navigator.userAgent
      };

      const headers = {
        'Content-Type': 'application/json',
        'X-Customer-ID': this.customerId || 'anonymous',
        'X-Conversation-ID': this.conversationId
      };

      if (this.authToken) {
        headers['Authorization'] = `Bearer ${this.authToken}`;
      }

      const response = await fetch(this.apiEndpoint, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      return await response.json();
    }

    addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `vv-chat-message ${sender}`;
      
      const sanitizedText = this.sanitizeText(text);
      messageDiv.innerHTML = sanitizedText;
      
      this.messages.appendChild(messageDiv);
      this.scrollToBottom();
      this.messageCount++;
      setTimeout(() => this.scrollToBottom(), 100);
    }

    sanitizeText(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }

    showTyping() {
      this.isTyping = true;
      this.typing.classList.add('show');
      this.scrollToBottom();
    }

    hideTyping() {
      this.isTyping = false;
      this.typing.classList.remove('show');
    }

    showError(message) {
      this.error.textContent = message;
      this.error.style.display = 'block';
      setTimeout(() => this.hideError(), 5000);
    }

    hideError() {
      this.error.style.display = 'none';
    }

    showNotification() {
      this.notification.style.display = 'flex';
    }

    hideNotification() {
      this.notification.style.display = 'none';
    }

    scrollToBottom() {
      this.messages.scrollTop = this.messages.scrollHeight;
    }

    sendQuickMessage(message) {
      this.input.value = message;
      this.sendMessage();
    }
  }

  // Initialize the chat widget
  const VVChat = new VictoryVisionChat();
  window.VVChat = VVChat;

  // Auto-show notification after 10 seconds if not opened
  setTimeout(() => {
    if (!VVChat.isOpen && VVChat.messageCount === 0) {
      VVChat.showNotification();
    }
  }, 10000);
  // Track if goal field was manually edited
let goalManuallyEdited = false;

document.addEventListener('DOMContentLoaded', function() {
  // Add change listener to goal textarea
  const goalTextareas = document.querySelectorAll('textarea[name="specific"], textarea[name="measurable"], textarea[name="achievable"], textarea[name="relevant"], textarea[name="time_bound"]');
  
  goalTextareas.forEach(textarea => {
    textarea.addEventListener('input', function() {
      goalManuallyEdited = true;
      document.getElementById('goalModifiedFlag').value = 'true';
    });
  });
  
  // Check if this is first login (no company data)
  checkIfFirstLogin();
});

async function checkIfFirstLogin() {
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) return;
    
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/user/get', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.access_token}`
      },
      body: JSON.stringify({
        customer_id: session.user.email
      })
    });
    
    const userData = await response.json();
    
    // If no company name, highlight domain section
    if (!userData.company_name || userData.company_name.trim() === '') {
      highlightDomainSection();
    } else {
      // Hide domain card after profile is filled
      document.getElementById('domainAutoReadCard').style.display = 'none';
      document.getElementById('step2Message').style.display = 'block';
    }
  } catch (error) {
    console.error('Error checking first login:', error);
  }
}

function highlightDomainSection() {
  const domainCard = document.getElementById('domainAutoReadCard');
  domainCard.style.animation = 'pulse 2s infinite';
  
  // Add pulse animation if not exists
  if (!document.getElementById('pulseAnimation')) {
    const style = document.createElement('style');
    style.id = 'pulseAnimation';
    style.textContent = `
      @keyframes pulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(187, 19, 62, 0.7); }
        50% { transform: scale(1.02); box-shadow: 0 0 20px 10px rgba(187, 19, 62, 0.3); }
      }
    `;
    document.head.appendChild(style);
  }
}

async function autoReadWebsite() {
  const domainInput = document.getElementById('websiteDomain');
  const domain = domainInput.value.trim();
  
  if (!domain) {
    showStatus('Please enter a website domain', true);
    return;
  }
  
  // Show loader
  document.getElementById('autoReadLoader').style.display = 'block';
  document.getElementById('autoReadWebsiteBtn').disabled = true;
  
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      throw new Error('Not authenticated');
    }
    
    const response = await fetch('https://victoryvision.app.n8n.cloud/webhook/user/auto', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.access_token}`
      },
      body: JSON.stringify({
        customer_id: session.user.email,
        domain: domain
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Auto-read response:', data);
    const profileData = Array.isArray(data) ? data[0] : data;
    
    // Fill in all the fields with returned data - CORRECTED FIELD IDs
    if (profileData.company_name) document.getElementById('companyName').value = profileData.company_name;
    if (profileData.title) document.getElementById('userTitle').value = profileData.title;
    if (profileData.industry) document.getElementById('industry').value = profileData.industry;
    if (profileData.company_description) document.getElementById('companyDescription').value = profileData.company_description;
    if (profileData.product_description) document.getElementById('productDescription').value = profileData.product_description;
    if (profileData.icp) document.getElementById('icp').value = profileData.icp;
    if (profileData.newsletter_title) document.getElementById('newsletterTitle').value = profileData.newsletter_title;
    if (profileData.newsletter_tagline) document.getElementById('newsletterTagline').value = profileData.newsletter_tagline;
    if (profileData.offer) document.getElementById('offer').value = profileData.offer;
    if (profileData.calendar) document.getElementById('calendar').value = profileData.calendar;
    
    // Brand colors
    if (profileData.primary_color) {
      document.getElementById('color1').value = profileData.primary_color;
      document.getElementById('color1Text').value = profileData.primary_color;
    }
    if (profileData.secondary_color) {
      document.getElementById('color2').value = profileData.secondary_color;
      document.getElementById('color2Text').value = profileData.secondary_color;
    }
    if (profileData.accent_color) {
      document.getElementById('color3').value = profileData.accent_color;
      document.getElementById('color3Text').value = profileData.accent_color;
    }
    
    // Logo if returned
    if (profileData.logo_URL) {
      document.getElementById('logoPreview').innerHTML = `<img src="${profileData.logo_URL}" alt="Company logo">`;
      document.getElementById('logoFileName').textContent = 'Logo found from website';
      uploadedLogoFile = { url: profileData.logo_URL };
    }
 // Populate goal fields
if (profileData.goal) {
  const goalForm = document.querySelector('.goal-form');
  if (goalForm) {
    if (profileData.goal.goal_description) goalForm.querySelector('[name="goal_description"]').value = profileData.goal.goal_description;
    if (profileData.goal.measurement) goalForm.querySelector('[name="measurement"]').value = profileData.goal.measurement;
    if (profileData.goal.achievable) goalForm.querySelector('[name="achievable"]').value = profileData.goal.achievable;
    if (profileData.goal.relationship) goalForm.querySelector('[name="relationship"]').value = profileData.goal.relationship;
    if (profileData.goal.time_limit) {
      try {
        const date = new Date(profileData.goal.time_limit);
        if (!isNaN(date.getTime())) {
          goalForm.querySelector('[name="time_limit"]').value = date.toISOString().split('T')[0];
        }
      } catch (e) {}
    }
  }
}   
    // Hide the auto-read card after successful fill
    document.getElementById('domainAutoReadCard').style.display = 'none';
  document.getElementById('step2Message').style.display = 'block';
  
    // Show success message
    const statusDiv = document.getElementById('autoReadStatus');
    statusDiv.textContent = '‚úÖ Success! Your company information has been auto-filled. Please review and confirm the information below, then click Save.';
    statusDiv.className = 'status-message status-success';
    statusDiv.style.display = 'block';
    
    // Scroll to company profile section
    document.getElementById('companyName').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
  } catch (error) {
    console.error('Error auto-reading website:', error);
    const statusDiv = document.getElementById('autoReadStatus');
    statusDiv.textContent = '‚ùå Error reading website: ' + error.message + '. Please fill in the form manually.';
    statusDiv.className = 'status-message status-error';
    statusDiv.style.display = 'block';
  } finally {
    document.getElementById('autoReadLoader').style.display = 'none';
    document.getElementById('autoReadWebsiteBtn').disabled = false;
  }
}
</script>
</body>
</html>
