<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Manage your company profile and SMART goals."/>
  <meta name="author" content="Victory Vision"/>
  <title>Victory Vision AI - Company Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      background-color: #0A3161;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .navbar nav ul li {
      margin: 0 10px;
    }
    .navbar nav ul li a {
      color: white;
      text-decoration: none;
    }
    .navbar .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .navbar .logout-btn {
      background: #BB133E;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .navbar .logout-btn:hover {
      background: #9e1034;
    }
    .logo img {
      height: 60px;
      width: auto;
      max-height: 100px;
    }
    .content {
      padding: 8px;
      max-width: none;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-group textarea {
      height: 80px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    button {
      background: #0A3161;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 5px 0 0;
    }
    button:hover {
      background: #083050;
    }
    button:disabled {
      background: #B3B3B3;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    .goals-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .goal-card {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      background: #f8f9fa;
    }
    .goal-card h4 {
      margin-top: 0;
      color: #0A3161;
      border-bottom: 2px solid #0A3161;
      padding-bottom: 5px;
    }
    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0A3161;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      display: none;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    footer {
      background: #0A3161;
      color: #fff;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
    }
    footer a {
      color: #fff;
      margin-right: 15px;
      text-decoration: none;
    }
    .section-header {
      background: linear-gradient(135deg, #0A3161, #1a4c80);
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
      border-radius: 8px 8px 0 0;
    }
    .color-palette {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .color-input {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .color-input input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .color-input input[type="text"] {
      width: 80px;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: none;
      border-radius: 8px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
    }
    .current-data {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin: 5px 0;
      border-left: 4px solid #0A3161;
    }
    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    .auth-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0A3161;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<!-- Authentication Loading Screen -->
<div id="authLoading" class="auth-loading">
  <div class="spinner"></div>
  <p>Verifying authentication...</p>
</div>

<header class="navbar">
  <div class="logo">
    <img src="logo.jpg" alt="Victory Vision Logo"
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%230A3161%22 /><text x=%225%22 y=%2225%22 font-size=%2220%22 fill=%22white%22>VV</text></svg>'"/>
  </div>
  <nav>
    <ul>
      <li><a href="companyprofile">Profile</a></li>
      <li><a href="ai-opt">ü§ñ-AI</a></li>
      <li><a href="campaigns">Campaigns</a></li>
      <li><a href="videos">Videos</a></li>
      <li><a href="pages">Pages</a></li>
      <li><a href="social">Social</a></li>    
      <li><a href="ads">Ads</a></li>
      <li><a href="leads">Leads</a></li> 
      <li><a href="settings">‚öôÔ∏è</a></li>
    </ul>
  </nav>
  <div class="user-info">
    <span id="userEmail"></span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="content">
  <h2>Company Profile & Goals Management</h2>
  
  <!-- Company Profile Section -->
  <div class="card">
    <div class="section-header">
      <h3>Company Information</h3>
    </div>
    
    <form id="companyForm">
      <div class="form-row">
        <div class="form-group">
          <label for="companyName">Company Name *</label>
          <input type="text" id="companyName" name="company_name" required>
        </div>
        <div class="form-group">
          <label for="industry">Industry</label>
          <select id="industry" name="industry">
            <option value="">Select Industry</option>
            <option value="technology">Technology</option>
            <option value="healthcare">Healthcare</option>
            <option value="finance">Finance</option>
            <option value="retail">Retail</option>
            <option value="manufacturing">Manufacturing</option>
            <option value="education">Education</option>
            <option value="real-estate">Real Estate</option>
            <option value="food-beverage">Food & Beverage</option>
            <option value="consulting">Consulting</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="logoUrl">Logo URL</label>
        <input type="url" id="logoUrl" name="logo_URL" placeholder="https://example.com/logo.png">
      </div>

      <div class="form-group">
        <label for="companyDescription">Company Description *</label>
        <textarea id="companyDescription" name="company_description" required placeholder="Describe your company, mission, and what makes you unique..."></textarea>
      </div>

      <div class="form-group">
        <label for="productDescription1">Primary Product/Service Description *</label>
        <textarea id="productDescription1" name="product_descriptions" required placeholder="Describe your main product or service in detail..."></textarea>
      </div>

      <div class="form-group">
        <label for="productDescription2">Secondary Product/Service Description</label>
        <textarea id="productDescription2" name="product_descriptions_2" placeholder="Describe additional products or services..."></textarea>
      </div>

      <div class="form-group">
        <label for="productDescription3">Third Product/Service Description</label>
        <textarea id="productDescription3" name="product_descriptions_3" placeholder="Describe other products or services..."></textarea>
      </div>

      <div class="form-group">
        <label>Brand Color Palette</label>
        <div class="color-palette">
          <div class="color-input">
            <input type="color" id="color1" name="brand_colors_1" value="#0A3161">
            <input type="text" id="color1Text" placeholder="#0A3161">
          </div>
          <div class="color-input">
            <input type="color" id="color2" name="brand_colors_2" value="#ffffff">
            <input type="text" id="color2Text" placeholder="#ffffff">
          </div>
          <div class="color-input">
            <input type="color" id="color3" name="brand_colors_3" value="#f5f5f5">
            <input type="text" id="color3Text" placeholder="#f5f5f5">
          </div>
        </div>
      </div>

      <button type="submit">Save Company Profile</button>
      <button type="button" class="secondary" onclick="loadCompanyProfile()">Load Current Profile</button>
      <button type="button" class="secondary" onclick="showCurrentData('company')">View Current Data</button>
    </form>
  </div>

  <!-- SMART Goals Section -->
  <div class="card">
    <div class="section-header">
      <h3>SMART Goals Management</h3>
      <p style="margin: 5px 0 0 0; opacity: 0.9;">Define up to 4 Specific, Measurable, Achievable, Relevant, Time-bound goals</p>
    </div>

    <div class="goals-container">
      <!-- Goal 1 -->
      <div class="goal-card">
        <h4>Goal 1</h4>
        <form class="goal-form" data-goal-number="1">
          <div class="form-group">
            <label>Goal Description (Specific) *</label>
            <textarea name="goal_description" required placeholder="What exactly do you want to achieve?"></textarea>
          </div>
          <div class="form-group">
            <label>How will you measure success? (Measurable) *</label>
            <input type="text" name="measurement" required placeholder="e.g., 30% increase in revenue, 1000 new customers">
          </div>
          <div class="form-group">
            <label>Why is this achievable? (Achievable)</label>
            <textarea name="achievable" placeholder="What resources/capabilities do you have to achieve this?"></textarea>
          </div>
          <div class="form-group">
            <label>How does this relate to your business? (Relevant)</label>
            <textarea name="relationship" placeholder="How does this goal align with your overall business strategy?"></textarea>
          </div>
          <div class="form-group">
            <label>Time Limit *</label>
            <input type="date" name="time_limit" required>
          </div>
        </form>
      </div>

      <!-- Goal 2 -->
      <div class="goal-card">
        <h4>Goal 2</h4>
        <form class="goal-form" data-goal-number="2">
          <div class="form-group">
            <label>Goal Description (Specific)</label>
            <textarea name="goal_description" placeholder="What exactly do you want to achieve?"></textarea>
          </div>
          <div class="form-group">
            <label>How will you measure success? (Measurable)</label>
            <input type="text" name="measurement" placeholder="e.g., 30% increase in revenue, 1000 new customers">
          </div>
          <div class="form-group">
            <label>Why is this achievable? (Achievable)</label>
            <textarea name="achievable" placeholder="What resources/capabilities do you have to achieve this?"></textarea>
          </div>
          <div class="form-group">
            <label>How does this relate to your business? (Relevant)</label>
            <textarea name="relationship" placeholder="How does this goal align with your overall business strategy?"></textarea>
          </div>
          <div class="form-group">
            <label>Time Limit</label>
            <input type="date" name="time_limit">
          </div>
        </form>
      </div>

      <!-- Goal 3 -->
      <div class="goal-card">
        <h4>Goal 3</h4>
        <form class="goal-form" data-goal-number="3">
          <div class="form-group">
            <label>Goal Description (Specific)</label>
            <textarea name="goal_description" placeholder="What exactly do you want to achieve?"></textarea>
          </div>
          <div class="form-group">
            <label>How will you measure success? (Measurable)</label>
            <input type="text" name="measurement" placeholder="e.g., 30% increase in revenue, 1000 new customers">
          </div>
          <div class="form-group">
            <label>Why is this achievable? (Achievable)</label>
            <textarea name="achievable" placeholder="What resources/capabilities do you have to achieve this?"></textarea>
          </div>
          <div class="form-group">
            <label>How does this relate to your business? (Relevant)</label>
            <textarea name="relationship" placeholder="How does this goal align with your overall business strategy?"></textarea>
          </div>
          <div class="form-group">
            <label>Time Limit</label>
            <input type="date" name="time_limit">
          </div>
        </form>
      </div>

      <!-- Goal 4 -->
      <div class="goal-card">
        <h4>Goal 4</h4>
        <form class="goal-form" data-goal-number="4">
          <div class="form-group">
            <label>Goal Description (Specific)</label>
            <textarea name="goal_description" placeholder="What exactly do you want to achieve?"></textarea>
          </div>
          <div class="form-group">
            <label>How will you measure success? (Measurable)</label>
            <input type="text" name="measurement" placeholder="e.g., 30% increase in revenue, 1000 new customers">
          </div>
          <div class="form-group">
            <label>Why is this achievable? (Achievable)</label>
            <textarea name="achievable" placeholder="What resources/capabilities do you have to achieve this?"></textarea>
          </div>
          <div class="form-group">
            <label>How does this relate to your business? (Relevant)</label>
            <textarea name="relationship" placeholder="How does this goal align with your overall business strategy?"></textarea>
          </div>
          <div class="form-group">
            <label>Time Limit</label>
            <input type="date" name="time_limit">
          </div>
        </form>
      </div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
      <button type="button" onclick="saveAllGoals()">Save All Goals</button>
      <button type="button" class="secondary" onclick="loadAllGoals()">Load Current Goals</button>
      <button type="button" class="secondary" onclick="showCurrentData('goals')">View Current Goals</button>
    </div>
  </div>

  <!-- Status Messages -->
  <div id="statusMessage" class="status-message"></div>
  <div id="loader" class="loader"></div>
</div>

<!-- Modal for viewing current data -->
<div id="dataModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle">Current Data</h2>
    <div id="modalContent"></div>
  </div>
</div>

<footer>
  <p>&copy; 2025 Victory Vision Digital Out of Home. All rights reserved.</p>
  <nav>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
  </nav>
</footer>

<script>
  // Supabase configuration - LIMITED to auth only
  const supabaseUrl = 'https://nyyvsdkumxvuwimmucdb.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55eXZzZGt1bXh2dXdpbW11Y2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3MzY5OTQsImV4cCI6MjA1OTMxMjk5NH0.7m7R_8mBhp7X8itl5cR81xbX2AjJUm2SIPR0FUv6ouU';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  
  // n8n webhook endpoints - Fixed to match your webhook configuration
  const N8N_ENDPOINTS = {
    SAVE_COMPANY: 'https://victoryvision.app.n8n.cloud/webhook/company-profile',
    GET_COMPANY: 'https://victoryvision.app.n8n.cloud/webhook/company-profile',
    SAVE_GOALS: 'https://victoryvision.app.n8n.cloud/webhook/update-goals',
    GET_GOALS: 'https://victoryvision.app.n8n.cloud/webhook/get-goals',
    UPDATE_USER_PROFILE: 'https://victoryvision.app.n8n.cloud/webhook/update-user-profile'
  };
  
  const DEBUG = true;
  let CUSTOMER_ID = null;
  let currentUser = null;
  let authToken = null;

  // Authentication and session management
  async function checkAuthentication() {
    try {
      console.log('Checking authentication...');
      
      // Check Supabase session for auth only
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      
      if (error) {
        console.error('Auth error:', error);
        return false;
      }

      if (session && session.user) {
        console.log('Valid session found:', session.user.email);
        CUSTOMER_ID = session.user.email;
        authToken = session.access_token;
        currentUser = {
          id: session.user.id,
          email: session.user.email,
          customer_id: session.user.email
        };
        
        document.getElementById('userEmail').textContent = CUSTOMER_ID;
        return true;
      }

      console.log('No valid session found');
      return false;
    } catch (e) {
      console.error('Auth check error:', e);
      return false;
    }
  }

  function redirectToLogin() {
    localStorage.removeItem('vv_session');
    window.location.href = 'login.html';
  }

  async function logout() {
    try {
      await supabaseClient.auth.signOut();
      localStorage.removeItem('vv_session');
      redirectToLogin();
    } catch (e) {
      console.error('Logout error:', e);
      localStorage.removeItem('vv_session');
      redirectToLogin();
    }
  }

  // Secure API call wrapper with authentication
  async function secureApiCall(endpoint, data, method = 'POST') {
    try {
      console.log(`Making secure API call to: ${endpoint} with method: ${method}`);
      
      const headers = {
        'Content-Type': 'application/json',
        'X-Customer-ID': CUSTOMER_ID,
        'X-Request-ID': generateRequestId(),
        'X-Timestamp': new Date().toISOString()
      };
      
      // Add auth token if available
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const requestPayload = {
        ...data,
        customer_id: CUSTOMER_ID,
        timestamp: new Date().toISOString(),
        request_id: generateRequestId()
      };

      console.log('Request payload:', requestPayload);

      const response = await fetch(endpoint, {
        method: method,
        headers: headers,
        body: JSON.stringify(requestPayload)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const result = await response.json();
      console.log('API response:', result);
      return result;
    } catch (error) {
      console.error('API call failed:', error);
      
      // Handle auth errors
      if (error.message.includes('401') || error.message.includes('403')) {
        showStatus('Session expired. Please log in again.', true);
        setTimeout(redirectToLogin, 2000);
      }
      
      throw error;
    }
  }

  function generateRequestId() {
    return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', async function() {
    document.getElementById('authLoading').style.display = 'flex';
    
    try {
      const isAuthenticated = await checkAuthentication();
      
      if (isAuthenticated) {
        document.getElementById('authLoading').style.display = 'none';
        setupColorPickers();
        await loadCompanyProfile();
        await loadAllGoals();
      } else {
        redirectToLogin();
      }
    } catch (e) {
      console.error('Initialization failed:', e);
      redirectToLogin();
    }
  });

  // Color picker synchronization
  function setupColorPickers() {
    document.getElementById('color1').addEventListener('change', function() {
      document.getElementById('color1Text').value = this.value;
    });
    document.getElementById('color2').addEventListener('change', function() {
      document.getElementById('color2Text').value = this.value;
    });
    document.getElementById('color3').addEventListener('change', function() {
      document.getElementById('color3Text').value = this.value;
    });

    document.getElementById('color1Text').addEventListener('change', function() {
      document.getElementById('color1').value = this.value;
    });
    document.getElementById('color2Text').addEventListener('change', function() {
      document.getElementById('color2').value = this.value;
    });
    document.getElementById('color3Text').addEventListener('change', function() {
      document.getElementById('color3').value = this.value;
    });
  }

  function showLoader() {
    document.getElementById('loader').style.display = 'block';
  }

  function hideLoader() {
    document.getElementById('loader').style.display = 'none';
  }

  function showStatus(message, isError = false) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = message;
    statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 5000);
  }

  // Modal functions
  function showCurrentData(type) {
    const modal = document.getElementById('dataModal');
    const modalTitle = document.getElementById('modalTitle');
    
    if (type === 'company') {
      modalTitle.textContent = 'Current Company Profile';
      loadCompanyDataForModal();
    } else if (type === 'goals') {
      modalTitle.textContent = 'Current Goals';
      loadGoalsDataForModal();
    }
    
    modal.style.display = 'block';
  }

  function closeModal() {
    document.getElementById('dataModal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('dataModal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  }

  async function loadCompanyDataForModal() {
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = '<div class="loader" style="display: block;"></div>';
    
    try {
      const data = await secureApiCall(N8N_ENDPOINTS.GET_COMPANY, {}, 'GET');
      
      if (data.company) {
        const company = data.company;
        modalContent.innerHTML = `
          <div class="current-data"><strong>Company Name:</strong> ${company.company_name || 'Not set'}</div>
          <div class="current-data"><strong>Industry:</strong> ${company.industry || 'Not set'}</div>
          <div class="current-data"><strong>Logo URL:</strong> ${company.logo_URL || 'Not set'}</div>
          <div class="current-data"><strong>Company Description:</strong> ${company.company_description || 'Not set'}</div>
          <div class="current-data"><strong>Primary Product:</strong> ${company.product_descriptions || 'Not set'}</div>
          <div class="current-data"><strong>Secondary Product:</strong> ${company.product_descriptions_2 || 'Not set'}</div>
          <div class="current-data"><strong>Third Product:</strong> ${company.product_descriptions_3 || 'Not set'}</div>
          <div class="current-data"><strong>Brand Colors:</strong> ${company.brand_colors || 'Not set'}</div>
        `;
      } else {
        modalContent.innerHTML = '<div class="current-data">No company profile found for this user.</div>';
      }
    } catch (error) {
      modalContent.innerHTML = `<div class="current-data" style="color: red;">Error loading data: ${error.message}</div>`;
    }
  }

  async function loadGoalsDataForModal() {
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = '<div class="loader" style="display: block;"></div>';
    
    try {
      const data = await secureApiCall(N8N_ENDPOINTS.GET_GOALS, {}, 'GET');
      
      if (data.goals && data.goals.length > 0) {
        let html = '';
        data.goals.forEach(goal => {
          html += `
            <div class="current-data">
              <h4>Goal ${goal.goal_number}</h4>
              <strong>Description:</strong> ${goal.goal_description || 'Not set'}<br>
              <strong>Measurement:</strong> ${goal.measurement || 'Not set'}<br>
              <strong>Achievable:</strong> ${goal.achievable || 'Not set'}<br>
              <strong>Relevant:</strong> ${goal.relationship || 'Not set'}<br>
              <strong>Time Limit:</strong> ${goal.time_limit ? new Date(goal.time_limit).toLocaleDateString() : 'Not set'}
            </div>
          `;
        });
        modalContent.innerHTML = html;
      } else {
        modalContent.innerHTML = '<div class="current-data">No goals found for this user.</div>';
      }
    } catch (error) {
      modalContent.innerHTML = `<div class="current-data" style="color: red;">Error loading data: ${error.message}</div>`;
    }
  }

  // Company Profile Functions - Via n8n Middleware
  document.getElementById('companyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    showLoader();
    
    try {
      const formData = new FormData(this);
      const companyData = {
        company_name: formData.get('company_name'),
        industry: formData.get('industry'),
        logo_URL: formData.get('logo_URL'),
        company_description: formData.get('company_description'),
        product_descriptions: formData.get('product_descriptions'),
        product_descriptions_2: formData.get('product_descriptions_2'),
        product_descriptions_3: formData.get('product_descriptions_3'),
        brand_colors: formData.get('brand_colors_1') + ',' + 
                     formData.get('brand_colors_2') + ',' + 
                     formData.get('brand_colors_3')
      };

      console.log('Saving company profile via n8n:', companyData);

      // Save company profile - Using POST method
      const companyResult = await secureApiCall(N8N_ENDPOINTS.SAVE_COMPANY, companyData, 'POST');

      if (companyResult.success || companyResult.status === 'success') {
        // Also update user profile with relevant info
        try {
          const userResult = await secureApiCall(N8N_ENDPOINTS.UPDATE_USER_PROFILE, companyData);
          console.log('User profile updated:', userResult);
        } catch (userError) {
          console.warn('User profile update failed (non-critical):', userError);
          // Don't fail the whole operation if user update fails
        }
        
        showStatus('Company profile saved successfully!');
      } else {
        throw new Error(companyResult.message || 'Save failed');
      }
    } catch (error) {
      console.error('Error saving company profile:', error);
      showStatus('Error saving company profile: ' + error.message, true);
    } finally {
      hideLoader();
    }
  });

  async function loadCompanyProfile() {
    showLoader();
    
    try {
      console.log('Loading company profile via n8n for:', CUSTOMER_ID);

      const data = await secureApiCall(N8N_ENDPOINTS.GET_COMPANY, {}, 'GET');

      if (data.company) {
        const company = data.company;
        console.log('Loaded company profile:', company);
        
        document.getElementById('companyName').value = company.company_name || '';
        document.getElementById('industry').value = company.industry || '';
        document.getElementById('logoUrl').value = company.logo_URL || '';
        document.getElementById('companyDescription').value = company.company_description || '';
        document.getElementById('productDescription1').value = company.product_descriptions || '';
        document.getElementById('productDescription2').value = company.product_descriptions_2 || '';
        document.getElementById('productDescription3').value = company.product_descriptions_3 || '';
        
        // Handle brand colors
        if (company.brand_colors) {
          const colors = company.brand_colors.split(',');
          if (colors[0]) {
            document.getElementById('color1').value = colors[0].trim();
            document.getElementById('color1Text').value = colors[0].trim();
          }
          if (colors[1]) {
            document.getElementById('color2').value = colors[1].trim();
            document.getElementById('color2Text').value = colors[1].trim();
          }
          if (colors[2]) {
            document.getElementById('color3').value = colors[2].trim();
            document.getElementById('color3Text').value = colors[2].trim();
          }
        }
        
        showStatus('Company profile loaded successfully!');
      } else {
        console.log('No company profile found for user');
        showStatus('No existing company profile found. Please fill out the form.');
      }
    } catch (error) {
      console.error('Error loading company profile:', error);
      showStatus('Error loading company profile: ' + error.message, true);
    } finally {
      hideLoader();
    }
  }

  // Goals Functions - Via n8n Middleware
  async function saveAllGoals() {
    showLoader();
    
    try {
      const goalForms = document.querySelectorAll('.goal-form');
      const goalsData = [];

      goalForms.forEach((form, index) => {
        const formData = new FormData(form);
        const goalNumber = index + 1;
        
        // Only save goals that have at least a description
        if (formData.get('goal_description') && formData.get('goal_description').trim()) {
          goalsData.push({
            goal_number: goalNumber,
            goal_description: formData.get('goal_description'),
            measurement: formData.get('measurement'),
            achievable: formData.get('achievable'),
            relationship: formData.get('relationship'),
            time_limit: formData.get('time_limit') || null
          });
        }
      });

      if (goalsData.length === 0) {
        showStatus('Please fill out at least one goal before saving.', true);
        return;
      }

      console.log('Saving goals via n8n:', goalsData);

      const result = await secureApiCall(N8N_ENDPOINTS.SAVE_GOALS, { goals: goalsData });

      if (result.success || result.status === 'success') {
        showStatus(`Successfully saved ${goalsData.length} goal(s)!`);
      } else {
        throw new Error(result.message || 'Save failed');
      }
    } catch (error) {
      console.error('Error saving goals:', error);
      showStatus('Error saving goals: ' + error.message, true);
    } finally {
      hideLoader();
    }
  }

  async function loadAllGoals() {
    showLoader();
    
    try {
      console.log('Loading goals via n8n for:', CUSTOMER_ID);

      const data = await secureApiCall(N8N_ENDPOINTS.GET_GOALS, {}, 'GET');

      console.log('Loaded goals:', data);

      // Clear all goal forms first
      const goalForms = document.querySelectorAll('.goal-form');
      goalForms.forEach(form => {
        form.reset();
      });

      if (data.goals && data.goals.length > 0) {
        data.goals.forEach(goal => {
          const goalIndex = goal.goal_number - 1;
          if (goalIndex >= 0 && goalIndex < goalForms.length) {
            const form = goalForms[goalIndex];
            
            form.querySelector('[name="goal_description"]').value = goal.goal_description || '';
            form.querySelector('[name="measurement"]').value = goal.measurement || '';
            form.querySelector('[name="achievable"]').value = goal.achievable || '';
            form.querySelector('[name="relationship"]').value = goal.relationship || '';
            if (goal.time_limit) {
              // Format date for input field
              const date = new Date(goal.time_limit);
              const formattedDate = date.toISOString().split('T')[0];
              form.querySelector('[name="time_limit"]').value = formattedDate;
            }
          }
        });
        
        showStatus(`Loaded ${data.goals.length} goal(s) successfully!`);
      } else {
        showStatus('No existing goals found. Please fill out the goals.');
      }
    } catch (error) {
      console.error('Error loading goals:', error);
      showStatus('Error loading goals: ' + error.message, true);
    } finally {
      hideLoader();
    }
  }

  // Security: Session timeout check
  setInterval(async function() {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        console.log('Session expired, redirecting to login');
        redirectToLogin();
      }
    } catch (e) {
      console.error('Session check failed:', e);
    }
  }, 300000); // Check every 5 minutes

  // Security: Detect tab visibility and re-verify auth when tab becomes visible
  document.addEventListener('visibilitychange', async function() {
    if (!document.hidden) {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          redirectToLogin();
        } else {
          // Update auth token if needed
          authToken = session.access_token;
        }
      } catch (e) {
        console.error('Visibility auth check failed:', e);
      }
    }
  });

  // Security: Rate limiting for API calls
  const rateLimiter = {
    calls: new Map(),
    maxCalls: 10,
    windowMs: 60000, // 1 minute
    
    canMakeCall: function(endpoint) {
      const now = Date.now();
      const windowStart = now - this.windowMs;
      
      if (!this.calls.has(endpoint)) {
        this.calls.set(endpoint, []);
      }
      
      const calls = this.calls.get(endpoint);
      // Remove old calls outside the window
      const recentCalls = calls.filter(time => time > windowStart);
      this.calls.set(endpoint, recentCalls);
      
      if (recentCalls.length >= this.maxCalls) {
        return false;
      }
      
      recentCalls.push(now);
      return true;
    }
  };

  // Security: Input validation and sanitization
  function validateAndSanitizeInput(data) {
    const sanitized = {};
    
    for (const [key, value] of Object.entries(data)) {
      if (typeof value === 'string') {
        // Basic XSS prevention
        sanitized[key] = value
          .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
          .replace(/javascript:/gi, '')
          .replace(/on\w+\s*=/gi, '')
          .trim();
      } else {
        sanitized[key] = value;
      }
    }
    
    return sanitized;
  }

  // Security: Override the secureApiCall to include validation and rate limiting
  const originalSecureApiCall = secureApiCall;
  secureApiCall = async function(endpoint, data, method = 'POST') {
    // Rate limiting check
    if (!rateLimiter.canMakeCall(endpoint)) {
      throw new Error('Rate limit exceeded. Please wait before making more requests.');
    }
    
    // Input validation and sanitization
    const sanitizedData = validateAndSanitizeInput(data);
    
    // Call original function with sanitized data
    return originalSecureApiCall(endpoint, sanitizedData, method);
  };
</script>
</body>
</html>
